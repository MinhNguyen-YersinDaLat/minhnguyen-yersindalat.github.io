<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game: Phân Cảnh Chuyển Tiếp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- THÊM THƯ VIỆN ÂM THANH TONE.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700;900&family=Metal+Mania&display=swap" rel="stylesheet">

    <style>
        :root {
            --glow-color: #ff4500;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0033 50%, #000a1a 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        /* --- Màn hình chờ bắt đầu --- */
        #start-prompt-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-align: center;
            transition: opacity 0.5s ease-out;
            padding: 2rem;
        }
        .prompt-content {
            animation: fadeIn 2s ease-in-out;
        }
        .prompt-content h1 {
            font-family: 'Metal Mania', cursive;
            font-size: 2.8rem;
            line-height: 1.3;
            color: var(--glow-color);
            text-shadow: 0 0 15px var(--glow-color);
            max-width: 900px;
        }
        .prompt-content p {
            font-size: 1.5rem;
            margin-top: 2rem;
            animation: pulse-text 2s infinite;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-text { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }


        /* --- Bố cục chính --- */
        .main-wrapper {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 40px;
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }

        .character-side-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            transition: opacity 0.5s ease-in-out;
            min-height: 450px;
        }
        
        #dialogue-container {
            flex: 2;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        /* --- Màn hình chính của cảnh chuyển tiếp --- */
        #cutscene-screen {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1s ease-in-out;
            opacity: 0; 
        }
        
        .cutscene-character {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.5s ease-in-out;
            opacity: 0;
            transform: scale(0.9);
            visibility: hidden;
        }

        .cutscene-character.visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }
        
        /* --- Hộp thoại --- */
        #dialogue-box {
            background: rgba(0,0,0,0.7);
            border: 2px solid var(--glow-color);
            border-radius: 15px;
            padding: 1.5rem 2rem;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease-out;
            box-shadow: 0 0 20px var(--glow-color);
            width: 100%;
        }

        #dialogue-box.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #dialogue-text {
            text-shadow: 0 0 10px var(--glow-color);
            font-size: 1.25rem;
            line-height: 1.6;
            min-height: 100px;
        }
        
        #speaker-name {
            font-family: 'Metal Mania', cursive;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--glow-color);
            text-shadow: 0 0 5px #fff;
        }
        
        #next-btn {
            margin-top: 1rem;
            padding: 0.5rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            background: var(--glow-color);
            border: 1px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #next-btn:hover {
            background: white;
            color: var(--glow-color);
        }

        /* --- Popup lựa chọn cuối cảnh --- */
        #end-popup-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-in-out;
        }
        #end-popup {
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            border: 2px solid var(--glow-color);
            border-radius: 15px;
            padding: 2rem 3rem;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 69, 0, 0.5);
            transform: scale(0.9);
            opacity: 0;
            animation: popIn 0.5s forwards ease-out;
        }
        @keyframes popIn {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        #end-popup h2 {
            font-family: 'Metal Mania', cursive;
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            color: var(--glow-color);
        }
        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .popup-buttons button {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            background: transparent;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .popup-buttons button:hover {
            background: var(--glow-color);
            border-color: var(--glow-color);
            transform: scale(1.05);
        }
        .hidden {
            display: none !important;
        }

        /* --- Hiệu ứng nhân vật --- */
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-15px) rotate(2deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(239, 68, 68, 0.8); } }
        @keyframes glow { 0%, 100% { filter: brightness(1) drop-shadow(0 0 10px currentColor); } 50% { filter: brightness(1.2) drop-shadow(0 0 20px currentColor); } }
        @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } }
        .float { animation: float 4s ease-in-out infinite; }
        .pulse { animation: pulse 2s ease-in-out infinite; }
        .glow { animation: glow 3s ease-in-out infinite; }
        .sparkle { animation: sparkle 2s ease-in-out infinite; }
        #cigarette-visual {
            width: 200px;
            height: 100px;
            filter: drop-shadow(0 5px 20px rgba(0, 0, 0, 0.8));
            animation: idle-spasm 6s ease-in-out infinite;
        }
        @keyframes idle-spasm { 0%, 100% { transform: translate(0, 0) rotate(0); } 10% { transform: translate(-2px, 2px) rotate(-1deg); } 20% { transform: translate(2px, -2px) rotate(1deg); } 30% { transform: translate(-3px, 0px) rotate(-1.5deg); } 40% { transform: translate(3px, 1px) rotate(1.5deg); } 50% { transform: translate(0, 0) rotate(0); } 70% { transform: translate(0, 0) rotate(0); } 72% { transform: translate(5px, -5px) rotate(3deg); } 74% { transform: translate(0, 0) rotate(0); } }
        .ember-shape { fill: #ff4500; filter: url(#emberGlow); animation: ember-flicker 1.5s infinite alternate; }
        @keyframes ember-flicker { from { opacity: 0.9; } to { opacity: 1; } }
        #nicotine-visual {
            width: 320px;
            position: relative;
        }
        .nicotine-monster-inner { width: 100%; height: 100%; animation: monsterFloat 3s ease-in-out infinite; filter: drop-shadow(0 0 20px #ff0000) drop-shadow(0 0 40px #800000); }
        @keyframes monsterFloat {0%, 100% {transform: translateY(0px) rotate(-1deg);} 33% {transform: translateY(-10px) rotate(1deg);} 66% {transform: translateY(-5px) rotate(-0.5deg);}}
        @keyframes monsterPulse {0%, 100% {transform: scale(1);} 50% {transform: scale(1.02);}}
        @keyframes eyeGlow {0% {fill: #ff0000; filter: brightness(1);} 100% {fill: #ff4000; filter: brightness(1.5) drop-shadow(0 0 3px #ff0000);}}
        @keyframes smokeRise {0% {opacity: 0.9; transform: translateY(0px) scale(1) rotate(0deg);} 50% {opacity: 0.6; transform: translateY(-8px) scale(1.1) rotate(5deg);} 100% {opacity: 0.2; transform: translateY(-15px) scale(1.3) rotate(10deg);}}
        @keyframes cigaretteBurn {0%, 100% {fill: #ff4000; filter: brightness(1);} 50% {fill: #ff8000; filter: brightness(1.5) drop-shadow(0 0 2px #ff4000);}}
        @keyframes auraFlicker {0%, 100% {opacity: 0.3; transform: scale(1);} 50% {opacity: 0.6; transform: scale(1.05);}}
        @keyframes briefcaseGlow {0%, 100% {filter: brightness(1);} 50% {filter: brightness(1.2) drop-shadow(0 0 2px #ff0000);}}
        @keyframes toxicFloat {0% {opacity: 0; transform: translateY(0px) scale(0);} 25% {opacity: 0.7; transform: translateY(-10px) scale(1);} 50% {opacity: 0.5; transform: translateY(-20px) scale(0.8);} 75% {opacity: 0.3; transform: translateY(-30px) scale(0.6);} 100% {opacity: 0; transform: translateY(-40px) scale(0);}}
    </style>
</head>
<div id="copyright">
    © <span id="year"></span> Thầy Thái Minh Nguyên - Trường Tiểu học, THCS & THPT Yersin Đà Lạt. All rights reserved.
</div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap');

#copyright {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 13px;
    padding: 6px 0;
    font-family: 'Roboto', Arial, Helvetica, sans-serif;
    z-index: 9999;
    pointer-events: none;

    color: rgba(255, 255, 255, 0.85);
    background: transparent;

    opacity: 0;
    animation: fadeIn 2s ease forwards;
}

@keyframes fadeIn {
    to { opacity: 1; }
}
</style>

<script>
document.getElementById("year").textContent = new Date().getFullYear();
</script>

<body>

<!-- Nút toàn màn hình -->
<button id="fullscreen-btn" class="fixed top-4 right-4 z-[1000] p-2 bg-black/50 rounded-full text-white hover:bg-black/75 transition-colors cursor-pointer">
    <svg id="fullscreen-icon-open" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    <svg id="fullscreen-icon-close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
</button>

<!-- Màn hình chờ để người dùng tương tác -->
<div id="start-prompt-overlay">
    <div class="prompt-content">
        <h1>Tưởng như đã tiêu diệt được Nicotine nhưng không, hắn lại trỗi dậy trong một hình hài khác, độc ác hơn rất nhiều</h1>
        <p>Nhấn vào bất cứ đâu để tiếp tục</p>
    </div>
</div>


<!-- SVG Definitions -->
<svg width="0" height="0" style="position:absolute">
    <defs>
        <filter id="emberGlow"><feGaussianBlur stdDeviation="3.5" result="coloredBlur" /><feMerge><feMergeNode in="coloredBlur" /><feMergeNode in="SourceGraphic" /></feMerge></filter>
        <radialGradient id="paper-gradient"><stop offset="0%" stop-color="#d2b48c" /><stop offset="100%" stop-color="#c8a97e" /></radialGradient>
        <radialGradient id="auraGradient" cx="50%" cy="50%" r="80%"><stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.1" /><stop offset="50%" style="stop-color:#800000;stop-opacity:0.3" /><stop offset="100%" style="stop-color:#000000;stop-opacity:0.5" /></radialGradient>
        <linearGradient id="suitGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#1a1a1a;stop-opacity:1" /><stop offset="50%" style="stop-color:#000000;stop-opacity:1" /><stop offset="100%" style="stop-color:#330000;stop-opacity:1" /></linearGradient>
        <linearGradient id="redGlowGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.8" /><stop offset="50%" style="stop-color:#cc0000;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#800000;stop-opacity:0.4" /></linearGradient>
        <linearGradient id="smokeGradient" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" style="stop-color:#666666;stop-opacity:0.9" /><stop offset="50%" style="stop-color:#999999;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#cccccc;stop-opacity:0.3" /></linearGradient>
    </defs>
</svg>

<!-- Màn hình cảnh chuyển tiếp -->
<div id="cutscene-screen" class="hidden">
    <div class="main-wrapper">
        <!-- Anh hùng Minh -->
        <div class="character-side-container">
            <div id="hero-container" class="cutscene-character">
                <div class="float">
                    <div class="relative">
                        <div class="absolute -inset-8 bg-gradient-to-r from-yellow-400/40 via-yellow-300/50 to-yellow-400/40 rounded-full glow"></div>
                        <div class="absolute -inset-6 bg-gradient-to-r from-yellow-200/30 via-yellow-100/40 to-yellow-200/30 rounded-full sparkle"></div>
                        <div class="absolute -inset-4 bg-gradient-to-r from-yellow-300/20 via-yellow-200/30 to-yellow-300/20 rounded-full glow"></div>
                        <div class="absolute -right-8 top-2 w-16 h-24 bg-gradient-to-b from-red-500 via-red-600 to-red-800 rounded-b-3xl transform rotate-20 glow shadow-2xl border-2 border-red-400 float">
                            <div class="absolute -right-2 top-4 w-4 h-16 bg-red-600 rounded-r-2xl transform rotate-12 opacity-80"></div>
                            <div class="absolute -right-1 top-8 w-2 h-12 bg-red-700 rounded-r-xl transform rotate-6 opacity-60"></div>
                        </div>
                        <div class="w-20 h-28 bg-gradient-to-b from-blue-400 via-blue-600 to-blue-800 rounded-2xl relative shadow-2xl border-2 border-blue-300">
                            <div class="absolute -top-8 left-2 w-16 h-16 bg-gradient-to-b from-orange-100 to-orange-200 rounded-full border-4 border-yellow-500 shadow-2xl">
                                <div class="absolute top-3 left-1 w-14 h-6 bg-black rounded-full border-2 border-gray-700">
                                    <div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 left-1"></div>
                                    <div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 right-1"></div>
                                    <div class="w-2 h-1 bg-gray-600 absolute top-2 left-1/2 transform -translate-x-1/2"></div>
                                </div>
                                <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-8 h-3 border-b-2 border-black rounded-full"></div>
                                <div class="absolute -top-3 left-1 w-14 h-6 bg-gradient-to-r from-amber-700 to-amber-900 rounded-t-full shadow-lg"></div>
                            </div>
                            <div class="absolute top-6 left-1/2 transform -translate-x-1/2 w-10 h-10 bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 rounded-full border-2 border-yellow-600 glow shadow-xl">
                                <div class="absolute top-1 left-1 w-8 h-8 bg-gradient-to-r from-yellow-200 to-yellow-300 rounded-full">
                                    <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-lg font-black text-blue-900" style="font-family: 'Nunito', sans-serif;">M</span>
                                </div>
                            </div>
                            <div class="absolute -left-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div>
                            <div class="absolute -right-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div>
                            <div class="absolute bottom-0 left-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div>
                            <div class="absolute bottom-0 right-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div>
                            <div class="absolute -bottom-2 left-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div>
                            <div class="absolute -bottom-2 right-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div>
                        </div>
                    </div>
                </div>
                <p class="text-lg font-bold text-cyan-300 mt-4" style="text-shadow: 0 0 8px #00ffff;">Anh hùng Minh</p>
            </div>
        </div>

        <!-- Hộp thoại -->
        <div id="dialogue-container">
            <div id="dialogue-box">
                <h3 id="speaker-name"></h3>
                <p id="dialogue-text"></p>
                <button id="next-btn">Tiếp theo &rarr;</button>
            </div>
        </div>

        <!-- Quái vật -->
        <div class="character-side-container">
            <!-- Quái vật Nicotine -->
            <div id="nicotine-container" class="cutscene-character">
                <div id="nicotine-visual">
                    <div class="nicotine-monster-inner">
                        <svg class="w-full h-full" viewBox="0 0 80 80">
                            <ellipse fill="url(#auraGradient)" cx="40" cy="40" rx="38" ry="35" style="animation: auraFlicker 2s ease-in-out infinite;"/>
                            <g transform="translate(15, 45)" style="animation: briefcaseGlow 2s ease-in-out infinite;">
                                <rect fill="#1a1a1a" stroke="#ff0000" stroke-width="0.5" x="0" y="0" width="8" height="6" rx="1"/>
                                <rect fill="#ff0000" x="1" y="1" width="6" height="1" opacity="0.6"/>
                                <circle fill="#ff0000" cx="7" cy="3" r="0.5"/>
                            </g>
                            <ellipse fill="url(#suitGradient)" stroke="url(#redGlowGradient)" stroke-width="1" cx="40" cy="45" rx="12" ry="18" style="animation: monsterPulse 2s ease-in-out infinite;"/>
                            <path fill="#000000" stroke="#ff0000" stroke-width="0.3" d="M32,35 L35,40 L40,38 L45,40 L48,35 L45,32 L35,32 Z"/>
                            <path fill="#cc0000" stroke="#ff0000" stroke-width="0.5" d="M38,38 L42,38 L41,50 L39,50 Z"/>
                            <circle fill="#ff0000" cx="40" cy="42" r="0.8"/><circle fill="#ff0000" cx="40" cy="46" r="0.8"/><circle fill="#ff0000" cx="40" cy="50" r="0.8"/>
                            <polygon fill="#ff0000" points="28,35 30,30 32,35"/><polygon fill="#ff0000" points="48,35 50,30 52,35"/>
                            <polygon fill="#ff0000" points="26,38 28,33 30,38"/><polygon fill="#ff0000" points="50,38 52,33 54,38"/>
                            <ellipse fill="#d0d0d0" stroke="#999999" stroke-width="0.5" cx="40" cy="25" rx="10" ry="12" style="animation: monsterPulse 2.5s ease-in-out infinite;"/>
                            <path fill="#1a1a1a" stroke="#000000" stroke-width="0.3" d="M30,18 Q40,15 50,18 Q48,22 45,20 Q40,19 35,20 Q32,22 30,18"/>
                            <polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="33,18 35,10 37,18"/>
                            <polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="43,18 45,10 47,18"/>
                            <ellipse fill="#ff0000" cx="36" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"/>
                            <ellipse fill="#ff0000" cx="44" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"/>
                            <ellipse fill="#000000" cx="36" cy="23" rx="0.8" ry="1"/><ellipse fill="#000000" cx="44" cy="23" rx="0.8" ry="1"/>
                            <circle fill="#ffff00" cx="35" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite;"/>
                            <circle fill="#ffff00" cx="45" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite; animation-delay: 0.5s;"/>
                            <path fill="#000000" d="M34,28 Q40,32 46,28 Q40,30 34,28" opacity="0.9"/>
                            <polygon fill="#ffffff" points="36,28 37,30 38,28"/><polygon fill="#ffffff" points="39,28 40,31 41,28"/><polygon fill="#ffffff" points="42,28 43,30 44,28"/>
                            <rect fill="#f5f5dc" x="46" y="26" width="6" height="1" rx="0.5"/>
                            <rect fill="#d2691e" x="46" y="26.2" width="5" height="0.6" rx="0.3"/>
                            <circle fill="#ff4000" cx="52" cy="26.5" r="0.8" style="animation: cigaretteBurn 1s ease-in-out infinite;"/>
                            <circle fill="#ff8000" cx="52" cy="26.5" r="0.4" style="animation: cigaretteBurn 1s ease-in-out infinite; animation-delay: 0.3s;"/>
                            <path fill="none" stroke="url(#smokeGradient)" stroke-width="1.5" stroke-linecap="round" d="M52,26 Q55,22 53,18 Q56,15 54,12" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0s;"/>
                            <path fill="none" stroke="url(#smokeGradient)" stroke-width="1.2" stroke-linecap="round" d="M52,26 Q57,23 55,19 Q58,16 56,13" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0.5s;"/>
                            <path fill="none" stroke="url(#smokeGradient)" stroke-width="1" stroke-linecap="round" d="M52,26 Q54,24 52,20 Q55,17 53,14" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 1s;"/>
                            <ellipse fill="#333333" cx="38" cy="25" rx="0.5" ry="0.3"/><ellipse fill="#333333" cx="42" cy="25" rx="0.5" ry="0.3"/>
                            <path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M38,25 Q36,22 38,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.3s;"/>
                            <path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M42,25 Q44,22 42,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.8s;"/>
                            <circle fill="#00ff00" cx="25" cy="15" r="0.8" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0s;"/>
                            <circle fill="#00ff00" cx="55" cy="20" r="0.6" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 1s;"/>
                            <circle fill="#00ff00" cx="20" cy="35" r="0.7" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 2s;"/>
                            <circle fill="#00ff00" cx="60" cy="30" r="0.5" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0.5s;"/>
                            <path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M20,20 Q25,15 30,20" style="animation: auraFlicker 1.8s ease-in-out infinite;"/>
                            <path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M50,20 Q55,15 60,20" style="animation: auraFlicker 1.8s ease-in-out infinite; animation-delay: 0.6s;"/>
                            <path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M15,40 Q20,35 25,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.3s;"/>
                            <path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M55,40 Q60,35 65,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.9s;"/>
                        </svg>
                    </div>
                </div>
                <p class="text-xl font-bold text-red-500 mt-4" style="text-shadow: 0 0 8px #ff0000;">Quái vật Nicotine</p>
            </div>

            <!-- Quái vật thuốc lá -->
            <div id="cigarette-container" class="cutscene-character">
                <svg id="cigarette-visual" viewBox="0 0 200 100">
                    <path class="filter-shape" fill="#6b3520" d="M160,30 L180,28 Q192,30 190,50 Q188,70 180,72 L160,70 Z" />
                    <path class="cigarette-body-shape" fill="url(#paper-gradient)" d="M20,30 L160,30 L160,70 L20,70 Q10,70 10,50 Q10,30 20,30 Z" />
                    <path class="stain" fill="#704214" opacity="0.6" d="M110,40 C 120,35 130,45 125,55 C 120,60 110,55 110,40 Z" />
                    <path class="stain" fill="#704214" opacity="0.6" d="M70,60 C 75,55 85,58 80,68 Z" />
                    <path class="crack" fill="none" stroke="#4e2a1d" stroke-width="1.2" d="M140,45 C 145,50, 145,55, 150,60" />
                    <path class="crack" fill="none" stroke="#4e2a1d" stroke-width="1.2" d="M100,35 C 105,45, 95,55, 100,65" />
                    <path class="crack" fill="none" stroke="#4e2a1d" stroke-width="1.2" d="M40,35 L 45,65" />
                    <path class="crack" fill="none" stroke="#4e2a1d" stroke-width="1.2" d="M155,35 L 158,65" />
                    <path class="ash-shape" fill="#333" d="M20,30 Q10,30 10,50 Q10,70 20,70 L30,70 Q25,50 30,30 Z" />
                    <path d="M28 40 L 32 38 M28 50 L 33 50 M28 60 L 32 62" stroke="#a0522d" stroke-width="1" />
                    <path class="ember-shape" d="M25,35 Q20,50 25,65 L20,65 Q15,50 20,35 Z" />
                    <g id="face">
                        <g id="eye1_group">
                            <circle class="eye-socket" fill="#1a0000" cx="55" cy="50" r="8" />
                            <circle class="eye-ball" fill="#dc143c" cx="55" cy="50" r="7" />
                            <path class="eye-vein" stroke="#8b0000" stroke-width="0.5" fill="none" d="M50,50 C 52,47 55,47 57,50" />
                            <path class="eye-vein" stroke="#8b0000" stroke-width="0.5" fill="none" d="M57,50 C 59,53 62,53 85,50" />
                            <circle class="eye-pupil" fill="#000" id="pupil1" cx="55" cy="50" r="3" />
                        </g>
                        <g id="eye2_group">
                            <circle class="eye-socket" fill="#1a0000" cx="80" cy="50" r="8" />
                            <circle class="eye-ball" fill="#dc143c" cx="80" cy="50" r="7" />
                            <path class="eye-vein" stroke="#8b0000" stroke-width="0.5" fill="none" d="M75,50 C 77,47 80,47 82,50" />
                            <path class="eye-vein" stroke="#8b0000" stroke-width="0.5" fill="none" d="M82,50 C 84,53 87,53 85,50" />
                            <circle class="eye-pupil" fill="#000" id="pupil2" cx="80" cy="50" r="3" />
                        </g>
                        <path class="mouth" fill="#1a1a1a" id="mouth-path" d="M60 65 L 64 63 L 68 65 L 72 63 L 76 65" />
                    </g>
                </svg>
                <p class="text-xl font-bold text-amber-400 mt-4" style="text-shadow: 0 0 8px #c8a97e;">Quái vật Thuốc lá</p>
            </div>
        </div>
    </div>
</div>

<!-- Popup lựa chọn cuối cảnh -->
<div id="end-popup-overlay" class="hidden">
    <div id="end-popup">
        <h2>Hành trình tiếp theo?</h2>
        <div class="popup-buttons">
            <button id="restart-btn">Xem lại hội thoại</button>
            <button id="continue-btn">Tiếp tục</button>
            <button id="home-btn">Về màn hình chính</button>
        </div>
    </div>
</div>

<script>
    // --- Lấy các phần tử DOM ---
    const startPromptOverlay = document.getElementById('start-prompt-overlay');
    const cutsceneScreen = document.getElementById('cutscene-screen');
    const dialogueBox = document.getElementById('dialogue-box');
    const speakerName = document.getElementById('speaker-name');
    const dialogueText = document.getElementById('dialogue-text');
    const nextButton = document.getElementById('next-btn');
    
    const heroCharacter = document.getElementById('hero-container');
    const nicotineMonster = document.getElementById('nicotine-container');
    const cigaretteMonster = document.getElementById('cigarette-container');

    const endPopupOverlay = document.getElementById('end-popup-overlay');
    const restartBtn = document.getElementById('restart-btn');
    const continueBtn = document.getElementById('continue-btn');
    const homeBtn = document.getElementById('home-btn');
    
    // --- DOM cho nút toàn màn hình ---
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const fullscreenIconOpen = document.getElementById('fullscreen-icon-open');
    const fullscreenIconClose = document.getElementById('fullscreen-icon-close');

    // --- BỘ QUẢN LÝ ÂM THANH ---
    const AudioManager = {
        isInitialized: false,
        sounds: {},
        music: null,

        async init() {
            if (this.isInitialized) return;
            await Tone.start();
            
            // Đặt âm lượng tổng thể
            Tone.Destination.volume.value = -9;

            this.sounds.click = new Tone.Synth({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }
            }).toDestination();
            
            this.sounds.appear = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.005, decay: 0.2, sustain: 0 }
            }).toDestination();

            const musicSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle8" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.2, release: 1 },
            }).toDestination();
            
            // Điều chỉnh âm lượng nhạc nền
            musicSynth.volume.value = -15;

            this.music = new Tone.Sequence((time, note) => {
                musicSynth.triggerAttackRelease(note, '8n', time);
            }, ['C4', 'E4', 'G4', 'E4']).start(0);
            this.music.loop = true;
            this.music.humanize = true;
            
            Tone.Transport.start();
            this.isInitialized = true;
            console.log("Audio Initialized");
        },

        playMusic() {
            if (this.isInitialized && this.music.state !== 'started') {
                this.music.start(0);
            }
        },

        stopMusic() {
            if (this.isInitialized) {
                this.music.stop();
            }
        },

        playSound(name) {
            if (this.isInitialized && this.sounds[name]) {
                if (name === 'click') {
                    this.sounds.click.triggerAttackRelease('C5', '8n');
                }
                if (name === 'appear') {
                    this.sounds.appear.triggerAttackRelease('4n');
                }
            }
        }
    };

    // --- Kịch bản ---
    const script = [
        {
            speaker: "Nicotine",
            character: nicotineMonster,
            line: "Ngươi nghĩ... ngươi đã thắng sao? Hahaha... Cuộc chiến chỉ mới bắt đầu thôi!"
        },
        {
            speaker: "Minh",
            character: heroCharacter,
            line: "Cái gì?! Hắn chưa bị tiêu diệt hoàn toàn sao?"
        },
        {
            speaker: "Quái Vật Thuốc Lá",
            character: cigaretteMonster,
            line: "Chủ nhân Nicotine đã ra lệnh! Ngươi sẽ phải trả giá vì đã thách thức bọn ta!"
        },
        {
            speaker: "Quái Vật Thuốc Lá",
            character: cigaretteMonster,
            line: "Chào mừng tới cạm bẫy của ta! Để xem ngươi có thể cứu những Trái Tim Sức Khỏe mỏng manh này khỏi nanh vuốt của ta không."
        },
        {
            speaker: "Quái Vật Thuốc Lá",
            character: cigaretteMonster,
            line: "Những Trái Tim tội nghiệp này sẽ không ngừng trôi dần lên phía ta. Nhiệm vụ của ngươi là tạo ra các chuỗi kim cương cùng màu có chứa chúng để giải cứu."
        },
        {
            speaker: "Quái Vật Thuốc Lá",
            character: cigaretteMonster,
            line: "Nếu ngươi chần chừ... và để bất kỳ Trái Tim nào chạm tới miệng của ta, nó sẽ trở thành bữa ăn ngon lành, tiếp thêm sức mạnh cho ta! Hahaha!"
        }
    ];

    let currentLine = 0;
    let lastCharacter = null;

    // --- Hàm điều khiển cảnh ---
    function showLine() {
        if (currentLine >= script.length) {
            endCutscene();
            return;
        }

        const scene = script[currentLine];
        nextButton.classList.remove('hidden'); // Đảm bảo nút next hiện ra

        // Ẩn tất cả quái vật trước
        nicotineMonster.classList.remove('visible');
        cigaretteMonster.classList.remove('visible');

        // Hiện nhân vật đang nói
        if (scene.character === heroCharacter) {
            const previousScene = script[currentLine - 1];
            if(previousScene && previousScene.character !== heroCharacter) {
                previousScene.character.classList.add('visible');
            }
        } else {
             scene.character.classList.add('visible');
        }
        
        if (scene.character !== lastCharacter) {
            AudioManager.playSound('appear');
            lastCharacter = scene.character;
        }

        speakerName.textContent = scene.speaker;
        dialogueText.textContent = scene.line;
        dialogueBox.classList.add('visible');
        
        if (currentLine === script.length - 1) {
            nextButton.textContent = "Kết thúc hội thoại";
        } else {
            nextButton.textContent = "Tiếp theo →";
        }
    }

    function endCutscene() {
        // Ẩn nút next và hiển thị popup
        nextButton.classList.add('hidden');
        endPopupOverlay.classList.remove('hidden');
    }
    
    function restartCutscene() {
        endPopupOverlay.classList.add('hidden');
        currentLine = 0;
        lastCharacter = null;
        showLine();
    }

    // --- Hàm bắt đầu cảnh ---
    async function startCutscene() {
        await AudioManager.init();
        AudioManager.playMusic();

        cutsceneScreen.classList.remove('hidden');
        setTimeout(() => {
            cutsceneScreen.style.opacity = '1';
        }, 10);
        
        heroCharacter.classList.add('visible');
        currentLine = 0;
        lastCharacter = null;
        showLine();
    }

    // --- Hàm điều hướng an toàn ---
    function navigateTo(page) {
        AudioManager.stopMusic();
        const currentUrl = window.location.href;
        const newUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1) + page;
        window.location.href = newUrl;
    }
    
    // --- Logic Toàn màn hình ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function updateFullscreenIcons() {
        if (document.fullscreenElement) {
            fullscreenIconOpen.classList.add('hidden');
            fullscreenIconClose.classList.remove('hidden');
        } else {
            fullscreenIconOpen.classList.remove('hidden');
            fullscreenIconClose.classList.add('hidden');
        }
    }

    // --- Gắn sự kiện ---
    startPromptOverlay.addEventListener('click', () => {
        startPromptOverlay.style.opacity = '0';
        setTimeout(() => {
            startPromptOverlay.style.display = 'none';
        }, 500);
        startCutscene();
    }, { once: true });
    
    nextButton.addEventListener('click', () => {
        AudioManager.playSound('click');
        currentLine++;
        showLine();
    });

    restartBtn.addEventListener('click', () => {
        AudioManager.playSound('click');
        restartCutscene();
    });

    continueBtn.addEventListener('click', () => {
        AudioManager.playSound('click');
        navigateTo('kimcuong.html');
    });

    homeBtn.addEventListener('click', () => {
        AudioManager.playSound('click');
        navigateTo('index.html');
    });

    fullscreenBtn.addEventListener('click', toggleFullScreen);
    document.addEventListener('fullscreenchange', updateFullscreenIcons);

</script>
</body>
</html>
