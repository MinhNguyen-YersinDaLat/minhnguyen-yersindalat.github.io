<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Nicotine: Cốt Truyện & Trận Chiến</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
        }
        .cyber-bg {
            background: #0d0221;
            background-image:
                linear-gradient(rgba(13, 2, 33, 0.95), rgba(13, 2, 33, 0.95)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre-v2.png');
            transition: background-color 1s ease;
        }
        .dialogue-box {
            background: rgba(0, 217, 255, 0.1);
            border: 2px solid #00d9ff;
            box-shadow: 0 0 15px #00d9ff, inset 0 0 10px #00d9ff;
            backdrop-filter: blur(5px);
        }
        .cyber-border {
            border: 2px solid #00d9ff;
            box-shadow: 0 0 15px #00d9ff, inset 0 0 10px #00d9ff;
        }
        .cyber-button {
            border: 2px solid #ff00ff;
            box-shadow: 0 0 10px #ff00ff;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px #ff00ff;
        }
        .cyber-button:hover {
            background-color: #ff00ff;
            color: #0d0221;
            box-shadow: 0 0 20px #ff00ff, 0 0 30px #ff00ff;
            text-shadow: none;
        }
        .hidden { display: none; }

        /* --- Animations for Intro & Game --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .fade-in { animation: fadeIn 1s ease-out forwards; }
        .zoom-in { animation: zoomIn 0.8s ease-out forwards; }
        .shake { animation: shake 0.5s linear; }

        /* --- Character Styles --- */
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-15px) rotate(2deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(239, 68, 68, 0.8); } }
        @keyframes glow { 0%, 100% { filter: brightness(1) drop-shadow(0 0 10px currentColor); } 50% { filter: brightness(1.2) drop-shadow(0 0 20px currentColor); } }
        @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } }
        @keyframes smoke { 0% { opacity: 0.6; transform: translateY(0) scale(1) rotate(0deg); } 100% { opacity: 0; transform: translateY(-30px) scale(1.5) rotate(10deg); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        .float { animation: float 4s ease-in-out infinite; }
        .pulse-effect { animation: pulse 1s ease-in-out; }
        .bounce-effect { animation: bounce 1s ease-in-out; }
        
        /* --- Styles for Game Screen --- */
        .monster-text { color: #ff3333; text-shadow: 0 0 5px #ff3333, 0 0 10px #ff3333; }
        .player-text { color: #00d9ff; text-shadow: 0 0 5px #00d9ff, 0 0 10px #00d9ff; }
        .correct-feedback { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
        .incorrect-feedback { color: #ff3333; text-shadow: 0 0 5px #ff3333; }
        .shield-bar-inner { background: linear-gradient(90deg, #00d9ff, #00ff88); box-shadow: 0 0 10px #00ff88; transition: width 0.5s ease-in-out; }
        .vortex-overlay { transition: background-color 0.5s ease-in-out; }
        .glitch { animation: glitch 1.5s linear infinite; }
        @keyframes glitch { 2%, 64% { transform: translate(2px, 0) skew(0deg); } 4%, 60% { transform: translate(-2px, 0) skew(0deg); } 62% { transform: translate(0, 0) skew(5deg); } }

        .character-container { 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 24rem; 
            padding-bottom: 1rem;
        }
        .minh-scale { transform: scale(0.7); }
        .nicotine-scale { transform: scale(0.8); }
        @media (min-width: 768px) { 
            .minh-scale { transform: scale(0.9); }
            .nicotine-scale { transform: scale(1.1); }
        }
        
        .readable-font {
            font-family: 'Nunito', sans-serif;
            text-shadow: none;
        }

        /* --- New Monster Styles --- */
        .nicotine-monster { width: 100%; height: 100%; animation: monsterFloat 3s ease-in-out infinite; filter: drop-shadow(0 0 20px #ff0000) drop-shadow(0 0 40px #800000); }
        .monster-svg { width: 100%; height: 100%; }
        @keyframes monsterFloat {0%, 100% {transform: translateY(0px) rotate(-1deg);} 33% {transform: translateY(-10px) rotate(1deg);} 66% {transform: translateY(-5px) rotate(-0.5deg);}}
        @keyframes monsterPulse {0%, 100% {transform: scale(1);} 50% {transform: scale(1.02);}}
        @keyframes eyeGlow {0% {fill: #ff0000; filter: brightness(1);} 100% {fill: #ff4000; filter: brightness(1.5) drop-shadow(0 0 3px #ff0000);}}
        @keyframes smokeRise {0% {opacity: 0.9; transform: translateY(0px) scale(1) rotate(0deg);} 50% {opacity: 0.6; transform: translateY(-8px) scale(1.1) rotate(5deg);} 100% {opacity: 0.2; transform: translateY(-15px) scale(1.3) rotate(10deg);}}
        @keyframes cigaretteBurn {0%, 100% {fill: #ff4000; filter: brightness(1);} 50% {fill: #ff8000; filter: brightness(1.5) drop-shadow(0 0 2px #ff4000);}}
        @keyframes auraFlicker {0%, 100% {opacity: 0.3; transform: scale(1);} 50% {opacity: 0.6; transform: scale(1.05);}}
        @keyframes briefcaseGlow {0%, 100% {filter: brightness(1);} 50% {filter: brightness(1.2) drop-shadow(0 0 2px #ff0000);}}
        @keyframes toxicFloat {0% {opacity: 0; transform: translateY(0px) scale(0);} 25% {opacity: 0.7; transform: translateY(-10px) scale(1);} 50% {opacity: 0.5; transform: translateY(-20px) scale(0.8);} 75% {opacity: 0.3; transform: translateY(-30px) scale(0.6);} 100% {opacity: 0; transform: translateY(-40px) scale(0);}}
        
        /* Highlighted button style */
        #continue-story-btn {
            border-color: #00ff88;
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
            box-shadow: 0 0 15px #00ff88;
            animation: pulse-green 2s infinite;
        }
        #continue-story-btn:hover {
            background-color: #00ff88;
            color: #0d0221;
            box-shadow: 0 0 25px #00ff88, 0 0 40px #00ff88;
        }
        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* MODIFIED: Added style for the lose popup */
        .lose-popup-style {
            background: rgba(255, 0, 0, 0.15);
            border-color: #ff3333;
            box-shadow: 0 0 25px #ff3333, inset 0 0 15px #ff3333;
        }
    </style>
</head>
<div id="copyright">
    © <span id="year"></span> Thầy Thái Minh Nguyên - Trường Tiểu học, THCS & THPT Yersin Đà Lạt. All rights reserved.
</div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap');

#copyright {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 13px;
    padding: 6px 0;
    font-family: 'Roboto', Arial, Helvetica, sans-serif;
    z-index: 9999;
    pointer-events: none;

    color: rgba(255, 255, 255, 0.85);
    background: transparent;

    opacity: 0;
    animation: fadeIn 2s ease forwards;
}

@keyframes fadeIn {
    to { opacity: 1; }
}
</style>

<script>
document.getElementById("year").textContent = new Date().getFullYear();
</script>

<body class="cyber-bg text-white min-h-screen flex flex-col items-center justify-center p-4">
    
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <radialGradient id="auraGradient" cx="50%" cy="50%" r="80%"><stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.1" /><stop offset="50%" style="stop-color:#800000;stop-opacity:0.3" /><stop offset="100%" style="stop-color:#000000;stop-opacity:0.5" /></radialGradient>
            <linearGradient id="suitGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#1a1a1a;stop-opacity:1" /><stop offset="50%" style="stop-color:#000000;stop-opacity:1" /><stop offset="100%" style="stop-color:#330000;stop-opacity:1" /></linearGradient>
            <linearGradient id="redGlowGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.8" /><stop offset="50%" style="stop-color:#cc0000;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#800000;stop-opacity:0.4" /></linearGradient>
            <linearGradient id="smokeGradient" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" style="stop-color:#666666;stop-opacity:0.9" /><stop offset="50%" style="stop-color:#999999;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#cccccc;stop-opacity:0.3" /></linearGradient>
        </defs>
    </svg>

    <button id="main-menu-button" class="fixed top-4 left-4 z-50 cyber-button text-sm px-4 py-2 rounded-lg readable-font">Về Giao Diện Chính</button>
    <button id="fullscreen-button" class="fixed top-4 left-52 z-50 cyber-button text-sm px-4 py-2 rounded-lg readable-font">⛶</button>


    <!-- SCENE 1: INTRODUCTION -->
    <div id="cutscene-container" class="w-full max-w-5xl mx-auto text-center">
        <div class="relative h-auto mb-4 flex justify-between items-end px-10">
            <!-- Minh -->
            <div id="minh-char-intro" class="opacity-0 transition-opacity duration-1000 character-container minh-scale">
                <div class="float">
                    <div class="relative">
                        <div class="absolute -inset-8 bg-gradient-to-r from-yellow-400/40 via-yellow-300/50 to-yellow-400/40 rounded-full" style="animation: glow 3s ease-in-out infinite; color: #facc15;"></div>
                        <div class="absolute -inset-6 bg-gradient-to-r from-yellow-200/30 via-yellow-100/40 to-yellow-200/30 rounded-full" style="animation: sparkle 2s ease-in-out infinite;"></div>
                        <div class="absolute -inset-4 bg-gradient-to-r from-yellow-300/20 via-yellow-200/30 to-yellow-300/20 rounded-full" style="animation: glow 3s ease-in-out infinite; color: #fde047;"></div>
                        <div class="absolute -right-8 top-2 w-16 h-24 bg-gradient-to-b from-red-500 via-red-600 to-red-800 rounded-b-3xl transform rotate-20 shadow-2xl border-2 border-red-400 float" style="animation: glow 3s ease-in-out infinite; color: #ef4444;">
                            <div class="absolute -right-2 top-4 w-4 h-16 bg-red-600 rounded-r-2xl transform rotate-12 opacity-80"></div>
                            <div class="absolute -right-1 top-8 w-2 h-12 bg-red-700 rounded-r-xl transform rotate-6 opacity-60"></div>
                        </div>
                        <div class="w-20 h-28 bg-gradient-to-b from-blue-400 via-blue-600 to-blue-800 rounded-2xl relative shadow-2xl border-2 border-blue-300">
                            <div class="absolute -top-8 left-2 w-16 h-16 bg-gradient-to-b from-orange-100 to-orange-200 rounded-full border-4 border-yellow-500 shadow-2xl">
                                <div class="absolute top-3 left-1 w-14 h-6 bg-black rounded-full border-2 border-gray-700">
                                    <div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 left-1"></div>
                                    <div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 right-1"></div>
                                    <div class="w-2 h-1 bg-gray-600 absolute top-2 left-1/2 transform -translate-x-1/2"></div>
                                </div>
                                <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-8 h-3 border-b-2 border-black rounded-full"></div>
                                <div class="absolute -top-3 left-1 w-14 h-6 bg-gradient-to-r from-amber-700 to-amber-900 rounded-t-full shadow-lg"></div>
                            </div>
                            <div class="absolute top-6 left-1/2 transform -translate-x-1/2 w-10 h-10 bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 rounded-full border-2 border-yellow-600 shadow-xl" style="animation: glow 2s ease-in-out infinite; color: #facc15;">
                                <div class="absolute top-1 left-1 w-8 h-8 bg-gradient-to-r from-yellow-200 to-yellow-300 rounded-full flex items-center justify-center">
                                    <span class="text-xl font-black text-blue-900" style="text-shadow: none;">M</span>
                                </div>
                            </div>
                            <div class="absolute -left-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div>
                            <div class="absolute -right-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div>
                            <div class="absolute bottom-0 left-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div>
                            <div class="absolute bottom-0 right-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div>
                            <div class="absolute -bottom-2 left-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div>
                            <div class="absolute -bottom-2 right-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div>
                            <div class="absolute top-12 left-3 w-1 h-8 bg-yellow-300 opacity-60" style="animation: glow 2s ease-in-out infinite; color: #fde047;"></div>
                            <div class="absolute top-12 right-3 w-1 h-8 bg-yellow-300 opacity-60" style="animation: glow 2s ease-in-out infinite; color: #fde047;"></div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-12">
                    <p class="text-lg font-bold player-text">Anh Hùng Minh</p>
                </div>
            </div>
            <!-- Nicotine -->
            <div id="nicotine-char-intro" class="opacity-0 transition-opacity duration-1000 character-container nicotine-scale">
                <div class="nicotine-monster" style="width: 200px; height: 200px;"><svg class="monster-svg" viewBox="0 0 80 80"><ellipse fill="url(#auraGradient)" cx="40" cy="40" rx="38" ry="35" style="animation: auraFlicker 2s ease-in-out infinite;"></ellipse><g transform="translate(15, 45)" style="animation: briefcaseGlow 2s ease-in-out infinite;"><rect fill="#1a1a1a" stroke="#ff0000" stroke-width="0.5" x="0" y="0" width="8" height="6" rx="1"></rect><rect fill="#ff0000" x="1" y="1" width="6" height="1" opacity="0.6"></rect><circle fill="#ff0000" cx="7" cy="3" r="0.5"></circle></g><ellipse fill="url(#suitGradient)" stroke="url(#redGlowGradient)" stroke-width="1" cx="40" cy="45" rx="12" ry="18" style="animation: monsterPulse 2s ease-in-out infinite;"></ellipse><path fill="#000000" stroke="#ff0000" stroke-width="0.3" d="M32,35 L35,40 L40,38 L45,40 L48,35 L45,32 L35,32 Z"></path><path fill="#cc0000" stroke="#ff0000" stroke-width="0.5" d="M38,38 L42,38 L41,50 L39,50 Z"></path><circle fill="#ff0000" cx="40" cy="42" r="0.8"></circle><circle fill="#ff0000" cx="40" cy="46" r="0.8"></circle><circle fill="#ff0000" cx="40" cy="50" r="0.8"></circle><polygon fill="#ff0000" points="28,35 30,30 32,35"></polygon><polygon fill="#ff0000" points="48,35 50,30 52,35"></polygon><polygon fill="#ff0000" points="26,38 28,33 30,38"></polygon><polygon fill="#ff0000" points="50,38 52,33 54,38"></polygon><ellipse fill="#d0d0d0" stroke="#999999" stroke-width="0.5" cx="40" cy="25" rx="10" ry="12" style="animation: monsterPulse 2.5s ease-in-out infinite;"></ellipse><path fill="#1a1a1a" stroke="#000000" stroke-width="0.3" d="M30,18 Q40,15 50,18 Q48,22 45,20 Q40,19 35,20 Q32,22 30,18"></path><polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="33,18 35,10 37,18"></polygon><polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="43,18 45,10 47,18"></polygon><ellipse fill="#ff0000" cx="36" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"></ellipse><ellipse fill="#ff0000" cx="44" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"></ellipse><ellipse fill="#000000" cx="36" cy="23" rx="0.8" ry="1"></ellipse><ellipse fill="#000000" cx="44" cy="23" rx="0.8" ry="1"></ellipse><circle fill="#ffff00" cx="35" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite;"></circle><circle fill="#ffff00" cx="45" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite; animation-delay: 0.5s;"></circle><path fill="#000000" d="M34,28 Q40,32 46,28 Q40,30 34,28" opacity="0.9"></path><polygon fill="#ffffff" points="36,28 37,30 38,28"></polygon><polygon fill="#ffffff" points="39,28 40,31 41,28"></polygon><polygon fill="#ffffff" points="42,28 43,30 44,28"></polygon><rect fill="#f5f5dc" x="46" y="26" width="6" height="1" rx="0.5"></rect><rect fill="#d2691e" x="46" y="26.2" width="5" height="0.6" rx="0.3"></rect><circle fill="#ff4000" cx="52" cy="26.5" r="0.8" style="animation: cigaretteBurn 1s ease-in-out infinite;"></circle><circle fill="#ff8000" cx="52" cy="26.5" r="0.4" style="animation: cigaretteBurn 1s ease-in-out infinite; animation-delay: 0.3s;"></circle><path fill="none" stroke="url(#smokeGradient)" stroke-width="1.5" stroke-linecap="round" d="M52,26 Q55,22 53,18 Q56,15 54,12" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0s;"></path><path fill="none" stroke="url(#smokeGradient)" stroke-width="1.2" stroke-linecap="round" d="M52,26 Q57,23 55,19 Q58,16 56,13" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0.5s;"></path><path fill="none" stroke="url(#smokeGradient)" stroke-width="1" stroke-linecap="round" d="M52,26 Q54,24 52,20 Q55,17 53,14" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 1s;"></path><ellipse fill="#333333" cx="38" cy="25" rx="0.5" ry="0.3"></ellipse><ellipse fill="#333333" cx="42" cy="25" rx="0.5" ry="0.3"></ellipse><path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M38,25 Q36,22 38,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.3s;"></path><path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M42,25 Q44,22 42,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.8s;"></path><circle fill="#00ff00" cx="25" cy="15" r="0.8" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0s;"></circle><circle fill="#00ff00" cx="55" cy="20" r="0.6" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 1s;"></circle><circle fill="#00ff00" cx="20" cy="35" r="0.7" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 2s;"></circle><circle fill="#00ff00" cx="60" cy="30" r="0.5" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0.5s;"></circle><path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M20,20 Q25,15 30,20" style="animation: auraFlicker 1.8s ease-in-out infinite;"></path><path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M50,20 Q55,15 60,20" style="animation: auraFlicker 1.8s ease-in-out infinite; animation-delay: 0.6s;"></path><path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M15,40 Q20,35 25,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.3s;"></path><path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M55,40 Q60,35 65,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.9s;"></path></svg></div>
                 <div class="text-center mt-12">
                    <p class="text-lg font-bold monster-text">Quái vật Nicotine</p>
                    <p class="text-sm monster-text opacity-70">(Nicotine)</p>
                </div>
            </div>
        </div>
        <div id="dialogue-box" class="dialogue-box rounded-lg p-6 min-h-[150px] flex flex-col justify-center items-center readable-font">
            <p id="story-text" class="text-xl lg:text-2xl text-cyan-200 leading-relaxed"></p>
        </div>
        <button id="continue-button" class="cyber-button text-xl font-bold py-3 px-8 rounded-lg mt-8 opacity-0 readable-font">Tiếp tục...</button>
    </div>

    <!-- SCENE 2: QUIZ GAME -->
    <div id="game-container" class="w-full max-w-6xl mx-auto relative hidden">
        <div id="vortex-overlay" class="vortex-overlay absolute top-0 left-0 w-full h-full bg-black bg-opacity-0 pointer-events-none z-0"></div>
        <div id="quiz-screen">
            <div class="flex justify-between items-center mb-4 p-4 cyber-border rounded-lg">
                <div>
                    <h2 class="text-xl font-bold">Điểm: <span id="score">0</span></h2>
                    <p class="text-sm">Câu hỏi: <span id="question-counter">1 / 15</span></p>
                </div>
                <div class="w-1/2">
                    <p class="text-center mb-1 player-text">Lá Chắn Tri Thức</p>
                    <div class="w-full bg-gray-700 rounded-full h-6 cyber-border p-1">
                        <div id="shield-bar" class="shield-bar-inner h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col md:flex-row justify-around items-end gap-4">
                <!-- Player Character -->
                <div id="player-character" class="character-container minh-scale">
                    <div class="float">
                        <div class="relative">
                            <div class="absolute -inset-8 bg-gradient-to-r from-yellow-400/40 via-yellow-300/50 to-yellow-400/40 rounded-full" style="animation: glow 3s ease-in-out infinite; color: #facc15;"></div>
                            <div class="absolute -inset-6 bg-gradient-to-r from-yellow-200/30 via-yellow-100/40 to-yellow-200/30 rounded-full" style="animation: sparkle 2s ease-in-out infinite;"></div>
                            <div class="absolute -inset-4 bg-gradient-to-r from-yellow-300/20 via-yellow-200/30 to-yellow-300/20 rounded-full" style="animation: glow 3s ease-in-out infinite; color: #fde047;"></div>
                            <div class="absolute -right-8 top-2 w-16 h-24 bg-gradient-to-b from-red-500 via-red-600 to-red-800 rounded-b-3xl transform rotate-20 shadow-2xl border-2 border-red-400 float" style="animation: glow 3s ease-in-out infinite; color: #ef4444;">
                                <div class="absolute -right-2 top-4 w-4 h-16 bg-red-600 rounded-r-2xl transform rotate-12 opacity-80"></div>
                                <div class="absolute -right-1 top-8 w-2 h-12 bg-red-700 rounded-r-xl transform rotate-6 opacity-60"></div>
                            </div>
                            <div class="w-20 h-28 bg-gradient-to-b from-blue-400 via-blue-600 to-blue-800 rounded-2xl relative shadow-2xl border-2 border-blue-300">
                                <div class="absolute -top-8 left-2 w-16 h-16 bg-gradient-to-b from-orange-100 to-orange-200 rounded-full border-4 border-yellow-500 shadow-2xl">
                                    <div class="absolute top-3 left-1 w-14 h-6 bg-black rounded-full border-2 border-gray-700">
                                        <div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 left-1"></div>
                                        <div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 right-1"></div>
                                        <div class="w-2 h-1 bg-gray-600 absolute top-2 left-1/2 transform -translate-x-1/2"></div>
                                    </div>
                                    <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-8 h-3 border-b-2 border-black rounded-full"></div>
                                    <div class="absolute -top-3 left-1 w-14 h-6 bg-gradient-to-r from-amber-700 to-amber-900 rounded-t-full shadow-lg"></div>
                                </div>
                                <div class="absolute top-6 left-1/2 transform -translate-x-1/2 w-10 h-10 bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 rounded-full border-2 border-yellow-600 shadow-xl" style="animation: glow 2s ease-in-out infinite; color: #facc15;">
                                    <div class="absolute top-1 left-1 w-8 h-8 bg-gradient-to-r from-yellow-200 to-yellow-300 rounded-full flex items-center justify-center">
                                        <span class="text-xl font-black text-blue-900" style="text-shadow: none;">M</span>
                                    </div>
                                </div>
                                <div class="absolute -left-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div>
                                <div class="absolute -right-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div>
                                <div class="absolute bottom-0 left-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div>
                                <div class="absolute bottom-0 right-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div>
                                <div class="absolute -bottom-2 left-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div>
                                <div class="absolute -bottom-2 right-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div>
                                <div class="absolute top-12 left-3 w-1 h-8 bg-yellow-300 opacity-60" style="animation: glow 2s ease-in-out infinite; color: #fde047;"></div>
                                <div class="absolute top-12 right-3 w-1 h-8 bg-yellow-300 opacity-60" style="animation: glow 2s ease-in-out infinite; color: #fde047;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-12">
                        <p class="text-lg font-bold player-text">Anh Hùng Minh</p>
                    </div>
                </div>
                <!-- Main Content -->
                <div class="w-full md:w-1/2 p-6 cyber-border rounded-lg readable-font">
                    <div id="monster-dialogue" class="mb-6 text-center">
                        <p class="text-2xl font-bold monster-text" style="font-family: 'Orbitron', sans-serif; text-shadow: 0 0 5px #ff3333;">Quái vật Nicotine</p>
                        <p id="question-text" class="text-xl font-bold text-white"></p>
                    </div>
                    <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div id="feedback-section" class="mt-6 text-center h-20">
                        <p id="feedback-text" class="text-xl font-bold"></p>
                        <p id="explanation-text" class="text-md mt-2"></p>
                    </div>
                </div>
                <!-- Monster Character -->
                <div id="monster-character" class="character-container nicotine-scale">
                    <div class="nicotine-monster" style="width: 200px; height: 200px;"><svg class="monster-svg" viewBox="0 0 80 80"><ellipse fill="url(#auraGradient)" cx="40" cy="40" rx="38" ry="35" style="animation: auraFlicker 2s ease-in-out infinite;"></ellipse><g transform="translate(15, 45)" style="animation: briefcaseGlow 2s ease-in-out infinite;"><rect fill="#1a1a1a" stroke="#ff0000" stroke-width="0.5" x="0" y="0" width="8" height="6" rx="1"></rect><rect fill="#ff0000" x="1" y="1" width="6" height="1" opacity="0.6"></rect><circle fill="#ff0000" cx="7" cy="3" r="0.5"></circle></g><ellipse fill="url(#suitGradient)" stroke="url(#redGlowGradient)" stroke-width="1" cx="40" cy="45" rx="12" ry="18" style="animation: monsterPulse 2s ease-in-out infinite;"></ellipse><path fill="#000000" stroke="#ff0000" stroke-width="0.3" d="M32,35 L35,40 L40,38 L45,40 L48,35 L45,32 L35,32 Z"></path><path fill="#cc0000" stroke="#ff0000" stroke-width="0.5" d="M38,38 L42,38 L41,50 L39,50 Z"></path><circle fill="#ff0000" cx="40" cy="42" r="0.8"></circle><circle fill="#ff0000" cx="40" cy="46" r="0.8"></circle><circle fill="#ff0000" cx="40" cy="50" r="0.8"></circle><polygon fill="#ff0000" points="28,35 30,30 32,35"></polygon><polygon fill="#ff0000" points="48,35 50,30 52,35"></polygon><polygon fill="#ff0000" points="26,38 28,33 30,38"></polygon><polygon fill="#ff0000" points="50,38 52,33 54,38"></polygon><ellipse fill="#d0d0d0" stroke="#999999" stroke-width="0.5" cx="40" cy="25" rx="10" ry="12" style="animation: monsterPulse 2.5s ease-in-out infinite;"></ellipse><path fill="#1a1a1a" stroke="#000000" stroke-width="0.3" d="M30,18 Q40,15 50,18 Q48,22 45,20 Q40,19 35,20 Q32,22 30,18"></path><polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="33,18 35,10 37,18"></polygon><polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="43,18 45,10 47,18"></polygon><ellipse fill="#ff0000" cx="36" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"></ellipse><ellipse fill="#ff0000" cx="44" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"></ellipse><ellipse fill="#000000" cx="36" cy="23" rx="0.8" ry="1"></ellipse><ellipse fill="#000000" cx="44" cy="23" rx="0.8" ry="1"></ellipse><circle fill="#ffff00" cx="35" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite;"></circle><circle fill="#ffff00" cx="45" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite; animation-delay: 0.5s;"></circle><path fill="#000000" d="M34,28 Q40,32 46,28 Q40,30 34,28" opacity="0.9"></path><polygon fill="#ffffff" points="36,28 37,30 38,28"></polygon><polygon fill="#ffffff" points="39,28 40,31 41,28"></polygon><polygon fill="#ffffff" points="42,28 43,30 44,28"></polygon><rect fill="#f5f5dc" x="46" y="26" width="6" height="1" rx="0.5"></rect><rect fill="#d2691e" x="46" y="26.2" width="5" height="0.6" rx="0.3"></rect><circle fill="#ff4000" cx="52" cy="26.5" r="0.8" style="animation: cigaretteBurn 1s ease-in-out infinite;"></circle><circle fill="#ff8000" cx="52" cy="26.5" r="0.4" style="animation: cigaretteBurn 1s ease-in-out infinite; animation-delay: 0.3s;"></circle><path fill="none" stroke="url(#smokeGradient)" stroke-width="1.5" stroke-linecap="round" d="M52,26 Q55,22 53,18 Q56,15 54,12" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0s;"></path><path fill="none" stroke="url(#smokeGradient)" stroke-width="1.2" stroke-linecap="round" d="M52,26 Q57,23 55,19 Q58,16 56,13" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0.5s;"></path><path fill="none" stroke="url(#smokeGradient)" stroke-width="1" stroke-linecap="round" d="M52,26 Q54,24 52,20 Q55,17 53,14" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 1s;"></path><ellipse fill="#333333" cx="38" cy="25" rx="0.5" ry="0.3"></ellipse><ellipse fill="#333333" cx="42" cy="25" rx="0.5" ry="0.3"></ellipse><path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M38,25 Q36,22 38,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.3s;"></path><path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M42,25 Q44,22 42,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.8s;"></path><circle fill="#00ff00" cx="25" cy="15" r="0.8" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0s;"></circle><circle fill="#00ff00" cx="55" cy="20" r="0.6" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 1s;"></circle><circle fill="#00ff00" cx="20" cy="35" r="0.7" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 2s;"></circle><circle fill="#00ff00" cx="60" cy="30" r="0.5" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0.5s;"></circle><path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M20,20 Q25,15 30,20" style="animation: auraFlicker 1.8s ease-in-out infinite;"></path><path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M50,20 Q55,15 60,20" style="animation: auraFlicker 1.8s ease-in-out infinite; animation-delay: 0.6s;"></path><path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M15,40 Q20,35 25,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.3s;"></path><path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M55,40 Q60,35 65,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.9s;"></path></svg></div>
                    <div class="text-center mt-12">
                        <p class="text-lg font-bold monster-text">Quái vật Nicotine</p>
                        <p class="text-sm monster-text opacity-70">(Nicotine)</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="end-screen" class="hidden text-center p-8 cyber-border rounded-lg flex flex-col items-center justify-center">
            <h2 id="end-title" class="text-4xl font-bold mb-4"></h2>
            <p id="end-message" class="text-xl mb-2"></p>
            <p id="final-score-display" class="text-2xl mb-6">Điểm cuối cùng: <span id="final-score"></span></p>
            
            <!-- MODIFIED: Restructured the lose content to include new buttons -->
            <div id="lose-content" class="flex flex-col md:flex-row items-center gap-4 mt-4">
                <button id="restart-button" class="cyber-button text-xl font-bold py-3 px-6 rounded-lg">CHƠI LẠI</button>
                <a href="thuvientrithuc.html" class="cyber-button text-xl font-bold py-3 px-6 rounded-lg" style="border-color: #00ff88; color: #00ff88; text-shadow: 0 0 10px #00ff88; box-shadow: 0 0 15px #00ff88;">Thư viện tri thức</a>
                <a href="index.html" class="cyber-button text-xl font-bold py-3 px-6 rounded-lg opacity-80">Về màn hình chính</a>
            </div>
        
            <div id="win-content" class="hidden flex flex-col items-center gap-4 mt-4">
                <a href="canhcuoi.html" id="continue-story-btn" class="cyber-button text-2xl font-bold py-4 px-10 rounded-lg inline-block">Tiếp tục cốt truyện</a>
                <a href="index.html" class="cyber-button text-lg py-2 px-6 rounded-lg opacity-80 inline-block">Về màn hình chính</a>
            </div>
        </div>
    </div>

    <script>
        // --- SHARED DOM ELEMENTS & DATA ---
        const cutsceneContainer = document.getElementById('cutscene-container');
        const gameContainer = document.getElementById('game-container');
        const quizData = [
            { question: "Theo WHO, hóa chất nào trong thuốc lá điện tử khi được đun nóng có thể tạo thành Formaldehyde, một chất gây ung thư?", options: ["Propylene Glycol", "Nicotine", "Hương liệu", "Nước"], answer: 0, explanation: "Propylene Glycol và Glycerin khi bị đun nóng ở nhiệt độ cao có thể phân hủy và tạo ra các chất gây ung thư như Formaldehyde. (Nguồn: WHO, CDC)" },
            { question: "Khói thuốc lá chứa hơn 7.000 chất hóa học, trong đó có ít nhất bao nhiêu chất gây ung thư?", options: ["10", "30", "70", "150"], answer: 2, explanation: "Theo CDC Hoa Kỳ, khói thuốc lá chứa hơn 7.000 chất hóa học, trong đó có ít nhất 70 chất được biết là gây ung thư." },
            { question: "Hút thuốc lá thụ động (hít phải khói thuốc từ người khác) có thể gây ra bệnh gì?", options: ["Không gây bệnh gì", "Chỉ gây khó chịu", "Bệnh tim, ung thư phổi và đột quỵ", "Cảm cúm thông thường"], answer: 2, explanation: "Hút thuốc thụ động là nguyên nhân gây ra nhiều bệnh nghiêm trọng tương tự như hút thuốc trực tiếp. (Nguồn: WHO)" },
            { question: "Chất nào trong thuốc lá gây nghiện tương đương với Heroin hoặc Cocaine?", options: ["Tar (Hắc ín)", "Carbon Monoxide", "Nicotine", "Ammonia"], answer: 2, explanation: "Nicotine là chất gây nghiện chính trong thuốc lá. Mức độ gây nghiện của nó được các cơ quan y tế so sánh với các chất ma túy mạnh. (Nguồn: U.S. Surgeon General)" },
            { question: "Hút thuốc ở thanh thiếu niên ảnh hưởng đến não bộ đang phát triển như thế nào?", options: ["Giúp tăng cường trí nhớ", "Không ảnh hưởng", "Gây hại cho vùng não kiểm soát sự chú ý, học tập, cảm xúc", "Kích thích sự sáng tạo"], answer: 2, explanation: "Nicotine gây hại vĩnh viễn cho não bộ vị thành niên, vốn vẫn đang phát triển cho đến khoảng 25 tuổi. (Nguồn: CDC)" },
            { question: "'Hơi' (aerosol) của thuốc lá điện tử chứa những gì?", options: ["Chỉ là hơi nước tinh khiết", "Hơi nước và hương liệu an toàn", "Nicotine, các hạt siêu mịn, hương liệu và hóa chất độc hại", "Chỉ có Nicotine và nước"], answer: 2, explanation: "Hơi thuốc lá điện tử không phải là hơi nước vô hại. Nó chứa các chất độc hại và có khả năng gây ung thư. (Nguồn: American Lung Association)" },
            { question: "Một người hút bao nhiêu điếu thuốc mỗi ngày thì được xem là an toàn?", options: ["1 điếu", "5 điếu", "10 điếu", "Không có mức nào an toàn"], answer: 3, explanation: "Bất kỳ mức độ hút thuốc nào cũng đều có hại cho sức khỏe. Không có ngưỡng an toàn. (Nguồn: WHO)" },
            { question: "Phụ nữ mang thai hít phải khói thuốc thụ động có thể gây ra nguy cơ nào cho thai nhi?", options: ["Trẻ thông minh hơn", "Sinh con nhẹ cân, sinh non, hội chứng đột tử ở trẻ sơ sinh (SIDS)", "Trẻ có hệ miễn dịch tốt hơn", "Không có nguy cơ nào"], answer: 1, explanation: "Hút thuốc khi mang thai là nguyên nhân hàng đầu gây ra các vấn đề sức khỏe nghiêm trọng cho thai nhi. (Nguồn: WHO)" },
            { question: "Sau khi bỏ thuốc lá bao lâu thì nguy cơ mắc bệnh tim mạch giảm đi một nửa?", options: ["10 năm", "5 năm", "1 năm", "1 tháng"], answer: 2, explanation: "Chỉ sau 1 năm bỏ thuốc, nguy cơ mắc bệnh mạch vành của bạn đã giảm đi một nửa so với người hút thuốc. (Nguồn: WHO)" },
            { question: "Thuốc lá điện tử loại 'pod' dùng một lần thường chứa lượng nicotine tương đương bao nhiêu điếu thuốc lá truyền thống?", options: ["1-2 điếu", "5-10 điếu", "20-40 điếu (1-2 bao)", "Không chứa nicotine"], answer: 2, explanation: "Nhiều loại pod dùng một lần chứa lượng nicotine bằng 1-2 bao thuốc lá, làm tăng nguy cơ nghiện nhanh chóng ở người trẻ. (Nguồn: Truth Initiative)" },
            { question: "Tổ chức Y tế Thế giới (WHO) đã gọi thuốc lá là gì?", options: ["Sát thủ thầm lặng", "Người bạn xấu", "Thói quen vô hại", "Thuốc giải stress"], answer: 0, explanation: "WHO gọi thuốc lá là “sát thủ thầm lặng” do số người chết vì nó hằng năm lên tới hàng triệu người." },
            { question: "Bỏ thuốc lá mang lại lợi ích gì?", options: ["Cải thiện sức khỏe", "Tiết kiệm tiền bạc", "Giảm nguy cơ mắc bệnh cho người xung quanh", "Tất cả đều đúng"], answer: 3, explanation: "Bỏ thuốc lá mang lại nhiều lợi ích cả về sức khỏe, kinh tế và xã hội." },
            { question: "Biện pháp nào được WHO công nhận là hiệu quả nhất để giảm tiêu thụ thuốc lá trong cộng đồng?", options: ["Phát thuốc lá miễn phí", "Giảm giá thuốc lá", "Tăng thuế thuốc lá", "Quảng cáo thuốc lá"], answer: 2, explanation: "Tăng thuế ở mức cao đối với các sản phẩm thuốc lá là biện pháp hiệu quả nhất để giảm tỷ lệ người hút thuốc. (Nguồn: WHO)" },
            { question: "Tại sao trẻ em và thanh thiếu niên đặc biệt dễ bị tổn thương bởi khói thuốc lá?", options: ["Vì họ chạy nhảy nhiều", "Vì hệ hô hấp của họ chưa phát triển hoàn thiện", "Vì họ ăn nhiều hơn", "Vì họ không sợ khói thuốc"], answer: 1, explanation: "Hệ hô hấp của trẻ em và thanh thiếu niên vẫn đang trong giai đoạn phát triển, khiến họ nhạy cảm hơn với các chất độc trong khói thuốc." },
            { question: "Hút thuốc lá ảnh hưởng đến kinh tế của một người như thế nào?", options: ["Giúp tiết kiệm tiền", "Không ảnh hưởng", "Tốn tiền mua thuốc và chi phí khám chữa bệnh sau này", "Giúp tăng thu nhập"], answer: 2, explanation: "Chi phí mua thuốc lá và điều trị các bệnh do thuốc lá gây ra là một gánh nặng kinh tế lớn." }
        ];

        // --- SCRIPT FOR INTRO SCENE ---
        const storyTextEl = document.getElementById('story-text');
        const continueButton = document.getElementById('continue-button');
        const minhCharIntro = document.getElementById('minh-char-intro');
        const nicotineCharIntro = document.getElementById('nicotine-char-intro');
        const storyParts = [
            "Vượt qua được thử thách kim cương, Minh khiến Nicotine tức giận. Hắn tung ra đòn tấn công hiểm độc nhất...",
            "...tạo ra một VÒNG XOÁY ĐỘC HẠI hút lấy những Trái Tim Ý Chí.",
            "Để chống lại, Minh phải tập trung cao độ, dùng ý chí của mình dựng lên một LÁ CHẮN TRI THỨC...",
            "...nạp năng lượng cho nó bằng cách trả lời nhanh những câu hỏi về tác hại của thuốc lá.",
            "Với mỗi lời dối trá của Nicotine, Minh sẽ dùng sự thật khoa học làm vũ khí, đập tan mọi ảo ảnh của hắn!",
            "Trận chiến trí tuệ sắp bắt đầu!"
        ];
        let currentPartIndex = 0;
        let audioInitialized = false;


        // --- Sound Effects ---
        const masterVolume = -10; // in Decibels
        let correctSynth, incorrectSynth, explosionSynth, backgroundMusic, dialogueSynth, bgSynth, kickLoop;

        function initializeAudio() {
            if (audioInitialized) return;
            
            correctSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
            correctSynth.volume.value = masterVolume;
            
            incorrectSynth = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 1 } }).toDestination();
            incorrectSynth.volume.value = masterVolume;
            
            explosionSynth = new Tone.MetalSynth({ frequency: 40, envelope: { attack: 0.001, decay: 1.4, release: 0.2 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination();
            explosionSynth.volume.value = masterVolume - 5;
            
            dialogueSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.1, release: 0.1 } }).toDestination();
            dialogueSynth.volume.value = masterVolume;

            const reverb = new Tone.Reverb({ decay: 2, preDelay: 0.01 }).toDestination();
            reverb.wet.value = 0.2;

            const melodySynth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 }
            }).connect(reverb);
            melodySynth.volume.value = masterVolume - 10;

            const kick = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 10,
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' }
            }).toDestination();
            kick.volume.value = masterVolume - 8;

            const melodyPattern = [
                'C4', 'E4', 'G4', 'E4',
                'F4', 'A4', 'C5', 'A4',
                'G4', 'B4', 'D5', 'B4',
                'C5', null, 'C5', null
            ];

            const melodySequence = new Tone.Sequence((time, note) => {
                if (note) {
                    melodySynth.triggerAttackRelease(note, '8n', time);
                }
            }, melodyPattern, '8n');
            
            kickLoop = new Tone.Loop(time => {
                kick.triggerAttackRelease('C2', '8n', time);
            }, '4n');
            
            backgroundMusic = melodySequence;
            
            audioInitialized = true;
        }

        async function startAudio() {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log("Audio context started.");
            }
            if (!audioInitialized) {
                initializeAudio();
            }
        }
        
        function playCorrectSound() { if(audioInitialized) correctSynth.triggerAttackRelease("C5", "8n"); }
        function playIncorrectSound() { if(audioInitialized) incorrectSynth.triggerAttackRelease("F#2", "8n"); }
        function playDialogueSound() { if(audioInitialized) dialogueSynth.triggerAttackRelease("C4", "16n", Tone.now()); }
        
        function playVictoryMusic() {
            if (!audioInitialized) return;
            const victorySynth = new Tone.PolySynth(Tone.Synth).toDestination();
            victorySynth.volume.value = masterVolume;
            const now = Tone.now();
            victorySynth.triggerAttackRelease(["C4", "E4", "G4"], "2n", now);
            victorySynth.triggerAttackRelease(["G4", "B4", "D5"], "2n", now + 1);
            victorySynth.triggerAttackRelease(["C5", "E5", "G5"], "1n", now + 2);
            setTimeout(() => victorySynth.dispose(), 4000);
        }

        function showNextPart() {
            if (currentPartIndex < storyParts.length) {
                playDialogueSound();
                storyTextEl.classList.remove('fade-in');
                void storyTextEl.offsetWidth;
                storyTextEl.textContent = storyParts[currentPartIndex];
                storyTextEl.classList.add('fade-in');

                if (currentPartIndex === 1) {
                    cutsceneContainer.classList.add('shake');
                    nicotineCharIntro.classList.add('nicotine-scale-large');
                } else {
                    cutsceneContainer.classList.remove('shake');
                    nicotineCharIntro.classList.remove('nicotine-scale-large');
                }
                if (currentPartIndex === 2) {
                    minhCharIntro.style.filter = 'drop-shadow(0 0 15px #00d9ff)';
                } else {
                     minhCharIntro.style.filter = 'none';
                }
                currentPartIndex++;
                if (currentPartIndex === storyParts.length) {
                    continueButton.textContent = "VÀO TRẬN CHIẾN!";
                }
            } else {
                cutsceneContainer.style.transition = 'opacity 0.5s ease';
                cutsceneContainer.style.opacity = '0';
                setTimeout(() => {
                    cutsceneContainer.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    gameContainer.classList.add('fade-in');
                    startGame();
                }, 500);
            }
        }
        window.addEventListener('load', () => {
            document.getElementById('dialogue-box').classList.add('zoom-in');
            minhCharIntro.style.opacity = '1';
            nicotineCharIntro.style.opacity = '1';
            continueButton.style.opacity = '1';
            continueButton.classList.add('fade-in');
            showNextPart();
        });
        
        continueButton.addEventListener('click', async () => {
            await startAudio();
            if (backgroundMusic && Tone.Transport.state !== 'started') {
                 Tone.Transport.start();
                 backgroundMusic.start(0);
                 kickLoop.start(0);
            }
            showNextPart();
        });

        // --- SCRIPT FOR QUIZ GAME ---
        const quizScreen = document.getElementById('quiz-screen');
        const endScreen = document.getElementById('end-screen');
        const restartButton = document.getElementById('restart-button');
        const scoreEl = document.getElementById('score');
        const questionCounterEl = document.getElementById('question-counter');
        const shieldBarEl = document.getElementById('shield-bar');
        const questionTextEl = document.getElementById('question-text');
        const answerButtonsEl = document.getElementById('answer-buttons');
        const feedbackTextEl = document.getElementById('feedback-text');
        const explanationTextEl = document.getElementById('explanation-text');
        const playerCharacterEl = document.getElementById('player-character');
        const monsterCharacterEl = document.getElementById('monster-character');
        const endTitleEl = document.getElementById('end-title');
        const endMessageEl = document.getElementById('end-message');
        const finalScoreEl = document.getElementById('final-score');
        let currentQuestionIndex, score, correctAnswersCount, incorrectAnswersCount, shuffledQuestions;

        const minhVictoryQuotes = [
            "Ngươi là kẻ gieo rắc bệnh tật! Sự thật sẽ đánh bại ngươi!",
            "Lời dối trá của ngươi không thể che lấp làn khói độc!",
            "Vì một tương lai không khói thuốc, ta sẽ ngăn chặn ngươi!",
            "Sức mạnh của tri thức sẽ dập tắt ngọn lửa độc hại của ngươi!",
            "Ta chiến đấu cho từng lá phổi khỏe mạnh!",
            "Ảo ảnh ngọt ngào của ngươi không lừa được ta, Nicotine!"
        ];

        function startGame() {
            quizScreen.classList.remove('hidden');
            endScreen.classList.add('hidden');
            endScreen.classList.remove('lose-popup-style'); // MODIFIED: Reset style on start
            
            document.getElementById('win-content').classList.add('hidden');
            document.getElementById('lose-content').classList.remove('hidden');
            document.getElementById('end-message').classList.remove('hidden');
            document.getElementById('final-score-display').classList.remove('hidden');

            currentQuestionIndex = 0;
            score = 0;
            correctAnswersCount = 0;
            incorrectAnswersCount = 0;
            shuffledQuestions = quizData.sort(() => Math.random() - 0.5);
            updateUI();
            loadQuestion();
        }

        function loadQuestion() {
            feedbackTextEl.textContent = '';
            explanationTextEl.textContent = '';
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            questionTextEl.textContent = currentQuestion.question;
            answerButtonsEl.innerHTML = '';
            currentQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.innerText = option;
                button.classList.add('cyber-button', 'w-full', 'p-4', 'rounded-lg', 'text-left', 'readable-font');
                button.addEventListener('click', () => selectAnswer(index));
                answerButtonsEl.appendChild(button);
            });
        }

        function selectAnswer(selectedIndex) {
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const isCorrect = selectedIndex === currentQuestion.answer;
            Array.from(answerButtonsEl.children).forEach(button => {
                button.disabled = true;
                if (button.innerText === currentQuestion.options[currentQuestion.answer]) button.classList.add('bg-green-500', 'border-green-500');
                else if (button.innerText === currentQuestion.options[selectedIndex]) button.classList.add('bg-red-500', 'border-red-500');
            });
            
            if (isCorrect) {
                handleCorrectAnswer(currentQuestion.explanation);
            } else {
                handleIncorrectAnswer(currentQuestion.explanation);
            }

            if (correctAnswersCount >= 10 || incorrectAnswersCount > 5) {
                setTimeout(endGame, 2000);
            } else {
                setTimeout(() => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < quizData.length) {
                        updateUI();
                        loadQuestion();
                    } else {
                        endGame();
                    }
                }, 4000);
            }
        }

        function handleCorrectAnswer(explanation) {
            playCorrectSound();
            score += 100;
            correctAnswersCount++;
            const randomQuote = minhVictoryQuotes[Math.floor(Math.random() * minhVictoryQuotes.length)];
            feedbackTextEl.innerHTML = `<span class='player-text'>Minh:</span> ${randomQuote}`;
            explanationTextEl.textContent = explanation;
            explanationTextEl.className = 'correct-feedback';
            playerCharacterEl.firstElementChild.classList.add('bounce-effect');
            setTimeout(() => playerCharacterEl.firstElementChild.classList.remove('bounce-effect'), 1000);
            updateUI();
        }

        function handleIncorrectAnswer(explanation) {
            playIncorrectSound();
            incorrectAnswersCount++;
            feedbackTextEl.innerHTML = `<span class='monster-text'>Nicotine:</span> Ngốc nghếch! Ngươi không thoát nổi đâu!`;
            explanationTextEl.textContent = `Đáp án đúng: ${shuffledQuestions[currentQuestionIndex].options[shuffledQuestions[currentQuestionIndex].answer]}`;
            explanationTextEl.className = 'incorrect-feedback';
            monsterCharacterEl.firstElementChild.classList.add('pulse-effect');
            setTimeout(() => monsterCharacterEl.firstElementChild.classList.remove('pulse-effect'), 1000);
            updateUI();
        }

        function updateUI() {
            scoreEl.textContent = score;
            questionCounterEl.textContent = `${currentQuestionIndex + 1} / ${quizData.length}`;
            shieldBarEl.style.width = `${Math.min((correctAnswersCount / 10) * 100, 100)}%`;
            document.getElementById('vortex-overlay').style.backgroundColor = `rgba(0, 0, 0, ${(incorrectAnswersCount / 6) * 0.7})`;
        }

        function endGame() {
            quizScreen.classList.add('hidden');
            finalScoreEl.textContent = score;
            
            if (correctAnswersCount >= 10) {
                playVictoryMusic();
                showVictoryScreen();
            } else {
                endScreen.classList.remove('hidden');
                endScreen.classList.add('lose-popup-style'); // MODIFIED: Add bright style on lose
                document.getElementById('win-content').classList.add('hidden');
                document.getElementById('lose-content').classList.remove('hidden');
                document.getElementById('final-score-display').classList.remove('hidden');
                document.getElementById('end-message').classList.remove('hidden');
                
                endTitleEl.textContent = "THẤT BẠI!";
                endTitleEl.className = "text-4xl font-bold mb-4 monster-text";
                
                if (incorrectAnswersCount > 5) {
                    endMessageEl.textContent = "Bạn hãy vượt qua nỗi sợ, truy cập thư viện tri thức và hạ gục kẻ thù chất độc nicotin đánh bay thuốc lá thuốc lá điện tử";
                } else {
                    endMessageEl.textContent = "Trái Tim Ý Chí của bạn đã bị nuốt chửng. Vòng xoáy độc hại đã chiến thắng...";
                }
            }
        }

        function showVictoryScreen() {
            endScreen.classList.remove('hidden');
            endScreen.classList.remove('lose-popup-style'); // MODIFIED: Remove style on win
            
            document.getElementById('lose-content').classList.add('hidden');
            document.getElementById('end-message').classList.add('hidden');
            document.getElementById('final-score-display').classList.add('hidden');
            document.getElementById('win-content').classList.remove('hidden');
            
            endTitleEl.textContent = "CHIẾN THẮNG!";
            endTitleEl.className = "text-4xl font-bold mb-4 text-cyan-400";
        }

        restartButton.addEventListener('click', startGame);
        
        const mainMenuButton = document.getElementById('main-menu-button');
        mainMenuButton.addEventListener('click', () => {
            try {
                window.location.href = 'index.html';
            } catch (e) {
                console.warn("Could not navigate to index.html. This is expected in a sandboxed environment.");
            }
        });
        
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Lỗi khi bật toàn màn hình: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        document.getElementById('fullscreen-button').addEventListener('click', toggleFullScreen);
    </script>
</body>
</html>
