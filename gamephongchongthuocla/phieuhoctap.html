<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Học Tập Tương Tác - Cuộc Chiến Không Khói</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700;900&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: #00f0ff; /* Cyan */
            --accent-color: #ff00ff; /* Magenta */
            --bg-color: #0d0221;
            --success-color: #00ff88;
            --error-color: #ff4b4b;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: #e0e0e0;
        }
        .font-display { font-family: 'Be Vietnam Pro', sans-serif; }
        .cyber-glow { text-shadow: 0 0 5px var(--glow-color), 0 0 10px var(--glow-color); }
        .cyber-panel {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.1), inset 0 0 10px rgba(0, 217, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        .cyber-button {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
            transition: all 0.3s ease;
            text-shadow: 0 0 5px var(--accent-color);
            color: var(--accent-color);
        }
        .cyber-button:hover:not(:disabled) {
            background-color: var(--accent-color);
            color: var(--bg-color);
            box-shadow: 0 0 20px var(--accent-color), 0 0 30px var(--accent-color);
            text-shadow: none;
            transform: scale(1.05);
        }
        .cyber-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #555;
            box-shadow: none;
            text-shadow: none;
            color: #888;
        }
        .cyber-button-success {
            border-color: var(--success-color);
            box-shadow: 0 0 10px var(--success-color);
            text-shadow: 0 0 5px var(--success-color);
            color: var(--success-color);
        }
        .cyber-button-success:hover:not(:disabled) {
            background-color: var(--success-color);
            color: var(--bg-color);
        }

        /* Matching Game Styles */
        .matching-column { list-style: none; padding: 0; }
        .matching-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .matching-item.selected {
            border-color: var(--accent-color);
            background-color: rgba(255, 0, 255, 0.2);
            transform: scale(1.05);
        }
        #matching-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        /* Text Input Styles */
        .cyber-textarea, .cyber-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glow-color);
            color: #e0e0e0;
            resize: none;
        }
        .cyber-textarea:focus, .cyber-input:focus {
            outline: none;
            box-shadow: 0 0 10px var(--glow-color);
        }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 5px var(--glow-color), 0 0 10px var(--glow-color); }
            50% { text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color), 0 0 30px var(--glow-color); }
        }
        .title-animation {
            animation: pulse-glow 2.5s ease-in-out infinite;
        }

        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        #volume-control {
            cursor: pointer;
            width: 32px;
            height: 32px;
            color: var(--glow-color);
        }
    </style>
</head>
<div id="copyright">
    © <span id="year"></span> Thầy Thái Minh Nguyên - Trường Tiểu học, THCS & THPT Yersin Đà Lạt. All rights reserved.
</div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap');

#copyright {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 13px;
    padding: 6px 0;
    font-family: 'Roboto', Arial, Helvetica, sans-serif;
    z-index: 9999;
    pointer-events: none;

    color: rgba(255, 255, 255, 0.85);
    background: transparent;

    opacity: 0;
    animation: fadeIn 2s ease forwards;
}

@keyframes fadeIn {
    to { opacity: 1; }
}
</style>

<script>
document.getElementById("year").textContent = new Date().getFullYear();
</script>

<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">
    
    <canvas id="background-canvas"></canvas>

    <div id="game-container" class="w-full max-w-4xl mx-auto">
        <!-- Start Screen -->
        <div id="start-screen" class="text-center">
            <h1 class="font-display text-4xl md:text-5xl font-black cyber-glow title-animation mb-4">TRẠM PHÂN TÍCH DỮ LIỆU</h1>
            <p class="text-lg text-gray-300 mb-8">Nhiệm vụ của bạn: Hoàn thành báo cáo sau trận chiến để củng cố tri thức.</p>
            <button id="start-btn" class="cyber-button font-display text-xl font-bold py-3 px-8 rounded-lg">BẮT ĐẦU NHIỆM VỤ</button>
            <p class="text-sm text-gray-400 mt-4 italic">Kết quả xuất sắc nhất sẽ nhận phần quà dễ thương từ thầy Thái Minh Nguyên.</p>
        </div>

        <!-- Game Screen -->
        <div id="quiz-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <h2 class="font-display text-2xl font-bold cyber-glow">BÁO CÁO NHIỆM VỤ</h2>
                <div class="flex items-center gap-4">
                    <div class="font-display text-xl" id="progress-tracker">Câu 1 / 8</div>
                    <div id="volume-control">
                        <svg id="volume-on" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                        </svg>
                        <svg id="volume-off" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l-2.25 2.25M19.5 12l2.25-2.25M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                        </svg>
                    </div>
                </div>
            </header>

            <div id="question-container" class="cyber-panel rounded-lg p-6 min-h-[400px]">
                <!-- Content will be injected by JavaScript -->
            </div>

            <div class="mt-6 flex justify-between items-center">
                <a href="index.html" class="text-gray-400 hover:text-white transition-colors">Về Giao Diện Chính</a>
                <button id="next-btn" class="cyber-button font-display text-lg font-bold py-2 px-6 rounded-lg">TIẾP TỤC</button>
            </div>
        </div>
        
        <!-- End Screen -->
        <div id="end-screen" class="hidden text-center">
             <h1 class="font-display text-4xl md:text-5xl font-black text-green-400 mb-4" style="text-shadow: 0 0 10px var(--success-color);">NHIỆM VỤ HOÀN THÀNH!</h1>
            <p class="text-lg text-gray-300 mb-4">Báo cáo của bạn đã được hoàn tất. Vui lòng nhập thông tin và nộp bài để gửi kết quả về cho giáo viên.</p>
            
            <div class="max-w-md mx-auto space-y-4 mb-6">
                <input type="text" id="student-name" placeholder="Nhập họ và tên của bạn" class="cyber-input w-full p-3 rounded-lg text-center">
                <input type="text" id="student-class" placeholder="Nhập lớp của bạn" class="cyber-input w-full p-3 rounded-lg text-center">
            </div>
            <div id="submission-confirmation" class="text-green-400 mb-4 hidden"></div>

            <div class="flex flex-wrap gap-4 justify-center">
                <button id="restart-btn" class="cyber-button font-display text-xl font-bold py-3 px-8 rounded-lg">LÀM LẠI</button>
                <a href="index.html" class="cyber-button font-display text-xl font-bold py-3 px-8 rounded-lg inline-flex items-center justify-center">VỀ TRANG CHỦ</a>
                <button id="submit-btn" class="cyber-button-success font-display text-xl font-bold py-3 px-8 rounded-lg">NỘP BÀI</button>
            </div>
        </div>

    </div>

    <script>
        // --- CẤU HÌNH GOOGLE FORM (ĐÃ CẬP NHẬT) ---
        const googleFormConfig = {
            formId: "1FAIpQLSf-ZzgJilnnyd_plGdR6BXCW4vQ8pzEqrtEPA4t77b1LV2CtA",
            entries: {
                studentName: "entry.26466532",
                studentClass: "entry.1819839671",
                q1: "entry.1232676616",
                q2: "entry.905076906",
                q3: "entry.1206332438",
                q4: "entry.68416665",
                q5: "entry.1238329820",
                q6: "entry.291880770",
                q7: "entry.728605034",
                q8: "entry.1217904893"
            }
        };

        // --- ÂM THANH ---
        let audioInitialized = false;
        let backgroundMusic;
        const sounds = {};
        function initAudio() {
            // Hiệu ứng âm thanh
            sounds.click = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination();
            sounds.correct = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
            sounds.incorrect = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.05, release: 0.1 } }).toDestination();
            sounds.logSaved = new Tone.FMSynth({ harmonicity: 1.2, modulationIndex: 5, envelope: { attack: 0.01, decay: 0.3, release: 0.3 } }).toDestination();
            sounds.complete = new Tone.PolySynth(Tone.Synth).toDestination();
            
            // THAY ĐỔI: Nhạc nền mới nhanh và du dương hơn
            const synth = new Tone.PluckSynth({
                attackNoise: 0.5,
                dampening: 4000,
                resonance: 0.9,
                volume: -10
            }).toDestination();

            const melody = [
                'C4', 'E4', 'G4', 'C5', 'E4', 'G4', 'B4', 'G4',
                'D4', 'F4', 'A4', 'D5', 'F4', 'A4', 'C5', 'A4'
            ];

            backgroundMusic = new Tone.Sequence((time, note) => {
                synth.triggerAttackRelease(note, '16n', time);
            }, melody, '16n').start(0);

            Tone.Transport.bpm.value = 140; // Tăng nhịp độ
            
            audioInitialized = true;
        }
        
        function playSound(soundName, note = "C5", duration = "8n") {
            if (audioInitialized && sounds[soundName]) {
                const now = Tone.now();
                 if (soundName === 'complete') {
                    sounds.complete.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now);
                } else {
                    sounds[soundName].triggerAttackRelease(note, duration, now);
                }
            }
        }
        
        // --- CƠ SỞ DỮ LIỆU CÂU HỎI ---
        const questions = [
            {
                type: 'short_answer',
                prompt: 'Sau khi chơi "Game Khám Phá", hãy ghi lại báo cáo về các mối đe dọa tại **Phổi**.',
                expertAnswer: 'Báo cáo ghi nhận 3 mối đe dọa chính tại Phổi: 1. **Hắc ín (Tar):** Khối nhầy đen bám dính, gây tắc nghẽn và cản trở hô hấp. 2. **Hạt Siêu Nhỏ:** Xâm nhập sâu gây viêm nhiễm và bệnh mạn tính. 3. **Acrolein:** "Ngọn lửa độc" đốt cháy lớp lót của phổi, gây ho và khó thở.'
            },
            {
                type: 'short_answer',
                prompt: 'Phân tích tại sao **Trái Tim** phải hoạt động quá sức khi bị tấn công.',
                expertAnswer: 'Trái Tim bị tấn công bởi 2 kẻ thù: 1. **Carbon Monoxide (CO):** Chiếm chỗ của oxy trong máu, khiến tim phải đập nhanh và mạnh hơn để bù đắp. 2. **Nicotine:** Gây co thắt mạch máu và tăng huyết áp, buộc tim phải bơm máu qua các "con đường" bị thu hẹp, dẫn đến kiệt sức.'
            },
            {
                type: 'matching',
                prompt: 'Ghép nối chính xác cơ quan (Cột A) với tác hại tương ứng (Cột B).',
                columnA: ['1. Não bộ', '2. Da', '3. Miệng & Răng', '4. Phổi'],
                columnB: ['a. Gây ố vàng, bệnh nướu và ung thư.', 'b. Gây nghiện, tăng nguy cơ đột quỵ, suy giảm trí nhớ.', 'c. Gây ung thư, bệnh COPD, phá hủy các túi khí.', 'd. Gây lão hóa sớm, xuất hiện nhiều nếp nhăn.'],
                correctPairs: { 0: 1, 1: 3, 2: 0, 3: 2 } // Index A -> Index B
            },
            {
                type: 'short_answer',
                prompt: 'Dựa vào "Thư viện tri thức", hãy kể tên **2 chất độc** khác ngoài bộ ba cốt lõi và mô tả nguy cơ của chúng.',
                expertAnswer: 'Có thể kể đến: 1. **Formaldehyde:** Chất dùng để ướp xác, có khả năng gây ung thư máu và ung thư vòm họng. 2. **Benzene:** Một dung môi công nghiệp, là nguyên nhân gây bệnh bạch cầu (ung thư máu).'
            },
            {
                type: 'short_answer',
                prompt: 'Phân tích luận điểm: "Thuốc lá điện tử (Vape) không an toàn".',
                expertAnswer: 'Luận điểm này hoàn toàn chính xác. Vape không an toàn vì: 1. Vẫn chứa **Nicotine** gây nghiện. 2. "Hơi" vape chứa các **hạt siêu mịn và kim loại nặng** có thể đi sâu vào phổi. 3. Các **chất tạo hương vị** khi bị đun nóng có thể biến đổi thành hóa chất độc hại, gây ung thư.'
            },
            {
                type: 'reflection',
                prompt: 'Trong "Game Trả Lời", Minh sử dụng "Lá Chắn Tri Thức". Hình ảnh này tượng trưng cho điều gì trong cuộc sống thực tế?',
                expertAnswer: '"Lá Chắn Tri Thức" tượng trưng cho **sự hiểu biết** và **kiến thức khoa học**. Khi chúng ta hiểu rõ về tác hại của thuốc lá và những mánh khóe quảng cáo, chúng ta sẽ có đủ sức mạnh và sự kiên định để từ chối nó. Kiến thức chính là công cụ phòng vệ tốt nhất.'
            },
            {
                type: 'reflection',
                prompt: 'Sau khi hoàn thành hành trình, hãy soạn một thông điệp ngắn gọn bạn muốn gửi đến bạn bè.',
                expertAnswer: 'Gợi ý: "Đừng để một phút tò mò đánh đổi cả một tương lai khỏe mạnh." hoặc "Bản lĩnh không đến từ khói thuốc, mà đến từ ý chí của bạn."'
            },
            {
                type: 'reflection',
                prompt: 'Bạn ấn tượng nhất với mô-đun game nào và tại sao?',
                expertAnswer: 'Đây là câu hỏi mở để bạn tự do bày tỏ. Ví dụ: "Tôi thích Game Kim Cương nhất vì nó ẩn dụ cho cuộc chạy đua với thời gian để bảo vệ sức khỏe."'
            }
        ];

        // --- TRẠNG THÁI GAME ---
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let isShowingHint = false;

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const endScreen = document.getElementById('end-screen');
        const questionContainer = document.getElementById('question-container');
        const progressTracker = document.getElementById('progress-tracker');
        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');
        const submitBtn = document.getElementById('submit-btn');
        const volumeControl = document.getElementById('volume-control');
        const volumeOnIcon = document.getElementById('volume-on');
        const volumeOffIcon = document.getElementById('volume-off');
        
        // --- LOGIC GAME ---
        async function startGame() {
            if (!audioInitialized) {
                await Tone.start();
                initAudio();
            }

            playSound('click');
            Tone.Transport.start();

            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            currentQuestionIndex = 0;
            userAnswers = [];
            isShowingHint = false;
            renderQuestion();
        }

        function renderQuestion() {
            const question = questions[currentQuestionIndex];
            questionContainer.innerHTML = '';
            questionContainer.classList.remove('fade-in');
            void questionContainer.offsetWidth;
            questionContainer.classList.add('fade-in');

            progressTracker.textContent = `Câu ${currentQuestionIndex + 1} / ${questions.length}`;
            nextBtn.disabled = true;
            nextBtn.textContent = "LƯU BÁO CÁO";

            const promptEl = document.createElement('h3');
            promptEl.className = 'font-display text-xl font-bold mb-4 text-cyan-300';
            promptEl.textContent = `[NHIỆM VỤ ${currentQuestionIndex + 1}] ` + question.prompt;
            questionContainer.appendChild(promptEl);

            if (question.type === 'matching') {
                renderMatchingQuestion(question);
            } else {
                renderShortAnswerQuestion(question);
            }
        }

        function renderShortAnswerQuestion(question) {
            const answerArea = document.createElement('div');
            const textarea = document.createElement('textarea');
            textarea.className = 'cyber-textarea w-full h-32 p-2 rounded-lg';
            textarea.placeholder = 'Nhập báo cáo của bạn tại đây...';
            textarea.addEventListener('input', () => {
                nextBtn.disabled = textarea.value.trim() === '';
            });
            answerArea.appendChild(textarea);
            questionContainer.appendChild(answerArea);
        }
        
        let userPairs = {};
        let drawLinesFunction = null; 

        function renderMatchingQuestion(question) {
            const matchingArea = document.createElement('div');
            matchingArea.className = 'relative grid grid-cols-2 gap-8 items-center';
            
            const canvas = document.createElement('canvas');
            canvas.id = 'matching-canvas';
            matchingArea.appendChild(canvas);

            const colA = document.createElement('ul');
            colA.className = 'matching-column space-y-2';
            colA.id = 'columnA';
            question.columnA.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'matching-item cyber-panel p-3 rounded-md';
                li.textContent = item;
                li.dataset.index = index;
                colA.appendChild(li);
            });

            const colB = document.createElement('ul');
            colB.className = 'matching-column space-y-2';
            colB.id = 'columnB';
            question.columnB.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'matching-item cyber-panel p-3 rounded-md';
                li.textContent = item;
                li.dataset.index = index;
                colB.appendChild(li);
            });

            matchingArea.insertBefore(colA, canvas);
            matchingArea.appendChild(colB);
            questionContainer.appendChild(matchingArea);

            setupMatchingLogic(question);
        }
        
        function setupMatchingLogic(question) {
            const colAItems = document.querySelectorAll('#columnA .matching-item');
            const colBItems = document.querySelectorAll('#columnB .matching-item');
            const canvas = document.getElementById('matching-canvas');
            const ctx = canvas.getContext('2d');
            userPairs = {};

            setTimeout(() => {
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
            }, 0);

            drawLinesFunction = function(evaluation = null) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                for (const aIndex in userPairs) {
                    const bIndex = userPairs[aIndex];
                    if (bIndex === undefined) continue;
                    const startEl = colAItems[aIndex];
                    const endEl = colBItems[bIndex];
                    
                    const startRect = startEl.getBoundingClientRect();
                    const endRect = endEl.getBoundingClientRect();
                    const canvasRect = canvas.getBoundingClientRect();
                    
                    const startX = startRect.right - canvasRect.left;
                    const startY = startRect.top + startRect.height / 2 - canvasRect.top;
                    const endX = endRect.left - canvasRect.left;
                    const endY = endRect.top + endRect.height / 2 - canvasRect.top;

                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    
                    ctx.lineWidth = 3;
                    ctx.shadowBlur = 10;

                    if (evaluation) {
                        if (evaluation[aIndex]) {
                            ctx.strokeStyle = `rgba(0, 255, 136, 0.8)`;
                            ctx.shadowColor = `rgba(0, 255, 136, 0.8)`;
                        } else {
                            ctx.strokeStyle = `rgba(255, 75, 75, 0.8)`;
                            ctx.shadowColor = `rgba(255, 75, 75, 0.8)`;
                        }
                    } else {
                        ctx.strokeStyle = `rgba(255, 0, 255, 0.7)`;
                        ctx.shadowColor = `rgba(255, 0, 255, 0.7)`;
                    }
                    ctx.stroke();
                }
            }

            let selectedA = null, selectedB = null;
            colAItems.forEach(item => item.addEventListener('click', () => {
                playSound('click', 'C5');
                selectedA = item;
                colAItems.forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                checkPair();
            }));

            colBItems.forEach(item => item.addEventListener('click', () => {
                playSound('click', 'D5');
                selectedB = item;
                colBItems.forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                checkPair();
            }));

            function checkPair() {
                if (selectedA && selectedB) {
                    const aIndex = parseInt(selectedA.dataset.index);
                    const bIndex = parseInt(selectedB.dataset.index);
                    
                    userPairs[aIndex] = bIndex;
                    if (drawLinesFunction) drawLinesFunction();
                    
                    selectedA.classList.remove('selected');
                    selectedB.classList.remove('selected');
                    selectedA = null;
                    selectedB = null;

                    if (Object.keys(userPairs).length === question.columnA.length) {
                        nextBtn.disabled = false;
                    }
                }
            }
        }
        
        function handleNextButtonClick() {
            if (isShowingHint) {
                advanceToNextQuestion();
            } else {
                saveAnswerAndShowHint();
            }
        }

        function saveAnswerAndShowHint() {
            playSound('click');
            const question = questions[currentQuestionIndex];
            let answer;
            
            if (question.type === 'matching') {
                const evaluation = {};
                let correctCount = 0;
                
                for (let i = 0; i < question.columnA.length; i++) {
                    const isCorrect = question.correctPairs[i] === userPairs[i];
                    evaluation[i] = isCorrect;
                    if (isCorrect) correctCount++;
                }
                
                const correctPairStrings = ['1-b', '2-d', '3-a', '4-c'];
                answer = correctPairStrings.join(', ');
                
                userAnswers.push({ question: question.prompt, answer: answer });
                
                document.querySelectorAll('.matching-item').forEach(i => {
                    i.style.pointerEvents = 'none';
                });

                if (drawLinesFunction) drawLinesFunction(evaluation);
                
                const expertAnswerEl = document.createElement('div');
                expertAnswerEl.className = 'mt-4 p-4 border-t-2 border-dashed border-cyan-400/50 fade-in';
                expertAnswerEl.innerHTML = `<h4 class="font-display text-lg font-bold text-green-400">KẾT QUẢ ĐÚNG</h4><p class="text-gray-300">1-b, 2-d, 3-a, 4-c</p>`;
                questionContainer.appendChild(expertAnswerEl);
                
                playSound(correctCount === question.columnA.length ? 'correct' : 'incorrect', 'A4');
                
                setTimeout(advanceToNextQuestion, 4000);
                nextBtn.disabled = true;
                return;

            } else {
                answer = questionContainer.querySelector('textarea').value;
                userAnswers.push({ question: question.prompt, answer: answer });
            }

            const expertAnswerEl = document.createElement('div');
            expertAnswerEl.className = 'mt-4 p-4 border-t-2 border-dashed border-cyan-400/50 fade-in';
            expertAnswerEl.innerHTML = `<h4 class="font-display text-lg font-bold text-green-400">PHÂN TÍCH GỢI Ý</h4><p class="text-gray-300">${question.expertAnswer}</p>`;
            questionContainer.appendChild(expertAnswerEl);
            playSound('logSaved', 'A4');
            
            nextBtn.textContent = "TIẾP TỤC";
            isShowingHint = true;
        }
        
        function advanceToNextQuestion() {
            playSound('click');
            currentQuestionIndex++;
            isShowingHint = false;
            if (currentQuestionIndex < questions.length) {
                renderQuestion();
            } else {
                showEndScreen();
            }
        }

        function showEndScreen() {
            playSound('complete');
            if (audioInitialized) {
                Tone.Transport.stop();
            }
            quizScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            endScreen.classList.add('fade-in');
        }

        function handleSubmit() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentClass = document.getElementById('student-class').value.trim();
            const confirmationMsg = document.getElementById('submission-confirmation');

            if (!studentName || !studentClass) {
                confirmationMsg.textContent = 'Vui lòng nhập đầy đủ họ tên và lớp.';
                confirmationMsg.className = 'text-red-400 mb-4';
                confirmationMsg.classList.remove('hidden');
                return;
            }

            if (userAnswers.length < 8) {
                confirmationMsg.textContent = 'Bạn chưa lưu đủ 8 câu trả lời. Vui lòng quay lại kiểm tra.';
                confirmationMsg.className = 'text-red-400 mb-4';
                confirmationMsg.classList.remove('hidden');
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `https://docs.google.com/forms/d/e/${googleFormConfig.formId}/formResponse`;
            form.target = '_blank';

            const add = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            };

            add(googleFormConfig.entries.studentName, studentName);
            add(googleFormConfig.entries.studentClass, studentClass);
            userAnswers.forEach((item, idx) => {
                const key = `q${idx + 1}`;
                if (googleFormConfig.entries[key]) add(googleFormConfig.entries[key], item.answer || '(Không trả lời)');
            });

            add('fvv', '1');
            add('pageHistory', '0');
            add('fbzx', Math.floor(Math.random() * 9000000000000000000) + 1000000000000000000);

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            confirmationMsg.textContent = 'Nộp bài thành công! Vui lòng kiểm tra tab mới để xem xác nhận.';
            confirmationMsg.className = 'text-green-400 mb-4';
            confirmationMsg.classList.remove('hidden');

            submitBtn.disabled = true;
            submitBtn.textContent = 'ĐÃ NỘP BÀI';
            playSound('correct', 'G5');
        }


        // --- EVENT LISTENERS ---
        startBtn.addEventListener('click', startGame);
        nextBtn.addEventListener('click', handleNextButtonClick);
        submitBtn.addEventListener('click', handleSubmit);
        
        restartBtn.addEventListener('click', () => {
            playSound('click');
            endScreen.classList.add('hidden');
            
            document.getElementById('student-name').value = '';
            document.getElementById('student-class').value = '';
            document.getElementById('submission-confirmation').classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.textContent = "NỘP BÀI";

            startGame();
        });
        
        volumeControl.addEventListener('click', () => {
            if (audioInitialized) {
                Tone.Destination.mute = !Tone.Destination.mute;
                volumeOnIcon.classList.toggle('hidden');
                volumeOffIcon.classList.toggle('hidden');
            }
        });
    </script>
    
    <script>
        const bgCanvas = document.getElementById('background-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        let particlesArray;

        class Particle {
            constructor(x, y, directionX, directionY, size, color) {
                this.x = x;
                this.y = y;
                this.directionX = directionX;
                this.directionY = directionY;
                this.size = size;
                this.color = color;
            }
            draw() {
                bgCtx.beginPath();
                bgCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                bgCtx.fillStyle = this.color;
                bgCtx.fill();
            }
            update() {
                if (this.x > bgCanvas.width || this.x < 0) {
                    this.directionX = -this.directionX;
                }
                if (this.y > bgCanvas.height || this.y < 0) {
                    this.directionY = -this.directionY;
                }
                this.x += this.directionX;
                this.y += this.directionY;
                this.draw();
            }
        }

        function resizeBgCanvas() {
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
            initBg();
        }
        window.addEventListener('resize', resizeBgCanvas);
        resizeBgCanvas();

        function initBg() {
            particlesArray = [];
            let numberOfParticles = (bgCanvas.height * bgCanvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 2) + 1;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let directionX = (Math.random() * .4) - .2;
                let directionY = (Math.random() * .4) - .2;
                let color = 'rgba(0, 240, 255, 0.5)';
                particlesArray.push(new Particle(x, y, directionX, directionY, size, color));
            }
        }

        function animateBg() {
            requestAnimationFrame(animateBg);
            bgCtx.clearRect(0, 0, innerWidth, innerHeight);

            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
            }
        }
        
        animateBg();
    </script>
</body>
</html>
