<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>ðŸŽ² Math Genius: Ultimate Canvas Edition</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');

  :root {
    --bg-dark: #050505;
    --card-dark: rgba(20, 20, 25, 0.95);
    --primary: #00f2ff;
    --accent: #ff0055;
    --success: #00ff9d;
    --warning: #ffcc00;
    --text: #ffffff;
    --font-head: 'Orbitron', sans-serif;
    --font-body: 'Rajdhani', sans-serif;
  }

  * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    background-color: var(--bg-dark);
    color: var(--text);
    overflow: hidden;
    position: fixed; /* Prevent scroll bounce on mobile */
    width: 100%; height: 100%;
    font-family: var(--font-body);
  }

  /* Fullscreen Canvas Background */
  #bgCanvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
  }

  /* Game Container */
  .game-ui {
    position: relative;
    z-index: 10;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* Push HUD top and Controls bottom */
    background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.6) 100%);
    padding-bottom: env(safe-area-inset-bottom); /* iOS Safe Area */
  }

  /* Main Interactive Canvas */
  #gameCanvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 1; /* Behind controls */
    pointer-events: none; /* Let clicks pass through */
  }

  /* Header HUD */
  .hud-top {
    position: relative; z-index: 20;
    padding: 15px 20px;
    padding-top: max(15px, env(safe-area-inset-top));
    display: flex; justify-content: space-between; align-items: center;
    pointer-events: none;
  }
  
  .score-box {
    text-align: left;
    text-shadow: 0 0 10px var(--primary);
  }
  .score-label { font-size: 12px; opacity: 0.8; letter-spacing: 2px; text-transform: uppercase; }
  .score-val { font-family: var(--font-head); font-size: 28px; font-weight: 900; color: var(--primary); line-height: 1; }

  /* Timer moved to Canvas drawing for better scaling, 
     keeping placeholder for layout balance if needed, but reducing visual clutter */
  .timer-placeholder { width: 50px; } 

  /* Bottom Controls */
  .control-dock {
    position: relative; z-index: 20;
    padding: 15px;
    margin-bottom: 10px;
    background: transparent;
    display: flex; gap: 10px; align-items: stretch;
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    width: 100%;
    max-width: 600px;
    align-self: center;
  }
  
  /* Mobile Optimization for inputs */
  input[type="number"] {
    flex: 2;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 12px;
    color: #fff;
    padding: 12px;
    font-family: var(--font-head);
    font-size: 22px; /* Large font prevents zoom on iOS */
    outline: none;
    transition: all 0.2s;
    text-align: center;
    -moz-appearance: textfield; /* Remove arrows */
  }
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

  input[type="number"]:focus {
    border-color: var(--primary);
    background: rgba(0, 20, 40, 0.8);
    box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
  }

  .btn {
    border: none;
    border-radius: 12px;
    font-family: var(--font-head);
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.1s;
    position: relative;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active { transform: scale(0.95); }
  
  .btn-submit { 
    flex: 1.5; 
    background: var(--primary); 
    color: #000; 
    font-size: 18px; 
    box-shadow: 0 5px 15px rgba(0, 242, 255, 0.3);
  }
  
  .btn-hint { 
    width: 60px; 
    background: rgba(255,255,255,0.1); 
    backdrop-filter: blur(5px);
    color: var(--text); 
    font-size: 12px; 
    flex-direction: column;
    line-height: 1.2;
  }
  .btn-hint span { font-size: 10px; opacity: 0.7; }

  /* Modal System */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
    padding: 20px;
  }
  .modal-overlay.active { opacity: 1; pointer-events: auto; }

  .modal-card {
    background: var(--card-dark);
    border: 1px solid var(--primary);
    box-shadow: 0 0 40px rgba(0, 242, 255, 0.15);
    padding: 30px;
    border-radius: 20px;
    width: 100%; max-width: 400px;
    text-align: center;
    max-height: 90vh;
    overflow-y: auto;
  }

  h1 { margin: 0 0 5px 0; font-family: var(--font-head); color: var(--primary); text-transform: uppercase; letter-spacing: 2px; font-size: 28px; }
  h2 { margin: 0 0 25px 0; font-family: var(--font-body); font-weight: 300; color: #aaa; font-size: 16px; letter-spacing: 4px; }

  .setting-row { margin-bottom: 20px; text-align: left; }
  .setting-row label { display: block; margin-bottom: 8px; color: var(--primary); font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
  
  select {
    width: 100%; padding: 15px;
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
    color: #fff; border-radius: 10px;
    font-family: var(--font-body); font-size: 16px;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
  }

  .btn-start {
    width: 100%; padding: 18px;
    background: linear-gradient(135deg, var(--accent), #ff5e00);
    border-radius: 12px;
    color: white; font-size: 20px; font-weight: 900; letter-spacing: 2px;
    margin-top: 15px;
    box-shadow: 0 10px 20px rgba(255, 0, 85, 0.3);
  }

  .mute-toggle {
    position: absolute; top: max(15px, env(safe-area-inset-top)); right: 20px;
    background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(4px);
    color: #fff; padding: 8px 12px; border-radius: 20px;
    cursor: pointer; z-index: 50; font-size: 12px; font-weight: bold;
    pointer-events: auto;
  }
</style>
</head>
<body>

<div id="bgCanvas"></div>

<div class="game-ui">
  <!-- Top HUD -->
  <div class="hud-top">
    <div class="score-box">
      <div class="score-label">Score</div>
      <div class="score-val" id="scoreDisplay">0</div>
    </div>
    <button class="mute-toggle" id="muteBtn">ðŸ”Š ON</button>
  </div>

  <!-- Drawing Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- Bottom Interactions -->
  <div class="control-dock" id="controlDock">
    <button class="btn btn-hint" id="hintBtn">
      HINT
      <span>(-2)</span>
    </button>
    <input type="number" id="answerInput" placeholder="?" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
    <button class="btn btn-submit" id="submitBtn">ENTER</button>
  </div>
</div>

<!-- START / SETTINGS MODAL -->
<div class="modal-overlay active" id="startModal">
  <div class="modal-card">
    <h1>Math Genius</h1>
    <h2>Ultimate Edition</h2>
    
    <div class="setting-row">
      <label>Mode</label>
      <select id="modeSelect">
        <option value="mixed">Mixed (Há»—n há»£p)</option>
        <option value="csc">Arithmetic (+)</option>
        <option value="csn">Geometric (Ã—)</option>
        <option value="fib">Fibonacci</option>
        <option value="prime">Primes</option>
        <option value="alt">Alternating</option>
      </select>
    </div>

    <div class="setting-row">
      <label>Difficulty</label>
      <select id="diffSelect">
        <option value="easy">Cadet (Dá»…)</option>
        <option value="medium">Officer (Vá»«a)</option>
        <option value="hard">Commander (KhÃ³)</option>
      </select>
    </div>

    <button class="btn btn-start" id="startBtn">PLAY NOW</button>
    <div style="margin-top:20px; font-size:12px; opacity:0.5;">
      Best Score: <span id="highScore" style="color:var(--primary); font-weight:bold;">0</span>
    </div>
  </div>
</div>

<script>
/**
 * MATH GENIUS: ULTIMATE CANVAS EDITION
 * Fully Responsive & Mobile Optimized
 */

// --- AUDIO ENGINE ---
class SoundEngine {
  constructor() {
    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    this.muted = false;
    this.masterGain = this.ctx.createGain();
    this.masterGain.connect(this.ctx.destination);
    this.masterGain.gain.value = 0.3;
  }

  toggleMute() {
    this.muted = !this.muted;
    this.masterGain.gain.value = this.muted ? 0 : 0.3;
    return this.muted;
  }

  playTone(freq, type, duration, startTime = 0) {
    if (this.ctx.state === 'suspended') this.ctx.resume();
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
    gain.gain.setValueAtTime(1, this.ctx.currentTime + startTime);
    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + startTime + duration);
    osc.connect(gain);
    gain.connect(this.masterGain);
    osc.start(this.ctx.currentTime + startTime);
    osc.stop(this.ctx.currentTime + startTime + duration);
  }

  playSuccess() {
    this.playTone(523.25, 'sine', 0.1, 0);
    this.playTone(659.25, 'sine', 0.1, 0.1);
    this.playTone(783.99, 'sine', 0.3, 0.2);
    this.playTone(1046.50, 'square', 0.4, 0.3);
  }
  playFail() {
    this.playTone(150, 'sawtooth', 0.3, 0);
    this.playTone(100, 'sawtooth', 0.5, 0.2);
  }
  playClick() {
    this.playTone(400, 'sine', 0.1, 0);
  }
}

// --- MATH LOGIC ---
const MathCore = {
  rand: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
  isPrime: (num) => {
    if(num <= 1) return false;
    if(num <= 3) return true;
    if(num % 2 === 0 || num % 3 === 0) return false;
    for(let i=5; i*i<=num; i+=6) if(num % i === 0 || num % (i+2) === 0) return false;
    return true;
  },
  nextPrime: (num) => {
    let next = num + 1;
    while(!MathCore.isPrime(next)) next++;
    return next;
  },
  generateSequence: (mode, diff) => {
    const len = 5;
    let seq = [], ans = 0, hint = "";
    const range = diff === 'easy' ? 20 : diff === 'medium' ? 50 : 100;
    
    if (mode === 'mixed') {
      const modes = ['csc', 'csn', 'fib', 'prime', 'alt'];
      mode = modes[MathCore.rand(0, modes.length - 1)];
    }

    switch(mode) {
      case 'csc': {
        const d = MathCore.rand(2, diff === 'hard' ? 15 : 8) * (Math.random() > 0.5 ? 1 : -1);
        const start = MathCore.rand(20, range);
        for(let i=0; i<len; i++) seq.push(start + i*d);
        ans = start + len*d;
        hint = `Cá»™ng thÃªm ${d}`;
        break;
      }
      case 'csn': {
        const q = MathCore.rand(2, diff === 'hard' ? 4 : 3);
        const start = MathCore.rand(1, 5);
        for(let i=0; i<len; i++) seq.push(start * Math.pow(q, i));
        ans = start * Math.pow(q, len);
        hint = `NhÃ¢n thÃªm ${q}`;
        break;
      }
      case 'fib': {
        const type = Math.random() > 0.7 ? 'tri' : 'fib';
        if (type === 'fib') {
          const a = MathCore.rand(1, 10);
          const b = MathCore.rand(a, a+10);
          seq = [a, b];
          for(let i=2; i<len; i++) seq.push(seq[i-1] + seq[i-2]);
          ans = seq[len-1] + seq[len-2];
          hint = "Tá»•ng 2 sá»‘ trÆ°á»›c (Fibonacci)";
        } else {
          seq = [1, 1, 2];
          for(let i=3; i<len; i++) seq.push(seq[i-1] + seq[i-2] + seq[i-3]);
          ans = seq[len-1] + seq[len-2] + seq[len-3];
          hint = "Tá»•ng 3 sá»‘ trÆ°á»›c (Tribonacci)";
        }
        break;
      }
      case 'prime': {
        let start = MathCore.rand(2, range);
        while(!MathCore.isPrime(start)) start++;
        seq.push(start);
        for(let i=1; i<len; i++) seq.push(MathCore.nextPrime(seq[i-1]));
        ans = MathCore.nextPrime(seq[len-1]);
        hint = "Sá»‘ nguyÃªn tá»‘ tiáº¿p theo";
        break;
      }
      case 'alt': {
        const a = MathCore.rand(1, 5);
        const b = MathCore.rand(2, 3);
        let current = MathCore.rand(2, 10);
        seq.push(current);
        for(let i=1; i<len; i++) {
          if (i % 2 !== 0) current += a; else current *= b;
          seq.push(current);
        }
        if (len % 2 !== 0) ans = current + a; else ans = current * b;
        hint = `+${a} rá»“i Ã—${b}`;
        break;
      }
    }
    return { seq, ans, hint, mode };
  }
};

// --- VISUALS ---
class Particle {
  constructor(x, y, color) {
    this.x = x; this.y = y;
    this.color = color;
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * 5 + 2;
    this.vx = Math.cos(angle) * speed;
    this.vy = Math.sin(angle) * speed;
    this.life = 1.0;
    this.decay = Math.random() * 0.03 + 0.02;
    this.size = Math.random() * 4 + 2;
  }
  update() {
    this.x += this.vx; this.y += this.vy;
    this.vy += 0.1; this.life -= this.decay;
  }
  draw(ctx) {
    ctx.globalAlpha = this.life;
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }
}

class Shockwave {
  constructor(x, y) {
    this.x = x; this.y = y;
    this.radius = 10; this.alpha = 1;
  }
  update() { this.radius += 10; this.alpha -= 0.04; }
  draw(ctx) {
    if(this.alpha <= 0) return;
    ctx.save();
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
    ctx.strokeStyle = `rgba(0, 242, 255, ${this.alpha})`;
    ctx.lineWidth = 4;
    ctx.stroke();
    ctx.restore();
  }
}

// --- GAME MAIN ---
class Game {
  constructor() {
    this.canvas = document.getElementById('gameCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.sound = new SoundEngine();
    
    this.input = document.getElementById('answerInput');
    this.scoreEl = document.getElementById('scoreDisplay');
    this.modal = document.getElementById('startModal');
    
    this.state = {
      score: 0, timeLeft: 0, maxTime: 20,
      currentQ: null, isPlaying: false,
      feedbackText: '', feedbackAlpha: 0, feedbackColor: '#fff'
    };
    
    this.entities = { numbers: [], particles: [], shockwaves: [] };
    
    this.resize();
    window.addEventListener('resize', () => this.resize());
    this.setupEvents();
    
    this.lastTime = 0;
    requestAnimationFrame(t => this.loop(t));
    document.getElementById('highScore').textContent = localStorage.getItem('math_hs') || 0;
  }

  resize() {
    // Dynamic resizing for canvas sharpness
    const parent = this.canvas.parentElement;
    this.W = parent.offsetWidth;
    this.H = parent.offsetHeight;
    this.canvas.width = this.W;
    this.canvas.height = this.H;
    
    // Scale factor for fonts/elements
    // Base 600px width. Mobile (<600) gets smaller scale
    this.scale = Math.min(1, this.W / 600);
  }

  setupEvents() {
    document.getElementById('startBtn').addEventListener('click', () => {
      this.startGame();
      this.sound.playClick();
    });
    document.getElementById('submitBtn').addEventListener('click', () => this.checkAnswer());
    this.input.addEventListener('keydown', e => {
      if(e.key === 'Enter') this.checkAnswer();
    });
    document.getElementById('hintBtn').addEventListener('click', (e) => {
      if(this.state.score >= 2 && this.state.isPlaying) {
        this.state.score -= 2;
        this.updateScore();
        alert(this.state.currentQ.hint);
        e.target.disabled = true;
      }
    });
    document.getElementById('muteBtn').addEventListener('click', (e) => {
      const isMuted = this.sound.toggleMute();
      e.target.textContent = isMuted ? "ðŸ”Š OFF" : "ðŸ”Š ON";
    });
  }

  startGame() {
    const mode = document.getElementById('modeSelect').value;
    const diff = document.getElementById('diffSelect').value;
    this.config = { mode, diff };
    this.state.score = 0;
    this.state.isPlaying = true;
    this.updateScore();
    this.modal.classList.remove('active');
    this.nextLevel();
  }

  nextLevel() {
    if(!this.state.isPlaying) return;
    this.state.currentQ = MathCore.generateSequence(this.config.mode, this.config.diff);
    this.state.maxTime = this.config.diff === 'easy' ? 20 : (this.config.diff === 'medium' ? 15 : 10);
    this.state.timeLeft = this.state.maxTime;
    
    const seq = this.state.currentQ.seq;
    // Responsive spacing
    const count = seq.length + 1;
    // Max width allowed for numbers row (90% of screen)
    const rowWidth = this.W * 0.9;
    const spacing = rowWidth / count;
    const startX = (this.W - rowWidth) / 2 + spacing/2;
    
    this.entities.numbers = seq.map((val, i) => ({
      val: val,
      x: startX + i * spacing,
      y: this.H + 100,
      targetY: this.H / 2, // Vertically centered
      scale: 0,
      delay: i * 5
    }));
    
    this.entities.numbers.push({
      val: '?',
      x: startX + seq.length * spacing,
      y: this.H + 100,
      targetY: this.H / 2,
      scale: 0,
      delay: seq.length * 5,
      isQ: true
    });

    this.input.value = '';
    this.input.focus();
    this.input.disabled = false;
    document.getElementById('hintBtn').disabled = false;
  }

  checkAnswer() {
    if(!this.state.isPlaying) return;
    const userVal = parseInt(this.input.value);
    
    if (userVal === this.state.currentQ.ans) {
      this.sound.playSuccess();
      this.state.score += 10 + Math.floor(this.state.timeLeft);
      this.updateScore();
      this.entities.shockwaves.push(new Shockwave(this.W/2, this.H/2));
      for(let i=0; i<30; i++) this.entities.particles.push(new Particle(this.W/2, this.H/2, '#00ff9d'));
      this.showFeedback('CHÃNH XÃC!', '#00ff9d');
      this.input.disabled = true;
      setTimeout(() => this.nextLevel(), 1200);
    } else {
      this.sound.playFail();
      this.state.timeLeft -= 5; // Harder penalty
      this.showFeedback('SAI Rá»’I!', '#ff0055');
      this.input.value = '';
      this.input.focus();
    }
  }

  gameOver() {
    this.state.isPlaying = false;
    this.sound.playFail();
    const oldHs = localStorage.getItem('math_hs') || 0;
    if(this.state.score > oldHs) {
      localStorage.setItem('math_hs', this.state.score);
      document.getElementById('highScore').textContent = this.state.score;
    }
    this.showFeedback('Háº¾T GIá»œ!', '#ff0055');
    setTimeout(() => {
      this.modal.classList.add('active');
      document.querySelector('.modal-card h2').textContent = `SCORE: ${this.state.score}`;
    }, 2000);
  }

  updateScore() { this.scoreEl.textContent = this.state.score; }
  showFeedback(text, color) {
    this.state.feedbackText = text;
    this.state.feedbackColor = color;
    this.state.feedbackAlpha = 1;
  }

  loop(timestamp) {
    const dt = timestamp - this.lastTime;
    this.lastTime = timestamp;
    this.ctx.clearRect(0,0,this.W, this.H);

    // Grid Background
    const time = Date.now() * 0.001;
    this.ctx.strokeStyle = 'rgba(0, 242, 255, 0.08)';
    this.ctx.lineWidth = 1;
    const gridSize = 50 * this.scale;
    const offsetX = (time * 20) % gridSize;
    for(let x=offsetX; x<this.W; x+=gridSize) {
      this.ctx.beginPath(); this.ctx.moveTo(x,0); this.ctx.lineTo(x,this.H); this.ctx.stroke();
    }

    if(this.state.isPlaying) {
      this.state.timeLeft -= dt/1000;
      if(this.state.timeLeft <= 0) { this.state.timeLeft = 0; this.gameOver(); }
    }

    // DRAW TIMER (Scalable)
    // Draw in top right corner, avoiding UI
    const tR = 30 * this.scale;
    const tX = this.W - tR - 20;
    const tY = tR + 60; // Below Top HUD

    this.ctx.beginPath();
    this.ctx.arc(tX, tY, tR, 0, Math.PI*2);
    this.ctx.strokeStyle = 'rgba(255,255,255,0.1)'; this.ctx.lineWidth=5*this.scale; this.ctx.stroke();
    
    const pct = this.state.timeLeft / this.state.maxTime;
    this.ctx.beginPath();
    this.ctx.arc(tX, tY, tR, -Math.PI/2, -Math.PI/2 + (Math.PI*2 * pct));
    this.ctx.strokeStyle = pct < 0.3 ? '#ff0055' : '#00f2ff';
    this.ctx.stroke();

    this.ctx.fillStyle = "#fff";
    this.ctx.font = `bold ${20*this.scale}px Orbitron`;
    this.ctx.textAlign = "center";
    this.ctx.textBaseline = "middle";
    this.ctx.fillText(Math.ceil(this.state.timeLeft), tX, tY);

    // DRAW NUMBERS (Scalable)
    // Adjust font size based on scale, but don't let it get too small
    const fontSize = Math.max(24, 48 * this.scale);
    this.ctx.font = `900 ${fontSize}px Orbitron`;
    
    this.entities.numbers.forEach(n => {
      if(n.delay > 0) n.delay--;
      else {
        n.y += (n.targetY - n.y) * 0.1;
        n.scale += (1 - n.scale) * 0.1;
      }
      const floatY = n.y + Math.sin(time*3 + n.x)*5;
      
      this.ctx.save();
      this.ctx.translate(n.x, floatY);
      this.ctx.scale(n.scale, n.scale);
      this.ctx.shadowBlur = 15;
      this.ctx.shadowColor = n.isQ ? '#ff0055' : '#00f2ff';
      this.ctx.fillStyle = n.isQ ? '#ff0055' : '#fff';
      this.ctx.fillText(n.val, 0, 0);
      this.ctx.restore();
    });

    // EFFECTS
    this.entities.shockwaves.forEach((sw, i) => {
      sw.update(); sw.draw(this.ctx);
      if(sw.alpha <= 0) this.entities.shockwaves.splice(i, 1);
    });
    this.entities.particles.forEach((p, i) => {
      p.update(); p.draw(this.ctx);
      if(p.life <= 0) this.entities.particles.splice(i, 1);
    });

    // FEEDBACK
    if(this.state.feedbackAlpha > 0) {
      this.ctx.save();
      this.ctx.globalAlpha = this.state.feedbackAlpha;
      this.ctx.translate(this.W/2, this.H/2 - 80*this.scale);
      const s = 1 + (1-this.state.feedbackAlpha);
      this.ctx.scale(s, s);
      this.ctx.font = `bold ${40*this.scale}px Rajdhani`;
      this.ctx.fillStyle = this.state.feedbackColor;
      this.ctx.fillText(this.state.feedbackText, 0, 0);
      this.ctx.restore();
      this.state.feedbackAlpha -= 0.02;
    }

    requestAnimationFrame(t => this.loop(t));
  }
}

window.onload = () => new Game();
</script>
</body>
</html>
