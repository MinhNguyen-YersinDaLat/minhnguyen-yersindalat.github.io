<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Math Genius: Arcade Scholar</title>
<style>
  /* C·∫¨P NH·∫¨T FONT: Montserrat & Merriweather (H·ªó tr·ª£ Ti·∫øng Vi·ªát tuy·ªát ƒë·ªëi) */
  @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;0,900;1,400&family=Montserrat:wght@400;600;700;800&display=swap');

  :root {
    --bg-paper: #f0f4f8;
    --grid-line: rgba(99, 102, 241, 0.15);
    --ink-blue: #1e1b4b;
    --game-accent: #f43f5e; /* Rose */
    --game-success: #10b981; /* Emerald */
    --game-warn: #f59e0b; /* Amber */
    --combo-fire: #ff5722;
    
    --card-shadow: 0 0.5rem 0 #cbd5e1, 0 1rem 1.5rem rgba(0,0,0,0.1);
    --card-active: 0 0 0 #cbd5e1, inset 0 0 0.5rem rgba(0,0,0,0.1);
    
    /* Font Variables Updated */
    --font-math: 'Merriweather', serif;
    --font-game: 'Montserrat', sans-serif;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

  body {
    margin: 0; padding: 0;
    background-color: var(--bg-paper);
    color: var(--ink-blue);
    font-family: var(--font-game);
    height: 100vh; height: 100dvh; /* Mobile viewport fix */
    overflow: hidden;
    display: flex; flex-direction: column;
    font-size: 16px; /* Base font size */
  }

  /* --- 3D GRID BACKGROUND --- */
  .world-container {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    overflow: hidden; z-index: 0; pointer-events: none;
    perspective: 1000px;
  }
  
  /* Math Rain Canvas (Background) */
  #bgCanvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0; opacity: 0.15;
  }

  .grid-floor {
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background-image: 
      linear-gradient(var(--grid-line) 2px, transparent 2px),
      linear-gradient(90deg, var(--grid-line) 2px, transparent 2px);
    background-size: 60px 60px;
    transform: rotateX(60deg);
    animation: planeFly 20s linear infinite;
    z-index: 1;
  }
  
  /* Vignette overlay */
  .vignette {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: radial-gradient(circle, transparent 40%, rgba(255,255,255,0.9) 100%);
    z-index: 2;
  }
  
  @keyframes planeFly { from { background-position: 0 0; } to { background-position: 0 60px; } }

  /* Effects Layer (Foreground) */
  #fxCanvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 50; pointer-events: none; }

  /* --- UI SHELL --- */
  .app-shell {
    position: relative; z-index: 10;
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    justify-content: space-between; /* Spread elements vertically */
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* 1. HUD - Responsive Sizing */
  .hud-bar {
    flex: 0 0 auto;
    padding: max(10px, env(safe-area-inset-top)) 15px 5px;
    display: flex; justify-content: space-between; align-items: flex-start;
    height: auto;
    min-height: 10%;
  }

  .score-badge {
    background: #fff;
    border: 3px solid var(--ink-blue);
    border-radius: 12px;
    padding: 0.3rem 1rem;
    box-shadow: 4px 4px 0 var(--ink-blue);
    transform: skew(-10deg);
  }
  .lbl { font-size: 0.7rem; color: var(--game-accent); letter-spacing: 1px; font-weight: 800; }
  .val { font-size: 1.5rem; line-height: 1; color: var(--ink-blue); font-weight: 900; }

  .timer-pill {
    background: #fff; border: 3px solid var(--ink-blue);
    border-radius: 30px; height: 2.5rem; width: 6rem;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 4px 4px 0 var(--ink-blue);
    position: relative; overflow: hidden;
  }
  .timer-bar {
    position: absolute; top:0; left:0; height:100%; width:100%;
    background: var(--game-success); opacity: 0.3; transform-origin: left;
    transition: width 0.1s linear;
  }
  .timer-txt { position: relative; font-size: 1.2rem; z-index: 2; font-weight: 800; }

  /* 2. GAMEPLAY AREA - Flexible Space */
  .game-stage {
    flex: 1;
    display: flex; flex-direction: column; 
    justify-content: space-evenly; /* Distribute cards and input evenly */
    align-items: center;
    position: relative;
    width: 100%;
    overflow-y: auto; /* Allow scroll on very short screens */
    overflow-x: hidden;
  }

  /* Combo Meter (Left) - Scaled */
  .combo-meter {
    position: absolute; left: 10px; top: 10%; bottom: 10%; width: 8px;
    background: rgba(0,0,0,0.1); border-radius: 5px;
    display: flex; flex-direction: column-reverse; overflow: hidden;
  }
  .combo-liquid {
    width: 100%; height: 0%;
    background: linear-gradient(to top, var(--game-success), var(--game-warn), var(--combo-fire));
    transition: height 0.3s;
    box-shadow: 0 0 10px var(--combo-fire);
  }
  .combo-text {
    position: absolute; left: 25px; top: 50%; transform: translateY(-50%) rotate(-90deg);
    font-size: 0.7rem; letter-spacing: 4px; color: var(--text-sub); opacity: 0.6; transform-origin: center; font-weight: 800;
  }

  /* Feedback */
  .feedback-pop {
    position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0);
    background: var(--ink-blue); color: #fff;
    padding: 0.8rem 1.5rem; border-radius: 8px;
    font-size: 1.2rem; text-transform: uppercase; font-weight: 800;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    z-index: 100; pointer-events: none; opacity: 0;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    white-space: nowrap;
  }
  .feedback-pop.show { opacity: 1; transform: translate(-50%, -150%) scale(1.2); }

  /* Card Grid - Responsive Sizing */
  .grid-wrap {
    display: flex; flex-wrap: wrap; justify-content: center; 
    gap: clamp(8px, 2vw, 15px);
    width: 100%; max-width: 600px; padding: 0 20px;
  }

  .math-tile {
    /* Responsive Width & Height based on viewport */
    width: clamp(50px, 18vw, 80px); 
    height: clamp(70px, 24vw, 110px);
    background: #fff;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    display: flex; justify-content: center; align-items: center;
    /* Font size scales with viewport */
    font-family: var(--font-math); 
    font-size: clamp(1.5rem, 5vw, 2.5rem); 
    font-weight: 700;
    color: var(--ink-blue);
    box-shadow: var(--card-shadow);
    transform: translateY(0);
    transition: transform 0.1s, box-shadow 0.1s;
    position: relative; overflow: hidden;
  }
  
  .math-tile::after {
    content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
    background: linear-gradient(to right, transparent, rgba(255,255,255,0.8), transparent);
    transform: skewX(-25deg);
    animation: shine 4s infinite;
  }
  @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

  .math-tile:active { transform: translateY(8px); box-shadow: var(--card-active); }
  
  .math-tile.q {
    background: #fff1f2; border-color: var(--game-accent); color: var(--game-accent);
    animation: bounce 2s infinite;
  }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

  /* Input - Responsive Height */
  .input-slate {
    width: 90%; max-width: 350px;
    height: clamp(50px, 10vh, 75px);
    background: #fff;
    border: 3px solid var(--ink-blue);
    border-radius: 16px;
    display: flex; justify-content: center; align-items: center;
    box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
    margin-top: 10px; margin-bottom: 10px; position: relative;
  }
  .input-val { 
    font-family: var(--font-math); 
    font-size: clamp(2rem, 6vh, 3rem); 
    font-weight: 900; color: var(--ink-blue); letter-spacing: 2px; 
  }
  .cursor { width: 3px; height: 60%; background: var(--game-accent); margin-left: 5px; animation: blink 1s infinite; }
  @keyframes blink { 50%{opacity:0;} }

  /* 3. CONTROL PAD CONTAINER */
  .control-pad {
    flex: 0 0 auto;
    background: #fff;
    border-top: 2px solid #e2e8f0;
    padding: 10px 10px 0 10px;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.05);
    width: 100%; max-width: 600px;
    margin: 0 auto;
    display: flex; flex-direction: column;
    gap: 8px;
  }

  .keys-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); 
    gap: clamp(5px, 2vw, 10px);
  }

  .key {
    height: clamp(45px, 8vh, 65px);
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-bottom-width: 4px;
    border-radius: 12px;
    color: var(--ink-blue); font-family: var(--font-game); 
    font-size: clamp(1.2rem, 3vh, 1.8rem); font-weight: 700;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; transition: all 0.1s;
  }
  .key:active { transform: translateY(3px); border-bottom-width: 1px; background: #e2e8f0; }
  
  .key.act { color: var(--game-accent); font-size: 1rem; }
  .key.hint { background: #fffbeb; border-color: #fcd34d; border-bottom-color: #d97706; color: #d97706; }
  
  .key.go {
    grid-column: span 2;
    background: var(--ink-blue); color: #fff; border-color: #0f172a;
  }
  .key.go:active { background: #312e81; }

  /* COPYRIGHT FOOTER - In Game */
  .copyright-footer {
    text-align: center;
    padding: 5px 0 max(5px, env(safe-area-inset-bottom)) 0;
    opacity: 0.6;
    font-family: var(--font-math);
    font-size: 0.75rem;
    color: var(--ink-blue);
    width: 100%;
    pointer-events: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .copyright-footer b { font-weight: 800; }

  /* COPYRIGHT BOX - In Menu */
  .copyright-menu {
    margin-top: 25px;
    padding-top: 15px;
    border-top: 2px dashed #cbd5e1;
    color: var(--ink-blue);
    opacity: 0.8;
  }
  .copy-name {
    font-family: var(--font-math);
    font-weight: 900;
    font-size: 1rem;
    display: block;
    color: var(--ink-blue);
  }
  .copy-school {
    font-family: var(--font-game);
    font-size: 0.75rem;
    color: #64748b;
    display: block;
    margin-top: 4px;
    font-weight: 600;
    text-transform: uppercase;
  }

  /* MODALS */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(30, 27, 75, 0.9); z-index: 200;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
    backdrop-filter: blur(5px);
    padding: 20px;
  }
  .modal-overlay.show { opacity: 1; pointer-events: auto; }

  .paper-card {
    width: 100%; max-width: 380px;
    background: #fff; padding: 30px 20px; text-align: center;
    border-radius: 24px;
    border: 4px solid var(--ink-blue);
    box-shadow: 10px 10px 0 var(--game-accent);
    transform: rotate(-2deg);
    max-height: 90vh; overflow-y: auto;
    position: relative;
  }

  h1 { margin: 0 0 10px; font-size: 2rem; color: var(--ink-blue); line-height: 1; font-weight: 900; }
  p.sub { color: #64748b; font-size: 0.8rem; margin-bottom: 20px; letter-spacing: 1px; font-weight: 700; text-transform: uppercase; }

  .row { margin-bottom: 15px; text-align: left; }
  label { display: block; font-size: 0.75rem; font-weight: 800; color: var(--ink-blue); margin-bottom: 5px; }
  select {
    width: 100%; padding: 12px; background: #f1f5f9;
    border: 2px solid #cbd5e1; color: var(--ink-blue);
    font-family: var(--font-game); font-size: 1rem; border-radius: 12px; outline: none; font-weight: 600;
  }

  .btn-big {
    width: 100%; padding: 15px;
    background: var(--game-success); color: #fff;
    font-size: 1.2rem; border: 3px solid #065f46; font-weight: 700;
    border-radius: 12px; margin-top: 10px; cursor: pointer;
    box-shadow: 0 4px 0 #065f46;
    transition: transform 0.1s;
  }
  .btn-big:active { transform: translateY(4px); box-shadow: none; }

  /* Stronger Shake Animation */
  .shake-screen { animation: shakeHard 0.5s ease-in-out; }
  @keyframes shakeHard {
    0%, 100% { transform: translate(0, 0); }
    10% { transform: translate(-5px, -5px); }
    30% { transform: translate(5px, 5px); }
    50% { transform: translate(-5px, 5px); }
    70% { transform: translate(5px, -5px); }
    90% { transform: translate(-2px, 2px); }
  }

</style>
</head>
<body>

<!-- BACKGROUND -->
<div class="world-container">
  <canvas id="bgCanvas"></canvas> <!-- Math Rain -->
  <div class="grid-floor"></div>
  <div class="vignette"></div>
</div>
<canvas id="fxCanvas"></canvas> <!-- Confetti -->

<div class="app-shell" id="appShell">
  <!-- HUD -->
  <div class="hud-bar">
    <div class="score-badge">
      <div class="lbl">ƒêI·ªÇM S·ªê</div>
      <div class="val" id="scoreVal">0</div>
    </div>
    <div class="timer-pill">
      <div class="timer-bar" id="timeBar"></div>
      <div class="timer-txt" id="timerVal">60</div>
    </div>
  </div>

  <!-- GAMEPLAY -->
  <div class="game-stage">
    <!-- COMBO -->
    <div class="combo-meter">
      <div class="combo-liquid" id="comboFill"></div>
    </div>
    <div class="combo-text">COMBO</div>

    <!-- FEEDBACK -->
    <div class="feedback-pop" id="feedback">CH√çNH X√ÅC</div>

    <!-- CARDS -->
    <div class="grid-wrap" id="cardGrid"></div>

    <!-- INPUT -->
    <div class="input-slate" id="inputBox">
      <span class="input-val" id="inputTxt"></span>
      <div class="cursor"></div>
    </div>
  </div>

  <!-- CONTROLS & FOOTER -->
  <div class="control-pad">
    <div class="keys-grid">
      <div class="key hint" id="btnHint">üí°</div>
      <div class="key act" id="btnClear">C</div>
      <div class="key act" id="btnBack">‚å´</div>
      <div class="key act" id="btnNeg">+/-</div>

      <div class="key num" data-k="1">1</div>
      <div class="key num" data-k="2">2</div>
      <div class="key num" data-k="3">3</div>
      <div class="key num" data-k="4">4</div>
      <div class="key num" data-k="5">5</div>
      <div class="key num" data-k="6">6</div>
      <div class="key num" data-k="7">7</div>
      <div class="key num" data-k="8">8</div>
      <div class="key num" data-k="9">9</div>
      <div class="key num" data-k="0">0</div>
      
      <button class="key go" id="btnEnter">NH·∫¨P</button>
    </div>
    <!-- B·∫¢N QUY·ªÄN T√ÅC GI·∫¢ IN-GAME -->
    <div class="copyright-footer">
      <b>Th·∫ßy Th√°i Minh Nguy√™n</b> ‚Ä¢ Tr∆∞·ªùng TH, THCS & THPT YERSIN ƒê√Ä L·∫†T
    </div>
  </div>
</div>

<!-- MENUS -->
<div class="modal-overlay show" id="startMenu">
  <div class="paper-card">
    <h1>ARCADE SCHOLAR</h1>
    <p class="sub">CHINH PH·ª§C TO√ÅN H·ªåC</p>
    
    <div class="row">
      <label>CH·ª¶ ƒê·ªÄ</label>
      <select id="modeSel">
        <option value="mixed">H·ªñN H·ª¢P</option>
        <option value="csc">C·∫§P S·ªê C·ªòNG (+)</option>
        <option value="csn">C·∫§P S·ªê NH√ÇN (√ó)</option>
        <option value="fib">FIBONACCI</option>
        <option value="prime">NGUY√äN T·ªê</option>
      </select>
    </div>
    
    <div class="row">
      <label>ƒê·ªò KH√ì</label>
      <select id="diffSel">
        <option value="easy">D·ªÑ (60s)</option>
        <option value="medium">V·ª™A (45s)</option>
        <option value="hard">KH√ì (30s)</option>
      </select>
    </div>
    
    <button class="btn-big" id="startBtn">B·∫ÆT ƒê·∫¶U</button>

    <!-- B·∫¢N QUY·ªÄN T√ÅC GI·∫¢ MENU -->
    <div class="copyright-menu">
      <span class="copy-name">Th·∫ßy Th√°i Minh Nguy√™n</span>
      <small class="copy-school">Tr∆∞·ªùng TH, THCS & THPT YERSIN ƒê√Ä L·∫†T</small>
    </div>
  </div>
</div>

<div class="modal-overlay" id="infoModal">
  <div class="paper-card" style="border-color: var(--game-warn); box-shadow: 10px 10px 0 var(--game-warn);">
    <h1 style="color: var(--game-warn);">G·ª¢I √ù</h1>
    <p id="msgText" style="font-size:24px; color: #1e293b; margin:20px 0; font-family: var(--font-math);">...</p>
    <button class="btn-big" id="closeInfo" style="background:var(--ink-blue); border-color:#0f172a; box-shadow: 0 4px 0 #0f172a;">ƒê√ìNG</button>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// --- AUDIO ---
const SFX = {
  ctx: new (window.AudioContext || window.webkitAudioContext)(),
  play(type, f1, f2, dur, vol=0.1) {
    if(this.ctx.state === 'suspended') this.ctx.resume();
    const osc = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(f1, this.ctx.currentTime);
    if(f2) osc.frequency.exponentialRampToValueAtTime(f2, this.ctx.currentTime + dur);
    g.gain.setValueAtTime(vol, this.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
    osc.connect(g); g.connect(this.ctx.destination);
    osc.start(); osc.stop(this.ctx.currentTime + dur);
  },
  tap() { this.play('triangle', 600, 300, 0.05); },
  win() { this.play('sine', 500, 1000, 0.1); setTimeout(()=>this.play('triangle', 800, 1200, 0.2), 100); },
  lose() { this.play('sawtooth', 150, 50, 0.3); },
  alert() { this.play('square', 600, 600, 0.1, 0.2); }
};

// --- VISUAL FX ---
const FX = {
  bg: $('#bgCanvas').getContext('2d'),
  fg: $('#fxCanvas').getContext('2d'),
  rain: [], sparks: [],
  
  init() {
    this.resize(); window.onresize = () => this.resize();
    // Initialize Math Rain
    const symbols = ['+', '-', '√ó', '√∑', '‚àë', 'œÄ', '‚àö', '‚àû'];
    for(let i=0; i<40; i++) {
      this.rain.push({
        x: Math.random() * window.innerWidth,
        y: Math.random() * window.innerHeight,
        txt: symbols[Math.floor(Math.random() * symbols.length)],
        size: Math.random() * 20 + 10,
        speed: Math.random() * 1.5 + 0.5
      });
    }
    this.loop();
  },
  
  resize() {
    [$('#bgCanvas'), $('#fxCanvas')].forEach(c => {
      c.width = window.innerWidth; c.height = window.innerHeight;
    });
  },

  confetti(x, y) {
    const colors = ['#e11d48', '#059669', '#d97706', '#2563eb'];
    for(let i=0; i<40; i++) {
      this.sparks.push({
        x, y, 
        vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*20,
        life: 1, size: Math.random()*8+4,
        color: colors[Math.floor(Math.random()*colors.length)]
      });
    }
  },

  loop() {
    // 1. Math Rain (Background)
    const b = this.bg;
    b.clearRect(0,0,b.canvas.width, b.canvas.height);
    b.fillStyle = '#1e1b4b'; 
    b.font = 'bold 20px serif'; // Fallback
    
    this.rain.forEach(p => {
      p.y += p.speed;
      if(p.y > b.canvas.height) p.y = -50;
      b.globalAlpha = 0.15; 
      b.font = `bold ${p.size}px 'Merriweather', serif`;
      b.fillText(p.txt, p.x, p.y);
    });

    // 2. Confetti (Foreground)
    const f = this.fg;
    f.clearRect(0,0,f.canvas.width, f.canvas.height);
    for(let i=this.sparks.length-1; i>=0; i--) {
      let p = this.sparks[i];
      p.x += p.vx; p.y += p.vy; p.vy += 0.5; // gravity
      p.life -= 0.02;
      
      f.globalAlpha = Math.max(0, p.life);
      f.fillStyle = p.color;
      
      f.save();
      f.translate(p.x, p.y);
      f.rotate(p.life * 5); // spin
      f.fillRect(-p.size/2, -p.size/2, p.size, p.size);
      f.restore();
      
      if(p.life <= 0) this.sparks.splice(i,1);
    }
    
    requestAnimationFrame(()=>this.loop());
  }
};

// --- LOGIC ---
const Logic = {
  isPrime: n => { if(n<2)return false; for(let i=2;i*i<=n;i++)if(n%i===0)return false; return true; },
  nextPrime: n => { let x=n+1; while(!Logic.isPrime(x)) x++; return x; },
  gen: (mode, diff) => {
    let m = mode === 'mixed' ? ['csc','csn','fib','prime'][rand(0,3)] : mode;
    let seq = [], ans = 0, hint = "";
    const len = 5;
    
    if(m==='csc') {
      let d = rand(2,10)*(Math.random()>.5?1:-1), s = rand(10,50);
      for(let i=0;i<len;i++) seq.push(s+i*d); ans=s+len*d; hint=`Quy lu·∫≠t: C·ªông th√™m ${d}`;
    } else if(m==='csn') {
      let q = rand(2,3), s = rand(1,5);
      for(let i=0;i<len;i++) seq.push(s*Math.pow(q,i)); ans=s*Math.pow(q,len); hint=`Quy lu·∫≠t: Nh√¢n th√™m ${q}`;
    } else if(m==='fib') {
      let a=rand(1,5), b=rand(a,a+5); seq=[a,b];
      for(let i=2;i<len;i++) seq.push(seq[i-1]+seq[i-2]); ans=seq[len-1]+seq[len-2]; hint="Fibonacci: T·ªïng 2 s·ªë li·ªÅn tr∆∞·ªõc";
    } else {
      let p=rand(2,50); while(!Logic.isPrime(p)) p++; seq.push(p);
      for(let i=1;i<len;i++) seq.push(Logic.nextPrime(seq[i-1])); ans=Logic.nextPrime(seq[len-1]); hint="D√£y s·ªë nguy√™n t·ªë tƒÉng d·∫ßn";
    }
    return { seq, ans, hint };
  }
};

// --- GAME ---
const Game = {
  state: { score: 0, time: 0, maxT: 60, input: "", playing: false, combo: 0 },
  q: null, fbTimer: null,

  init() {
    FX.init();
    
    $$('.key.num').forEach(b => {
      b.onclick = () => this.type(b.dataset.k);
    });
    
    $('#btnBack').onclick = () => this.del();
    $('#btnClear').onclick = () => this.clr();
    $('#btnNeg').onclick = () => this.neg();
    $('#btnEnter').onclick = () => this.check();
    $('#startBtn').onclick = () => this.start();
    $('#btnHint').onclick = () => this.hint();
    $('#closeInfo').onclick = () => $('#infoModal').classList.remove('show');
  },

  type(k) { 
    if(this.state.input.length < 8) this.state.input += k; 
    this.ui(); SFX.tap();
  },
  del() { this.state.input = this.state.input.slice(0,-1); this.ui(); SFX.tap(); },
  clr() { this.state.input = ""; this.ui(); SFX.tap(); },
  neg() { 
    this.state.input = this.state.input.startsWith('-') ? this.state.input.slice(1) : '-' + this.state.input;
    this.ui(); SFX.tap(); 
  },
  ui() { 
    $('#inputTxt').innerText = this.state.input; 
  },

  start() {
    $('#startMenu').classList.remove('show');
    this.state.score = 0; this.state.combo = 0; this.state.playing = true;
    this.state.maxT = $('#diffSel').value==='easy'?60:($('#diffSel').value==='medium'?45:30);
    $('#scoreVal').innerText = "0";
    this.updateCombo();
    this.next(); this.loop();
  },

  next() {
    this.q = Logic.gen($('#modeSel').value, $('#diffSel').value);
    this.state.time = this.state.maxT;
    this.state.input = ""; this.ui();
    
    $('#feedback').classList.remove('show');
    if(this.fbTimer) clearTimeout(this.fbTimer);

    const g = $('#cardGrid'); g.innerHTML = '';
    this.q.seq.forEach((n,i) => {
      let d = document.createElement('div');
      d.className = 'math-tile'; d.innerText = n;
      g.appendChild(d);
    });
    let qm = document.createElement('div');
    qm.className = 'math-tile q'; qm.innerText = '?';
    g.appendChild(qm);
  },

  check() {
    if(!this.state.playing) return;
    let v = parseInt(this.state.input);
    if(isNaN(v)) return;

    if(v === this.q.ans) {
      SFX.win();
      this.state.combo = Math.min(this.state.combo + 1, 10);
      let bonus = this.state.combo * 2;
      this.state.score += 10 + bonus;
      
      $('#scoreVal').innerText = this.state.score;
      this.msg(`CH√çNH X√ÅC! +${10+bonus}`, "#10b981");
      
      const rect = $('.game-stage').getBoundingClientRect();
      FX.confetti(rect.left+rect.width/2, rect.top+rect.height/2);
      
      setTimeout(() => this.next(), 1000);
    } else {
      SFX.lose();
      this.state.combo = 0;
      this.state.time -= 5;
      this.msg("SAI R·ªíI (-5s)", "#f43f5e", 1500);
      
      // Stronger Screen Shake
      $('#appShell').classList.add('shake-screen');
      setTimeout(()=>$('#appShell').classList.remove('shake-screen'), 500);
      
      this.state.input = ""; this.ui();
    }
    this.updateCombo();
  },

  updateCombo() {
    $('#comboFill').style.height = (this.state.combo * 10) + '%';
  },

  hint() {
    if(this.state.score >= 2) {
      this.state.score -= 2;
      $('#scoreVal').innerText = this.state.score;
      $('#msgText').innerText = this.q.hint;
      $('#infoModal').classList.add('show');
    } else {
      SFX.alert();
      this.msg("THI·∫æU ƒêI·ªÇM", "#f59e0b", 1500);
    }
  },

  msg(t, col, autoHide=0) {
    if(this.fbTimer) clearTimeout(this.fbTimer);
    
    let el = $('#feedback');
    el.innerText = t; el.style.backgroundColor = col;
    el.classList.add('show');
    
    if(autoHide > 0) {
      this.fbTimer = setTimeout(() => {
        el.classList.remove('show');
      }, autoHide);
    }
  },

  loop() {
    if(!this.state.playing) return;
    this.state.time -= 0.05;
    
    $('#timerVal').innerText = Math.ceil(this.state.time);
    $('#timeBar').style.width = (this.state.time / this.state.maxT * 100) + '%';
    
    if(this.state.time < 10) $('#timeBar').style.background = '#f43f5e';
    else $('#timeBar').style.background = '#10b981';

    if(this.state.time <= 0) {
      this.state.playing = false;
      $('#startMenu').classList.add('show');
      $('h1').innerText = "H·∫æT GI·ªú";
      $('.sub').innerText = `T·ªîNG ƒêI·ªÇM: ${this.state.score}`;
      $('#startBtn').innerText = "CH∆†I L·∫†I";
    } else {
      setTimeout(() => this.loop(), 50);
    }
  }
};

window.onload = () => Game.init();
</script>
</body>
</html>
