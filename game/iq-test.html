<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Math Genius: Quantum Realm</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bruno+Ace+SC&family=Chakra+Petch:wght@400;600;700&display=swap');

  :root {
    --bg-void: #0a0515;
    --q-cyan: #00f0ff;
    --q-purple: #bc13fe;
    --q-pink: #ff0055;
    --q-gold: #ffd700;
    --glass-surf: rgba(25, 10, 40, 0.6);
    --border-glow: rgba(188, 19, 254, 0.5);
    --font-head: 'Bruno Ace SC', cursive;
    --font-body: 'Chakra Petch', sans-serif;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

  body {
    margin: 0; padding: 0;
    background-color: var(--bg-void);
    color: #fff;
    font-family: var(--font-body);
    height: 100vh; height: 100dvh;
    overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* --- LAYERS --- */
  .abs-fill { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
  
  #voidCanvas { z-index: 0; } /* Background Animation */
  #partCanvas { z-index: 50; } /* Foreground Sparks */

  /* GRID FLOOR (Perspective) */
  .quantum-grid {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 45%;
    background: linear-gradient(180deg, transparent 0%, rgba(188, 19, 254, 0.15) 100%);
    perspective: 800px; z-index: 1; pointer-events: none; overflow: hidden;
  }
  .grid-mesh {
    width: 200%; height: 200%; margin-left: -50%;
    background-image: 
      linear-gradient(rgba(188, 19, 254, 0.3) 1px, transparent 1px),
      linear-gradient(90deg, rgba(188, 19, 254, 0.3) 1px, transparent 1px);
    background-size: 60px 60px;
    transform: rotateX(70deg) translateY(0);
    transform-origin: 50% 100%;
    animation: warpGrid 4s linear infinite;
    mask-image: linear-gradient(to bottom, transparent 0%, black 50%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 50%);
  }
  @keyframes warpGrid { from { background-position: 0 0; } to { background-position: 0 60px; } }

  /* UI SHELL */
  .quantum-shell {
    position: relative; z-index: 10;
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    padding-bottom: env(safe-area-inset-bottom);
    background: radial-gradient(circle at top, transparent 0%, #000 120%);
  }

  /* 1. HUD */
  .hud-strip {
    flex: 0 0 auto;
    padding: max(15px, env(safe-area-inset-top)) 20px 10px;
    display: flex; justify-content: space-between; align-items: center;
  }

  .stat-block {
    background: linear-gradient(90deg, rgba(188,19,254,0.2), transparent);
    border-left: 3px solid var(--q-purple);
    padding: 5px 15px;
    display: flex; flex-direction: column;
  }
  .stat-lbl { font-size: 10px; color: var(--q-cyan); letter-spacing: 2px; }
  .stat-val { font-family: var(--font-head); font-size: 24px; color: #fff; text-shadow: 0 0 10px var(--q-purple); }

  .timer-diamond {
    width: 50px; height: 50px;
    transform: rotate(45deg);
    border: 2px solid rgba(255,255,255,0.1);
    box-shadow: 0 0 10px rgba(188,19,254,0.3);
    display: grid; place-items: center;
    position: relative;
  }
  .timer-diamond::before {
    content:''; position: absolute; top:2px; left:2px; right:2px; bottom:2px;
    border: 2px solid var(--q-cyan);
    opacity: 0; transition: opacity 0.3s;
  }
  .timer-diamond.low::before { opacity: 1; border-color: var(--q-pink); animation: blink fast 0.5s infinite; }
  .timer-num { transform: rotate(-45deg); font-weight: bold; font-size: 18px; }

  /* 2. GAME AREA */
  .play-zone {
    flex: 1;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    position: relative;
  }

  /* Feedback Text */
  .feedback-msg {
    position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%) scale(0);
    font-family: var(--font-head); font-size: 40px; font-weight: 900;
    color: #fff; text-shadow: 0 0 20px currentColor;
    pointer-events: none; opacity: 0; z-index: 100; white-space: nowrap;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .feedback-msg.show { opacity: 1; transform: translate(-50%, -80%) scale(1.2); }

  /* Hexagon Cards Container */
  .hex-grid {
    display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
    width: 100%; max-width: 600px; padding: 10px; margin-bottom: 20px;
  }

  .hex-card {
    width: 60px; height: 70px;
    background: var(--glass-surf);
    position: relative;
    display: flex; justify-content: center; align-items: center;
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    font-family: var(--font-head); font-size: 22px; color: #fff;
    transition: transform 0.3s;
    backdrop-filter: blur(5px);
    box-shadow: inset 0 0 20px rgba(188, 19, 254, 0.2);
    animation: hexFloat 4s ease-in-out infinite;
  }
  /* Border hack for clip-path */
  .hex-card::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    box-shadow: inset 0 0 0 2px rgba(0, 240, 255, 0.3);
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
  }
  
  .hex-card:nth-child(odd) { animation-delay: 0.5s; }
  @keyframes hexFloat { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-5px);} }

  .hex-card.q {
    color: var(--q-gold);
    animation: hexPulse 1s infinite alternate;
  }
  .hex-card.q::after { background: rgba(255, 215, 0, 0.1); box-shadow: inset 0 0 0 2px var(--q-gold); }
  @keyframes hexPulse { to { transform: scale(1.05); text-shadow: 0 0 10px var(--q-gold); } }

  /* Input Display */
  .input-prism {
    width: 260px; height: 60px;
    background: linear-gradient(90deg, transparent, rgba(0,0,0,0.8), transparent);
    border-top: 1px solid var(--q-cyan);
    border-bottom: 1px solid var(--q-cyan);
    display: flex; justify-content: center; align-items: center;
    position: relative;
  }
  .input-val { font-family: var(--font-head); font-size: 32px; color: var(--q-cyan); letter-spacing: 3px; }
  .input-cursor { width: 10px; height: 2px; background: var(--q-cyan); position: absolute; bottom: 10px; animation: blink 0.8s infinite; }
  @keyframes blink { 50% { opacity: 0; } }

  /* 3. CONTROLS */
  .control-pad {
    flex: 0 0 auto;
    background: rgba(10, 5, 20, 0.9);
    border-top: 2px solid var(--q-purple);
    padding: 15px; padding-bottom: max(20px, env(safe-area-inset-bottom));
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
    box-shadow: 0 -10px 40px rgba(188, 19, 254, 0.2);
  }

  .btn {
    height: 55px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff; font-family: var(--font-head); font-size: 20px;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; position: relative;
    clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
    transition: all 0.1s;
  }
  .btn:active { background: rgba(188, 19, 254, 0.3); border-color: var(--q-purple); transform: scale(0.95); }
  
  .btn.hint { color: var(--q-gold); border-color: rgba(255, 215, 0, 0.3); font-size: 22px; }
  .btn.act { color: var(--q-pink); border-color: rgba(255, 0, 85, 0.3); font-size: 16px; }
  
  .btn.go {
    grid-column: span 2;
    background: linear-gradient(90deg, var(--q-purple), var(--q-cyan));
    color: #000; font-weight: 900; border: none;
    clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
  }
  .btn.go:active { filter: brightness(1.2); }

  /* 4. MODALS */
  .modal-wrap {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 200;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
    backdrop-filter: blur(10px);
  }
  .modal-wrap.active { opacity: 1; pointer-events: auto; }

  .quantum-card {
    width: 90%; max-width: 380px;
    background: #05020a;
    border: 1px solid var(--q-purple);
    box-shadow: 0 0 60px rgba(188, 19, 254, 0.2);
    padding: 30px; text-align: center;
    position: relative;
  }
  .quantum-card::after {
    content:''; position: absolute; top:-5px; left:-5px; right:-5px; bottom:-5px;
    border: 1px solid var(--q-cyan); opacity: 0.3; pointer-events: none;
  }

  h1 { font-family: var(--font-head); color: var(--q-cyan); margin: 0 0 10px; font-size: 26px; text-transform: uppercase; }
  p.sub { color: #888; font-size: 12px; margin-bottom: 25px; letter-spacing: 3px; }

  .q-row { margin-bottom: 20px; text-align: left; }
  label { color: var(--q-purple); font-size: 11px; display: block; margin-bottom: 8px; font-weight: bold; letter-spacing: 1px; }
  select {
    width: 100%; padding: 12px; background: rgba(255,255,255,0.05);
    border: 1px solid #333; color: #fff; font-family: var(--font-body); font-size: 16px; outline: none;
  }

  .btn-launch {
    width: 100%; padding: 15px;
    background: var(--q-cyan); color: #000;
    font-family: var(--font-head); font-weight: 700; font-size: 18px; border: none;
    cursor: pointer; margin-top: 15px;
    clip-path: polygon(15px 0, 100% 0, 100% 100%, 0 100%, 0 15px);
    transition: transform 0.1s;
  }
  .btn-launch:active { transform: scale(0.98); background: #fff; }

  /* Message Box */
  #msgText { color: #fff; font-size: 16px; line-height: 1.6; margin: 20px 0; min-height: 40px; }

</style>
</head>
<body>

<!-- BACKGROUND -->
<div class="abs-fill" id="voidContainer">
  <canvas id="voidCanvas"></canvas>
  <div class="quantum-grid"><div class="grid-mesh"></div></div>
</div>

<div class="quantum-shell">
  <!-- HUD -->
  <div class="hud-strip">
    <div class="stat-block">
      <span class="stat-lbl">SCORE</span>
      <span class="stat-val" id="scoreVal">0</span>
    </div>
    <div class="timer-diamond" id="timerBox">
      <span class="timer-num" id="timerVal">60</span>
    </div>
  </div>

  <!-- GAMEPLAY -->
  <div class="play-zone">
    <!-- Feedback Text -->
    <div class="feedback-msg" id="feedback">PERFECT</div>

    <!-- Cards -->
    <div class="hex-grid" id="cardGrid"></div>

    <!-- Display -->
    <div class="input-prism" id="inputBox">
      <span class="input-val" id="inputTxt"></span>
      <div class="input-cursor"></div>
    </div>
  </div>

  <!-- KEYPAD -->
  <div class="control-pad">
    <div class="btn hint" id="btnHint">üí°</div>
    <div class="btn act" id="btnClear">C</div>
    <div class="btn act" id="btnBack">‚å´</div>
    <div class="btn act" id="btnNeg">+/-</div>

    <div class="btn num" data-k="1">1</div>
    <div class="btn num" data-k="2">2</div>
    <div class="btn num" data-k="3">3</div>
    <div class="btn num" data-k="4">4</div>
    <div class="btn num" data-k="5">5</div>
    <div class="btn num" data-k="6">6</div>
    <div class="btn num" data-k="7">7</div>
    <div class="btn num" data-k="8">8</div>
    <div class="btn num" data-k="9">9</div>
    <div class="btn num" data-k="0">0</div>
    
    <button class="btn go" id="btnEnter">EXECUTE</button>
  </div>
</div>

<!-- START MENU -->
<div class="modal-wrap active" id="menuModal">
  <div class="quantum-card">
    <h1>QUANTUM REALM</h1>
    <p class="sub">MATH GENIUS EDITION</p>
    
    <div class="q-row">
      <label>MODE</label>
      <select id="modeSel">
        <option value="mixed">H·ªñN H·ª¢P (MIXED)</option>
        <option value="csc">C·ªòNG (+)</option>
        <option value="csn">NH√ÇN (√ó)</option>
        <option value="fib">FIBONACCI</option>
        <option value="prime">NGUY√äN T·ªê</option>
      </select>
    </div>
    
    <div class="q-row">
      <label>DIFFICULTY</label>
      <select id="diffSel">
        <option value="easy">D·ªÑ (60s)</option>
        <option value="medium">V·ª™A (45s)</option>
        <option value="hard">KH√ì (30s)</option>
      </select>
    </div>
    
    <button class="btn-launch" id="startBtn">KH·ªûI ƒê·ªòNG</button>
  </div>
</div>

<!-- INFO MODAL -->
<div class="modal-wrap" id="infoModal">
  <div class="quantum-card" style="border-color: var(--q-gold);">
    <h1 style="color: var(--q-gold);">G·ª¢I √ù</h1>
    <p id="msgText">...</p>
    <button class="btn-launch" id="closeInfo" style="background:#333; color:#fff;">ƒê√ìNG</button>
  </div>
</div>

<!-- PARTICLES -->
<canvas id="partCanvas" class="abs-fill"></canvas>

<script>
// --- UTILS ---
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// --- AUDIO ---
const SFX = {
  ctx: new (window.AudioContext || window.webkitAudioContext)(),
  play(type, f1, f2, dur, vol=0.1) {
    if(this.ctx.state === 'suspended') this.ctx.resume();
    const osc = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(f1, this.ctx.currentTime);
    if(f2) osc.frequency.exponentialRampToValueAtTime(f2, this.ctx.currentTime + dur);
    g.gain.setValueAtTime(vol, this.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
    osc.connect(g); g.connect(this.ctx.destination);
    osc.start(); osc.stop(this.ctx.currentTime + dur);
  },
  tap() { this.play('triangle', 600, 300, 0.05); },
  win() { this.play('sine', 400, 800, 0.1); setTimeout(()=>this.play('square',800,1200,0.2), 100); },
  lose() { this.play('sawtooth', 150, 50, 0.3); },
  alert() { this.play('square', 800, 400, 0.1, 0.2); }
};

// --- VFX ---
const VFX = {
  void: { cvs:$('#voidCanvas'), ctx:$('#voidCanvas').getContext('2d'), parts:[] },
  fg: { cvs:$('#partCanvas'), ctx:$('#partCanvas').getContext('2d'), sparks:[] },
  
  init() {
    this.resize(); window.onresize = () => this.resize();
    // Background Particles
    for(let i=0; i<80; i++) {
      this.void.parts.push({
        x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight,
        r: Math.random()*1.5, a: Math.random()*0.5+0.1,
        vy: Math.random()*0.5+0.1
      });
    }
    this.loop();
  },
  
  resize() {
    [this.void, this.fg].forEach(l => {
      l.cvs.width = window.innerWidth; l.cvs.height = window.innerHeight;
    });
  },

  burst(x, y, color) {
    for(let i=0; i<30; i++) {
      this.fg.sparks.push({
        x, y, color, vx:(Math.random()-.5)*12, vy:(Math.random()-.5)*12, life:1, size:Math.random()*4+1
      });
    }
  },

  loop() {
    // 1. Void BG
    const vc = this.void.ctx;
    vc.clearRect(0,0,this.void.cvs.width, this.void.cvs.height);
    vc.fillStyle = '#bc13fe';
    this.void.parts.forEach(p => {
      p.y -= p.vy;
      if(p.y < 0) { p.y = this.void.cvs.height; p.x = Math.random()*this.void.cvs.width; }
      vc.globalAlpha = p.a;
      vc.beginPath(); vc.arc(p.x, p.y, p.r, 0, Math.PI*2); vc.fill();
    });

    // 2. FG Sparks
    const fc = this.fg.ctx;
    fc.clearRect(0,0,this.fg.cvs.width, this.fg.cvs.height);
    fc.globalCompositeOperation = 'lighter';
    for(let i=this.fg.sparks.length-1; i>=0; i--) {
      let p = this.fg.sparks[i];
      p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.03;
      fc.globalAlpha = Math.max(0, p.life);
      fc.fillStyle = p.color;
      fc.beginPath(); fc.arc(p.x, p.y, p.size, 0, Math.PI*2); fc.fill();
      if(p.life <= 0) this.fg.sparks.splice(i,1);
    }
    
    requestAnimationFrame(() => this.loop());
  }
};

// --- LOGIC ---
const Logic = {
  isPrime: n => { if(n<2)return false; for(let i=2;i*i<=n;i++)if(n%i===0)return false; return true; },
  nextPrime: n => { let x=n+1; while(!Logic.isPrime(x)) x++; return x; },
  gen: (mode, diff) => {
    let m = mode === 'mixed' ? ['csc','csn','fib','prime'][rand(0,3)] : mode;
    let seq = [], ans = 0, hint = "";
    const len = 5;
    
    if(m==='csc') {
      let d = rand(2,10)*(Math.random()>.5?1:-1), s = rand(10,50);
      for(let i=0;i<len;i++) seq.push(s+i*d); ans=s+len*d; hint=`C·ªông th√™m ${d}`;
    } else if(m==='csn') {
      let q = rand(2,3), s = rand(1,5);
      for(let i=0;i<len;i++) seq.push(s*Math.pow(q,i)); ans=s*Math.pow(q,len); hint=`Nh√¢n th√™m ${q}`;
    } else if(m==='fib') {
      let a=rand(1,5), b=rand(a,a+5); seq=[a,b];
      for(let i=2;i<len;i++) seq.push(seq[i-1]+seq[i-2]); ans=seq[len-1]+seq[len-2]; hint="Fibonacci: T·ªïng 2 s·ªë tr∆∞·ªõc";
    } else {
      let p=rand(2,50); while(!Logic.isPrime(p)) p++; seq.push(p);
      for(let i=1;i<len;i++) seq.push(Logic.nextPrime(seq[i-1])); ans=Logic.nextPrime(seq[len-1]); hint="Nguy√™n t·ªë ti·∫øp theo";
    }
    return { seq, ans, hint };
  }
};

// --- GAME ---
const Game = {
  state: { score: 0, time: 0, maxT: 60, input: "", playing: false },
  q: null,

  init() {
    VFX.init();
    
    $$('.btn.num').forEach(b => {
      b.addEventListener('touchstart', () => b.style.background = 'rgba(188,19,254,0.3)');
      b.addEventListener('touchend', () => b.style.background = '');
      b.onclick = () => this.type(b.dataset.k);
    });
    $('#btnBack').onclick = () => this.del();
    $('#btnClear').onclick = () => this.clr();
    $('#btnNeg').onclick = () => this.neg();
    $('#btnEnter').onclick = () => this.check();
    $('#startBtn').onclick = () => this.start();
    $('#btnHint').onclick = () => this.hint();
    $('#closeInfo').onclick = () => $('#infoModal').classList.remove('active');
  },

  type(k) { 
    if(this.state.input.length < 8) this.state.input += k; 
    this.ui(); SFX.tap();
  },
  del() { this.state.input = this.state.input.slice(0,-1); this.ui(); SFX.tap(); },
  clr() { this.state.input = ""; this.ui(); SFX.tap(); },
  neg() { 
    this.state.input = this.state.input.startsWith('-') ? this.state.input.slice(1) : '-' + this.state.input;
    this.ui(); SFX.tap(); 
  },
  ui() { $('#inputTxt').innerText = this.state.input; },

  start() {
    $('#menuModal').classList.remove('active');
    this.state.score = 0; this.state.playing = true;
    this.state.maxT = $('#diffSel').value==='easy'?60:($('#diffSel').value==='medium'?45:30);
    this.next(); this.loop();
  },

  next() {
    this.q = Logic.gen($('#modeSel').value, $('#diffSel').value);
    this.state.time = this.state.maxT;
    this.state.input = ""; this.ui();
    
    // FIX: Hide previous feedback immediately when next question starts
    $('#feedback').classList.remove('show');

    const g = $('#cardGrid'); g.innerHTML = '';
    this.q.seq.forEach(n => {
      let d = document.createElement('div');
      d.className = 'hex-card'; d.innerText = n;
      g.appendChild(d);
    });
    let qm = document.createElement('div');
    qm.className = 'hex-card q'; qm.innerText = '?';
    g.appendChild(qm);
  },

  check() {
    if(!this.state.playing) return;
    let v = parseInt(this.state.input);
    if(isNaN(v)) return;

    if(v === this.q.ans) {
      SFX.win();
      this.state.score += 10 + Math.ceil(this.state.time/5);
      $('#scoreVal').innerText = this.state.score;
      this.msg("CH√çNH X√ÅC", "#00ff9d");
      
      const rect = $('.play-zone').getBoundingClientRect();
      VFX.burst(rect.left+rect.width/2, rect.top+rect.height/2, '#00ff9d');
      
      setTimeout(() => this.next(), 1000);
    } else {
      SFX.lose();
      this.state.time -= 5;
      this.msg("SAI R·ªíI", "#ff0055");
      $('#inputBox').style.borderColor = '#ff0055';
      setTimeout(()=>$('#inputBox').style.borderColor='', 300);
      this.state.input = ""; this.ui();
    }
  },

  hint() {
    if(this.state.score >= 2) {
      this.state.score -= 2;
      $('#scoreVal').innerText = this.state.score;
      $('#msgText').innerText = this.q.hint;
      $('#infoModal').classList.add('active');
    } else {
      SFX.alert();
      this.msg("C·∫¶N 2 ƒêI·ªÇM", "#ffd700");
    }
  },

  msg(t, c) {
    let el = $('#feedback');
    el.innerText = t; el.style.color = c; el.style.textShadow = `0 0 20px ${c}`;
    // Force restart animation
    el.classList.remove('show');
    void el.offsetWidth; // trigger reflow
    el.classList.add('show');
  },

  loop() {
    if(!this.state.playing) return;
    this.state.time -= 0.05;
    
    $('#timerVal').innerText = Math.ceil(this.state.time);
    
    if(this.state.time < 10) $('#timerBox').classList.add('low');
    else $('#timerBox').classList.remove('low');

    if(this.state.time <= 0) {
      this.state.playing = false;
      $('#menuModal').classList.add('active');
      $('#menuModal h1').innerText = "H·∫æT GI·ªú";
      $('#startBtn').innerText = "CH∆†I L·∫†I";
    } else {
      setTimeout(() => this.loop(), 50);
    }
  }
};

window.onload = () => Game.init();
</script>
</body>
</html>
