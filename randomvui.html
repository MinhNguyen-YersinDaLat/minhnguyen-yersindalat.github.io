<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ch·ªçn H·ªçc Sinh Ng·∫´u Nhi√™n - Game Th√∫ Cute</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
  body {
    margin:0; padding:0;
    font-family: 'Fredoka One', cursive, Arial, sans-serif;
    background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
    display: flex; flex-direction: column; align-items: center; min-height: 100vh;
    color: #333;
  }
  header {
    margin-top: 20px;
    text-align: center;
  }
  header h1 {
    font-size: 2.8rem;
    color: #ef476f;
    margin-bottom: 5px;
  }
  header p {
    font-size: 1.1rem;
    color: #555;
  }
  #inputArea {
    margin: 20px auto;
    width: 90%; max-width: 600px;
    text-align: center;
  }
  #inputNames {
    width: 100%;
    height: 110px;
    font-size: 1.1rem;
    padding: 10px;
    border-radius: 12px;
    border: 2px solid #ef476f;
    resize: vertical;
  }
  #btnStart, #btnNext {
    background: #06d6a0;
    color: white;
    border:none;
    padding: 14px 30px;
    font-size: 1.3rem;
    margin-top: 12px;
    border-radius: 24px;
    cursor: pointer;
    box-shadow: 0 6px 10px rgb(6 214 160 / 0.4);
    transition: background-color 0.3s ease;
  }
  #btnStart:hover, #btnNext:hover {
    background: #059b6b;
  }
  #gameArea {
    margin-top: 30px;
    max-width: 1000px;
    width: 95vw;
    min-height: 400px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
  }
  .animal-card {
    position: relative;
    width: 80px;
    height: 80px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 4px 8px rgb(0 0 0 / 0.15);
    display: flex; justify-content: center; align-items: center;
    flex-direction: column;
    user-select: none;
    cursor: default;
    transition: transform 0.3s ease, filter 0.3s ease;
  }
  .animal-icon {
    font-size: 3.5rem;
    line-height: 1;
  }
  .animal-name {
    margin-top: 4px;
    font-weight: 700;
    font-size: 0.9rem;
    color: #333;
    user-select: text;
  }
  /* Khi ƒë∆∞·ª£c ch·ªçn */
  .winner {
    z-index: 1000;
    position: fixed !important;
    top: 50%;
    left: 50%;
    width: 320px !important;
    height: 320px !important;
    margin-left: -160px;
    margin-top: -160px;
    background: #fff;
    border-radius: 50%;
    box-shadow:
      0 0 20px #ef476f,
      0 0 40px #ef476f,
      0 0 60px #ef476f,
      0 0 80px #ef476f;
    font-size: 12rem !important;
    line-height: 1;
    display: flex !important;
    justify-content: center;
    align-items: center;
    animation: spinAndGlow 3s linear infinite;
    filter: drop-shadow(0 0 10px #ef476f);
  }
  .winner-name {
    position: fixed;
    top: 65%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 3rem;
    font-weight: 900;
    color: #ef476f;
    text-shadow: 0 0 6px #ef476f;
    user-select: none;
    letter-spacing: 3px;
  }
  /* Hi·ªáu ·ª©ng xoay v√† ph√°t s√°ng */
  @keyframes spinAndGlow {
    0% {
      transform: rotate(0deg);
      filter: drop-shadow(0 0 5px #ef476f);
    }
    50% {
      transform: rotate(180deg);
      filter: drop-shadow(0 0 20px #ef476f);
    }
    100% {
      transform: rotate(360deg);
      filter: drop-shadow(0 0 5px #ef476f);
    }
  }
  /* L√†m m·ªù nh·ªØng con c√≤n l·∫°i khi c√≥ winner */
  .dimmed {
    filter: brightness(0.5) blur(1px);
    transition: filter 0.5s ease;
  }
  /* Hi·ªáu ·ª©ng nh·∫£y l·ªôn x·ªôn cho animal-card */
  .jumping {
    animation: jump 0.6s ease infinite alternate;
  }
  @keyframes jump {
    0% { transform: translateY(0); }
    100% { transform: translateY(-15px); }
  }
  /* Icons to√°n bay bay */
  .math-icon {
    position: fixed;
    font-size: 2.4rem;
    user-select: none;
    animation: floatUp 8s linear infinite;
    opacity: 0.7;
    pointer-events: none;
  }
  @keyframes floatUp {
    0% {
      transform: translateY(100vh) rotate(0deg);
      opacity: 0.7;
    }
    100% {
      transform: translateY(-20vh) rotate(360deg);
      opacity: 0;
    }
  }
  /* Responsive */
  @media (max-width: 720px) {
    .animal-card {
      width: 60px;
      height: 60px;
    }
    .animal-icon {
      font-size: 2.5rem;
    }
    .winner {
      width: 240px !important;
      height: 240px !important;
      margin-left: -120px;
      margin-top: -120px;
      font-size: 9rem !important;
    }
    .winner-name {
      font-size: 2.2rem;
      top: 60%;
    }
  }
  /* Scroll l·ªãch s·ª≠ */
  #historyArea {
    max-width: 600px;
    margin: 20px auto 40px;
    padding: 12px;
    background: #f7f7f7;
    border-radius: 15px;
    height: 160px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9rem;
    color: #666;
  }
  /* N√∫t b·∫≠t t·∫Øt √¢m thanh */
  #soundToggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #ef476f;
    color: white;
    border: none;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1100;
    transition: background-color 0.3s;
  }
  #soundToggle:hover {
    background: #c43d63;
  }
</style>
</head>
<body>

<header>
  <h1>üéâ Game ch·ªçn h·ªçc sinh d·ªÖ th∆∞∆°ng</h1>
  <p>Nh·∫≠p t√™n h·ªçc sinh, r·ªìi b·∫•m "B·∫Øt ƒë·∫ßu" ƒë·ªÉ ch·ªçn ng·∫´u nhi√™n!</p>
</header>

<div id="inputArea">
  <textarea id="inputNames" placeholder="Nh·∫≠p t√™n h·ªçc sinh, m·ªói t√™n m·ªôt d√≤ng (t·ªëi ƒëa 50)" maxlength="500"></textarea><br/>
  <button id="btnStart">üöÄ B·∫Øt ƒë·∫ßu</button>
  <button id="btnNext" style="display:none;">‚ñ∂Ô∏è Ti·∫øp t·ª•c (b·ªè ng∆∞·ªùi th·∫Øng)</button>
</div>

<div id="gameArea"></div>
<div id="winnerName" class="winner-name" style="display:none;"></div>
<div id="historyArea" aria-label="L·ªãch s·ª≠ k·∫øt qu·∫£ ch·ªçn h·ªçc sinh">L·ªãch s·ª≠ k·∫øt qu·∫£:</div>

<button id="soundToggle" title="B·∫≠t/T·∫Øt √¢m thanh">üîä</button>

<script>
  // List icon th√∫ d·ªÖ th∆∞∆°ng (Emoji)
  const animalIcons = [
    'üê∞','üêª','üêº','üê®','üêØ','ü¶ä','üêµ','üê∏','üê∑','üêî',
    'ü¶Ñ','üêù','üêô','ü¶â','üê¢','üêß','ü¶Å','üê¨','üê¥','üê∂',
    'üêπ','üê∞','ü¶ã','üêû','üêõ','ü¶Ñ','üêó','ü¶¢','üêü','üê¥',
    'ü¶ú','üêì','üêï','üêà','ü¶ö','üê≤','ü¶ï','ü¶ñ','üêâ','üê∫',
    'üê¥','ü¶Ñ','üê¨','ü¶•','üêøÔ∏è','ü¶¶','ü¶®','ü¶°','üêá','üê£'
  ];

  const maxPlayers = 50;
  let players = [];
  let winnerIndex = -1;
  let isRunning = false;
  let history = JSON.parse(localStorage.getItem('selectionHistory')) || [];
  let soundOn = true;

  // DOM Elements
  const inputNames = document.getElementById('inputNames');
  const btnStart = document.getElementById('btnStart');
  const btnNext = document.getElementById('btnNext');
  const gameArea = document.getElementById('gameArea');
  const winnerNameDisplay = document.getElementById('winnerName');
  const historyArea = document.getElementById('historyArea');
  const soundToggle = document.getElementById('soundToggle');

  // Audio
  const audioJump = new Audio('https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_roll.ogg');
  const audioWin = new Audio('https://actions.google.com/sounds/v1/celebration/party_horn.ogg');

  // Format t√™n: l·∫•y ch·ªØ c√°i ƒë·∫ßu vi·∫øt hoa + h·ªç + t√™n l√≥t
  function formatName(name) {
    name = name.trim();
    if(!name) return "";
    let parts = name.split(/\s+/);
    if(parts.length === 1) return parts[0].toUpperCase();
    let firstInitial = parts[0].charAt(0).toUpperCase();
    let lastName = parts[parts.length - 1];
    return firstInitial + " " + lastName.toUpperCase();
  }

  function createAnimalCard(player, index) {
    const card = document.createElement('div');
    card.className = 'animal-card jumping';
    card.style.animationDelay = (Math.random()*0.5) + 's';

    const iconSpan = document.createElement('div');
    iconSpan.className = 'animal-icon';
    iconSpan.textContent = animalIcons[index % animalIcons.length];

    const nameSpan = document.createElement('div');
    nameSpan.className = 'animal-name';
    nameSpan.textContent = formatName(player);

    card.appendChild(iconSpan);
    card.appendChild(nameSpan);

    return card;
  }

  function renderPlayers() {
    gameArea.innerHTML = '';
    players.forEach((player, idx) => {
      const card = createAnimalCard(player, idx);
      gameArea.appendChild(card);
    });
  }

  function dimAllExcept(winnerIdx) {
    [...gameArea.children].forEach((card, idx) => {
      if(idx !== winnerIdx) card.classList.add('dimmed');
      else card.classList.remove('dimmed');
    });
  }

  function clearDim() {
    [...gameArea.children].forEach(card => card.classList.remove('dimmed'));
  }

  // B·∫Øt ƒë·∫ßu tr√≤ ch∆°i
  btnStart.onclick = () => {
    if(isRunning) return;
    const rawNames = inputNames.value.trim();
    if(!rawNames) {
      alert('Vui l√≤ng nh·∫≠p t√™n h·ªçc sinh!');
      return;
    }
    players = rawNames.split('\n').map(s => s.trim()).filter(s => s).slice(0, maxPlayers);
    if(players.length === 0) {
      alert('Kh√¥ng t√¨m th·∫•y t√™n h·ª£p l·ªá!');
      return;
    }
    renderPlayers();
    btnStart.disabled = true;
    btnNext.style.display = 'none';
    winnerNameDisplay.style.display = 'none';
    isRunning = true;
    runSelection();
  };

  // Ch·∫°y animation ch·ªçn h·ªçc sinh
  async function runSelection() {
    let count = 20 + Math.floor(Math.random()*20);
    for(let i=0; i<count; i++) {
      const idx = Math.floor(Math.random()*players.length);
      highlightCard(idx);
      if(soundOn) audioJump.play();
      await delay(100);
      unhighlightAll();
    }
    winnerIndex = Math.floor(Math.random()*players.length);
    highlightWinner(winnerIndex);
    if(soundOn) audioWin.play();
    saveHistory(players[winnerIndex]);
    btnNext.style.display = 'inline-block';
    isRunning = false;
  }

  // Highlight 1 card khi ch·∫°y
  function highlightCard(idx) {
    const cards = gameArea.children;
    unhighlightAll();
    if(cards[idx]) {
      cards[idx].style.transform = 'scale(1.4)';
      cards[idx].style.zIndex = 10;
      cards[idx].style.filter = 'brightness(1.2)';
    }
  }
  function unhighlightAll() {
    [...gameArea.children].forEach(card => {
      card.style.transform = 'scale(1)';
      card.style.zIndex = 0;
      card.style.filter = 'brightness(1)';
    });
  }

  // Highlight ng∆∞·ªùi th·∫Øng
  function highlightWinner(idx) {
    const cards = gameArea.children;
    [...cards].forEach((card, i) => {
      if(i === idx) {
        card.classList.add('winner');
        card.style.zIndex = 9999;
      } else {
        card.style.filter = 'brightness(0.4) blur(1.5px)';
        card.style.transition = 'filter 0.5s ease';
      }
    });
    winnerNameDisplay.textContent = formatName(players[idx]);
    winnerNameDisplay.style.display = 'block';
  }

  // N√∫t ti·∫øp t·ª•c: lo·∫°i b·ªè ng∆∞·ªùi th·∫Øng v√† ch·ªçn ti·∫øp
  btnNext.onclick = () => {
    if(winnerIndex < 0) return;
    players.splice(winnerIndex, 1);
    if(players.length === 0) {
      alert('Kh√¥ng c√≤n h·ªçc sinh ƒë·ªÉ ch·ªçn ti·∫øp!');
      resetGame();
      return;
    }
    resetGame();
    renderPlayers();
    btnNext.style.display = 'none';
    winnerNameDisplay.style.display = 'none';
    runSelection();
  };

  // Reset l·∫°i tr·∫°ng th√°i ban ƒë·∫ßu
  function resetGame() {
    isRunning = false;
    btnStart.disabled = false;
    unhighlightAll();
    clearDim();
  }

  // L∆∞u l·ªãch s·ª≠
  function saveHistory(name) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    history.unshift(`[${timeStr}] ${formatName(name)}`);
    if(history.length > 50) history.pop();
    localStorage.setItem('selectionHistory', JSON.stringify(history));
    renderHistory();
  }
  // Hi·ªÉn th·ªã l·ªãch s·ª≠
  function renderHistory() {
    historyArea.innerHTML = 'L·ªãch s·ª≠ k·∫øt qu·∫£:<br>' + history.map(h => h).join('<br>');
  }
  renderHistory();

  // Delay helper
  function delay(ms) {
    return new Promise(res => setTimeout(res, ms));
  }

  // N√∫t b·∫≠t t·∫Øt √¢m thanh
  soundToggle.onclick = () => {
    soundOn = !soundOn;
    soundToggle.textContent = soundOn ? 'üîä' : 'üîà';
  };

  // Hi·ªáu ·ª©ng icons to√°n bay bay
  const mathIcons = ['‚ûï','‚ûñ','‚úñÔ∏è','‚ûó','‚àö','œÄ','‚àû','‚àë','‚à´','‚âà'];
  function spawnMathIcon() {
    const icon = document.createElement('div');
    icon.className = 'math-icon';
    icon.textContent = mathIcons[Math.floor(Math.random()*mathIcons.length)];
    icon.style.left = (Math.random()*90 + 5) + 'vw';
    icon.style.animationDuration = (6 + Math.random()*4) + 's';
    document.body.appendChild(icon);
    setTimeout(() => {
      icon.remove();
    }, 10000);
  }
  setInterval(spawnMathIcon, 700);

</script>

</body>
</html>
