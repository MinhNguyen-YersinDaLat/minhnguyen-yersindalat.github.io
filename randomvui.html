<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sàn Đấu Vật Nuôi Ngang - Party Animals phiên bản Toán</title>
<style>
  body {
    margin:0; background:#f0f8ff; font-family: Arial, sans-serif; text-align:center;
  }
  #canvas-container {
    position: relative; margin: 20px auto; width: 1000px; height: 400px; 
    border: 3px solid #333; border-radius: 15px; background: #fff;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: transparent !important;
  }
  #winner {
    font-size: 24px; font-weight: bold; color: #d63384; margin: 15px 0;
  }
  #startBtn, #resetBtn {
    padding: 12px 24px; font-size: 16px; border:none; border-radius: 25px; cursor:pointer;
    margin: 10px 8px;
    background: #ff69b4; color: white;
    box-shadow: 0 4px 8px rgba(255,105,180,0.6);
    transition: background-color 0.3s ease;
  }
  #startBtn:hover, #resetBtn:hover {
    background: #d63384;
  }
  #inputNames {
    width: 980px; height: 120px; margin: 10px auto; font-size: 16px; padding: 8px;
    border-radius: 8px; border: 2px solid #ff69b4; resize: none;
  }
  label {
    font-weight: bold; color: #444; font-size: 18px;
  }
</style>
</head>
<body>

<h1>🎉 Sàn Đấu Vật Nuôi Ngang - Chọn Học Sinh Ngẫu Nhiên 🎉</h1>

<label for="inputNames">Nhập danh sách tên học sinh (tối đa 50), mỗi tên một dòng:</label><br/>
<textarea id="inputNames" placeholder="Ví dụ: Nguyễn Văn A&#10;Trần Thị B&#10;Lê Văn C"></textarea><br/>

<button id="startBtn">🚀 Bắt đầu đua</button>
<button id="resetBtn" disabled>🔄 Làm lại</button>

<div id="canvas-container"></div>

<div id="winner"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<script>
  const { Engine, Render, Runner, Bodies, Composite, Events, Body, Vector } = Matter;

  const container = document.getElementById('canvas-container');
  const winnerDiv = document.getElementById('winner');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');
  const inputNames = document.getElementById('inputNames');

  let engine, render, runner;
  let balls = [];
  let isRunning = false;

  const maxPlayers = 50;
  const arenaWidth = container.clientWidth;
  const arenaHeight = container.clientHeight;
  const animalRadius = 25;
  const startX = 50;
  const endX = arenaWidth - 50;

  // Màu thú
  function getRandomColor(seed) {
    const colors = [
      '#ff6f91', '#ff9671', '#ffc75f', '#f9f871', '#5bd1a6',
      '#00bcd4', '#8067c9', '#b36ac9', '#ff9a76', '#ff7f50',
      '#7fffd4', '#ffdab9', '#e0ffff', '#afeeee', '#dda0dd'
    ];
    return colors[seed % colors.length];
  }

  // Tạo thú (hình tròn + tên), đặt dọc theo chiều ngang, 10 thú 1 hàng, nhiều hàng
  function createAnimal(name, index) {
    const row = Math.floor(index / 10);
    const col = index % 10;
    const spacingX = 90; // khoảng cách ngang giữa thú
    const spacingY = 70; // khoảng cách dọc giữa hàng

    let x = startX + col * spacingX;
    let y = 50 + row * spacingY;

    let ball = Bodies.circle(x, y, animalRadius, {
      restitution: 0.8,
      friction: 0.3,
      density: 0.002,
      label: name
    });
    ball.render.fillStyle = getRandomColor(index);
    ball.name = name;
    return ball;
  }

  // Vẽ tên trên canvas
  function drawNames(render, balls) {
    let ctx = render.context;
    ctx.font = "14px Arial";
    ctx.textAlign = "center";
    ctx.fillStyle = "black";
    balls.forEach(ball => {
      let pos = ball.position;
      ctx.fillText(ball.name, pos.x, pos.y - animalRadius - 10);
    });
  }

  // Giới hạn thú trong sàn ngang (bên dưới khung)
  function keepInArena(ball) {
    return (ball.position.x >= -animalRadius && ball.position.x <= arenaWidth + animalRadius
      && ball.position.y >= -animalRadius && ball.position.y <= arenaHeight + animalRadius);
  }

  // Khởi tạo game
  function initGame(names) {
    if (engine) {
      Matter.Render.stop(render);
      Matter.Runner.stop(runner);
      Composite.clear(engine.world);
      Engine.clear(engine);
      render.canvas.remove();
      render.textures = {};
      balls = [];
      isRunning = false;
      winnerDiv.textContent = '';
    }

    engine = Engine.create();
    engine.world.gravity.y = 0; // không rơi xuống

    render = Render.create({
      element: container,
      engine: engine,
      options: {
        width: arenaWidth,
        height: arenaHeight,
        wireframes: false,
        background: 'transparent',
      }
    });

    // Tường 2 bên trái phải, trên dưới thì không cần
    const leftWall = Bodies.rectangle(-20, arenaHeight/2, 40, arenaHeight, { isStatic: true });
    const rightWall = Bodies.rectangle(arenaWidth + 20, arenaHeight/2, 40, arenaHeight, { isStatic: true });

    Composite.add(engine.world, [leftWall, rightWall]);

    // Tạo các thú vật theo vị trí hàng ngang
    names.forEach((name, i) => {
      let animal = createAnimal(name, i);
      Composite.add(engine.world, animal);
      balls.push(animal);
    });

    // Tạo runner và render
    runner = Runner.create();
    Render.run(render);
    Runner.run(runner, engine);

    // Vẽ tên mỗi frame
    Events.on(render, 'afterRender', function() {
      drawNames(render, balls);
    });

    resetBtn.disabled = true;
  }

  // Đẩy thú chạy liên tục sang phải, tạo va chạm đẩy nhau
  function startRace() {
    isRunning = true;

    // Mỗi thú đẩy lực nhẹ, hướng sang phải
    const forceMag = 0.0003;

    const interval = setInterval(() => {
      if (!isRunning) {
        clearInterval(interval);
        return;
      }
      balls.forEach(ball => {
        Body.applyForce(ball, ball.position, { x: forceMag, y: 0 });
      });

      // Loại bỏ thú ra khỏi màn nếu đi ra ngoài bên trái
      balls = balls.filter(ball => {
        if (ball.position.x < -animalRadius) {
          Composite.remove(engine.world, ball);
          return false;
        }
        return true;
      });

      // Nếu còn 1 hoặc 0 thú thì dừng
      if (balls.length <= 1) {
        isRunning = false;
        if (balls.length === 1) {
          winnerDiv.textContent = `🎉 Người chiến thắng là: ${balls[0].name} 🎉`;
          playWinSound();
        } else {
          winnerDiv.textContent = `Không có người chiến thắng!`;
        }
        resetBtn.disabled = false;
        startBtn.disabled = false;
      }
    }, 100);
  }

  // Phát âm thanh thắng
  function playWinSound() {
    const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
    audio.volume = 0.5;
    audio.play();
  }

  startBtn.addEventListener('click', () => {
    let rawNames = inputNames.value.trim();
    if (!rawNames) {
      alert('Vui lòng nhập danh sách tên học sinh!');
      return;
    }
    let names = rawNames.split('\n').map(n => n.trim()).filter(n => n.length > 0).slice(0, 50);
    if (names.length < 2) {
      alert('Phải nhập ít nhất 2 tên!');
      return;
    }
    winnerDiv.textContent = '';
    initGame(names);
    startRace();
    startBtn.disabled = true;
    resetBtn.disabled = true;
  });

  resetBtn.addEventListener('click', () => {
    winnerDiv.textContent = '';
    balls = [];
    Composite.clear(engine.world);
    Engine.clear(engine);
    render.canvas.remove();
    render.textures = {};
    startBtn.disabled = false;
    resetBtn.disabled = true;
  });
</script>

</body>
</html>
