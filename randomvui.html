<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sàn Đấu Vật Nuôi - Party Animals phiên bản Toán</title>
<style>
  body {
    margin:0; background:#f0f8ff; font-family: Arial, sans-serif; text-align:center;
  }
  #canvas-container {
    position: relative; margin: 20px auto; width: 800px; height: 800px; 
    border: 3px solid #333; border-radius: 50%; background: #fff;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: transparent !important;
  }
  #winner {
    font-size: 24px; font-weight: bold; color: #d63384; margin: 15px 0;
  }
  #startBtn, #resetBtn {
    padding: 12px 24px; font-size: 16px; border:none; border-radius: 25px; cursor:pointer;
    margin: 10px 8px;
    background: #ff69b4; color: white;
    box-shadow: 0 4px 8px rgba(255,105,180,0.6);
    transition: background-color 0.3s ease;
  }
  #startBtn:hover, #resetBtn:hover {
    background: #d63384;
  }
  #inputNames {
    width: 800px; height: 120px; margin: 10px auto; font-size: 16px; padding: 8px;
    border-radius: 8px; border: 2px solid #ff69b4; resize: none;
  }
  label {
    font-weight: bold; color: #444; font-size: 18px;
  }
</style>
</head>
<body>

<h1>🎉 Sàn Đấu Vật Nuôi - Chọn Học Sinh Ngẫu Nhiên 🎉</h1>

<label for="inputNames">Nhập danh sách tên học sinh (tối đa 50), mỗi tên một dòng:</label><br/>
<textarea id="inputNames" placeholder="Ví dụ: Nguyễn Văn A&#10;Trần Thị B&#10;Lê Văn C"></textarea><br/>

<button id="startBtn">🚀 Bắt đầu đua</button>
<button id="resetBtn" disabled>🔄 Làm lại</button>

<div id="canvas-container"></div>

<div id="winner"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<script>
  const { Engine, Render, Runner, Bodies, Composite, Events, Body, Vector } = Matter;

  const container = document.getElementById('canvas-container');
  const winnerDiv = document.getElementById('winner');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');
  const inputNames = document.getElementById('inputNames');

  let engine, render, runner;
  let balls = [];
  let isRunning = false;

  const maxPlayers = 50;
  const arenaRadius = 380;

  // Tạo màu sắc khác nhau cho từng thú
  function getRandomColor(seed) {
    const colors = [
      '#ff6f91', '#ff9671', '#ffc75f', '#f9f871', '#5bd1a6',
      '#00bcd4', '#8067c9', '#b36ac9', '#ff9a76', '#ff7f50',
      '#7fffd4', '#ffdab9', '#e0ffff', '#afeeee', '#dda0dd'
    ];
    return colors[seed % colors.length];
  }

  // Tạo thú (hình tròn + tên)
  function createAnimal(name, index) {
    // Random vị trí trong vòng tròn arena
    let angle = Math.random() * 2 * Math.PI;
    let r = Math.random() * (arenaRadius - 30);
    let x = container.clientWidth/2 + r * Math.cos(angle);
    let y = container.clientHeight/2 + r * Math.sin(angle);

    let ball = Bodies.circle(x, y, 30, {
      restitution: 0.8,
      friction: 0.2,
      density: 0.002,
      label: name
    });
    ball.render.fillStyle = getRandomColor(index);
    ball.name = name;
    return ball;
  }

  // Vẽ tên trên canvas
  function drawNames(render, balls) {
    let ctx = render.context;
    ctx.font = "16px Arial";
    ctx.textAlign = "center";
    ctx.fillStyle = "black";
    balls.forEach(ball => {
      let pos = ball.position;
      ctx.fillText(ball.name, pos.x, pos.y - 40);
    });
  }

  // Tạo sàn đấu hình tròn ranh giới
  function createArenaWalls() {
    let walls = [];

    // 4 cạnh vuông lớn chứa sàn
    walls.push(Bodies.rectangle(container.clientWidth/2, -50, container.clientWidth, 100, { isStatic: true }));
    walls.push(Bodies.rectangle(container.clientWidth/2, container.clientHeight + 50, container.clientWidth, 100, { isStatic: true }));
    walls.push(Bodies.rectangle(-50, container.clientHeight/2, 100, container.clientHeight, { isStatic: true }));
    walls.push(Bodies.rectangle(container.clientWidth + 50, container.clientHeight/2, 100, container.clientHeight, { isStatic: true }));

    return walls;
  }

  // Giới hạn vật thể trong vòng tròn arena
  function keepInsideArena(ball) {
    let center = { x: container.clientWidth/2, y: container.clientHeight/2 };
    let dist = Matter.Vector.magnitude(Matter.Vector.sub(ball.position, center));
    if (dist > arenaRadius) {
      return false; // out of arena
    }
    return true;
  }

  // Khởi tạo game
  function initGame(names) {
    if (engine) {
      Matter.Render.stop(render);
      Matter.Runner.stop(runner);
      Composite.clear(engine.world);
      Engine.clear(engine);
      render.canvas.remove();
      render.textures = {};
      balls = [];
      isRunning = false;
      winnerDiv.textContent = '';
    }

    engine = Engine.create();

    render = Render.create({
      element: container,
      engine: engine,
      options: {
        width: container.clientWidth,
        height: container.clientHeight,
        wireframes: false,
        background: 'transparent',
      }
    });

    // Đặt background sàn đấu màu trắng tròn
    let ctx = render.context;
    ctx.canvas.style.borderRadius = '50%';

    Composite.add(engine.world, createArenaWalls());

    // Tạo các thú vật
    names.forEach((name, i) => {
      let animal = createAnimal(name, i);
      Composite.add(engine.world, animal);
      balls.push(animal);
    });

    // Tạo runner và render
    runner = Runner.create();
    Render.run(render);
    Runner.run(runner, engine);

    // Va chạm tạo lực ngẫu nhiên đẩy nhau
    Events.on(engine, 'beforeUpdate', function() {
      balls.forEach(ball => {
        // Đẩy ngẫu nhiên 1 lực nhỏ để động vật không đứng yên
        let force = Vector.create((Math.random() - 0.5)*0.0006, (Math.random() - 0.5)*0.0006);
        Body.applyForce(ball, ball.position, force);
      });

      // Loại bỏ thú ra khỏi vòng tròn
      balls = balls.filter(ball => {
        if (!keepInsideArena(ball)) {
          Composite.remove(engine.world, ball);
          return false;
        }
        return true;
      });

      // Nếu còn 1 con duy nhất thì dừng game
      if (balls.length === 1 && isRunning) {
        isRunning = false;
        winnerDiv.textContent = `🎉 Người chiến thắng là: ${balls[0].name} 🎉`;
        resetBtn.disabled = false;
        startBtn.disabled = false;
        playWinSound();
      }
    });

    // Vẽ tên mỗi frame
    Events.on(render, 'afterRender', function() {
      drawNames(render, balls);
    });

    resetBtn.disabled = true;
  }

  // Phát âm thanh thắng
  function playWinSound() {
    const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
    audio.volume = 0.5;
    audio.play();
  }

  // Bắt đầu game
  startBtn.addEventListener('click', () => {
    let rawNames = inputNames.value.trim();
    if (!rawNames) {
      alert('Vui lòng nhập danh sách tên học sinh!');
      return;
    }
    let names = rawNames.split('\n').map(n => n.trim()).filter(n => n.length > 0).slice(0, 50);
    if (names.length < 2) {
      alert('Phải nhập ít nhất 2 tên!');
      return;
    }
    winnerDiv.textContent = '';
    initGame(names);
    isRunning = true;
    startBtn.disabled = true;
    resetBtn.disabled = false;
  });

  // Reset game
  resetBtn.addEventListener('click', () => {
    winnerDiv.textContent = '';
    balls = [];
    Composite.clear(engine.world);
    Engine.clear(engine);
    render.canvas.remove();
    render.textures = {};
    startBtn.disabled = false;
    resetBtn.disabled = true;
  });

</script>
</body>
</html>
