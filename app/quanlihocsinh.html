<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω H·∫°nh Ki·ªÉm Yersin - V11 (XLSX Platinum)</title>
    <!-- Tailwind CSS (H·ªó tr·ª£) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS: Th∆∞ vi·ªán xu·∫•t Excel .xlsx chu·∫©n -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #e65100;
            --primary-light: #ffe0b2;
            --primary-gradient: linear-gradient(135deg, #ef6c00 0%, #e65100 100%);
            --header-height: 64px;
            --sidebar-width: 320px;
            --border-color: #ddd;
            --bg-gray: #f5f7fa;
            --success: #2e7d32;
            --danger: #c62828;
            --warning: #f57f17;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: var(--bg-gray); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- HEADER --- */
        header { 
            height: var(--header-height); 
            background: var(--primary-gradient); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 24px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            z-index: 100; 
            flex-shrink: 0;
        }
        
        .brand { display: flex; align-items: center; gap: 16px; }
        .logo-placeholder { 
            width: 40px; height: 40px; 
            background: white; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 900; color: var(--primary); 
            font-size: 20px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .logo-placeholder img { width: 100%; height: 100%; object-fit: contain; }
        
        .app-title h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: 0.5px; line-height: 1.2; }
        .app-title span { font-size: 13px; opacity: 0.9; }

        .toolbar { display: flex; gap: 12px; align-items: center; }
        
        /* --- LAYOUT --- */
        .container { display: flex; flex: 1; height: calc(100vh - var(--header-height)); overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-width); 
            background: white; 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;
            height: 100%;
        }
        
        .sidebar-tools { padding: 16px; border-bottom: 1px solid var(--border-color); background: #fff; }
        .search-input { 
            width: 100%; padding: 10px; 
            border: 1px solid #ccc; border-radius: 6px; 
            font-size: 14px; outline: none; 
            box-sizing: border-box;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(230,81,0,0.1); }
        
        .student-list { flex: 1; overflow-y: auto; overflow-x: hidden; }
        /* Custom Scrollbar */
        .student-list::-webkit-scrollbar, .main::-webkit-scrollbar, .rules-container::-webkit-scrollbar, .table-container::-webkit-scrollbar {
            width: 6px; height: 6px;
        }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }

        .student-item { 
            padding: 12px 20px; 
            border-bottom: 1px solid #f0f0f0; 
            cursor: pointer; 
            display: flex; align-items: center; justify-content: space-between; 
            transition: all 0.2s; 
        }
        .student-item:hover { background-color: #fff8e1; }
        .student-item.active { background-color: var(--primary-light); border-left: 4px solid var(--primary); padding-left: 16px; }
        
        .s-name { font-weight: 600; font-size: 14px; color: #333; }
        .s-info { font-size: 12px; color: #666; margin-top: 2px;}
        .s-score { font-weight: 800; font-size: 14px; color: var(--primary); min-width: 30px; text-align: right; }

        .sidebar-footer { padding: 12px; text-align: center; font-size: 11px; color: #888; border-top: 1px solid #eee; background: #fafafa; }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; height: 100%; box-sizing: border-box; }

        /* INFO CARD */
        .info-card { 
            background: white; border-radius: 8px; padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
            border-left: 5px solid var(--primary); 
            flex-shrink: 0;
        }
        .info-block label { display: block; font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        .info-block .value { font-size: 20px; font-weight: 700; color: #333; }
        .highlight { color: var(--primary) !important; }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; min-height: 0; flex: 1; }
        
        .panel { 
            background: white; border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; 
            overflow: hidden; 
            border: 1px solid #eee;
        }
        .panel-header { 
            padding: 12px 20px; 
            background: #fafafa; 
            border-bottom: 1px solid #eee; 
            font-weight: 700; color: #444; font-size: 14px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* TABS & BUTTONS */
        .tabs { display: flex; padding: 10px 20px 0; gap: 5px; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tab-btn { 
            padding: 8px 16px; 
            border: none; background: none; 
            cursor: pointer; 
            font-weight: 600; color: #666; font-size: 13px;
            border-bottom: 3px solid transparent; 
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--primary); background: #fff8e1; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .rules-container { padding: 20px; overflow-y: auto; flex: 1; }
        .rules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        
        .rule-card { 
            border: 1px solid #eee; border-radius: 8px; padding: 12px; 
            cursor: pointer; background: white; transition: all 0.2s; 
            display: flex; flex-direction: column; justify-content: space-between; min-height: 70px;
            position: relative; overflow: hidden;
        }
        .rule-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: var(--primary-light); }
        .rule-card:active { transform: scale(0.98); }
        
        .rule-card.bonus { border-left: 4px solid var(--success); background: linear-gradient(to right, #f1f8e9, #fff); }
        .rule-card.penalty { border-left: 4px solid var(--danger); background: linear-gradient(to right, #ffebee, #fff); }
        
        .r-content { font-size: 13px; font-weight: 500; color: #333; line-height: 1.3; margin-bottom: 8px;}
        .r-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; }
        .r-score { font-weight: 800; font-size: 14px; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }

        /* MANUAL INPUT */
        .manual-input { 
            display: flex; gap: 10px; padding: 15px 20px; 
            background: #fff8e1; border-bottom: 1px solid #ffe0b2; 
        }

        /* HISTORY TABLE */
        .table-container { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px 15px; background: #f9f9f9; color: #666; font-weight: 600; position: sticky; top: 0; border-bottom: 2px solid #eee; z-index: 10; }
        td { padding: 10px 15px; border-bottom: 1px solid #eee; color: #333; vertical-align: middle; }
        tr:hover { background-color: #fafafa; }

        /* COMMON UI */
        .btn { 
            padding: 8px 16px; border-radius: 6px; border: none; 
            font-weight: 600; cursor: pointer; font-size: 13px; 
            display: inline-flex; align-items: center; gap: 6px; 
            transition: 0.2s; 
            white-space: nowrap;
        }
        .btn-primary { background: white; color: var(--primary); }
        .btn-primary:hover { background: #fff3e0; }
        .btn-action { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(230,81,0,0.3); }
        .btn-action:hover { background: #ef6c00; transform: translateY(-1px); }
        .btn-danger { background: #ffebee; color: var(--danger); }
        .btn-danger:hover { background: #ffcdd2; }
        
        select.form-control { padding: 8px; border-radius: 4px; border: none; background: rgba(255,255,255,0.2); color: white; font-weight: 600; cursor: pointer;}
        select.form-control option { color: #333; }

        /* MODAL */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 200; 
            display: none; align-items: center; justify-content: center; 
            backdrop-filter: blur(2px);
        }
        .modal { 
            background: white; width: 450px; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            padding: 24px; animation: slideIn 0.2s ease-out; 
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal h2 { margin-top: 0; color: var(--primary); font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #555; }
        .form-control-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .form-control-input:focus { border-color: var(--primary); outline: none; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }

        @media (max-width: 1024px) {
            .dashboard { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
            .sidebar { width: 280px; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <div class="logo-placeholder" id="logoContainer">
             <img src="logo.png" alt="Y" onerror="this.style.display='none'; document.getElementById('logoText').style.display='block';">
             <span id="logoText" style="display:none;">Y</span>
        </div>
        <div class="app-title">
            <h1>H·∫†NH KI·ªÇM YERSIN</h1>
            <span>L·ªõp 10H ‚Ä¢ Th·∫ßy Nguy√™n ‚Ä¢ V11 Platinum</span>
        </div>
    </div>
    <div class="toolbar">
        <select id="monthSelect" class="form-control" title="Ch·ªçn th√°ng xu·∫•t b√°o c√°o">
            <option value="9">Th√°ng 9</option>
            <option value="10">Th√°ng 10</option>
            <option value="11">Th√°ng 11</option>
            <option value="12">Th√°ng 12</option>
            <option value="1">Th√°ng 1</option>
            <option value="2">Th√°ng 2</option>
            <option value="3">Th√°ng 3</option>
            <option value="4">Th√°ng 4</option>
            <option value="5">Th√°ng 5</option>
        </select>
        <button class="btn btn-primary" onclick="app.exportExcel()">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/></svg>
            Xu·∫•t Excel (.xlsx)
        </button>
    </div>
</header>

<div class="container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-tools">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç T√¨m t√™n h·ªçc sinh..." onkeyup="app.renderStudentList()">
            <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
                <label style="font-size:13px; font-weight:600; cursor:pointer; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="selectAll" onchange="app.toggleSelectAll()"> Ch·ªçn t·∫•t c·∫£
                </label>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;" onclick="app.resetData()">Reset</button>
                    <button class="btn btn-action" style="padding:4px 10px;" onclick="app.openModal('modalStudent')">+ HS</button>
                </div>
            </div>
        </div>
        <div class="student-list" id="studentList"></div>
        <div class="sidebar-footer">
            Developed by <strong>Th·∫ßy Th√°i Minh Nguy√™n</strong><br>Tr∆∞·ªùng Yersin ƒê√† L·∫°t
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
        <!-- BATCH ALERT -->
        <div id="batchAlert" style="background:#37474f; color:white; padding:15px; border-radius:8px; display:none; justify-content:space-between; align-items:center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display:flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;">‚ö°</span>
                <span>ƒêang ch·ªçn <strong id="batchCount" style="color:#ffcc80; font-size:1.2em;">0</strong> h·ªçc sinh. Thao t√°c s·∫Ω √°p d·ª•ng cho to√†n b·ªô nh√≥m.</span>
            </div>
            <button class="btn btn-primary" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:white;" onclick="app.clearSelection()">H·ªßy ch·ªçn</button>
        </div>

        <!-- INFO CARD -->
        <div class="info-card" id="infoCard">
            <div style="display:flex; gap:20px; align-items:center;">
                <div class="info-block">
                    <label>Ng√†y ghi nh·∫≠n</label>
                    <input type="date" id="datePicker" style="border:1px solid #ddd; padding:5px; border-radius:4px; font-weight:bold; color:#444; font-family: inherit;">
                </div>
                <div class="info-block" style="border-left:1px solid #eee; padding-left:20px;">
                    <label>H·ªçc sinh</label>
                    <div class="value" id="dispName">...</div>
                </div>
            </div>
            <div style="display:flex; gap:40px;">
                <div class="info-block" style="text-align:right;">
                    <label>T·ªïng ƒëi·ªÉm</label>
                    <div class="value highlight" id="dispScore">0</div>
                </div>
                <div class="info-block" style="text-align:right;">
                    <label>X·∫øp lo·∫°i</label>
                    <div class="value" id="dispRank">-</div>
                </div>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div class="dashboard">
            <!-- LEFT: RULES -->
            <div class="panel">
                <div class="panel-header">
                    <span>C·∫¨P NH·∫¨T H√ÄNH VI</span>
                    <div style="font-size:12px; color:#c62828; display:flex; align-items:center; gap:5px; font-weight: 600;">
                        <input type="checkbox" id="critCheck" onchange="app.toggleCrit()"> Vi ph·∫°m n·∫∑ng (H·∫° b·∫≠c)
                    </div>
                </div>
                
                <div class="tabs">
                    <button class="tab-btn active" onclick="app.switchTab('all', this)">T·∫•t c·∫£</button>
                    <button class="tab-btn" onclick="app.switchTab('learning', this)">H·ªçc t·∫≠p</button>
                    <button class="tab-btn" onclick="app.switchTab('discipline', this)">N·ªÅ n·∫øp</button>
                    <button class="tab-btn" onclick="app.switchTab('activity', this)">Ho·∫°t ƒë·ªông</button>
                    <button class="tab-btn" onclick="app.switchTab('custom', this)">T√πy ch·ªânh</button>
                </div>

                <div class="manual-input">
                    <input type="text" id="manText" class="form-control-input" placeholder="Nh·∫≠p n·ªôi dung kh√°c..." style="flex:1;">
                    <input type="number" id="manScore" class="form-control-input" placeholder="ƒêi·ªÉm" style="width:80px;">
                    <button class="btn btn-action" onclick="app.addManualLog()">L∆∞u</button>
                </div>

                <div class="rules-container">
                    <div class="rules-grid" id="rulesGrid"></div>
                </div>
            </div>

            <!-- RIGHT: HISTORY -->
            <div class="panel" id="historyPanel">
                <div class="panel-header">
                    <span>L·ªäCH S·ª¨ & NH·∫¨N X√âT</span>
                    <button class="btn btn-danger" style="padding:2px 8px; font-size:11px;" onclick="app.deleteStudent()">X√≥a HS</button>
                </div>
                
                <div style="padding:15px; border-bottom:1px solid #eee; background:#fafafa;">
                    <label style="font-size:11px; font-weight:700; color:#555;">NH·∫¨N X√âT GVCN (AI G·ª£i √Ω):</label>
                    <textarea id="remarkBox" rows="3" class="form-control-input" style="margin-top:5px; resize:vertical; font-family: inherit;" onblur="app.saveRemark()"></textarea>
                    <div style="text-align:right; margin-top:5px;">
                        <button class="btn btn-primary" style="background:#eee; color:#333; font-size:11px;" onclick="app.generateRemark(true)">‚ú® T·∫°o l·∫°i</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="logTable">
                        <thead><tr><th>Ng√†y</th><th>N·ªôi dung</th><th>ƒêi·ªÉm</th><th></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- MODAL ADD RULE -->
<div class="modal-overlay" id="modalRule">
    <div class="modal">
        <h2>Th√™m N√∫t M·ªõi</h2>
        <div class="form-group">
            <label>T√™n h√†nh vi</label>
            <input type="text" id="newRText" class="form-control-input" placeholder="V√≠ d·ª•: Qu√™n khƒÉn qu√†ng">
        </div>
        <div class="form-group">
            <label>ƒêi·ªÉm c·ªông/tr·ª´</label>
            <input type="number" id="newRScore" class="form-control-input" placeholder="VD: -0.5 ho·∫∑c 1">
        </div>
        <div class="form-group">
            <label>Nh√≥m</label>
            <select id="newRCat" class="form-control-input">
                <option value="learning">H·ªçc t·∫≠p</option>
                <option value="discipline">N·ªÅ n·∫øp</option>
                <option value="activity">Ho·∫°t ƒë·ªông</option>
                <option value="custom">T√πy ch·ªânh</option>
            </select>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="app.closeModal('modalRule')">H·ªßy</button>
            <button class="btn btn-action" onclick="app.saveNewRule()">L∆∞u & D√πng ngay</button>
        </div>
    </div>
</div>

<!-- MODAL ADD STUDENT -->
<div class="modal-overlay" id="modalStudent">
    <div class="modal">
        <h2>Th√™m H·ªçc Sinh M·ªõi</h2>
        <div class="form-group">
            <label>T√™n h·ªçc sinh</label>
            <input type="text" id="newStudentName" class="form-control-input" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="app.closeModal('modalStudent')">H·ªßy</button>
            <button class="btn btn-action" onclick="app.addStudent()">Th√™m</button>
        </div>
    </div>
</div>

<script>
// --- CONFIG ---
// inc: true k√≠ch ho·∫°t ch·∫ø ƒë·ªô ph·∫°t l≈©y ti·∫øn (l·∫ßn 1 nh√¢n 1, l·∫ßn 2 nh√¢n 2...)
const DEFAULT_RULES = [
    {id:'h1', t:'H·ªçc t·∫≠p t·ªët 1 tu·∫ßn', s:0.5, c:'learning'},
    {id:'h2', t:'H·ªçc t·∫≠p t·ªët 4 tu·∫ßn', s:2.0, c:'learning'},
    {id:'h3', t:'Xung phong ph√°t bi·ªÉu', s:0.25, c:'learning'},
    {id:'h4', t:'Thi·∫øu b√†i/So·∫°n b√†i', s:-1.0, c:'learning', inc:true}, /* L≈©y ti·∫øn: -1, -2, -3 */
    {id:'h5', t:'Thi·∫øu d·ª•ng c·ª• h·ªçc t·∫≠p', s:-1.0, c:'learning', inc:true},
    {id:'h6', t:'M·∫•t tr·∫≠t t·ª±/Ng·ªß', s:-0.25, c:'learning', inc:true}, /* -0.25, -0.5, -0.75 */
    {id:'h7', t:'Treo m√°y (Online)', s:-2.0, c:'learning', inc:true}, /* -2, -4, -6 */
    {id:'h8', t:'Gian l·∫≠n thi c·ª≠', s:-4.0, c:'learning', sp:'cheat'},
    {id:'n1', t:'T√°c phong t·ªët 1 tu·∫ßn', s:0.5, c:'discipline'},
    {id:'n2', t:'T√°c phong t·ªët 4 tu·∫ßn', s:2.0, c:'discipline'},
    {id:'n3', t:'Chuy√™n c·∫ßn t·ªët 1 tu·∫ßn', s:0.5, c:'discipline'},
    {id:'n4', t:'Chuy√™n c·∫ßn t·ªët 4 tu·∫ßn', s:2.0, c:'discipline'},
    {id:'n5', t:'Vi·ªác t·ªët', s:2.0, c:'discipline'},
    {id:'n6', t:'ƒêi tr·ªÖ', s:-1.0, c:'discipline', inc:true}, /* C·∫≠p nh·∫≠t l≈©y ti·∫øn cho ƒëi tr·ªÖ */
    {id:'n7', t:'V·∫Øng kh√¥ng ph√©p', s:-2.0, c:'discipline', inc:true}, /* C·∫≠p nh·∫≠t l≈©y ti·∫øn */
    {id:'n8', t:'L·ªói ƒê.Ph·ª•c/T√≥c/Gi√†y', s:-0.25, c:'discipline', inc:true},
    {id:'n9', t:'D√πng ƒêT sai quy ƒë·ªãnh', s:-2.0, c:'discipline', inc:true},
    {id:'n10', t:'N√≥i t·ª•c/Ch·ª≠i th·ªÅ', s:-2.0, c:'discipline', inc:true},
    {id:'n12', t:'ƒê√°nh nhau (L·ªói n·∫∑ng)', s:-40.0, c:'discipline'},
    {id:'a1', t:'Tham gia phong tr√†o', s:2.0, c:'activity'},
    {id:'a2', t:'N√≤ng c·ªët phong tr√†o', s:4.0, c:'activity'},
    {id:'a3', t:'ƒêo·∫°t gi·∫£i', s:5.0, c:'activity'},
    {id:'a4', t:'V·∫Øng t·∫≠p trung', s:-2.0, c:'activity'}
];

const INIT_DATA = [
    "B√πi Ho√†ng Gia An", "Yoo Minh Anh", "V≈© Nguy·ªÖn H·ªìng √Çn", "Nguy·ªÖn L√™ Ch√≠ D≈©ng", "Nguy·ªÖn Minh ƒê·ª©c",
    "Nguy·ªÖn Thanh H·∫±ng", "B√πi M·∫°nh H√πng", "Nguy·ªÖn Ph√∫c L·ªôc", "Nguy·ªÖn Tr·ªçng Nghƒ©a", "Nguy·ªÖn Tr·ªçng Nghƒ©a",
    "Nguy·ªÖn Thi·ªán Nh√¢n", "H·ªì ƒê·ª©c Nh·∫≠t", "Nguy·ªÖn B·∫£o Thi√™n", "Nguy·ªÖn Th·ªã Thu Th·ªßy", "Tr·∫ßn H√† Uy√™n",
    "L√™ Ho√†ng Vi·ªát", "Ho√†ng Ng·ªçc H√† Vy"
].map((n, i) => ({ id: i+1, name: n, logs: [], remark: "", crit: false }));

class App {
    constructor() {
        try {
            this.students = JSON.parse(localStorage.getItem('hk_v10_data')) || INIT_DATA;
            this.customRules = JSON.parse(localStorage.getItem('hk_v10_rules')) || [];
        } catch (e) {
            console.warn("Storage not available, using defaults", e);
            this.students = INIT_DATA;
            this.customRules = [];
        }
        
        this.selectedIds = new Set();
        this.currentId = null;
        this.tab = 'all';
        
        document.getElementById('datePicker').valueAsDate = new Date();
        this.init();
    }

    init() {
        this.renderStudentList();
        this.renderRules();
        if (this.students.length) this.selectStudent(this.students[0].id);
    }

    save() {
        try {
            localStorage.setItem('hk_v10_data', JSON.stringify(this.students));
        } catch (e) { console.error("Save failed", e); }
        
        this.renderStudentList();
        if (this.currentId) this.renderInfo();
    }

    saveRules() {
        try {
            localStorage.setItem('hk_v10_rules', JSON.stringify(this.customRules));
        } catch (e) { console.error("Save rules failed", e); }
        this.renderRules();
    }

    calculate(s) {
        let total = 80;
        let cheats = 0;
        s.logs.forEach(l => {
            total += parseFloat(l.s);
            if (l.sp === 'cheat') cheats++;
        });

        let rank = 'ƒê·∫°t';
        if (total >= 80) rank = 'T·ªët';
        else if (total >= 65) rank = 'Kh√°';
        else if (total >= 50) rank = 'ƒê·∫°t';
        else rank = 'Ch∆∞a ƒê·∫°t';

        if (cheats >= 2 && (rank === 'T·ªët' || rank === 'Kh√°')) rank = 'ƒê·∫°t';
        if (cheats >= 3) rank = 'Ch∆∞a ƒê·∫°t';
        if (s.crit || total < 50) rank = 'Ch∆∞a ƒê·∫°t';

        total = Math.round(total * 100) / 100;

        return { total: total, rank };
    }

    selectStudent(id) {
        if (this.selectedIds.size) this.clearSelection();
        this.currentId = id;
        this.renderStudentList();
        this.renderInfo();
        this.renderRules(); 
    }

    toggleSelect(id) {
        if (this.selectedIds.has(id)) this.selectedIds.delete(id);
        else this.selectedIds.add(id);
        this.currentId = null;
        this.renderStudentList();
        this.renderInfo();
    }

    toggleSelectAll() {
        if (document.getElementById('selectAll').checked) this.students.forEach(s => this.selectedIds.add(s.id));
        else this.selectedIds.clear();
        this.renderStudentList();
        this.renderInfo();
    }

    clearSelection() {
        this.selectedIds.clear();
        document.getElementById('selectAll').checked = false;
        if (this.students.length) this.selectStudent(this.students[0].id);
    }

    addLog(txt, score, ruleId = null, special = null, inc = false) {
        const dateStr = document.getElementById('datePicker').value.split('-').reverse().slice(0, 2).join('/');
        const targets = this.selectedIds.size ? this.students.filter(s => this.selectedIds.has(s.id)) : (this.currentId ? [this.students.find(s => s.id == this.currentId)] : []);

        if (!targets.length) return alert("Ch∆∞a ch·ªçn h·ªçc sinh!");

        targets.forEach(s => {
            let finalS = score;
            let finalT = txt;

            // X·ª¨ L√ù L≈®Y TI·∫æN (L·∫ßn 1 nh√¢n 1, l·∫ßn 2 nh√¢n 2...)
            if (inc && score < 0) {
                const count = s.logs.filter(l => l.rid === ruleId).length + 1;
                finalS = score * count; 
                finalT += ` (L·∫ßn ${count})`;
            }

            s.logs.push({ t: finalT, s: finalS, d: dateStr, rid: ruleId, sp: special });
            s.remark = this.generateRemarkText(s);
        });

        this.save();
        if(this.currentId) {
            const s = this.students.find(s => s.id == this.currentId);
            if(s) document.getElementById('remarkBox').value = s.remark;
            this.renderInfo();
            this.renderRules();
        }
    }

    addManualLog() {
        const t = document.getElementById('manText').value.trim();
        const s = parseFloat(document.getElementById('manScore').value);
        if (!t || isNaN(s)) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        this.addLog(t, s);
        document.getElementById('manText').value = '';
        document.getElementById('manScore').value = '';
    }

    removeLog(idx) {
        const s = this.students.find(x => x.id == this.currentId);
        if (!s) return;
        s.logs.splice(idx, 1);
        s.remark = this.generateRemarkText(s);
        this.save();
        this.renderRules(); 
    }

    renderStudentList() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const list = document.getElementById('studentList');
        list.innerHTML = this.students.map((s, i) => {
            if (!s.name.toLowerCase().includes(term)) return '';
            const st = this.calculate(s);
            const isActive = this.currentId == s.id;
            const isChecked = this.selectedIds.has(s.id);
            return `
                <div class="student-item ${isActive ? 'active' : ''}" onclick="app.selectStudent(${s.id})">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation(); app.toggleSelect(${s.id})" style="transform:scale(1.2); cursor: pointer;">
                        <div>
                            <div class="s-name">${i + 1}. ${s.name}</div>
                            <div class="s-info">${st.rank}</div>
                        </div>
                    </div>
                    <span class="s-score" style="color:${st.rank === 'T·ªët' ? 'var(--success)' : (st.rank === 'Ch∆∞a ƒê·∫°t' ? 'var(--danger)' : 'var(--warning)')}">${st.total}</span>
                </div>
            `;
        }).join('');
    }

    renderInfo() {
        if (this.selectedIds.size > 0) {
            document.getElementById('batchAlert').style.display = 'flex';
            document.getElementById('batchCount').innerText = this.selectedIds.size;
            document.getElementById('infoCard').style.opacity = '0.5';
            document.getElementById('infoCard').style.pointerEvents = 'none';
            document.getElementById('historyPanel').style.visibility = 'hidden';
            return;
        }

        if (!this.currentId) return;
        document.getElementById('batchAlert').style.display = 'none';
        document.getElementById('infoCard').style.opacity = '1';
        document.getElementById('infoCard').style.pointerEvents = 'auto';
        document.getElementById('historyPanel').style.visibility = 'visible';

        const s = this.students.find(x => x.id == this.currentId);
        if (!s) return;
        const st = this.calculate(s);

        document.getElementById('dispName').innerText = s.name;
        document.getElementById('dispScore').innerText = st.total;
        document.getElementById('dispRank').innerText = st.rank;
        document.getElementById('critCheck').checked = s.crit;
        
        if (!s.remark) s.remark = this.generateRemarkText(s);
        document.getElementById('remarkBox').value = s.remark;

        const tbody = document.querySelector('#logTable tbody');
        tbody.innerHTML = s.logs.slice().reverse().map((l, idx) => `
            <tr>
                <td>${l.d}</td>
                <td>${l.t}</td>
                <td style="font-weight:bold; color:${l.s > 0 ? 'green' : 'red'}">${l.s > 0 ? '+' : ''}${l.s}</td>
                <td style="text-align: right;"><button onclick="app.removeLog(${s.logs.length - 1 - idx})" style="border:none; background:none; color:red; cursor:pointer; font-weight: bold;">&times;</button></td>
            </tr>
        `).join('');
    }

    renderRules() {
        const allRules = [...DEFAULT_RULES, ...this.customRules];
        const filtered = this.tab === 'all' ? allRules : allRules.filter(r => r.c === this.tab);
        const grid = document.getElementById('rulesGrid');
        
        let html = `<div class="rule-card" style="border:2px dashed #ccc; align-items:center; justify-content:center; color:#888;" onclick="app.openModal('modalRule')">
            <span style="font-size:24px;">+</span> Th√™m
        </div>`;

        html += filtered.map(r => {
            const isCustom = r.id.startsWith('cust_');
            let badge = '';
            if(this.currentId && !this.selectedIds.size && r.inc) {
                const s = this.students.find(x => x.id == this.currentId);
                if (s) {
                    const count = s.logs.filter(l => l.rid === r.id).length;
                    if(count > 0) badge = `<span style="font-size:10px; background:#333; color:white; padding:2px 6px; border-radius:10px;">L·∫ßn: ${count+1}</span>`;
                }
            }

            return `
            <div class="rule-card ${r.s > 0 ? 'bonus' : 'penalty'}" onclick="app.addLog('${r.t}', ${r.s}, '${r.id}', '${r.sp||''}', ${r.inc||false})">
                <div class="r-content">${r.t}</div>
                <div class="r-footer">
                    ${badge}
                    ${isCustom ? `<span style="font-size:10px; color:#999;" onclick="event.stopPropagation(); app.deleteRule('${r.id}')">X√≥a</span>` : '<span></span>'}
                    <span class="r-score ${r.s > 0 ? 'text-success' : 'text-danger'}">${r.s > 0 ? '+' : ''}${r.s}</span>
                </div>
            </div>`;
        }).join('');
        
        grid.innerHTML = html;
    }

    switchTab(t, btn) {
        this.tab = t;
        this.renderRules();
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    openModal(id) { 
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none'); 
        document.getElementById(id).style.display = 'flex'; 
    }
    closeModal(id) { document.getElementById(id).style.display = 'none'; }

    saveNewRule() {
        const t = document.getElementById('newRText').value.trim();
        const s = parseFloat(document.getElementById('newRScore').value);
        const c = document.getElementById('newRCat').value;
        
        if (!t || isNaN(s)) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        
        this.customRules.push({ id: 'cust_' + Date.now(), t, s, c });
        this.saveRules();
        this.closeModal('modalRule');
        this.tab = 'custom';
        this.renderRules();
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const customBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.includes('T√πy ch·ªânh'));
        if(customBtn) customBtn.classList.add('active');
    }

    deleteRule(id) {
        if(confirm("X√≥a n√∫t n√†y?")) {
            this.customRules = this.customRules.filter(r => r.id !== id);
            this.saveRules();
        }
    }

    generateRemarkText(s) {
        const stats = this.calculate(s);
        let arr = [];
        if (stats.rank === 'T·ªët') arr.push("Ngoan, l·ªÖ ph√©p, ch·∫•p h√†nh t·ªët n·ªôi quy.");
        else if (stats.rank === 'Kh√°') arr.push("C√≥ √Ω th·ª©c r√®n luy·ªán, c·∫ßn kh·∫Øc ph·ª•c l·ªói nh·ªè.");
        else arr.push("C·∫ßn nghi√™m t√∫c ch·∫•n ch·ªânh n·ªÅ n·∫øp.");

        const has = (k) => s.logs.some(l => l.t.toLowerCase().includes(k) && l.s < 0);
        if (has('tr·ªÖ')) arr.push("C·∫ßn ƒëi h·ªçc ƒë√∫ng gi·ªù.");
        if (has('v·∫Øng')) arr.push("C·∫ßn ƒëi h·ªçc ƒë·∫ßy ƒë·ªß.");
        if (has('b√†i') || has('d·ª•ng c·ª•')) arr.push("C·∫ßn chu·∫©n b·ªã b√†i k·ªπ h∆°n.");
        if (has('ph·ª•c') || has('t√≥c')) arr.push("L∆∞u √Ω t√°c phong.");
        if (has('ƒëi·ªán tho·∫°i')) arr.push("Tu√¢n th·ªß quy ƒë·ªãnh d√πng ƒêT.");
        if (s.logs.some(l => l.s > 0)) arr.push("T√≠ch c·ª±c tham gia phong tr√†o.");
        
        return arr.join(" ");
    }
    
    generateRemark(force) {
        if(!this.currentId) return;
        const s = this.students.find(x => x.id == this.currentId);
        if(s) {
            s.remark = this.generateRemarkText(s);
            document.getElementById('remarkBox').value = s.remark;
            this.save();
        }
    }
    
    saveRemark() {
        if(!this.currentId) return;
        const s = this.students.find(x => x.id == this.currentId);
        if(s) {
            s.remark = document.getElementById('remarkBox').value;
            this.save();
        }
    }

    addStudent() { 
        const n = document.getElementById('newStudentName').value.trim();
        if (n) { 
            this.students.push({ id: Date.now(), name: n, logs: [], remark: '', crit: false }); 
            this.save(); 
            this.closeModal('modalStudent');
            document.getElementById('newStudentName').value = ''; 
        } else {
            alert("Vui l√≤ng nh·∫≠p t√™n!");
        }
    }
    deleteStudent() { 
        if (confirm("X√≥a h·ªçc sinh n√†y?")) { 
            this.students = this.students.filter(s => s.id != this.currentId); 
            this.currentId = null; 
            this.save(); 
            if(this.students.length) this.selectStudent(this.students[0].id);
            else this.renderStudentList(); 
        } 
    }
    toggleCrit() { 
        if(!this.currentId) return;
        const s = this.students.find(x => x.id == this.currentId);
        if (s) {
            s.crit = !s.crit; 
            this.save(); 
            this.renderInfo(); 
        }
    }
    resetData() { 
        if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")) { 
            localStorage.removeItem('hk_v10_data'); 
            location.reload(); 
        } 
    }

    // --- XU·∫§T EXCEL CHU·∫®N XLSX D√ôNG SHEETJS ---
    exportExcel() {
        const month = document.getElementById('monthSelect').value;
        const className = "Lop10H";
        const fileName = `HK_Yersin_${className}_Thang${month}.xlsx`;

        // 1. Chu·∫©n b·ªã d·ªØ li·ªáu b·∫£ng
        const ws_data = [];

        // Header
        const headerStyle = { font: { bold: true }, fill: { fgColor: { rgb: "E0E0E0" } }, alignment: { horizontal: "center", vertical: "center" } };
        ws_data.push(["STT", "H·ªå V√Ä T√äN", "BI·ªÇU HI·ªÜN T√çCH C·ª∞C", "ƒêI·ªÇM (+)", "H√ÄNH VI C·∫¶N C·∫¢I THI·ªÜN", "ƒêI·ªÇM (-)", "T·ªîNG ƒêI·ªÇM", "X·∫æP LO·∫†I", "NH·∫¨N X√âT"]);

        this.students.forEach((s, idx) => {
            const stats = this.calculate(s);
            
            // H√†m g·ªôp n·ªôi dung l·ªói
            const getGroupedText = (type) => {
                const logs = s.logs.filter(l => type === 'bonus' ? l.s > 0 : l.s < 0);
                let dict = {};
                logs.forEach(l => {
                    // Lo·∫°i b·ªè ch·ªØ (L·∫ßn X) ƒë·ªÉ g·ªôp nh√≥m cho g·ªçn n·∫øu mu·ªën, nh∆∞ng y√™u c·∫ßu hi·ªán t·∫°i gi·ªØ nguy√™n ƒë·ªÉ th·∫•y chi ti·∫øt
                    // ·ªû ƒë√¢y ta gi·ªØ nguy√™n text g·ªëc ƒë·ªÉ th·∫•y r√µ "L·∫ßn 1, L·∫ßn 2"
                    // Ho·∫∑c g·ªôp theo t√™n g·ªëc rule
                    const cleanName = l.t.replace(/\(L·∫ßn \d+\)/, '').trim();
                    if(!dict[cleanName]) dict[cleanName] = {dates:[], score:0};
                    dict[cleanName].dates.push(l.d);
                    dict[cleanName].score += l.s;
                });
                return Object.keys(dict).map(k => {
                    const g = dict[k];
                    // Format m·ªõi: - T√™n l·ªói [Ng√†y] (T·ªïng ƒëi·ªÉm tr·ª´)
                    // S·ª≠ d·ª•ng \n ƒë·ªÉ xu·ªëng d√≤ng trong √¥ Excel
                    return `- ${k} [${g.dates.join(', ')}] (${Math.abs(g.score)})`;
                }).join('\n');
            };

            const bonus = s.logs.filter(l => l.s > 0).reduce((a, b) => a + b.s, 0);
            const penalty = Math.abs(s.logs.filter(l => l.s < 0).reduce((a, b) => a + b.s, 0));

            ws_data.push([
                idx + 1,
                s.name,
                getGroupedText('bonus'),
                bonus || '',
                getGroupedText('penalty'),
                penalty || '',
                stats.total,
                stats.rank,
                s.remark || ''
            ]);
        });

        // 2. T·∫°o Workbook v√† Worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);

        // 3. ƒê·ªãnh d·∫°ng ƒë·ªô r·ªông c·ªôt
        ws['!cols'] = [
            { wch: 5 },  // STT
            { wch: 20 }, // T√™n
            { wch: 40 }, // T√≠ch c·ª±c
            { wch: 8 },  // ƒêi·ªÉm +
            { wch: 40 }, // Ti√™u c·ª±c
            { wch: 8 },  // ƒêi·ªÉm -
            { wch: 10 }, // T·ªïng
            { wch: 10 }, // X·∫øp lo·∫°i
            { wch: 30 }  // Nh·∫≠n x√©t
        ];

        // 4. B·∫≠t Wrap Text (xu·ªëng d√≤ng) cho t·∫•t c·∫£ c√°c √¥
        // L∆∞u √Ω: Phi√™n b·∫£n SheetJS Community (mi·ªÖn ph√≠) kh√¥ng h·ªó tr·ª£ style t·ª´ng √¥ khi xu·∫•t.
        // Tuy nhi√™n, k√Ω t·ª± \n v·∫´n ho·∫°t ƒë·ªông t·ªët khi m·ªü file. 
        // Ng∆∞·ªùi d√πng ch·ªâ c·∫ßn click "Wrap Text" trong Excel n·∫øu n√≥ kh√¥ng t·ª± nh·∫≠n.
        // (ƒê√¢y l√† gi·ªõi h·∫°n c·ªßa th∆∞ vi·ªán client-side mi·ªÖn ph√≠, nh∆∞ng n·ªôi dung th√¨ ƒë·∫£m b·∫£o chu·∫©n).

        XLSX.utils.book_append_sheet(wb, ws, "HanhKiem");

        // 5. Xu·∫•t file
        XLSX.writeFile(wb, fileName);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    window.app = new App();
});
</script>
</body>
</html>
