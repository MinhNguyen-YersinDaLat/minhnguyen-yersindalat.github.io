<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£o v·ªá s·ª©c kh·ªèe - N√≥i kh√¥ng v·ªõi thu·ªëc l√°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fefcfb 0%, #fef3e2 30%, #fef0f0 70%, #fefefe 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Main Menu Styles */
        .main-menu {
            text-align: center;
            color: #92400e;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(251, 146, 60, 0.15);
            box-shadow: 0 25px 50px rgba(194, 65, 12, 0.08);
        }

        .logo {
            font-size: 2.5rem;
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(194, 65, 12, 0.2);
            font-weight: bold;
            background: linear-gradient(45deg, #ef4444, #f97316, #fb923c, #fbbf24);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .title {
            font-size: 2.2rem;
            margin-bottom: 20px;
            line-height: 1.3;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 600;
            color: #92400e;
        }

        .subtitle {
            font-size: 1.1rem;
            margin-bottom: 35px;
            color: #92400e;
            font-style: italic;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7);
            padding: 15px 30px;
            background: rgba(254, 243, 199, 0.5);
            border-radius: 25px;
            border: 1px solid rgba(251, 146, 60, 0.2);
        }

        .author-info {
            margin-top: 40px;
            padding-top: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .author-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.5), transparent);
            max-width: 100px;
        }

        .author-text {
            text-align: center;
            font-size: 0.95rem;
            line-height: 1.4;
            color: #92400e;
        }

        .author-title {
            font-weight: 300;
            font-size: 0.9rem;
            color: #a16207;
        }

        .author-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #b91c1c;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }

        .author-school {
            font-weight: 500;
            font-size: 0.95rem;
            color: #92400e;
        }

        .smoke-effect {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 5rem;
            opacity: 0.4;
            animation: smokeDisappear 4s ease-out infinite;
            z-index: -1;
        }

        .smoke-effect::before {
            content: 'üí®üí®üí®';
            position: absolute;
            top: -20px;
            left: -100px;
            font-size: 3rem;
            opacity: 0.2;
            animation: smokeDisappear 5s ease-out infinite 1s;
        }

        .smoke-effect::after {
            content: 'üö≠';
            position: absolute;
            top: 60px;
            left: 20px;
            font-size: 2rem;
            opacity: 0.6;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes smokeDisappear {
            0% { opacity: 0.6; transform: translateX(-50%) translateY(0) scale(1); }
            50% { opacity: 0.3; transform: translateX(-50%) translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-80px) scale(1.5); }
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 40px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.25);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f97316, #ea580c);
            color: white;
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.25);
        }

        .btn-tertiary {
            background: linear-gradient(45deg, #fb923c, #f97316);
            color: white;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.25);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* Instructions Styles */
        .instructions {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            color: #1e293b;
            box-shadow: 0 25px 50px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .instructions h2 {
            color: #3b82f6;
            margin-bottom: 20px;
            font-size: 2rem;
            text-align: center;
        }

        .instructions p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .instructions ul {
            margin: 20px 0;
            padding-left: 30px;
        }

        .instructions li {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        /* Game Part 1 Styles */
        .game-part1 {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 30%, #334155 70%, #475569 100%);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .intro-text {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(147, 51, 234, 0.15) 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            max-width: 650px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
            backdrop-filter: blur(12px);
        }

        .intro-text h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .game-area {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 500px;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3) 0%, rgba(67, 56, 202, 0.2) 50%, rgba(79, 70, 229, 0.25) 100%);
            border-radius: 25px;
            margin: 20px auto;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(99, 102, 241, 0.4);
            box-shadow: 0 12px 40px rgba(30, 58, 138, 0.2);
            overflow: hidden;
        }

        /* Lighting Effects */
        .spotlight {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 40%, transparent 70%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 5;
            transform: translate(-50%, -50%);
        }

        .spotlight.active {
            opacity: 1;
            animation: spotlightPulse 2s ease-in-out infinite;
        }

        @keyframes spotlightPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .organ-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .organ.nearby .organ-glow {
            opacity: 1;
            animation: organGlow 1.5s ease-in-out infinite;
        }

        @keyframes organGlow {
            0%, 100% { transform: scale(1); opacity: 0.4; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        .character {
            position: absolute;
            font-size: 3rem;
            transition: all 0.3s ease;
            z-index: 10;
            cursor: pointer;
            animation: bounce 2s ease-in-out infinite;
            left: 50%;
            top: 80%;
            transform: translate(-50%, -50%);
        }

        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) translateY(0px); }
            50% { transform: translate(-50%, -50%) translateY(-10px); }
        }

        .organ {
            position: absolute;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(196, 181, 253, 0.2) 100%);
            border-radius: 50%;
            padding: 20px;
            cursor: pointer;
            transition: all 0.4s ease;
            min-width: 120px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(12px);
            border: 3px solid rgba(139, 92, 246, 0.5);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
        }

        .organ:hover, .organ.nearby {
            transform: scale(1.15);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(196, 181, 253, 0.35) 100%);
            box-shadow: 0 15px 40px rgba(139, 92, 246, 0.3);
            border-color: rgba(168, 85, 247, 0.8);
            filter: brightness(1.1);
        }

        /* Chia th√†nh l∆∞·ªõi 3x3 v·ªõi c√°c khu v·ª±c ri√™ng bi·ªát */
        .organ-eyes {
            top: 15%;
            left: 15%;
        }

        .organ-brain {
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
        }

        .organ-lungs {
            top: 15%;
            right: 15%;
        }

        .organ-heart {
            top: 45%;
            left: 15%;
        }

        .organ-liver {
            top: 45%;
            left: 50%;
            transform: translateX(-50%);
        }

        .organ-stomach {
            top: 45%;
            right: 15%;
        }

        .organ-kidney {
            top: 75%;
            left: 50%;
            transform: translateX(-50%);
        }

        .organ-icon {
            font-size: 3rem;
            margin-bottom: 8px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
            to { text-shadow: 0 0 20px rgba(255, 255, 255, 0.8); }
        }

        .organ-name {
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
        }

        .game-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(147, 51, 234, 0.15) 100%);
            border-radius: 15px;
            padding: 12px;
            backdrop-filter: blur(12px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
        }

        .control-hint {
            font-size: 0.8rem;
            text-align: center;
            margin-bottom: 8px;
            color: white;
            font-weight: bold;
        }

        .movement-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            max-width: 120px;
            margin: 0 auto;
        }

        .move-btn {
            padding: 6px;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .move-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .move-btn:active {
            transform: scale(0.95);
        }

        .interaction-hint {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
        }

        .interaction-hint.show {
            opacity: 1;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            color: #1e293b;
            box-shadow: 0 25px 50px rgba(15, 23, 42, 0.15);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-size: 2rem;
            color: #3b82f6;
        }

        .modal-icon {
            font-size: 3rem;
            margin-right: 15px;
        }

        .modal-text {
            font-size: 1.1rem;
            line-height: 1.7;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .conversation-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: #3b82f6;
            transform: scale(1.2);
        }

        .progress-dot.completed {
            background: #10b981;
        }

        .conversation-controls {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .conversation-hint {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            font-style: italic;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #ef4444;
        }

        /* Progress and Score */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 100;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #06b6d4);
            width: 0%;
            transition: width 0.5s ease;
        }

        .score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            color: #1e293b;
            z-index: 100;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .title {
                font-size: 1.5rem;
            }
            
            .organs-container {
                gap: 20px;
            }
            
            .organ {
                min-width: 150px;
                padding: 20px;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
        }

        /* Navigation Buttons */
        .nav-buttons {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .nav-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            color: #1e293b;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(15, 23, 42, 0.15);
        }

        .completion-screen {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            text-align: center;
        }

        .completion-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            backdrop-filter: blur(10px);
        }

        .completion-content h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .completion-content p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        /* Game Part 2 Styles - Shooting Game */
        .part2-intro {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .part2-intro-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .part2-intro h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: warningPulse 2s ease-in-out infinite;
        }

        @keyframes warningPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .falling-toxins {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .falling-toxin {
            position: absolute;
            font-size: 2rem;
            animation: fallDown 3s linear infinite;
            opacity: 0.7;
        }

        @keyframes fallDown {
            0% { transform: translateY(-50px); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0.7; }
            100% { transform: translateY(100vh); opacity: 0; }
        }

        .shooting-game {
            background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
            color: white;
            position: relative;
            overflow: hidden;
            min-height: 100vh;
        }

        .game-canvas {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .player-ship {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            z-index: 10;
            transition: left 0.1s ease;
        }

        .enemy {
            position: absolute;
            font-size: 2rem;
            z-index: 5;
            transition: all 0.1s ease;
            cursor: pointer;
        }

        .enemy:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8));
        }

        .bullet {
            position: absolute;
            width: 4px;
            height: 15px;
            background: linear-gradient(180deg, #fbbf24, #f59e0b);
            border-radius: 2px;
            z-index: 8;
        }

        .explosion {
            position: absolute;
            font-size: 3rem;
            z-index: 15;
            animation: explode 0.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes explode {
            0% { transform: scale(0.5); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .game-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }

        .lives-display {
            display: flex;
            gap: 10px;
            font-size: 2rem;
        }

        .life-icon {
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        .life-icon.lost {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .score-hud {
            font-size: 1.2rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .wave-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            z-index: 25;
            opacity: 0;
            animation: waveAnnounce 2s ease-out;
        }

        @keyframes waveAnnounce {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .toxin-info-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid #ef4444;
            z-index: 100;
            max-width: 350px;
            text-align: left;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
            opacity: 0;
            animation: popupSlideIn 2s ease-out forwards;
            backdrop-filter: blur(10px);
        }

        @keyframes popupSlideIn {
            0% { opacity: 0; transform: translateX(100%); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }

        .toxin-info-popup h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toxin-info-popup p {
            font-size: 0.9rem;
            line-height: 1.4;
            margin: 0;
        }

        .game-controls-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 20;
        }

        .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .game-over-screen.show {
            opacity: 1;
            pointer-events: all;
        }

        .game-over-content {
            text-align: center;
            background: rgba(220, 38, 38, 0.2);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #dc2626;
            max-width: 600px;
        }

        .game-over-content h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #ef4444;
        }

        .game-over-content p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .game-mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .victory-screen {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            text-align: center;
        }

        .victory-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
            backdrop-filter: blur(10px);
        }

        .victory-content h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            animation: victoryGlow 2s ease-in-out infinite;
        }

        @keyframes victoryGlow {
            0%, 100% { text-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
            50% { text-shadow: 0 0 30px rgba(16, 185, 129, 1); }
        }
    </style>
</head>
<body>
    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Score Display -->
    <div class="score-display" id="scoreDisplay">ƒêi·ªÉm: 0</div>

    <!-- Main Menu Screen -->
    <div class="screen active" id="mainMenu">
        <div class="smoke-effect">üí®</div>
        <div class="main-menu">
            <div class="logo">üö≠‚ú® "H√ÄNH TR√åNH KH√îNG KH√ìI" ‚ú®üö≠</div>
            <h1 class="title">Cu·ªôc phi√™u l∆∞u qua c√°c c∆° quan<br><span style="font-size: 0.75em; color: #b91c1c; font-weight: 600; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">ƒë·ªÉ gi·ªØ c∆° th·ªÉ kh·ªèe m·∫°nh</span></h1>
            <div class="subtitle">üåü Kh√°m ph√° 7 c∆° quan quan tr·ªçng v√† h·ªçc c√°ch b·∫£o v·ªá ch√∫ng üåü</div>
            <div class="menu-buttons">
                <button class="btn btn-primary" onclick="startGame()">üéÆ B·∫Øt ƒë·∫ßu h√†nh tr√¨nh</button>
                <button class="btn btn-secondary" onclick="showInstructions()">üìñ H∆∞·ªõng d·∫´n ch∆°i</button>
                <button class="btn btn-tertiary" onclick="exitGame()">üö™ Tho√°t</button>
            </div>
            <div class="author-info">
                <div class="author-line"></div>
                <div class="author-text">
                    <span class="author-title">T√°c gi·∫£:</span><br>
                    <span class="author-name">Th·∫ßy gi√°o Th√°i Minh Nguy√™n</span><br>
                    <span class="author-school">Tr∆∞·ªùng THPT Yersin ƒê√† L·∫°t</span>
                </div>
                <div class="author-line"></div>
            </div>
        </div>
    </div>

    <!-- Instructions Screen -->
    <div class="screen" id="instructionsScreen">
        <div class="instructions">
            <h2>üìã H∆∞·ªõng d·∫´n ch∆°i</h2>
            <p><strong>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi tr√≤ ch∆°i gi√°o d·ª•c v·ªÅ s·ª©c kh·ªèe!</strong></p>
            
            <h3>üéØ M·ª•c ti√™u:</h3>
            <p>T√¨m hi·ªÉu t√°c h·∫°i c·ªßa thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠ ƒë·ªëi v·ªõi c∆° th·ªÉ, ƒë·ªìng th·ªùi h·ªçc c√°ch b·∫£o v·ªá s·ª©c kh·ªèe.</p>
            
            <h3>üéÆ C·∫•u tr√∫c game:</h3>
            <ul>
                <li><strong>Ph·∫ßn 1:</strong> Kh√°m ph√° vai tr√≤ c·ªßa c√°c c∆° quan (Tim - N√£o - Ph·ªïi)</li>
                <li><strong>Ph·∫ßn 2:</strong> T√¨m hi·ªÉu t√°c h·∫°i c·ªßa thu·ªëc l√°</li>
                <li><strong>Ph·∫ßn 3:</strong> H·ªçc c√°ch b·∫£o v·ªá s·ª©c kh·ªèe</li>
            </ul>
            
            <h3>‚≠ê C√°ch ch∆°i:</h3>
            <ul>
                <li>Nh·∫•p v√†o c√°c c∆° quan ƒë·ªÉ t√¨m hi·ªÉu th√¥ng tin</li>
                <li>ƒê·ªçc k·ªπ n·ªôi dung ƒë·ªÉ hi·ªÉu r√µ t√°c h·∫°i</li>
                <li>T√≠ch l≈©y ƒëi·ªÉm s·ªë qua t·ª´ng ph·∫ßn</li>
                <li>Ho√†n th√†nh t·∫•t c·∫£ ƒë·ªÉ nh·∫≠n ph·∫ßn th∆∞·ªüng</li>
            </ul>
            
            <p><strong>üí° L∆∞u √Ω:</strong> ƒêi·ªÉm s·ªë t√≠ch l≈©y s·∫Ω quy·∫øt ƒë·ªãnh ph·∫ßn th∆∞·ªüng cu·ªëi game. H√£y tham gia t√≠ch c·ª±c!</p>
            
            <div class="menu-buttons">
                <button class="btn btn-primary" onclick="startGame()">B·∫Øt ƒë·∫ßu ngay</button>
                <button class="btn btn-secondary" onclick="showMainMenu()">Quay l·∫°i</button>
            </div>
        </div>
    </div>

    <!-- Game Part 1 Screen -->
    <div class="screen" id="gamePart1">
        <div class="intro-text">
            <h2>‚ù§Ô∏èüß†ü´Åü´Äü´òüåÄüëÅÔ∏è G·∫∑p g·ª° 7 ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh</h2>
            <p>"Ch√∫ng t√¥i l√† 7 c∆° quan quan tr·ªçng nh·∫•t c·ªßa c∆° th·ªÉ ‚Äì h√£y t√¨m hi·ªÉu v√† b·∫£o v·ªá ch√∫ng t√¥i kh·ªèi t√°c h·∫°i c·ªßa thu·ªëc l√°!"</p>
        </div>
        
        <div class="game-area">
            <!-- Spotlight Effect -->
            <div class="spotlight" id="spotlight"></div>
            
            <!-- Character -->
            <div class="character" id="character">üßë‚Äç‚öïÔ∏è</div>
            
            <!-- Organs -->
            <div class="organ organ-heart" id="heartOrgan">
                <div class="organ-glow"></div>
                <div class="organ-icon">‚ù§Ô∏è</div>
                <div class="organ-name">TIM</div>
                <div class="interaction-hint" id="heartHint">Nh·∫•n SPACE ƒë·ªÉ n√≥i chuy·ªán!</div>
            </div>
            
            <div class="organ organ-brain" id="brainOrgan">
                <div class="organ-glow"></div>
                <div class="organ-icon">üß†</div>
                <div class="organ-name">N√ÉO</div>
                <div class="interaction-hint" id="brainHint">Nh·∫•n SPACE ƒë·ªÉ n√≥i chuy·ªán!</div>
            </div>
            
            <div class="organ organ-lungs" id="lungsOrgan">
                <div class="organ-glow"></div>
                <div class="organ-icon">ü´Å</div>
                <div class="organ-name">PH·ªîI</div>
                <div class="interaction-hint" id="lungsHint">Nh·∫•n SPACE ƒë·ªÉ n√≥i chuy·ªán!</div>
            </div>
            
            <div class="organ organ-liver" id="liverOrgan">
                <div class="organ-glow"></div>
                <div class="organ-icon">ü´Ä</div>
                <div class="organ-name">GAN</div>
                <div class="interaction-hint" id="liverHint">Nh·∫•n SPACE ƒë·ªÉ n√≥i chuy·ªán!</div>
            </div>
            
            <div class="organ organ-kidney" id="kidneyOrgan">
                <div class="organ-glow"></div>
                <div class="organ-icon">ü´ò</div>
                <div class="organ-name">TH·∫¨N</div>
                <div class="interaction-hint" id="kidneyHint">Nh·∫•n SPACE ƒë·ªÉ n√≥i chuy·ªán!</div>
            </div>
            
            <div class="organ organ-stomach" id="stomachOrgan">
                <div class="organ-glow"></div>
                <div class="organ-icon">üåÄ</div>
                <div class="organ-name">RU·ªòT</div>
                <div class="interaction-hint" id="stomachHint">Nh·∫•n SPACE ƒë·ªÉ n√≥i chuy·ªán!</div>
            </div>
            
            <div class="organ organ-eyes" id="eyesOrgan">
                <div class="organ-glow"></div>
                <div class="organ-icon">üëÅÔ∏è</div>
                <div class="organ-name">M·∫ÆT</div>
                <div class="interaction-hint" id="eyesHint">Nh·∫•n SPACE ƒë·ªÉ n√≥i chuy·ªán!</div>
            </div>

            <!-- Game Controls Inside Game Area -->
            <div class="game-controls">
                <div class="control-hint">üéÆ ƒêi·ªÅu khi·ªÉn</div>
                <div class="movement-buttons">
                    <div></div>
                    <button class="move-btn" onmousedown="moveCharacter('up')" onmouseup="stopMoving()">‚Üë</button>
                    <div></div>
                    <button class="move-btn" onmousedown="moveCharacter('left')" onmouseup="stopMoving()">‚Üê</button>
                    <button class="move-btn" onmousedown="moveCharacter('down')" onmouseup="stopMoving()">‚Üì</button>
                    <button class="move-btn" onmousedown="moveCharacter('right')" onmouseup="stopMoving()">‚Üí</button>
                    <div></div>
                    <button class="move-btn" onclick="interactWithNearbyOrgan()">üí¨</button>
                    <div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Completion Screen -->
    <div class="screen" id="completionScreen">
        <div class="completion-content">
            <h2>üéâ Ch√∫c m·ª´ng!</h2>
            <p>B·∫°n ƒë√£ kh√°m ph√° vai tr√≤ quan tr·ªçng c·ªßa c√°c c∆° quan s·ªëng c√≤n.</p>
            <p><strong>H√£y b·∫£o v·ªá ch√∫ng b·∫±ng c√°ch tr√°nh xa thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠!</strong></p>
            <p>ƒêi·ªÉm s·ªë c·ªßa b·∫°n: <span id="finalScore">0</span></p>
            
            <div class="menu-buttons">
                <button class="btn btn-primary" onclick="continueToNextPart()">Ti·∫øp t·ª•c Ph·∫ßn 2</button>
                <button class="btn btn-secondary" onclick="showMainMenu()">V·ªÅ menu ch√≠nh</button>
            </div>
        </div>
    </div>

    <!-- Game Mode Selection Screen -->
    <div class="screen" id="gameModeSelection">
        <div class="part2-intro-content">
            <h2>üéÆ PH·∫¶N 2: CH·ªåN C√ÅCH CH∆†I üéÆ</h2>
            <p style="font-size: 1.2rem; margin-bottom: 40px;">
                B·∫°n mu·ªën t√¨m hi·ªÉu t√°c h·∫°i c·ªßa thu·ªëc l√° theo c√°ch n√†o?
            </p>
            
            <div class="game-mode-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 800px; margin: 0 auto;">
                <!-- Shooting Game Mode -->
                <div class="game-mode-card" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); padding: 30px; border-radius: 20px; text-align: center; cursor: pointer; transition: transform 0.3s ease;" onclick="startShootingGame()">
                    <div style="font-size: 4rem; margin-bottom: 15px;">üöÄ</div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: white;">Game B·∫Øn S√∫ng</h3>
                    <p style="color: #fecaca; margin-bottom: 20px;">Chi·∫øn ƒë·∫•u v·ªõi c√°c ch·∫•t ƒë·ªôc h·∫°i t·ª´ thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠!</p>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; font-size: 0.9rem;">
                        ‚ö° H√†nh ƒë·ªông nhanh<br>
                        üéØ Ph·∫£n x·∫° t·ªët<br>
                        üí• Th·ª≠ th√°ch k·ªπ nƒÉng
                    </div>
                </div>
                
                <!-- Quiz Game Mode -->
                <div class="game-mode-card" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); padding: 30px; border-radius: 20px; text-align: center; cursor: pointer; transition: transform 0.3s ease;" onclick="startQuizGame()">
                    <div style="font-size: 4rem; margin-bottom: 15px;">üß†</div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: white;">Game C√¢u H·ªèi</h3>
                    <p style="color: #a7f3d0; margin-bottom: 20px;">Tr·∫£ l·ªùi c√¢u h·ªèi v·ªÅ t√°c h·∫°i c·ªßa thu·ªëc l√° m·ªôt c√°ch th√¥ng minh!</p>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; font-size: 0.9rem;">
                        üìö H·ªçc ki·∫øn th·ª©c<br>
                        ü§î Suy nghƒ© logic<br>
                        üèÜ T√≠ch l≈©y ƒëi·ªÉm cao
                    </div>
                </div>
                
                <!-- Memory Game Mode -->
                <div class="game-mode-card" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); padding: 30px; border-radius: 20px; text-align: center; cursor: pointer; transition: transform 0.3s ease;" onclick="startMemoryGame()">
                    <div style="font-size: 4rem; margin-bottom: 15px;">üß©</div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: white;">Game Tr√≠ Nh·ªõ</h3>
                    <p style="color: #ddd6fe; margin-bottom: 20px;">Gh√©p ƒë√¥i c√°c ch·∫•t ƒë·ªôc v·ªõi t√°c h·∫°i c·ªßa ch√∫ng!</p>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; font-size: 0.9rem;">
                        üß† R√®n luy·ªán tr√≠ nh·ªõ<br>
                        üîó K·∫øt n·ªëi th√¥ng tin<br>
                        ‚è∞ Th·ª≠ th√°ch th·ªùi gian
                    </div>
                </div>
                
                <!-- Story Mode -->
                <div class="game-mode-card" style="background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); padding: 30px; border-radius: 20px; text-align: center; cursor: pointer; transition: transform 0.3s ease;" onclick="startStoryMode()">
                    <div style="font-size: 4rem; margin-bottom: 15px;">üìñ</div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: white;">Ch·∫ø ƒê·ªô C√¢u Chuy·ªán</h3>
                    <p style="color: #fed7aa; margin-bottom: 20px;">Theo d√µi h√†nh tr√¨nh c·ªßa m·ªôt ng∆∞·ªùi h√∫t thu·ªëc!</p>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; font-size: 0.9rem;">
                        üìö C√¢u chuy·ªán th·ª±c t·∫ø<br>
                        üí≠ C·∫£m x√∫c s√¢u s·∫Øc<br>
                        üé≠ Tr·∫£i nghi·ªám nh·∫≠p vai
                    </div>
                </div>
            </div>
            
            <div class="menu-buttons" style="margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showMainMenu()">üè† V·ªÅ menu ch√≠nh</button>
            </div>
        </div>
        
        <!-- Falling toxins animation -->
        <div class="falling-toxins" id="fallingToxins"></div>
    </div>

    <!-- Part 2 Intro Screen -->
    <div class="screen" id="part2Intro">
        <div class="part2-intro-content">
            <h2>‚ö†Ô∏è PH·∫¶N 2: S·ª∞ X√ÇM LƒÇNG C·ª¶A C√ÅC CH·∫§T ƒê·ªòC H·∫†I ‚ö†Ô∏è</h2>
            <p style="font-size: 1.3rem; margin-bottom: 30px;">
                üö® <strong>C·∫©n th·∫≠n! K·∫ª th√π ƒëang ·ªì ·∫°t t·∫•n c√¥ng t·ª´ thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠!</strong>
            </p>
            <p style="font-size: 1.1rem; margin-bottom: 30px;">
                üéØ <strong>Nhi·ªám v·ª•:</strong> N√© tr√°nh v√† ti√™u di·ªát c√°c ch·∫•t ƒë·ªôc h·∫°i tr∆∞·ªõc khi ch√∫ng ph√° h·ªßy c∆° th·ªÉ b·∫°n!
            </p>
            <div style="margin: 30px 0;">
                <p style="font-size: 1rem; color: #fbbf24;">
                    üéÆ <strong>ƒêi·ªÅu khi·ªÉn:</strong> ‚Üê ‚Üí ƒë·ªÉ di chuy·ªÉn, SPACE ƒë·ªÉ b·∫Øn<br>
                    üíñ B·∫°n c√≥ 3 m·∫°ng: Tr√°i tim üíñ - S·ª©c m·∫°nh üåü - NƒÉng l∆∞·ª£ng ‚ú®
                </p>
            </div>
            <div class="menu-buttons">
                <button class="btn btn-primary" onclick="startActualShootingGame()">üöÄ B·∫Øt ƒë·∫ßu chi·∫øn ƒë·∫•u!</button>
                <button class="btn btn-secondary" onclick="showGameModeSelection()">üîô Ch·ªçn l·∫°i ch·∫ø ƒë·ªô</button>
                <button class="btn btn-secondary" onclick="showMainMenu()">üè† V·ªÅ menu ch√≠nh</button>
            </div>
        </div>
        
        <!-- Falling toxins animation -->
        <div class="falling-toxins" id="fallingToxins"></div>
    </div>

    <!-- Shooting Game Screen -->
    <div class="screen" id="shootingGame">
        <div class="game-canvas" id="gameCanvas">
            <!-- Game HUD -->
            <div class="game-hud">
                <div class="lives-display" id="livesDisplay">
                    <span class="life-icon" id="life1">üíñ</span>
                    <span class="life-icon" id="life2">üåü</span>
                    <span class="life-icon" id="life3">‚ú®</span>
                </div>
                <div class="score-hud">
                    <span>ƒêi·ªÉm: </span><span id="gameScore">0</span>
                </div>
            </div>
            
            <!-- Player Ship -->
            <div class="player-ship" id="playerShip">ü¶∏‚Äç‚ôÄÔ∏è</div>
            
            <!-- Wave Indicator -->
            <div class="wave-indicator" id="waveIndicator"></div>
            
            <!-- Game Over Screen -->
            <div class="game-over-screen" id="gameOverScreen">
                <div class="game-over-content">
                    <h2 id="gameOverTitle">üíÄ Game Over</h2>
                    <p id="gameOverMessage">H√∫t thu·ªëc h·ªßy ho·∫°i s·ª©c kh·ªèe t·ª´ng ng√†y. C∆° th·ªÉ b·∫°n ƒë√£ b·ªã t·ªïn th∆∞∆°ng nghi√™m tr·ªçng!</p>
                    <div class="menu-buttons">
                        <button class="btn btn-primary" onclick="restartShootingGame()">üîÑ Ch∆°i l·∫°i</button>
                        <button class="btn btn-secondary" onclick="showMainMenu()">üè† Menu ch√≠nh</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Controls Info -->
        <div class="game-controls-info">
            üéÆ ‚Üê ‚Üí Di chuy·ªÉn | SPACE B·∫Øn | ESC T·∫°m d·ª´ng
        </div>
    </div>

    <!-- Victory Screen -->
    <div class="screen" id="victoryScreen">
        <div class="victory-content">
            <h2>üéâ Chi·∫øn th·∫Øng!</h2>
            <p style="font-size: 1.3rem; margin-bottom: 20px;">
                B·∫°n ƒë√£ ngƒÉn ch·∫∑n l√†n s√≥ng t·∫•n c√¥ng c·ªßa c√°c ch·∫•t ƒë·ªôc h·∫°i!
            </p>
            <p style="font-size: 1.1rem; margin-bottom: 30px;">
                ‚ö†Ô∏è <strong>Nh∆∞ng hi·ªÉm h·ªça v·∫´n c√≤n...</strong><br>
                Trong th·ª±c t·∫ø, thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠ t·∫•n c√¥ng c∆° th·ªÉ 24/7.<br>
                C√°ch duy nh·∫•t ƒë·ªÉ th·∫Øng l√† <strong>KH√îNG BAO GI·ªú H√öT!</strong>
            </p>
            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <p style="font-size: 1rem;">
                    üèÜ <strong>ƒêi·ªÉm s·ªë cu·ªëi c√πng:</strong> <span id="finalGameScore">0</span><br>
                    üéØ <strong>Ch·∫•t ƒë·ªôc ti√™u di·ªát:</strong> <span id="toxinsDestroyed">0</span>
                </p>
            </div>
            <div class="menu-buttons">
                <button class="btn btn-primary" onclick="continueToNextPart()">‚û°Ô∏è Ti·∫øp t·ª•c Ph·∫ßn 3</button>
                <button class="btn btn-secondary" onclick="showMainMenu()">üè† Menu ch√≠nh</button>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="nav-buttons" id="navButtons" style="display: none;">
        <button class="nav-btn" onclick="goBack()">‚¨ÖÔ∏è Quay l·∫°i</button>
        <button class="nav-btn" onclick="showMainMenu()">üè† Menu ch√≠nh</button>
    </div>

    <!-- Modal for Organ Information -->
    <div class="modal" id="organModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div class="modal-header">
                <span class="modal-icon" id="modalIcon"></span>
                <span id="modalTitle"></span>
            </div>
            <div class="conversation-progress" id="conversationProgress"></div>
            <div class="modal-text" id="modalText"></div>
            <div class="conversation-controls">
                <div class="conversation-hint" id="conversationHint">Nh·∫•n SPACE ƒë·ªÉ ti·∫øp t·ª•c cu·ªôc tr√≤ chuy·ªán...</div>
                <div class="menu-buttons">
                    <button class="btn btn-secondary" id="nextMessageBtn" onclick="nextMessage()">Ti·∫øp t·ª•c (SPACE)</button>
                    <button class="btn btn-primary" id="finishConversationBtn" onclick="closeModal()" style="display: none;">K·∫øt th√∫c</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentScreen = 'mainMenu';
        let score = 0;
        let visitedOrgans = new Set();
        let progress = 0;
        
        // Character movement variables
        let characterPosition = { x: 50, y: 80 }; // Percentage positions
        let isMoving = false;
        let moveInterval = null;
        let currentDirection = null;
        let nearbyOrgan = null;

        // Sound System with improved audio context handling
        const soundSystem = {
            audioContext: null,
            heartbeat: null,
            breathing: null,
            currentAmbient: null,
            isInitialized: false,
            
            async init() {
                try {
                    // Initialize audio context on user interaction
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Resume audio context if suspended
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    this.createHeartbeatSound();
                    this.createBreathingSound();
                    this.isInitialized = true;
                    console.log('Sound system initialized successfully');
                } catch (e) {
                    console.log('Audio initialization failed:', e);
                    this.isInitialized = false;
                }
            },
            
            async ensureAudioContext() {
                if (!this.audioContext || this.audioContext.state === 'closed') {
                    await this.init();
                }
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }
            },
            
            createHeartbeatSound() {
                this.heartbeat = {
                    isPlaying: false,
                    interval: null,
                    async play() {
                        if (this.isPlaying) return;
                        await soundSystem.ensureAudioContext();
                        this.isPlaying = true;
                        this.interval = setInterval(async () => {
                            await this.playBeat();
                        }, 800); // 75 BPM
                    },
                    stop() {
                        this.isPlaying = false;
                        if (this.interval) {
                            clearInterval(this.interval);
                            this.interval = null;
                        }
                    },
                    async playBeat() {
                        try {
                            await soundSystem.ensureAudioContext();
                            const oscillator = soundSystem.audioContext.createOscillator();
                            const gainNode = soundSystem.audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(soundSystem.audioContext.destination);
                            
                            oscillator.frequency.setValueAtTime(200, soundSystem.audioContext.currentTime);
                            gainNode.gain.setValueAtTime(0.15, soundSystem.audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, soundSystem.audioContext.currentTime + 0.15);
                            
                            oscillator.start(soundSystem.audioContext.currentTime);
                            oscillator.stop(soundSystem.audioContext.currentTime + 0.15);
                        } catch (e) {
                            console.log('Heartbeat sound failed:', e);
                        }
                    }
                };
            },
            
            createBreathingSound() {
                this.breathing = {
                    isPlaying: false,
                    interval: null,
                    async play() {
                        if (this.isPlaying) return;
                        await soundSystem.ensureAudioContext();
                        this.isPlaying = true;
                        this.interval = setInterval(async () => {
                            await this.playBreath();
                        }, 3000); // Every 3 seconds
                    },
                    stop() {
                        this.isPlaying = false;
                        if (this.interval) {
                            clearInterval(this.interval);
                            this.interval = null;
                        }
                    },
                    async playBreath() {
                        try {
                            await soundSystem.ensureAudioContext();
                            const oscillator = soundSystem.audioContext.createOscillator();
                            const gainNode = soundSystem.audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(soundSystem.audioContext.destination);
                            
                            oscillator.frequency.setValueAtTime(120, soundSystem.audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(180, soundSystem.audioContext.currentTime + 1.5);
                            oscillator.frequency.exponentialRampToValueAtTime(120, soundSystem.audioContext.currentTime + 2.5);
                            
                            gainNode.gain.setValueAtTime(0.08, soundSystem.audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, soundSystem.audioContext.currentTime + 2.5);
                            
                            oscillator.start(soundSystem.audioContext.currentTime);
                            oscillator.stop(soundSystem.audioContext.currentTime + 2.5);
                        } catch (e) {
                            console.log('Breathing sound failed:', e);
                        }
                    }
                };
            },
            
            async playInteractionSound() {
                try {
                    await this.ensureAudioContext();
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(500, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, this.audioContext.currentTime + 0.2);
                    
                    gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.2);
                } catch (e) {
                    console.log('Interaction sound failed:', e);
                }
            },
            
            async playMoveSound() {
                try {
                    await this.ensureAudioContext();
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(350, this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.05, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.1);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                } catch (e) {
                    console.log('Move sound failed:', e);
                }
            },
            
            async startOrganAmbient(organType) {
                this.stopAllAmbient();
                switch(organType) {
                    case 'heart':
                        await this.heartbeat.play();
                        this.currentAmbient = 'heart';
                        break;
                    case 'lungs':
                        await this.breathing.play();
                        this.currentAmbient = 'lungs';
                        break;
                    case 'brain':
                        // Brain has no specific ambient sound
                        this.currentAmbient = 'brain';
                        break;
                }
            },
            
            stopAllAmbient() {
                if (this.heartbeat) this.heartbeat.stop();
                if (this.breathing) this.breathing.stop();
                this.currentAmbient = null;
            }
        };

        const organInfo = {
            heart: {
                icon: '‚ù§Ô∏è',
                title: 'Tim - Tr√°i tim c·ªßa b·∫°n',
                messages: [
                    "Xin ch√†o! M√¨nh l√† Tim ‚Äì tr√°i tim c·ªßa b·∫°n. üíì",
                    "M·ªói ng√†y, m√¨nh ƒë·∫≠p kho·∫£ng 100.000 l·∫ßn, b∆°m h∆°n 7.500 l√≠t m√°u ƒëi kh·∫Øp c∆° th·ªÉ ƒë·ªÉ nu√¥i d∆∞·ª°ng t·ª´ng t·∫ø b√†o.",
                    "Nh·ªù m√¨nh, n√£o c√≥ ƒë·ªß oxy ƒë·ªÉ suy nghƒ©, ph·ªïi ho·∫°t ƒë·ªông tr∆°n tru, v√† c√°c c∆° quan kh√°c duy tr√¨ s·ª± s·ªëng.",
                    "Nh∆∞ng n·∫øu b·∫°n h√∫t thu·ªëc, ch·∫•t nicotine s·∫Ω l√†m tƒÉng nh·ªãp tim v√† huy·∫øt √°p... üò∞",
                    "Carbon monoxide chi·∫øm ch·ªó oxy trong m√°u, khi·∫øn m√¨nh ph·∫£i l√†m vi·ªác qu√° s·ª©c v√† d·ªÖ b·ªã nh·ªìi m√°u c∆° tim.",
                    "M√¨nh mu·ªën s·ªëng kh·ªèe m·∫°nh ƒë·ªÉ ƒë·ªìng h√†nh c√πng b·∫°n c·∫£ ƒë·ªùi. ƒê·ª´ng ƒë·ªÉ kh√≥i thu·ªëc ph√° h·ªßy m√¨nh nh√©! ‚ù§Ô∏è"
                ]
            },
            brain: {
                icon: 'üß†',
                title: 'N√£o - Trung t√¢m ƒëi·ªÅu khi·ªÉn',
                messages: [
                    "Xin ch√†o! M√¨nh l√† N√£o ‚Äì trung t√¢m ƒëi·ªÅu khi·ªÉn c·ªßa c∆° th·ªÉ. üß†",
                    "M√¨nh ch·ª©a kho·∫£ng 86 t·ª∑ t·∫ø b√†o th·∫ßn kinh, x·ª≠ l√Ω h√†ng tri·ªáu th√¥ng tin m·ªói gi√¢y...",
                    "M√¨nh gi√∫p b·∫°n suy nghƒ©, h·ªçc t·∫≠p, v√† c·∫£m nh·∫≠n cu·ªôc s·ªëng m·ªôt c√°ch tuy·ªát v·ªùi!",
                    "Nh∆∞ng nicotine trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠ c√≥ th·ªÉ thay ƒë·ªïi c·∫•u tr√∫c v√† ch·ª©c nƒÉng c·ªßa m√¨nh... üòµ",
                    "ƒê·∫∑c bi·ªát nguy hi·ªÉm ·ªü tu·ªïi v·ªã th√†nh ni√™n khi m√¨nh ƒëang ph√°t tri·ªÉn.",
                    "M√¨nh s·∫Ω b·ªã r·ªëi lo·∫°n t·∫≠p trung, gi·∫£m tr√≠ nh·ªõ, th·∫≠m ch√≠ m·∫•t ki·ªÉm so√°t h√†nh vi khi ph·ª• thu·ªôc v√†o ch·∫•t g√¢y nghi·ªán n√†y.",
                    "H√£y cho m√¨nh m√¥i tr∆∞·ªùng trong l√†nh, kh√¥ng kh√≥i thu·ªëc ƒë·ªÉ m√¨nh c√≥ th·ªÉ gi√∫p b·∫°n ƒë·∫°t ƒë∆∞·ª£c m·ªçi ∆∞·ªõc m∆°! üåü"
                ]
            },
            lungs: {
                icon: 'ü´Å',
                title: 'Ph·ªïi - L√° ph·ªïi c·ªßa b·∫°n',
                messages: [
                    "Xin ch√†o! M√¨nh l√† Ph·ªïi ‚Äì l√° ph·ªïi c·ªßa b·∫°n. ü´Å",
                    "M·ªói ng√†y, m√¨nh trao ƒë·ªïi h∆°n 6.000 l√≠t kh√¥ng kh√≠, ƒë∆∞a oxy v√†o m√°u v√† lo·∫°i b·ªè CO‚ÇÇ.",
                    "M√¨nh l√† 'm√°y l·ªçc kh√¥ng kh√≠' t·ª± nhi√™n c·ªßa c∆° th·ªÉ b·∫°n ƒë·∫•y!",
                    "N·∫øu b·∫°n h√≠t kh√≥i thu·ªëc, tar (h·∫Øc √≠n) s·∫Ω b√°m ch·∫∑t v√†o m√¨nh... üò∑",
                    "Tar l√†m gi·∫£m di·ªán t√≠ch trao ƒë·ªïi kh√≠, formaldehyde c√≥ th·ªÉ g√¢y ung th∆∞...",
                    "Hydrogen cyanide s·∫Ω ph√° h·ªßy l√¥ng mao ‚Äì h·ªá th·ªëng t·ª± l√†m s·∫°ch c·ªßa m√¨nh.",
                    "Khi m√¨nh b·ªã t·ªïn th∆∞∆°ng, b·∫°n s·∫Ω kh√≥ th·ªü, m·ªát m·ªèi v√† kh√¥ng th·ªÉ tham gia nh·ªØng ho·∫°t ƒë·ªông y√™u th√≠ch.",
                    "Xin h√£y ƒë·ªÉ m√¨nh ƒë∆∞·ª£c h√≠t th·ªü kh√¥ng kh√≠ trong l√†nh! üå¨Ô∏èüíö"
                ]
            },
            liver: {
                icon: 'ü´Ä',
                title: 'Gan - Nh√† m√°y h√≥a h·ªçc c·ªßa c∆° th·ªÉ',
                messages: [
                    "Xin ch√†o! M√¨nh l√† Gan ‚Äì nh√† m√°y h√≥a h·ªçc c·ªßa c∆° th·ªÉ b·∫°n. ü´Ä",
                    "M√¨nh th·ª±c hi·ªán h∆°n 500 ch·ª©c nƒÉng kh√°c nhau, t·ª´ l·ªçc ƒë·ªôc t·ªë ƒë·∫øn s·∫£n xu·∫•t protein quan tr·ªçng.",
                    "M√¨nh c√≥ kh·∫£ nƒÉng t√°i sinh tuy·ªát v·ªùi ‚Äì c√≥ th·ªÉ ph·ª•c h·ªìi 75% kh·ªëi l∆∞·ª£ng khi b·ªã t·ªïn th∆∞∆°ng!",
                    "Nh∆∞ng khi b·∫°n h√∫t thu·ªëc, m√¨nh ph·∫£i l√†m vi·ªác qu√° t·∫£i ƒë·ªÉ lo·∫°i b·ªè c√°c ch·∫•t ƒë·ªôc... üòµ‚Äçüí´",
                    "Nicotine, tar v√† h√†ng trƒÉm h√≥a ch·∫•t kh√°c l√†m m√¨nh vi√™m nhi·ªÖm v√† x∆° h√≥a.",
                    "Benzopyrene v√† formaldehyde c√≥ th·ªÉ g√¢y ung th∆∞ gan, khi·∫øn m√¨nh kh√¥ng th·ªÉ t√°i sinh.",
                    "M√¨nh c·∫ßn b·∫°n tr√°nh xa thu·ªëc l√° ƒë·ªÉ c√≥ th·ªÉ b·∫£o v·ªá c∆° th·ªÉ kh·ªèi ƒë·ªôc t·ªë m·ªói ng√†y! üí™"
                ]
            },
            kidney: {
                icon: 'ü´ò',
                title: 'Th·∫≠n - B·ªô l·ªçc si√™u vi·ªát',
                messages: [
                    "Xin ch√†o! M√¨nh l√† Th·∫≠n ‚Äì b·ªô l·ªçc si√™u vi·ªát c·ªßa c∆° th·ªÉ. ü´ò",
                    "M·ªói ng√†y, m√¨nh l·ªçc kho·∫£ng 180 l√≠t m√°u, lo·∫°i b·ªè ch·∫•t th·∫£i v√† gi·ªØ l·∫°i nh·ªØng g√¨ c·∫ßn thi·∫øt.",
                    "M√¨nh ƒëi·ªÅu h√≤a huy·∫øt √°p, s·∫£n xu·∫•t h·ªìng c·∫ßu v√† c√¢n b·∫±ng n∆∞·ªõc trong c∆° th·ªÉ.",
                    "Khi b·∫°n h√∫t thu·ªëc, nicotine l√†m co m·∫°ch m√°u, gi·∫£m l∆∞u l∆∞·ª£ng m√°u ƒë·∫øn m√¨nh... üò∞",
                    "Cadmium v√† ch√¨ trong kh√≥i thu·ªëc t√≠ch t·ª• trong m√¨nh, g√¢y t·ªïn th∆∞∆°ng kh√¥ng th·ªÉ ph·ª•c h·ªìi.",
                    "M√¨nh c√≥ th·ªÉ b·ªã suy th·∫≠n m√£n t√≠nh, bu·ªôc b·∫°n ph·∫£i l·ªçc m√°u su·ªët ƒë·ªùi.",
                    "H√£y gi√∫p m√¨nh ho·∫°t ƒë·ªông t·ªët b·∫±ng c√°ch u·ªëng ƒë·ªß n∆∞·ªõc v√† tr√°nh xa thu·ªëc l√°! üíß"
                ]
            },
            stomach: {
                icon: 'üåÄ',
                title: 'Ru·ªôt - H·ªá th·ªëng ti√™u h√≥a',
                messages: [
                    "Xin ch√†o! M√¨nh l√† Ru·ªôt ‚Äì h·ªá th·ªëng ti√™u h√≥a d√†i 7-8 m√©t c·ªßa c∆° th·ªÉ b·∫°n. üåÄ",
                    "M√¨nh g·ªìm ru·ªôt non v√† ru·ªôt gi√†, h·∫•p th·ª• dinh d∆∞·ª°ng v√† n∆∞·ªõc t·ª´ th·ª©c ƒÉn ƒë√£ ti√™u h√≥a.",
                    "M√¨nh c√≥ h√†ng tri·ªáu vi khu·∫©n c√≥ √≠ch gi√∫p ti√™u h√≥a v√† tƒÉng c∆∞·ªùng mi·ªÖn d·ªãch!",
                    "Nh∆∞ng nicotine v√† c√°c ch·∫•t ƒë·ªôc trong thu·ªëc l√° l√†m r·ªëi lo·∫°n h·ªá vi sinh c·ªßa m√¨nh... üò£",
                    "Kh√≥i thu·ªëc tƒÉng nguy c∆° vi√™m ru·ªôt, lo√©t ru·ªôt v√† ung th∆∞ ƒë·∫°i tr·ª±c tr√†ng.",
                    "M√¨nh s·∫Ω co th·∫Øt b·∫•t th∆∞·ªùng, g√¢y ƒëau b·ª•ng, ti√™u ch·∫£y ho·∫∑c t√°o b√≥n.",
                    "H√£y cho m√¨nh th·ª©c ƒÉn gi√†u ch·∫•t x∆° v√† tr√°nh xa thu·ªëc l√° ƒë·ªÉ m√¨nh ho·∫°t ƒë·ªông t·ªët! ü•¨"
                ]
            },
            eyes: {
                icon: 'üëÅÔ∏è',
                title: 'M·∫Øt - C·ª≠a s·ªï t√¢m h·ªìn',
                messages: [
                    "Xin ch√†o! M√¨nh l√† M·∫Øt ‚Äì c·ª≠a s·ªï t√¢m h·ªìn c·ªßa b·∫°n. üëÅÔ∏è",
                    "M√¨nh gi√∫p b·∫°n nh√¨n th·∫•y th·∫ø gi·ªõi tuy·ªát ƒë·∫πp v·ªõi h√†ng tri·ªáu m√†u s·∫Øc v√† chi ti·∫øt.",
                    "M√¨nh x·ª≠ l√Ω 80% th√¥ng tin m√† n√£o b·ªô nh·∫≠n ƒë∆∞·ª£c m·ªói ng√†y!",
                    "Nh∆∞ng kh√≥i thu·ªëc ch·ª©a c√°c g·ªëc t·ª± do t·∫•n c√¥ng v√µng m·∫°c c·ªßa m√¨nh... üòµ",
                    "M√¨nh c√≥ th·ªÉ b·ªã tho√°i h√≥a ƒëi·ªÉm v√†ng, ƒë·ª•c th·ªßy tinh th·ªÉ (ƒë·ª•c m·∫Øt).",
                    "Nicotine l√†m gi·∫£m l∆∞u l∆∞·ª£ng m√°u ƒë·∫øn th·∫ßn kinh th·ªã gi√°c, c√≥ th·ªÉ g√¢y m√π l√≤a.",
                    "M√¨nh mu·ªën gi√∫p b·∫°n nh√¨n th·∫•y v·∫ª ƒë·∫πp cu·ªôc s·ªëng ‚Äì h√£y b·∫£o v·ªá m√¨nh kh·ªèi kh√≥i thu·ªëc! ‚ú®"
                ]
            }
        };

        // Conversation state
        let currentConversation = null;
        let conversationStep = 0;
        
        // Shooting Game State
        let gameState = {
            isPlaying: false,
            isPaused: false,
            lives: 3,
            gameScore: 0,
            playerPosition: 50, // percentage
            enemies: [],
            bullets: [],
            wave: 1,
            enemiesDestroyed: 0,
            gameSpeed: 1,
            lastEnemySpawn: 0,
            enemySpawnRate: 2000, // milliseconds
            gameLoop: null
        };

        // Toxin data with detailed information
        const toxinData = {
            // Group 1: Carcinogens
            'benzen': { icon: 'üß™', name: 'Benzen', group: 'carcinogen', 
                info: 'C√≥ trong xƒÉng v√† kh√≥i thu·ªëc (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠). G√¢y b·ªánh b·∫°ch c·∫ßu v√† l√†m t·ªïn th∆∞∆°ng t·ªßy x∆∞∆°ng.' },
            'formaldehyde': { icon: 'üß¥', name: 'Formaldehyde', group: 'carcinogen',
                info: 'D√πng trong ∆∞·ªõp x√°c (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠). G√¢y ung th∆∞ m≈©i, h·ªçng v√† k√≠ch ·ª©ng m·∫Øt, da, ƒë∆∞·ªùng h√¥ h·∫•p.' },
            'arsenic': { icon: '‚ò†Ô∏è', name: 'Arsenic', group: 'carcinogen',
                info: 'Kim lo·∫°i n·∫∑ng c·ª±c ƒë·ªôc (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y ung th∆∞ da, ph·ªïi, v√† t·ªïn th∆∞∆°ng tim.' },
            'cadmium': { icon: 'üîã', name: 'Cadmium', group: 'carcinogen',
                info: 'C√≥ trong pin (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠). G√¢y ung th∆∞ ph·ªïi v√† suy th·∫≠n nghi√™m tr·ªçng.' },
            'chromium': { icon: 'üß©', name: 'Chromium VI', group: 'carcinogen',
                info: 'Ch·∫•t oxy h√≥a m·∫°nh (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y ung th∆∞ ph·ªïi v√† t·ªïn th∆∞∆°ng gan.' },
            'nitrosamine': { icon: 'üß´', name: 'Nitrosamine', group: 'carcinogen',
                info: 'Ch·∫•t g√¢y ƒë·ªôt bi·∫øn gen (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), ƒë·∫∑c bi·ªát nguy hi·ªÉm trong kh√≥i thu·ªëc.' },
            
            // Group 2: Neurotoxins
            'nicotine': { icon: '‚ö°', name: 'Nicotine', group: 'neurotoxin',
                info: 'G√¢y nghi·ªán m·∫°nh (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), l√†m tƒÉng huy·∫øt √°p, nh·ªãp tim, v√† thay ƒë·ªïi c·∫•u tr√∫c n√£o.' },
            'carbon_monoxide': { icon: 'üí®', name: 'Carbon Monoxide', group: 'neurotoxin',
                info: 'Chi·∫øm ch·ªó oxy trong m√°u (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y thi·∫øu oxy n√£o v√† tim.' },
            
            // Group 3: Lung destroyers
            'tar': { icon: 'ü™∂', name: 'Tar (H·∫Øc √≠n)', group: 'lung_destroyer',
                info: 'L√†m t·∫Øc ngh·∫Ωn ph·ªïi (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y vi√™m ph·∫ø qu·∫£n m√£n t√≠nh v√† ung th∆∞.' },
            'ammonia': { icon: 'üß¥', name: 'Ammonia', group: 'lung_destroyer',
                info: 'TƒÉng h·∫•p thu nicotine (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y t·ªïn th∆∞∆°ng ni√™m m·∫°c ph·ªïi.' },
            'hydrogen_cyanide': { icon: 'üß™', name: 'Hydrogen Cyanide', group: 'lung_destroyer',
                info: 'Ph√° h·ªßy l√¥ng mao c·ªßa ph·ªïi (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), l√†m gi·∫£m kh·∫£ nƒÉng t·ª± l√†m s·∫°ch.' },
            
            // Group 4: Toxic additives
            'acetone': { icon: 'üíÖ', name: 'Acetone', group: 'toxic_additive',
                info: 'Dung m√¥i trong s∆°n m√≥ng tay (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y k√≠ch ·ª©ng m·∫Øt, m≈©i, h·ªçng.' },
            'ddt': { icon: 'üêú', name: 'DDT', group: 'toxic_additive',
                info: 'Thu·ªëc tr·ª´ s√¢u (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y r·ªëi lo·∫°n n·ªôi ti·∫øt v√† ung th∆∞.' },
            'polonium': { icon: '‚ò¢Ô∏è', name: 'Polonium-210', group: 'toxic_additive',
                info: 'Ch·∫•t ph√≥ng x·∫° (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠) g√¢y ung th∆∞ ph·ªïi.' },
            
            // Group 5: Vape toxins
            'liquid_nicotine': { icon: 'üíß', name: 'Nicotine l·ªèng', group: 'vape_toxin',
                info: 'G√¢y nghi·ªán m·∫°nh (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), ·∫£nh h∆∞·ªüng nghi√™m tr·ªçng ƒë·∫øn n√£o b·ªô v√† tim m·∫°ch.' },
            'diacetyl': { icon: 'üçø', name: 'Diacetyl', group: 'vape_toxin',
                info: 'H∆∞∆°ng li·ªáu g√¢y b·ªánh "popcorn lung" (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠) ‚Äì vi√™m ti·ªÉu ph·∫ø qu·∫£n t·∫Øc ngh·∫Ωn.' },
            'heavy_metals': { icon: '‚öôÔ∏è', name: 'Kim lo·∫°i n·∫∑ng', group: 'vape_toxin',
                info: 'Ch√¨, Cadmium, Nickel, Chromium (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠) - G√¢y nhi·ªÖm ƒë·ªôc, t·ªïn th∆∞∆°ng ph·ªïi v√† gan.' },
            'pg_vg_heated': { icon: 'üå´Ô∏è', name: 'PG & VG ƒë·ªët n√≥ng', group: 'vape_toxin',
                info: 'Sinh ra formaldehyde v√† acrolein (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y k√≠ch ·ª©ng ph·ªïi v√† m·∫°ch m√°u.' },
            'ultrafine_particles': { icon: 'üåå', name: 'H·∫°t si√™u m·ªãn', group: 'vape_toxin',
                info: 'Th√¢m nh·∫≠p s√¢u v√†o m√°u (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), g√¢y vi√™m ph·ªïi v√† x∆° v·ªØa ƒë·ªông m·∫°ch.' },
            'vitamin_e_acetate': { icon: 'üß¥', name: 'Vitamin E Acetate', group: 'vape_toxin',
                info: 'Li√™n quan ƒë·∫øn b·ªánh ph·ªïi c·∫•p t√≠nh EVALI (c√≥ trong thu·ªëc l√° v√† thu·ªëc l√° ƒëi·ªán t·ª≠), c√≥ th·ªÉ g√¢y t·ª≠ vong.' }
        };

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
            
            // Show/hide navigation buttons
            const navButtons = document.getElementById('navButtons');
            if (screenId === 'mainMenu') {
                navButtons.style.display = 'none';
            } else {
                navButtons.style.display = 'flex';
            }
            
            updateProgress();
        }

        function showMainMenu() {
            showScreen('mainMenu');
        }

        function showInstructions() {
            showScreen('instructionsScreen');
        }

        async function startGame() {
            showScreen('gamePart1');
            score = 0;
            visitedOrgans.clear();
            updateScore();
            resetCharacterPosition();
            
            // Initialize sound system with user interaction
            try {
                await soundSystem.init();
                console.log('Game started with sound system');
            } catch (e) {
                console.log('Game started without sound:', e);
            }
        }

        function resetCharacterPosition() {
            characterPosition = { x: 50, y: 80 };
            updateCharacterPosition();
            checkNearbyOrgans();
        }

        function updateCharacterPosition() {
            const character = document.getElementById('character');
            const spotlight = document.getElementById('spotlight');
            
            if (character) {
                character.style.left = characterPosition.x + '%';
                character.style.top = characterPosition.y + '%';
            }
            
            // Update spotlight position to follow character
            if (spotlight) {
                spotlight.style.left = characterPosition.x + '%';
                spotlight.style.top = characterPosition.y + '%';
            }
        }

        function moveCharacter(direction) {
            if (currentScreen !== 'gamePart1') return;
            
            currentDirection = direction;
            if (!isMoving) {
                isMoving = true;
                soundSystem.playMoveSound();
                
                moveInterval = setInterval(() => {
                    const moveSpeed = 2; // Percentage per move
                    
                    switch(currentDirection) {
                        case 'up':
                            if (characterPosition.y > 10) characterPosition.y -= moveSpeed;
                            break;
                        case 'down':
                            if (characterPosition.y < 90) characterPosition.y += moveSpeed;
                            break;
                        case 'left':
                            if (characterPosition.x > 10) characterPosition.x -= moveSpeed;
                            break;
                        case 'right':
                            if (characterPosition.x < 90) characterPosition.x += moveSpeed;
                            break;
                    }
                    
                    updateCharacterPosition();
                    checkNearbyOrgans();
                }, 50);
            }
        }

        function stopMoving() {
            isMoving = false;
            currentDirection = null;
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
        }

        function checkNearbyOrgans() {
            const organs = [
                { id: 'eyes', x: 15, y: 15, element: document.getElementById('eyesOrgan'), hint: document.getElementById('eyesHint') },
                { id: 'brain', x: 50, y: 15, element: document.getElementById('brainOrgan'), hint: document.getElementById('brainHint') },
                { id: 'lungs', x: 85, y: 15, element: document.getElementById('lungsOrgan'), hint: document.getElementById('lungsHint') },
                { id: 'heart', x: 15, y: 45, element: document.getElementById('heartOrgan'), hint: document.getElementById('heartHint') },
                { id: 'liver', x: 50, y: 45, element: document.getElementById('liverOrgan'), hint: document.getElementById('liverHint') },
                { id: 'stomach', x: 85, y: 45, element: document.getElementById('stomachOrgan'), hint: document.getElementById('stomachHint') },
                { id: 'kidney', x: 50, y: 75, element: document.getElementById('kidneyOrgan'), hint: document.getElementById('kidneyHint') }
            ];

            let foundNearby = null;
            const spotlight = document.getElementById('spotlight');

            organs.forEach(organ => {
                const distance = Math.sqrt(
                    Math.pow(characterPosition.x - organ.x, 2) + 
                    Math.pow(characterPosition.y - organ.y, 2)
                );

                if (distance < 20) { // Within interaction range
                    foundNearby = organ.id;
                    organ.element.classList.add('nearby');
                    organ.hint.classList.add('show');
                    
                    // Activate spotlight when near organ
                    if (spotlight) {
                        spotlight.classList.add('active');
                    }
                    
                    // Start organ-specific ambient sound
                    soundSystem.startOrganAmbient(organ.id);
                } else {
                    organ.element.classList.remove('nearby');
                    organ.hint.classList.remove('show');
                }
            });

            // Deactivate spotlight if no organ nearby
            if (!foundNearby && spotlight) {
                spotlight.classList.remove('active');
                soundSystem.stopAllAmbient();
            }

            nearbyOrgan = foundNearby;
        }

        async function interactWithNearbyOrgan() {
            if (nearbyOrgan) {
                try {
                    await soundSystem.playInteractionSound();
                } catch (e) {
                    console.log('Interaction sound failed:', e);
                }
                showOrganInfo(nearbyOrgan);
            }
        }

        // Add click handlers for organs
        function addOrganClickHandlers() {
            document.getElementById('heartOrgan').addEventListener('click', () => {
                if (nearbyOrgan === 'heart') {
                    interactWithNearbyOrgan();
                }
            });
            
            document.getElementById('brainOrgan').addEventListener('click', () => {
                if (nearbyOrgan === 'brain') {
                    interactWithNearbyOrgan();
                }
            });
            
            document.getElementById('lungsOrgan').addEventListener('click', () => {
                if (nearbyOrgan === 'lungs') {
                    interactWithNearbyOrgan();
                }
            });
            
            document.getElementById('liverOrgan').addEventListener('click', () => {
                if (nearbyOrgan === 'liver') {
                    interactWithNearbyOrgan();
                }
            });
            
            document.getElementById('kidneyOrgan').addEventListener('click', () => {
                if (nearbyOrgan === 'kidney') {
                    interactWithNearbyOrgan();
                }
            });
            
            document.getElementById('stomachOrgan').addEventListener('click', () => {
                if (nearbyOrgan === 'stomach') {
                    interactWithNearbyOrgan();
                }
            });
            
            document.getElementById('eyesOrgan').addEventListener('click', () => {
                if (nearbyOrgan === 'eyes') {
                    interactWithNearbyOrgan();
                }
            });
        }

        function exitGame() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën tho√°t kh·ªèi tr√≤ ch∆°i?')) {
                alert('C·∫£m ∆°n b·∫°n ƒë√£ tham gia! H√£y nh·ªõ b·∫£o v·ªá s·ª©c kh·ªèe nh√©! üåü');
            }
        }

        function showOrganInfo(organType) {
            const info = organInfo[organType];
            currentConversation = organType;
            conversationStep = 0;
            
            document.getElementById('modalIcon').textContent = info.icon;
            document.getElementById('modalTitle').textContent = info.title;
            
            // Create progress dots
            createProgressDots(info.messages.length);
            
            // Show first message
            showCurrentMessage();
            
            document.getElementById('organModal').classList.add('active');
            
            // Add points if first visit - 10 points per organ
            if (!visitedOrgans.has(organType)) {
                visitedOrgans.add(organType);
                score += 10; // 10 points per organ
                updateScore();
            }
        }

        function createProgressDots(totalMessages) {
            const progressContainer = document.getElementById('conversationProgress');
            progressContainer.innerHTML = '';
            
            for (let i = 0; i < totalMessages; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (i === 0) dot.classList.add('active');
                progressContainer.appendChild(dot);
            }
        }

        function showCurrentMessage() {
            // Determine which info object to use
            const info = organInfo[currentConversation] || damageInfo[currentConversation];
            const messageText = info.messages[conversationStep];
            
            document.getElementById('modalText').textContent = messageText;
            
            // Update progress dots
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active');
                if (index < conversationStep) {
                    dot.classList.add('completed');
                } else if (index === conversationStep) {
                    dot.classList.add('active');
                }
            });
            
            // Update buttons and hints
            const nextBtn = document.getElementById('nextMessageBtn');
            const finishBtn = document.getElementById('finishConversationBtn');
            const hint = document.getElementById('conversationHint');
            
            if (conversationStep < info.messages.length - 1) {
                nextBtn.style.display = 'inline-block';
                finishBtn.style.display = 'none';
                hint.textContent = 'Nh·∫•n SPACE ƒë·ªÉ ti·∫øp t·ª•c cu·ªôc tr√≤ chuy·ªán...';
            } else {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-block';
                hint.textContent = 'Cu·ªôc tr√≤ chuy·ªán ƒë√£ k·∫øt th√∫c. C·∫£m ∆°n b·∫°n ƒë√£ l·∫Øng nghe!';
                
                // Check if all organs visited for Part 1
                if (organInfo[currentConversation]) {
                    // Check if all organs visited
                    if (visitedOrgans.size === 7) {
                        setTimeout(() => {
                            closeModal();
                            setTimeout(() => {
                                showCompletionScreen();
                            }, 1000);
                        }, 2000);
                    }
                }
            }
        }

        function nextMessage() {
            if (currentConversation) {
                const info = organInfo[currentConversation] || damageInfo[currentConversation];
                if (conversationStep < info.messages.length - 1) {
                    conversationStep++;
                    showCurrentMessage();
                }
            }
        }

        function closeModal() {
            document.getElementById('organModal').classList.remove('active');
            currentConversation = null;
            conversationStep = 0;
        }

        function showCompletionScreen() {
            document.getElementById('finalScore').textContent = score;
            showScreen('completionScreen');
        }

        function continueToNextPart() {
            // Show game mode selection instead of going directly to shooting game
            showGameModeSelection();
        }
        
        function showGameModeSelection() {
            showScreen('gameModeSelection');
        }

        function updateScore() {
            document.getElementById('scoreDisplay').textContent = `ƒêi·ªÉm: ${score}`;
        }

        function updateProgress() {
            let progressPercent = 0;
            
            switch(currentScreen) {
                case 'mainMenu':
                    progressPercent = 0;
                    break;
                case 'instructionsScreen':
                    progressPercent = 10;
                    break;
                case 'gamePart1':
                    progressPercent = 30 + (visitedOrgans.size * 8);
                    break;
                case 'gamePart2':
                    progressPercent = 60 + (visitedDamageTypes.size * 10);
                    break;
                case 'completionScreen':
                    progressPercent = 100;
                    break;
            }
            
            document.getElementById('progressFill').style.width = progressPercent + '%';
        }

        function resetPart2() {
            part2Progress = 0;
            visitedDamageTypes.clear();
            updatePart2Progress();
            
            // Reset visual states
            document.querySelectorAll('.damage-item').forEach(item => {
                item.classList.remove('visited');
            });
        }

        // Falling toxins animation for intro
        function initializeFallingToxins() {
            const container = document.getElementById('fallingToxins');
            if (!container) return;
            
            container.innerHTML = '';
            const toxinIcons = ['üß™', 'üß¥', '‚ò†Ô∏è', 'üîã', '‚ö°', 'üí®', 'ü™∂', 'üíÖ', 'üçø', '‚öôÔ∏è'];
            
            // Create falling toxins
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const toxin = document.createElement('div');
                    toxin.className = 'falling-toxin';
                    toxin.textContent = toxinIcons[Math.floor(Math.random() * toxinIcons.length)];
                    toxin.style.left = Math.random() * 100 + '%';
                    toxin.style.animationDelay = Math.random() * 2 + 's';
                    toxin.style.animationDuration = (2 + Math.random() * 2) + 's';
                    container.appendChild(toxin);
                    
                    // Remove after animation
                    setTimeout(() => {
                        if (toxin.parentNode) {
                            toxin.parentNode.removeChild(toxin);
                        }
                    }, 5000);
                }, i * 200);
            }
        }

        // Start shooting game
        function startShootingGame() {
            showScreen('part2Intro');
            initializeFallingToxins();
        }
        
        function startActualShootingGame() {
            showScreen('shootingGame');
            resetGameState();
            startGameLoop();
        }
        
        function startQuizGame() {
            alert('üß† Game C√¢u H·ªèi ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn! S·∫Ω c√≥ c√¢u h·ªèi tr·∫Øc nghi·ªám v·ªÅ t√°c h·∫°i c·ªßa thu·ªëc l√° v·ªõi nhi·ªÅu m·ª©c ƒë·ªô kh√≥ kh√°c nhau.');
            // TODO: Implement quiz game
        }
        
        function startMemoryGame() {
            alert('üß© Game Tr√≠ Nh·ªõ ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn! B·∫°n s·∫Ω gh√©p ƒë√¥i c√°c ch·∫•t ƒë·ªôc h·∫°i v·ªõi t√°c h·∫°i t∆∞∆°ng ·ª©ng trong th·ªùi gian gi·ªõi h·∫°n.');
            // TODO: Implement memory matching game
        }
        
        function startStoryMode() {
            alert('üìñ Ch·∫ø ƒê·ªô C√¢u Chuy·ªán ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn! B·∫°n s·∫Ω theo d√µi h√†nh tr√¨nh c·ªßa m·ªôt ng∆∞·ªùi t·ª´ khi b·∫Øt ƒë·∫ßu h√∫t thu·ªëc ƒë·∫øn nh·ªØng h·∫≠u qu·∫£ nghi√™m tr·ªçng.');
            // TODO: Implement story mode with interactive narrative
        }

        function resetGameState() {
            gameState = {
                isPlaying: true,
                isPaused: false,
                lives: 3,
                gameScore: 0,
                playerPosition: 50,
                enemies: [],
                bullets: [],
                wave: 1,
                enemiesDestroyed: 0,
                gameSpeed: 1,
                lastEnemySpawn: 0,
                enemySpawnRate: 2000,
                gameLoop: null
            };
            
            updateGameHUD();
            clearGameCanvas();
        }

        function updateGameHUD() {
            document.getElementById('gameScore').textContent = gameState.gameScore;
            
            // Update lives display
            const lifeIcons = ['life1', 'life2', 'life3'];
            lifeIcons.forEach((id, index) => {
                const lifeElement = document.getElementById(id);
                if (index >= gameState.lives) {
                    lifeElement.classList.add('lost');
                } else {
                    lifeElement.classList.remove('lost');
                }
            });
        }

        function clearGameCanvas() {
            const canvas = document.getElementById('gameCanvas');
            // Remove all enemies and bullets
            canvas.querySelectorAll('.enemy, .bullet, .explosion').forEach(el => el.remove());
        }

        function startGameLoop() {
            if (gameState.gameLoop) {
                clearInterval(gameState.gameLoop);
            }
            
            gameState.gameLoop = setInterval(() => {
                if (!gameState.isPlaying || gameState.isPaused) return;
                
                updateGame();
            }, 33); // 30 FPS for smoother gameplay
        }

        function updateGame() {
            const currentTime = Date.now();
            
            // Spawn enemies
            if (currentTime - gameState.lastEnemySpawn > gameState.enemySpawnRate) {
                spawnEnemy();
                gameState.lastEnemySpawn = currentTime;
            }
            
            // Update enemies
            updateEnemies();
            
            // Update bullets
            updateBullets();
            
            // Check collisions
            checkCollisions();
            
            // Check game over conditions
            if (gameState.lives <= 0) {
                gameOver();
            }
            
            // Increase difficulty over time
            if (gameState.enemiesDestroyed > 0 && gameState.enemiesDestroyed % 10 === 0) {
                gameState.gameSpeed += 0.1;
                gameState.enemySpawnRate = Math.max(800, gameState.enemySpawnRate - 100);
            }
        }

        function spawnEnemy() {
            const toxinKeys = Object.keys(toxinData);
            const randomToxin = toxinKeys[Math.floor(Math.random() * toxinKeys.length)];
            const toxin = toxinData[randomToxin];
            
            const enemy = document.createElement('div');
            enemy.className = 'enemy';
            enemy.textContent = toxin.icon;
            enemy.style.left = Math.random() * 90 + '%';
            enemy.style.top = '0px';
            enemy.dataset.toxinKey = randomToxin;
            enemy.dataset.speed = (1 + Math.random() * 2) * gameState.gameSpeed;
            
            document.getElementById('gameCanvas').appendChild(enemy);
            gameState.enemies.push(enemy);
        }

        function updateEnemies() {
            gameState.enemies.forEach((enemy, index) => {
                const currentTop = parseFloat(enemy.style.top) || 0;
                const speed = parseFloat(enemy.dataset.speed) || 1;
                const newTop = currentTop + speed;
                
                enemy.style.top = newTop + 'px';
                
                // Remove if off screen or hit player
                if (newTop > 600) {
                    enemy.remove();
                    gameState.enemies.splice(index, 1);
                } else if (newTop > 520 && checkPlayerCollision(enemy)) {
                    // Player hit
                    playerHit();
                    enemy.remove();
                    gameState.enemies.splice(index, 1);
                }
            });
        }

        function updateBullets() {
            gameState.bullets.forEach((bullet, index) => {
                const currentTop = parseFloat(bullet.style.top) || 0;
                const newTop = currentTop - 12; // Faster bullet speed
                
                bullet.style.top = newTop + 'px';
                
                // Remove if off screen
                if (newTop < 0) {
                    bullet.remove();
                    gameState.bullets.splice(index, 1);
                }
            });
        }

        function checkCollisions() {
            gameState.bullets.forEach((bullet, bulletIndex) => {
                gameState.enemies.forEach((enemy, enemyIndex) => {
                    if (isColliding(bullet, enemy)) {
                        // Hit!
                        const toxinKey = enemy.dataset.toxinKey;
                        const toxin = toxinData[toxinKey];
                        
                        // Show toxin info popup
                        showToxinPopup(toxin);
                        
                        // Create explosion effect
                        createExplosion(enemy);
                        
                        // Remove bullet and enemy
                        bullet.remove();
                        enemy.remove();
                        gameState.bullets.splice(bulletIndex, 1);
                        gameState.enemies.splice(enemyIndex, 1);
                        
                        // Update score
                        gameState.gameScore += 10;
                        gameState.enemiesDestroyed++;
                        updateGameHUD();
                        
                        // Check victory condition
                        if (gameState.enemiesDestroyed >= 30) {
                            victory();
                        }
                    }
                });
            });
        }

        function isColliding(bullet, enemy) {
            const bulletRect = bullet.getBoundingClientRect();
            const enemyRect = enemy.getBoundingClientRect();
            
            return !(bulletRect.right < enemyRect.left || 
                    bulletRect.left > enemyRect.right || 
                    bulletRect.bottom < enemyRect.top || 
                    bulletRect.top > enemyRect.bottom);
        }

        function checkPlayerCollision(enemy) {
            const playerRect = document.getElementById('playerShip').getBoundingClientRect();
            const enemyRect = enemy.getBoundingClientRect();
            
            return !(playerRect.right < enemyRect.left || 
                    playerRect.left > enemyRect.right || 
                    playerRect.bottom < enemyRect.top || 
                    playerRect.top > enemyRect.bottom);
        }

        function createExplosion(enemy) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = 'üí•';
            explosion.style.left = enemy.style.left;
            explosion.style.top = enemy.style.top;
            
            document.getElementById('gameCanvas').appendChild(explosion);
            
            setTimeout(() => {
                if (explosion.parentNode) {
                    explosion.remove();
                }
            }, 500);
        }

        function showToxinPopup(toxin) {
            const popup = document.createElement('div');
            popup.className = 'toxin-info-popup';
            popup.innerHTML = `
                <h3><span>${toxin.icon}</span> ${toxin.name}</h3>
                <p>${toxin.info}</p>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                }
            }, 2000);
        }

        function playerHit() {
            gameState.lives--;
            updateGameHUD();
            
            // Flash effect
            const player = document.getElementById('playerShip');
            player.style.filter = 'brightness(2) drop-shadow(0 0 20px red)';
            setTimeout(() => {
                player.style.filter = '';
            }, 200);
        }

        function gameOver() {
            gameState.isPlaying = false;
            clearInterval(gameState.gameLoop);
            
            const gameOverScreen = document.getElementById('gameOverScreen');
            const gameOverMessage = document.getElementById('gameOverMessage');
            
            // Show damaged organ based on which life was lost last
            let organDamage = '';
            if (gameState.lives === 0) {
                organDamage = '‚ú® NƒÉng l∆∞·ª£ng c·ªßa b·∫°n ƒë√£ c·∫°n ki·ªát b·ªüi c√°c ch·∫•t ƒë·ªôc h·∫°i t·ª´ thu·ªëc l√°!';
            } else if (gameState.lives === 1) {
                organDamage = 'üåü S·ª©c m·∫°nh c·ªßa b·∫°n ƒë√£ b·ªã suy y·∫øu b·ªüi nicotine v√† c√°c ch·∫•t ƒë·ªôc th·∫ßn kinh!';
            } else {
                organDamage = 'üíñ Tr√°i tim c·ªßa b·∫°n ƒë√£ b·ªã t·ªïn th∆∞∆°ng b·ªüi carbon monoxide v√† c√°c ch·∫•t g√¢y ung th∆∞!';
            }
            
            gameOverMessage.innerHTML = `
                ${organDamage}<br><br>
                <strong>H√∫t thu·ªëc h·ªßy ho·∫°i s·ª©c kh·ªèe t·ª´ng ng√†y.</strong><br>
                Trong th·ª±c t·∫ø, b·∫°n kh√¥ng th·ªÉ "b·∫Øn h·∫°" c√°c ch·∫•t ƒë·ªôc n√†y - ch√∫ng s·∫Ω t√≠ch t·ª• v√† ph√° h·ªßy c∆° th·ªÉ!
            `;
            
            gameOverScreen.classList.add('show');
        }

        function victory() {
            gameState.isPlaying = false;
            clearInterval(gameState.gameLoop);
            
            // Update final scores
            document.getElementById('finalGameScore').textContent = gameState.gameScore;
            document.getElementById('toxinsDestroyed').textContent = gameState.enemiesDestroyed;
            
            // Add bonus points to main score
            score += gameState.gameScore;
            updateScore();
            
            showScreen('victoryScreen');
        }

        function restartShootingGame() {
            document.getElementById('gameOverScreen').classList.remove('show');
            resetGameState();
            startGameLoop();
        }

        // Player movement and shooting with smooth controls
        let playerMovement = {
            left: false,
            right: false,
            moveSpeed: 3,
            smoothMoveInterval: null
        };

        function startPlayerMovement(direction) {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            playerMovement[direction] = true;
            
            if (!playerMovement.smoothMoveInterval) {
                playerMovement.smoothMoveInterval = setInterval(() => {
                    let moved = false;
                    
                    if (playerMovement.left && gameState.playerPosition > 2) {
                        gameState.playerPosition -= playerMovement.moveSpeed;
                        moved = true;
                    }
                    if (playerMovement.right && gameState.playerPosition < 98) {
                        gameState.playerPosition += playerMovement.moveSpeed;
                        moved = true;
                    }
                    
                    if (moved) {
                        document.getElementById('playerShip').style.left = gameState.playerPosition + '%';
                    }
                    
                    if (!playerMovement.left && !playerMovement.right) {
                        clearInterval(playerMovement.smoothMoveInterval);
                        playerMovement.smoothMoveInterval = null;
                    }
                }, 16); // ~60 FPS for smooth movement
            }
        }

        function stopPlayerMovement(direction) {
            playerMovement[direction] = false;
        }

        function movePlayer(direction) {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            const moveSpeed = 8;
            if (direction === 'left' && gameState.playerPosition > 2) {
                gameState.playerPosition -= moveSpeed;
            } else if (direction === 'right' && gameState.playerPosition < 98) {
                gameState.playerPosition += moveSpeed;
            }
            
            document.getElementById('playerShip').style.left = gameState.playerPosition + '%';
        }

        function shootBullet() {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            bullet.style.left = gameState.playerPosition + '%';
            bullet.style.top = '520px';
            
            document.getElementById('gameCanvas').appendChild(bullet);
            gameState.bullets.push(bullet);
        }

        // Clean up game when leaving shooting game screen
        function cleanupShootingGame() {
            if (gameState.gameLoop) {
                clearInterval(gameState.gameLoop);
                gameState.gameLoop = null;
            }
            gameState.isPlaying = false;
        }

        function goBack() {
            // Clean up shooting game if leaving it
            if (currentScreen === 'shootingGame') {
                cleanupShootingGame();
            }
            
            switch(currentScreen) {
                case 'instructionsScreen':
                    showMainMenu();
                    break;
                case 'gamePart1':
                    showMainMenu();
                    break;
                case 'part2Intro':
                    showScreen('completionScreen');
                    break;
                case 'shootingGame':
                    showScreen('part2Intro');
                    break;
                case 'victoryScreen':
                    showMainMenu();
                    break;
                case 'completionScreen':
                    showScreen('gamePart1');
                    break;
                default:
                    showMainMenu();
            }
        }

        // Close modal when clicking outside
        document.getElementById('organModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Keyboard navigation with improved space key handling
        document.addEventListener('keydown', function(e) {
            console.log('Key pressed:', e.key, 'Current screen:', currentScreen, 'Modal active:', document.getElementById('organModal').classList.contains('active'));
            
            if (e.key === 'Escape') {
                if (currentScreen === 'shootingGame') {
                    gameState.isPaused = !gameState.isPaused;
                } else {
                    closeModal();
                }
                return;
            }
            
            // Conversation controls when modal is open
            if (document.getElementById('organModal').classList.contains('active')) {
                if (e.code === 'Space' || e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    if (currentConversation && conversationStep < (organInfo[currentConversation] || damageInfo[currentConversation]).messages.length - 1) {
                        nextMessage();
                    } else {
                        closeModal();
                    }
                }
                return;
            }
            
            // Shooting game controls
            if (currentScreen === 'shootingGame' && gameState.isPlaying && !gameState.isPaused) {
                switch(e.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        e.preventDefault();
                        startPlayerMovement('left');
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        e.preventDefault();
                        startPlayerMovement('right');
                        break;
                    case 'Space':
                        e.preventDefault();
                        e.stopPropagation();
                        shootBullet();
                        break;
                }
                return;
            }
            
            // Character movement controls for Part 1
            if (currentScreen === 'gamePart1') {
                switch(e.code) {
                    case 'ArrowUp':
                    case 'KeyW':
                        e.preventDefault();
                        moveCharacter('up');
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        e.preventDefault();
                        moveCharacter('down');
                        break;
                    case 'ArrowLeft':
                    case 'KeyA':
                        e.preventDefault();
                        moveCharacter('left');
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        e.preventDefault();
                        moveCharacter('right');
                        break;
                    case 'Space':
                    case 'Enter':
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Space pressed, nearby organ:', nearbyOrgan);
                        interactWithNearbyOrgan();
                        break;
                }
            }
        });

        document.addEventListener('keyup', function(e) {
            if (currentScreen === 'gamePart1') {
                switch(e.code) {
                    case 'ArrowUp':
                    case 'KeyW':
                    case 'ArrowDown':
                    case 'KeyS':
                    case 'ArrowLeft':
                    case 'KeyA':
                    case 'ArrowRight':
                    case 'KeyD':
                        stopMoving();
                        break;
                }
            } else if (currentScreen === 'shootingGame' && gameState.isPlaying && !gameState.isPaused) {
                switch(e.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        e.preventDefault();
                        stopPlayerMovement('left');
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        e.preventDefault();
                        stopPlayerMovement('right');
                        break;
                }
            }
        });

        // Initialize
        updateScore();
        updateProgress();
        
        // Initialize click handlers when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addOrganClickHandlers();
        });
        
        // Also add handlers immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addOrganClickHandlers);
        } else {
            addOrganClickHandlers();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d0daa2112ff9ad',t:'MTc1NDg0MzE3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
