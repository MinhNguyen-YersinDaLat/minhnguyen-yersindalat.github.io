<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cu·ªôc Chi·∫øn H∆°i Th·ªü Xanh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #0c0a18;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            background-image: radial-gradient(circle, #1a1a2e, #16213e, #0f3460, #0c0a18);
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            max-height: 900px;
            background: #000 url('https://www.transparenttextures.com/patterns/stardust.png');
            border: 4px solid #764ba2;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(118, 75, 162, 0.7);
            position: relative;
            overflow: hidden;
        }

        /* --- Animations --- */
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes glow { 0%, 100% { filter: brightness(1) drop-shadow(0 0 5px currentColor); } 50% { filter: brightness(1.2) drop-shadow(0 0 10px currentColor); } }
        @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } }
        @keyframes smoke { 0% { opacity: 0.6; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-20px) scale(1.5); } }
        @keyframes explosion { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        @keyframes playerHit { 0%, 100% { opacity: 1; } 25%, 75% { opacity: 0.3; } 50% { opacity: 0.8; } }
        @keyframes bossHit { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(3); } }
        @keyframes warningPulse { 0%, 100% { color: #ef4444; transform: scale(1); } 50% { color: #f87171; transform: scale(1.1); } }
        @keyframes shield-glow {
            0% { box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.5); }
            100% { box-shadow: 0 0 30px 10px rgba(59, 130, 246, 0.8); }
        }
        @keyframes pop-in-out-left {
            0% { transform: translate(10px, -50%) scale(0.5); opacity: 0; }
            10% { transform: translate(0, -50%) scale(1.1); opacity: 1; }
            20% { transform: translate(0, -50%) scale(1); }
            80% { transform: translate(0, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-10px, -50%) scale(0.5); opacity: 0; }
        }


        /* --- Game Elements --- */
        .game-object { position: absolute; }
        .player { bottom: 20px; width: 80px; height: 112px; transform-origin: bottom center; }
        .player.hit { animation: playerHit 0.6s ease-in-out; }
        .player.shielded::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 150%; height: 120%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.4) 100%);
            border-radius: 50%; animation: shield-glow 1s ease-in-out infinite alternate;
        }
        .bullet { width: 8px; height: 25px; background: linear-gradient(to top, #fde047, #facc15, #eab308); border-radius: 10px; box-shadow: 0 0 15px #fde047; }
        .enemy-bullet { width: 10px; height: 10px; background: radial-gradient(circle, #ff416c, #ff4b2b); border-radius: 50%; box-shadow: 0 0 15px #ff416c; }
        .enemy { transform-origin: center center; }
        .explosion { width: 80px; height: 80px; background-image: radial-gradient(circle, rgba(255,255,0,1) 0%, rgba(255,165,0,1) 50%, rgba(255,0,0,0) 70%); border-radius: 50%; animation: explosion 0.3s ease-out forwards; z-index: 8; }
        .player-explosion { background-image: radial-gradient(circle, rgba(255,100,100,1) 0%, rgba(255,0,0,1) 50%, rgba(255,0,0,0) 70%); }
        .boss { transform-origin: top center; }
        .boss.hit { animation: bossHit 0.1s ease-in-out; }
        
        .boss-info-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            z-index: 7;
            transform: translateX(-50%);
        }
        .boss-name {
            background: rgba(0,0,0,0.6);
            padding: 2px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            white-space: nowrap;
        }
        .boss-name .scientific-name {
            font-size: 0.7rem;
            opacity: 0.8;
            font-style: italic;
        }
        .health-bar-container { width: 120px; background: rgba(0,0,0,0.5); padding: 3px; border-radius: 5px; border: 1px solid #4a5568; }
        .health-bar { width: 100%; height: 8px; background: linear-gradient(to right, #ef4444, #f87171); border-radius: 3px; transition: width 0.3s ease-out; }
        
        .speech-bubble {
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            background: linear-gradient(145deg, #db2777, #ef4444);
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            border: 2px solid white;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            max-width: 220px;
            z-index: 10;
            margin-right: 20px;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.5);
            animation: pop-in-out-left 5s ease-in-out forwards;
            white-space: normal;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            border-width: 10px;
            border-style: solid;
            border-color: transparent transparent transparent #db2777;
        }


        /* --- UI Screens --- */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(12, 10, 24, 0.8); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 10; padding: 1rem; }
        .screen h1 { font-size: 3rem; sm:font-size: 4rem; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; }
        .screen p { font-size: 1.25rem; sm:font-size: 1.5rem; margin-bottom: 2rem; }
        .screen button, .screen a { padding: 1rem 2rem; font-size: 1.25rem; font-weight: 700; color: white; background: linear-gradient(135deg, #ef4444, #db2777); border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4); text-decoration: none; display: inline-block;}
        .screen button:hover, .screen a:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6); }
        .difficulty-button {
             background: linear-gradient(135deg, #3b82f6, #8b5cf6);
             box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        .difficulty-button:hover {
             box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
        }
        #game-info { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: 700; z-index: 5; }
        #level-up-screen { display: none; animation: fadeInOut 2s ease-in-out forwards; }
        #warning-screen h1 { animation: warningPulse 1s ease-in-out infinite; }
        kbd {
            background-color: #4a5568;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            border: 1px solid #718096;
        }

        /* --- Fullscreen Container --- */
        #fullscreen-container {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
    </style>
</head>
<body>
    
    <!-- N√öT TO√ÄN M√ÄN H√åNH V√Ä TH√îNG B√ÅO -->
    <div id="fullscreen-container">
        <p class="text-yellow-400 font-semibold text-sm uppercase tracking-wider animate-pulse hidden md:block" style="text-shadow: 0 0 5px #fbbd24;">
            B·∫•m v√†o ƒë√¢y ƒë·ªÉ c√≥ tr·∫£i nghi·ªám t·ªët nh·∫•t
        </p>
        <button id="fullscreen-btn" title="To√†n m√†n h√¨nh" class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-full w-12 h-12 flex items-center justify-center text-white hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <svg id="icon-fullscreen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4m-4-4l5-5m11 5v-4m0 0h-4m4 4l-5-5" />
            </svg>
            <svg id="icon-exit-fullscreen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <div id="game-container">
        <!-- Giao di·ªán game -->
        <div id="game-info">
            <div id="score-display">ƒêi·ªÉm: 0</div>
            <div id="level-display">M√†n: 1</div>
            <div id="lives-display"></div>
        </div>
        
        <div id="start-screen" class="screen">
            <h1>Cu·ªôc Chi·∫øn H∆°i Th·ªü Xanh</h1>
            <p>Ch·ªçn ch·∫ø ƒë·ªô ch∆°i ho·∫∑c xem h∆∞·ªõng d·∫´n.</p>
            <div class="flex flex-col sm:flex-row gap-4">
                 <button id="easy-button" class="difficulty-button">D·ªÖ</button>
                 <button id="hard-button" class="difficulty-button" style="background: linear-gradient(135deg, #ef4444, #db2777); box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);">Kh√≥</button>
                 <button id="instructions-button" class="difficulty-button" style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);">H∆∞·ªõng D·∫´n</button>
                 <a href="index.html" class="difficulty-button" style="background: linear-gradient(135deg, #6b7280, #4b5563); box-shadow: 0 5px 15px rgba(107, 114, 128, 0.4);">Quay L·∫°i</a>
            </div>
        </div>

        <div id="instructions-screen" class="screen" style="display: none;">
            <h1>H∆∞·ªõng D·∫´n Ch∆°i</h1>
            <div class="text-left max-w-lg mx-auto text-lg space-y-4 bg-black/20 p-6 rounded-lg">
                <p><strong class="text-yellow-400">Di Chuy·ªÉn:</strong> S·ª≠ d·ª•ng ph√≠m m≈©i t√™n <kbd>‚Üê</kbd> v√† <kbd>‚Üí</kbd> ƒë·ªÉ di chuy·ªÉn phi thuy·ªÅn.</p>
                <p><strong class="text-yellow-400">B·∫Øn:</strong> Nh·∫•n ph√≠m <kbd>D·∫•u c√°ch</kbd> ƒë·ªÉ b·∫Øn ti√™u di·ªát k·∫ª th√π.</p>
                <p><strong class="text-yellow-400">M·ª•c Ti√™u:</strong> Ti√™u di·ªát h·∫øt c√°c l√†n s√≥ng qu√°i v·∫≠t v√† c√°c con tr√πm ƒë·ªÉ b·∫£o v·ªá h∆°i th·ªü xanh!</p>
                <p class="text-yellow-400 font-bold pt-2">V·∫≠t Ph·∫©m H·ªó Tr·ª£:</p>
                <div class="flex justify-around items-center text-center gap-4">
                    <div><span class="text-4xl">ü•à</span><br>ƒê·∫°n Ch√πm</div>
                    <div><span class="text-4xl">üõ°Ô∏è</span><br>Khi√™n B·∫£o V·ªá</div>
                    <div><span class="text-4xl">‚ù§Ô∏è</span><br>Th√™m M·∫°ng</div>
                </div>
            </div>
            <button id="back-button" class="mt-8">Quay L·∫°i</button>
        </div>

        <div id="level-up-screen" class="screen">
            <h1 id="level-up-text">M√†n 2</h1>
        </div>
        
        <div id="warning-screen" class="screen" style="display: none;">
            <h1 id="warning-text" class="mb-4">‚ö†Ô∏è C·∫¢NH B√ÅO BOSS ‚ö†Ô∏è</h1>
            <p id="warning-subtext" class="text-xl italic text-gray-300 mb-2"></p>
            <p id="warning-meaning" class="text-lg max-w-md text-gray-400"></p>
        </div>

        <div id="game-over-screen" class="screen" style="display: none;">
            <h1>Tr√≤ Ch∆°i K·∫øt Th√∫c</h1>
            <p id="final-score">ƒêi·ªÉm c·ªßa b·∫°n: 0</p>
            <button id="restart-button">Ch∆°i L·∫°i</button>
        </div>

        <!-- M√†n h√¨nh chi·∫øn th·∫Øng m·ªõi -->
        <div id="victory-screen" class="screen" style="display: none;">
            <h1>CHI·∫æN TH·∫ÆNG!</h1>
            <p>B·∫°n ƒë√£ b·∫£o v·ªá th√†nh c√¥ng H∆°i Th·ªü Xanh!</p>
            <div class="flex flex-col sm:flex-row gap-4 mt-4">
                <button id="restart-victory-button" class="difficulty-button">Ch∆°i L·∫°i</button>
                <button id="continue-button" class="difficulty-button" style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);">Ti·∫øp T·ª•c</button>
                <button id="main-menu-button" class="difficulty-button" style="background: linear-gradient(135deg, #6b7280, #4b5563); box-shadow: 0 5px 15px rgba(107, 114, 128, 0.4);">V·ªÅ M√†n H√¨nh Ch√≠nh</button>
            </div>
        </div>
    </div>

    <!-- T√°ch bi·ªát HTML c·ªßa c√°c ƒë·ªëi t∆∞·ª£ng game ra kh·ªèi JS -->
    <template id="player-template">
        <div class="float"><div class="relative"><div class="absolute -inset-8 bg-gradient-to-r from-yellow-400/40 via-yellow-300/50 to-yellow-400/40 rounded-full glow"></div><div class="absolute -inset-6 bg-gradient-to-r from-yellow-200/30 via-yellow-100/40 to-yellow-200/30 rounded-full sparkle"></div><div class="absolute -inset-4 bg-gradient-to-r from-yellow-300/20 via-yellow-200/30 to-yellow-300/20 rounded-full glow"></div><div class="absolute -right-8 top-2 w-16 h-24 bg-gradient-to-b from-red-500 via-red-600 to-red-800 rounded-b-3xl transform rotate-20 glow shadow-2xl border-2 border-red-400 float"><div class="absolute -right-2 top-4 w-4 h-16 bg-red-600 rounded-r-2xl transform rotate-12 opacity-80"></div><div class="absolute -right-1 top-8 w-2 h-12 bg-red-700 rounded-r-xl transform rotate-6 opacity-60"></div><div class="absolute -left-4 top-6 w-3 h-0.5 bg-white/40 rounded-full"></div><div class="absolute -left-3 top-10 w-2 h-0.5 bg-white/30 rounded-full"></div><div class="absolute -left-2 top-14 w-1 h-0.5 bg-white/20 rounded-full"></div></div><div class="w-20 h-28 bg-gradient-to-b from-blue-400 via-blue-600 to-blue-800 rounded-2xl relative shadow-2xl border-2 border-blue-300"><div class="absolute -top-8 left-2 w-16 h-16 bg-gradient-to-b from-orange-100 to-orange-200 rounded-full border-4 border-yellow-500 shadow-2xl"><div class="absolute top-3 left-1 w-14 h-6 bg-black rounded-full border-2 border-gray-700"><div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 left-1"></div><div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 right-1"></div><div class="w-2 h-1 bg-gray-600 absolute top-2 left-1/2 transform -translate-x-1/2"></div></div><div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-8 h-3 border-b-3 border-black rounded-full"></div><div class="absolute -top-3 left-1 w-14 h-6 bg-gradient-to-r from-amber-700 to-amber-900 rounded-t-full shadow-lg"></div></div><div class="absolute top-6 left-1/2 transform -translate-x-1/2 w-10 h-10 bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 rounded-full border-3 border-yellow-600 glow shadow-xl"><div class="absolute top-1 left-1 w-8 h-8 bg-gradient-to-r from-yellow-200 to-yellow-300 rounded-full"><span class="absolute top-2 left-2.5 text-sm font-black text-blue-900">M</span></div></div><div class="absolute -left-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div><div class="absolute -right-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div><div class="absolute bottom-0 left-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div><div class="absolute bottom-0 right-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div><div class="absolute -bottom-2 left-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div><div class="absolute -bottom-2 right-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div><div class="absolute top-12 left-3 w-1 h-8 bg-yellow-300 opacity-60 glow"></div><div class="absolute top-12 right-3 w-1 h-8 bg-yellow-300 opacity-60 glow"></div></div></div></div>
    </template>
    <template id="enemy-nicotine-template">
        <div class="float"><div class="w-16 h-24 bg-gradient-to-b from-gray-800 to-black rounded-lg relative shadow-2xl border-2 border-red-600"><div class="w-12 h-12 bg-gradient-to-b from-gray-700 to-black rounded-full absolute -top-6 left-2 border-3 border-red-700 shadow-2xl"><div class="w-3 h-3 bg-red-600 rounded-full absolute top-2 left-1 glow shadow-lg"><div class="w-1 h-1 bg-red-300 rounded-full absolute top-1 left-1 sparkle"></div></div><div class="w-3 h-3 bg-red-600 rounded-full absolute top-2 right-1 glow shadow-lg"><div class="w-1 h-1 bg-red-300 rounded-full absolute top-1 right-1 sparkle"></div></div><div class="w-8 h-3 border-b-3 border-red-700 rounded-full absolute bottom-1 left-2 transform rotate-180"></div><div class="w-1 h-2 bg-white absolute bottom-2 left-3 transform rotate-12"></div><div class="w-1 h-2 bg-white absolute bottom-2 right-3 transform -rotate-12"></div><div class="w-10 h-4 bg-black rounded-t-full absolute -top-3 left-1 border border-gray-600"></div><div class="w-1 h-3 bg-red-800 absolute -top-2 left-2 transform rotate-12"></div><div class="w-1 h-3 bg-red-800 absolute -top-2 right-2 transform -rotate-12"></div></div><div class="w-14 h-18 bg-black rounded-lg absolute top-3 left-1 border-2 border-red-700 shadow-xl"><div class="w-2 h-12 bg-red-900 absolute top-2 left-6 border border-red-800"></div><div class="w-1 h-1 bg-red-500 rounded-full absolute top-4 left-7 glow"></div><div class="w-1 h-1 bg-red-500 rounded-full absolute top-8 left-7 glow"></div><div class="w-1 h-2 bg-gray-600 absolute top-1 left-1 transform rotate-45"></div><div class="w-1 h-2 bg-gray-600 absolute top-1 right-1 transform -rotate-45"></div></div><div class="w-2 h-8 bg-gray-200 absolute -right-3 top-6 rounded border-2 border-gray-400 shadow-lg"><div class="w-3 h-3 bg-orange-600 absolute -top-2 -left-0.5 glow pulse"></div><div class="w-1 h-1 bg-gray-500 rounded-full absolute top-1 left-0.5"></div><div class="w-2 h-2 bg-gray-700 rounded-full absolute -top-4 left-0 opacity-70 smoke"></div><div class="w-1 h-1 bg-gray-800 rounded-full absolute -top-6 left-0.5 opacity-50 smoke" style="animation-delay: 0.5s;"></div></div><div class="w-6 h-4 bg-gray-900 rounded absolute -left-2 bottom-2 border-2 border-red-700 shadow-lg"><div class="w-4 h-2 bg-red-800 absolute top-1 left-1 rounded opacity-80"></div></div><div class="absolute -inset-2 bg-gradient-to-r from-red-900/20 via-black/30 to-red-900/20 rounded-lg"></div></div></div>
    </template>
    <template id="enemy-formaldehyde-template">
        <div class="float"><div class="w-12 h-20 bg-gradient-to-b from-green-300 to-green-600 rounded-t-2xl relative shadow-2xl border-2 border-green-200"><div class="w-8 h-14 bg-gradient-to-b from-green-400 to-green-700 rounded-t-2xl absolute top-2 left-2 opacity-90"><div class="w-6 h-10 bg-green-500 rounded-t-xl absolute top-2 left-1 opacity-80"></div><div class="w-1 h-1 bg-yellow-400 rounded-full absolute top-3 left-2 sparkle"></div><div class="w-1 h-1 bg-yellow-400 rounded-full absolute top-6 right-2 sparkle" style="animation-delay: 0.5s;"></div><div class="w-0.5 h-0.5 bg-yellow-400 rounded-full absolute top-8 left-3 sparkle" style="animation-delay: 1s;"></div><div class="w-1 h-1 bg-yellow-300 rounded-full absolute top-10 left-1 sparkle" style="animation-delay: 0.2s;"></div></div><div class="w-6 h-3 bg-gray-600 absolute top-0 left-3 rounded-t border border-gray-500"></div><div class="w-8 h-4 bg-red-600 absolute bottom-4 left-2 rounded border border-red-500 pulse"><div class="w-6 h-2 bg-white absolute top-1 left-1 rounded text-xs flex items-center justify-center"><span class="text-red-600 text-xs font-bold">‚ö†</span></div></div><div class="w-2 h-2 bg-green-400 rounded-full absolute -top-2 left-5 opacity-60 smoke"></div></div></div>
    </template>
    <template id="enemy-acrolein-template">
        <div class="glow"><div class="w-12 h-20 bg-gradient-to-t from-blue-600 via-cyan-400 to-cyan-200 relative shadow-2xl rounded-t-full"><div class="w-8 h-14 bg-gradient-to-t from-blue-300 via-cyan-300 to-white absolute top-3 left-2 rounded-t-full opacity-80"></div><div class="w-2 h-2 bg-red-500 rounded-full absolute top-6 left-3 glow"></div><div class="w-2 h-2 bg-red-500 rounded-full absolute top-6 right-3 glow"></div><div class="w-4 h-1 bg-red-600 absolute bottom-8 left-4 rounded-full"></div><div class="w-2 h-4 bg-cyan-200 absolute -top-2 left-3 rounded-t-full opacity-60 float"></div><div class="w-1 h-3 bg-white absolute -top-1 right-4 rounded-t-full opacity-80 float" style="animation-delay: 0.5s;"></div><div class="w-2 h-3 bg-cyan-100 absolute -top-1.5 left-5 rounded-t-full opacity-70 float" style="animation-delay: 0.2s;"></div><div class="w-12 h-4 bg-blue-800 absolute bottom-0 left-0 rounded-b"></div></div></div>
    </template>
    <template id="enemy-benzene-template">
        <div class="glow"><div class="w-18 h-18 border-4 border-purple-600 rounded-full relative shadow-2xl bg-gradient-to-r from-purple-900 via-black to-purple-900"><div class="w-4 h-4 bg-purple-600 rounded-full absolute top-0 left-1/2 transform -translate-x-1/2 sparkle border-2 border-red-500 shadow-xl"><div class="w-2 h-2 bg-red-500 rounded-full absolute top-1 left-1 glow"></div></div><div class="w-4 h-4 bg-purple-600 rounded-full absolute top-2 right-0 sparkle border-2 border-red-500 shadow-xl" style="animation-delay: 0.3s;"><div class="w-2 h-2 bg-red-500 rounded-full absolute top-1 right-1 glow"></div></div><div class="w-4 h-4 bg-purple-600 rounded-full absolute bottom-2 right-0 sparkle border-2 border-red-500 shadow-xl" style="animation-delay: 0.6s;"><div class="w-2 h-2 bg-red-500 rounded-full absolute bottom-1 right-1 glow"></div></div><div class="w-4 h-4 bg-purple-600 rounded-full absolute bottom-0 left-1/2 transform -translate-x-1/2 sparkle border-2 border-red-500 shadow-xl" style="animation-delay: 0.9s;"><div class="w-2 h-2 bg-red-500 rounded-full absolute bottom-1 left-1 glow"></div></div><div class="w-4 h-4 bg-purple-600 rounded-full absolute bottom-2 left-0 sparkle border-2 border-red-500 shadow-xl" style="animation-delay: 1.2s;"><div class="w-2 h-2 bg-red-500 rounded-full absolute bottom-1 left-1 glow"></div></div><div class="w-4 h-4 bg-purple-600 rounded-full absolute top-2 left-0 sparkle border-2 border-red-500 shadow-xl" style="animation-delay: 1.5s;"><div class="w-2 h-2 bg-red-500 rounded-full absolute top-1 left-1 glow"></div></div><div class="absolute -inset-3 border-3 border-purple-600 rounded-full opacity-40 glow"></div><div class="w-8 h-8 bg-gradient-to-r from-purple-800 to-black rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pulse border-3 border-red-700 shadow-2xl"><div class="w-4 h-4 bg-red-600 rounded-full absolute top-2 left-2 glow"><div class="w-1 h-1 bg-white rounded-full absolute top-0.5 left-0.5"></div></div></div></div></div>
    </template>

    <script>
        // --- Fullscreen Logic ---
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const iconFullscreen = document.getElementById('icon-fullscreen');
        const iconExitFullscreen = document.getElementById('icon-exit-fullscreen');
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            document.addEventListener('fullscreenchange', updateFullscreenIcons);
            document.addEventListener('webkitfullscreenchange', updateFullscreenIcons);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                document.documentElement.requestFullscreen?.().catch(err => console.warn(`Error enabling full-screen: ${err.message}`));
            } else {
                document.exitFullscreen?.().catch(err => console.warn(`Error exiting full-screen: ${err.message}`));
            }
        }
        
        function updateFullscreenIcons() {
            const isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement;
            if(iconFullscreen) iconFullscreen.classList.toggle('hidden', isFullscreen);
            if(iconExitFullscreen) iconExitFullscreen.classList.toggle('hidden', !isFullscreen);
        }

        // --- CONFIG: Qu·∫£n l√Ω c√°c th√¥ng s·ªë game ·ªü m·ªôt n∆°i ---
        const CONFIG = {
            PLAYER_SPEED: 7,
            BULLET_SPEED: 10,
            ENEMY_BULLET_SPEED: 0.7,
            PLAYER_SHOOT_COOLDOWN: 300,
            INITIAL_LIVES: 3,
            ENEMY_TYPES: {
                nicotine: { 
                    displayName: "Nicotine ‚Äì K·∫ª Xi·ªÅng X√≠ch",
                    meaning: "G·∫Øn ch·∫∑t ng∆∞·ªùi d√πng v√†o v√≤ng nghi·ªán ng·∫≠p nh∆∞ t√π nh√¢n.",
                    subtitle: "‚ÄúM∆∞u m√¥ trong chi·∫øc √°o vest t·ªëi‚Äù",
                    templateId: 'enemy-nicotine-template', scale: 0.4, baseWidth: 64, baseHeight: 96, score: 10,
                    taunts: [
                        "B·ªô n√£o c·ªßa ng∆∞∆°i s·∫Ω kh√¥ng th·ªÉ s·ªëng thi·∫øu ta!",
                        "Ta s·∫Ω khi·∫øn tim ng∆∞∆°i ph·∫£i ƒë·∫≠p trong m·ªát m·ªèi!",
                        "Nghi·ªán ng·∫≠p l√† kh√¥ng th·ªÉ tr√°nh kh·ªèi!",
                        "Tr√≠ nh·ªõ c·ªßa ng∆∞∆°i s·∫Ω suy gi·∫£m!",
                        "M·ªói h∆°i th·ªü c·ªßa ng∆∞∆°i ƒë·ªÅu ch·ª©a ch·∫•t ƒë·ªôc c·ªßa ta!",
                        "Ng∆∞∆°i ch·ªâ l√† m·ªôt con r·ªëi trong tay ta!",
                        "C√†ng chi·∫øn ƒë·∫•u, ng∆∞∆°i c√†ng l√∫n s√¢u v√†o s·ª± ki·ªÉm so√°t c·ªßa ta.",
                        "N√£o b·ªô ng∆∞∆°i ƒëang g√†o th√©t t√™n ta ƒë·∫•y, nghe kh√¥ng?",
                        "B·ªè cu·ªôc ƒëi, s·ª± th·ªèa m√£n t·ª©c th·ªùi ƒëang ch·ªù ng∆∞∆°i."
                    ] 
                },
                formaldehyde: { 
                    displayName: "Formaldehyde ‚Äì L·ªç T·ª≠ Th·∫ßn",
                    meaning: "H√≥a ch·∫•t ∆∞·ªõp x√°c, bi·∫øn s·ª± s·ªëng th√†nh x√°c ch·∫øt.",
                    subtitle: "‚ÄúK·∫ª ƒë√≥ng h·ªôp linh h·ªìn trong th·ªßy tinh‚Äù",
                    templateId: 'enemy-formaldehyde-template', scale: 0.42, baseWidth: 48, baseHeight: 80, score: 15,
                    taunts: [
                        "Ng∆∞∆°i s·∫Ω b·ªã ung th∆∞ ph·ªïi!",
                        "Ta ƒëang ph√° h·ªßy t·ª´ng t·∫ø b√†o c·ªßa ng∆∞∆°i...",
                        "Ho khan s·∫Ω l√† b·∫°n ƒë·ªìng h√†nh c·ªßa ng∆∞∆°i!",
                        "C∆° th·ªÉ ng∆∞∆°i s·∫Ω s·ªõm tr·ªü th√†nh m·ªôt t√°c ph·∫©m ngh·ªá thu·∫≠t c·ªßa ta.",
                        "M·ªói h∆°i th·ªü c·ªßa ng∆∞∆°i ƒë·ªÅu l√† m·ªôt b∆∞·ªõc g·∫ßn h∆°n ƒë·∫øn s·ª± b·∫•t t·ª≠... trong l·ªç.",
                        "Ta s·∫Ω b·∫£o qu·∫£n th·∫•t b·∫°i c·ªßa ng∆∞∆°i m√£i m√£i.",
                        "Kh√¥ng kh√≠ trong l√†nh ∆∞? Th·∫≠t l√† m·ªôt kh√°i ni·ªám xa x·ªâ."
                    ]
                },
                acrolein: { 
                    displayName: "Acrolein ‚Äì Ng·ªçn L·ª≠a T√†n Ph√°",
                    meaning: "Thi√™u ƒë·ªët v√† h·ªßy ho·∫°i c∆° th·ªÉ t·ª´ b√™n trong.",
                    subtitle: "‚ÄúNg·ªçn l·ª≠a ƒë·ªôc √°c lu√¥n r√¨nh r·∫≠p‚Äù",
                    templateId: 'enemy-acrolein-template', scale: 0.42, baseWidth: 48, baseHeight: 80, score: 15,
                    taunts: [
                        "Ta s·∫Ω l·∫•y ƒëi h∆°i th·ªü c·ªßa ng∆∞∆°i!",
                        "L√° ph·ªïi trong l√†nh c·ªßa ng∆∞∆°i s·∫Ω s·ªõm b·ªã t·ªïn th∆∞∆°ng vƒ©nh vi·ªÖn!",
                        "Diacetyl t·ª´ ta, th·ª© s·∫Ω ph√° h·ªßy ph·ªïi c·ªßa ng∆∞∆°i!",
                        "C·∫£m nh·∫≠n l√° ph·ªïi c·ªßa ng∆∞∆°i ƒëang ch√°y √¢m ·ªâ ƒëi!",
                        "M·ªói ph√°t b·∫Øn c·ªßa ng∆∞∆°i ch·ªâ l√†m ng·ªçn l·ª≠a trong ta th√™m b√πng ch√°y.",
                        "Ta l√† c∆°n ho kh√¥ng bao gi·ªù d·ª©t c·ªßa ng∆∞∆°i.",
                        "S·ª± t∆∞∆°i m√°t c·ªßa ng∆∞∆°i s·∫Ω s·ªõm b·ªã thay th·∫ø b·∫±ng tro t√†n."
                    ]
                },
                benzene: { 
                    displayName: "T·ª≠ Th·∫ßn Benzene",
                    templateId: 'enemy-benzene-template', scale: 0.4, baseWidth: 72, baseHeight: 72, score: 20,
                    taunts: [
                         "Ta s·∫Ω khi·∫øn ng∆∞∆°i b·ªã ung th∆∞ m√°u!",
                        "H·ªá mi·ªÖn d·ªãch c·ªßa ng∆∞∆°i s·∫Ω y·∫øu d·∫ßn!",
                    ]
                }
            },
            POWERUP_TYPES: [
                { type: 'spread-shot', emoji: 'ü•à', duration: 10000 },
                { type: 'shield', emoji: 'üõ°Ô∏è', duration: 5000 },
                { type: 'health', emoji: '‚ù§Ô∏è', duration: 0 }
            ],
            POWERUP_SPAWN_CHANCE: 0.05,
            BOSS_POWERUP_SPAWN_CHANCE: 0.15,
        };

        // --- C√†i ƒë·∫∑t ƒë·ªô kh√≥ ---
        const DIFFICULTY_SETTINGS = {
            easy: {
                powerUpSpawnChance: 0.15, // TƒÉng t·ªâ l·ªá
                bossPowerUpSpawnChance: 0.30,
                scaleWithLevel: false // Kh√¥ng tƒÉng ƒë·ªô kh√≥
            },
            hard: {
                powerUpSpawnChance: CONFIG.POWERUP_SPAWN_CHANCE, // M·∫∑c ƒë·ªãnh
                bossPowerUpSpawnChance: CONFIG.BOSS_POWERUP_SPAWN_CHANCE,
                scaleWithLevel: true // TƒÉng ƒë·ªô kh√≥
            }
        };

        // --- Sound Manager ---
        const soundManager = {
            isStarted: false,
            synths: {},
            music: null,

            init() {
                // Sound Effects for single triggers
                this.synths.playerShoot = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.1 } }).toDestination();
                this.synths.bossDefeat = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.01, decay: 1.5, sustain: 0, release: 0.2 } }).toDestination();

                this.synths.powerUp = new Tone.PolySynth(Tone.Synth).toDestination();
                this.synths.powerUp.set({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 }
                });

                this.synths.explosion = new Tone.PolySynth(Tone.NoiseSynth).toDestination();
                this.synths.explosion.set({
                    envelope: { attack: 0.01, decay: 0.15, sustain: 0, release: 0.1 }
                });

                this.synths.playerHit = new Tone.PolySynth(Tone.Synth).toDestination();
                this.synths.playerHit.set({
                    oscillator: { type: 'square' },
                    envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.2 }
                });

                this.synths.bossHit = new Tone.PolySynth(Tone.MetalSynth).toDestination();
                this.synths.bossHit.set({
                    frequency: 50,
                    envelope: { attack: 0.01, decay: 0.4, release: 0.2 },
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                });
                
                // Background Music
                const bassSynth = new Tone.MonoSynth({
                    oscillator: { type: "fmsquare" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.4, release: 0.8 }
                }).toDestination();
                bassSynth.volume.value = -16; // Adjusted volume
                
                const melodySynth = new Tone.Synth({
                    oscillator: { type: "pulse", width: 0.6 },
                    envelope: { attack: 0.01, decay: 0.3, sustain: 0.2, release: 0.4 }
                }).toDestination();
                melodySynth.volume.value = -14; // Adjusted volume

                const bassPart = new Tone.Sequence((time, note) => {
                    bassSynth.triggerAttackRelease(note, "8n", time);
                }, ["C2", "G1", "A1", "F1"], "4n");

                const melodyPart = new Tone.Sequence((time, note) => {
                    melodySynth.triggerAttackRelease(note, "16n", time);
                }, [
                    'G4', 'A4', 'C5', 'A4', 'G4', null, 'E4', 'D4',
                    'C4', 'E4', 'G4', 'E4', 'D4', null, 'C4', null
                ], "8n");

                this.music = { bass: bassPart, melody: melodyPart };
            },

            async ensureStarted() {
                if (this.isStarted) return;
                if (typeof Tone === 'undefined') {
                    console.error('Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán √¢m thanh (Tone.js). Ki·ªÉm tra m·∫°ng/CDN ho·∫∑c th·ª≠ l·∫°i.');
                    return;
                }
                try {
                    await Tone.start();
                    this.init();
                    this.isStarted = true;
                    Tone.Transport.start();
                    this.music.bass.start(0);
                    this.music.melody.start(0);
                } catch (e) {
                    console.error("Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông √¢m thanh:", e);
                }
            },

            stopMusic() {
                if (this.isStarted && this.music) {
                    this.music.bass.stop(0);
                    this.music.melody.stop(0);
                    Tone.Transport.stop();
                }
            },

            play(sound) {
                if (!this.isStarted) return;
                switch(sound) {
                    case 'playerShoot':
                        this.synths.playerShoot.triggerAttackRelease('C5', '8n');
                        break;
                    case 'explosion':
                        this.synths.explosion.triggerAttackRelease('0.1');
                        break;
                    case 'playerHit':
                        this.synths.playerHit.triggerAttackRelease('C#2', '4n');
                        break;
                    case 'powerUp':
                        this.synths.powerUp.triggerAttackRelease('G5', '8n');
                        break;
                    case 'bossHit':
                        this.synths.bossHit.triggerAttackRelease("C3", "8n");
                        break;
                    case 'bossDefeat':
                        this.synths.bossDefeat.triggerAttackRelease("1n");
                        break;
                }
            }
        };

        // --- L·ªõp Game ch√≠nh ---
        // ... (ph·∫ßn c√≤n l·∫°i c·ªßa m√£ game kh√¥ng thay ƒë·ªïi) ...
        class Game {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.error('Game container not found!');
                    return;
                }
                this.initDOM();
                this.initProperties();
                this.setupEventListeners();
                this.init();
            }

            initDOM() {
                this.scoreDisplay = document.getElementById('score-display');
                this.livesDisplay = document.getElementById('lives-display');
                this.levelDisplay = document.getElementById('level-display');
                this.startScreen = document.getElementById('start-screen');
                this.gameOverScreen = document.getElementById('game-over-screen');
                this.levelUpScreen = document.getElementById('level-up-screen');
                this.warningScreen = document.getElementById('warning-screen');
                this.warningText = document.getElementById('warning-text');
                this.warningSubtext = document.getElementById('warning-subtext');
                this.warningMeaning = document.getElementById('warning-meaning');
                this.levelUpText = document.getElementById('level-up-text');
                this.easyButton = document.getElementById('easy-button');
                this.hardButton = document.getElementById('hard-button');
                this.restartButton = document.getElementById('restart-button');
                this.finalScoreDisplay = document.getElementById('final-score');
                this.instructionsScreen = document.getElementById('instructions-screen');
                this.instructionsButton = document.getElementById('instructions-button');
                this.backButton = document.getElementById('back-button');
                this.victoryScreen = document.getElementById('victory-screen');
                this.restartVictoryButton = document.getElementById('restart-victory-button');
                this.continueButton = document.getElementById('continue-button');
                this.mainMenuButton = document.getElementById('main-menu-button');
            }
            
            initProperties() {
                this.score = 0;
                this.lives = CONFIG.INITIAL_LIVES;
                this.level = 1;
                this.difficulty = 'hard'; // M·∫∑c ƒë·ªãnh l√† kh√≥
                this.gameMode = 'wave';
                this.gameObjects = [];
                this.player = null;
                this.boss = null;
                this.miniBosses = [];
                this.keys = {};
                this.gameLoopId = null;
                this.enemyShootInterval = null;
                this.bossShootInterval = null;
                this.enemyDirection = 1;
                this.enemyMoveDown = false;
                this.allEnemiesInFormation = false;
                this.enemySpeed = 0.5;
                this.bossSpeed = 0.5;
                this.bossDirection = 1;
                this.miniBossesSpawned = false;
            }

            setupEventListeners() {
                window.addEventListener('keydown', (e) => {
                    if (this.keys) this.keys[e.key] = true;
                });
                window.addEventListener('keyup', (e) => {
                    if (this.keys) this.keys[e.key] = false;
                });
                this.easyButton.addEventListener('click', () => this.selectDifficulty('easy'));
                this.hardButton.addEventListener('click', () => this.selectDifficulty('hard'));
                this.restartButton.addEventListener('click', () => {
                    this.init();
                });
                this.instructionsButton.addEventListener('click', () => this.showInstructions());
                this.backButton.addEventListener('click', () => this.hideInstructions());

                // Event listeners cho m√†n h√¨nh chi·∫øn th·∫Øng
                this.restartVictoryButton.addEventListener('click', () => {
                    this.victoryScreen.style.display = 'none';
                    this.init();
                });
                this.continueButton.addEventListener('click', () => {
                    window.location.href = 'bansungquakimcuong.html';
                });
                this.mainMenuButton.addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }

            init() {
                if (this.gameLoopId) cancelAnimationFrame(this.gameLoopId);
                if (this.enemyShootInterval) clearInterval(this.enemyShootInterval);
                if (this.bossShootInterval) clearInterval(this.bossShootInterval);

                if (this.gameObjects) {
                    this.gameObjects.forEach(obj => obj.destroy());
                }
                
                this.initProperties(); // Reset l·∫°i m·ªçi th·ª©
                
                this.updateUI();
                this.player = new Player(this);
                this.gameObjects.push(this.player);
                
                this.gameOverScreen.style.display = 'none';
                this.victoryScreen.style.display = 'none';
                this.warningScreen.style.display = 'none';
                this.instructionsScreen.style.display = 'none';
                this.startScreen.style.display = 'flex';
            }
            
            showInstructions() {
                this.startScreen.style.display = 'none';
                this.instructionsScreen.style.display = 'flex';
            }

            hideInstructions() {
                this.instructionsScreen.style.display = 'none';
                this.startScreen.style.display = 'flex';
            }

            selectDifficulty(difficulty) {
                this.difficulty = difficulty;
                this.start();
            }

            async start() {
                await soundManager.ensureStarted();
                this.startScreen.style.display = 'none';
                if (this.gameLoopId) cancelAnimationFrame(this.gameLoopId);
                this.startWaveLevel();
                this.gameLoop();
            }

            gameLoop = () => {
                this.update();
                this.draw();
                this.gameLoopId = requestAnimationFrame(this.gameLoop);
            }

            update() {
                this.gameObjects.forEach(obj => obj.update());
                this.gameObjects = this.gameObjects.filter(obj => !obj.isDestroyed);
                if (this.gameMode === 'wave') this.moveEnemies();
                this.checkCollisions();
                this.checkGameFlow();
            }

            draw() {
                this.gameObjects.forEach(obj => obj.draw());
            }
            
            showVictoryScreen() {
                if (this.gameLoopId) cancelAnimationFrame(this.gameLoopId);
                clearInterval(this.enemyShootInterval);
                clearInterval(this.bossShootInterval);
                soundManager.stopMusic();
                this.victoryScreen.style.display = 'flex';
            }

            checkCollisions() {
                const bullets = this.gameObjects.filter(g => g instanceof Bullet && g.isPlayerBullet);
                const enemyBullets = this.gameObjects.filter(g => g instanceof Bullet && !g.isPlayerBullet);
                const enemies = this.gameObjects.filter(g => g instanceof Enemy && !(g instanceof Boss));
                const powerUps = this.gameObjects.filter(g => g instanceof PowerUp);

                for (const bullet of bullets) {
                    if (bullet.isDestroyed) continue;

                    let closestTarget = null;
                    let maxTargetY = -1; 

                    let potentialTargets = [];
                    if (this.gameMode === 'wave') {
                        potentialTargets = enemies;
                    } else if (this.gameMode === 'miniboss') {
                        potentialTargets = this.miniBosses;
                    } else if (this.gameMode === 'boss' && this.boss) {
                        potentialTargets = [this.boss];
                    }

                    for (const target of potentialTargets) {
                        if (target.isDestroyed) continue;

                        if (this.isPathColliding(bullet, target)) {
                            if (target.y > maxTargetY) {
                                maxTargetY = target.y;
                                closestTarget = target;
                            }
                        }
                    }

                    if (closestTarget) {
                        if (this.gameMode === 'wave') {
                            closestTarget.takeDamage(1);
                        } else { 
                            closestTarget.takeDamage(5);
                        }
                        
                        bullet.destroy();
                    }
                }


                if (this.player && !this.player.isInvulnerable) {
                    enemyBullets.forEach(bullet => {
                        if (this.isPathColliding(bullet, this.player)) {
                            bullet.destroy();
                            this.player.takeDamage();
                            if (this.lives <= 0) this.endGame();
                        }
                    });
                     enemies.forEach(enemy => {
                        if (enemy.isInFormation && this.isAABBColliding(enemy, this.player)) {
                             this.player.takeDamage();
                             enemy.takeDamage(1000); 
                             if (this.lives <= 0) this.endGame();
                        }
                    });
                }
                
                powerUps.forEach(p => {
                    if (this.player && this.isAABBColliding(p, this.player)) {
                        this.player.activatePowerUp(p.powerUpType);
                        p.destroy();
                    }
                });
            }
            
            checkGameFlow() {
                const enemies = this.gameObjects.filter(g => g instanceof Enemy && !(g instanceof Boss));
                
                if (this.gameMode === 'wave' && enemies.length === 0 && this.allEnemiesInFormation) {
                    if (this.level < 5) {
                        this.level++;
                        this.startWaveLevel();
                    } else {
                        this.startMiniBossPhase();
                    }
                } 
                else if (this.gameMode === 'miniboss' && this.miniBosses.length === 0 && this.miniBossesSpawned) {
                    this.startMainBossPhase();
                }
            }

            startMiniBossPhase() {
                this.gameMode = 'miniboss';
                this.levelDisplay.textContent = `M√†n: Mini-Boss`;
                this.updateUI();

                const settings = DIFFICULTY_SETTINGS[this.difficulty];
                this.bossSpeed = 0.5 + (settings.scaleWithLevel ? (this.level - 5) * 0.1 : 0);
                const shootInterval = Math.max(500, (1200 - (settings.scaleWithLevel ? (this.level - 5) * 100 : 0)) * (settings.scaleWithLevel ? 1 : 1.5));

                const acroleinInfo = CONFIG.ENEMY_TYPES.acrolein;
                const formaldehydeInfo = CONFIG.ENEMY_TYPES.formaldehyde;

                this.warningText.textContent = '‚ö†Ô∏è MINI BOSS XU·∫§T HI·ªÜN ‚ö†Ô∏è';
                this.warningSubtext.innerHTML = `${acroleinInfo.displayName} & ${formaldehydeInfo.displayName}`;
                this.warningMeaning.innerHTML = `<i>${acroleinInfo.subtitle} & ${formaldehydeInfo.subtitle}</i>`;
                this.warningScreen.style.display = 'flex';
                
                setTimeout(() => {
                    this.warningScreen.style.display = 'none';
                    const boss1 = new Boss(this, 'acrolein', 1.2, 150, 100);
                    const boss2 = new Boss(this, 'formaldehyde', 1.2, 150, 100);
                    
                    const quarterWidth = this.container.offsetWidth / 4;
                    boss1.x = quarterWidth - boss1.width / 2;
                    boss2.x = (quarterWidth * 3) - boss2.width / 2;

                    this.miniBosses.push(boss1, boss2);
                    this.gameObjects.push(boss1, boss2);
                    this.miniBossesSpawned = true;
                    if(this.bossShootInterval) clearInterval(this.bossShootInterval);
                    this.bossShootInterval = setInterval(() => this.miniBosses.forEach(b => { if(b && !b.isDestroyed) b.shoot() }), shootInterval);
                }, 4000);
            }

            startMainBossPhase() {
                this.gameMode = 'boss';
                if(this.bossShootInterval) clearInterval(this.bossShootInterval);
                
                this.levelDisplay.textContent = `M√†n: Boss Cu·ªëi`;
                const settings = DIFFICULTY_SETTINGS[this.difficulty];
                this.bossSpeed = 0.5 + (settings.scaleWithLevel ? (this.level - 5) * 0.1 : 0);
                const shootInterval = Math.max(400, (1000 - (settings.scaleWithLevel ? (this.level - 5) * 100 : 0)) * (settings.scaleWithLevel ? 1 : 1.5));

                const nicotineInfo = CONFIG.ENEMY_TYPES.nicotine;

                this.warningText.textContent = `‚ö†Ô∏è ${nicotineInfo.displayName} ‚ö†Ô∏è`;
                this.warningSubtext.textContent = nicotineInfo.subtitle;
                this.warningMeaning.textContent = nicotineInfo.meaning;
                this.warningScreen.style.display = 'flex';
                
                setTimeout(() => {
                    this.warningScreen.style.display = 'none';
                    this.boss = new Boss(this, "nicotine", 1.5, 500 + (settings.scaleWithLevel ? (this.level - 5) * 50 : 0), 100, true);
                    this.gameObjects.push(this.boss);
                    this.bossShootInterval = setInterval(() => {
                        if (this.boss && !this.boss.isDestroyed) this.boss.shoot()
                    }, shootInterval);
                }, 4000);
            }

            startWaveLevel() {
                this.gameMode = 'wave';
                const settings = DIFFICULTY_SETTINGS[this.difficulty];
                this.enemySpeed = 0.5 + (settings.scaleWithLevel ? this.level * 0.15 : 0);
                this.allEnemiesInFormation = false;
                this.levelUpText.textContent = `M√†n ${this.level}`;
                this.levelUpScreen.style.display = 'flex';

                if (this.enemyShootInterval) clearInterval(this.enemyShootInterval);
                const shootInterval = Math.max(500, (2500 - (settings.scaleWithLevel ? this.level * 200 : 0)) * (settings.scaleWithLevel ? 1 : 1.5) );
                this.enemyShootInterval = setInterval(() => this.enemyShoot(), shootInterval);

                setTimeout(() => {
                    this.levelUpScreen.style.display = 'none';
                    this.createEnemyFormation();
                }, 2000);
                this.updateUI();
            }
            
            createEnemyFormation() {
                const formationSetup = [10, 8];
                const rows = formationSetup.length;
                const padding = 20;
                const startY = 60;
                
                let enemyPool = ['nicotine'];
                if (this.level >= 2) enemyPool.push('formaldehyde');
                if (this.level >= 3) enemyPool.push('acrolein');
                if (this.level >= 4) enemyPool.push('benzene');

                for (let row = 0; row < rows; row++) {
                    const cols = formationSetup[row];
                    const enemyWidth = 64 * 0.4; 
                    const enemyHeight = 96 * 0.4;
                    const formationWidth = cols * (enemyWidth + padding) - padding;
                    const startX = (this.container.offsetWidth - formationWidth) / 2;
                    for (let col = 0; col < cols; col++) {
                        const targetX = startX + col * (enemyWidth + padding);
                        const targetY = startY + row * (enemyHeight + padding);
                        let enemyType = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                        const enemy = new Enemy(this, targetX, targetY, enemyType);
                        this.gameObjects.push(enemy);
                    }
                }
            }
            
            moveEnemies() {
                const enemies = this.gameObjects.filter(g => g instanceof Enemy && !(g instanceof Boss));
                if (enemies.length === 0) return;

                let formationCheck = true;
                enemies.forEach(enemy => {
                    if (!enemy.isInFormation) {
                        formationCheck = false;
                    }
                });
                this.allEnemiesInFormation = formationCheck;

                if (this.allEnemiesInFormation) {
                    this.enemyMoveDown = false;
                    let rightmostEnemy = 0;
                    let leftmostEnemy = this.container.offsetWidth;
                    enemies.forEach(e => {
                        if (e.x > rightmostEnemy) rightmostEnemy = e.x;
                        if (e.x < leftmostEnemy) leftmostEnemy = e.x;
                    });
                    if ((rightmostEnemy + enemies[0].width > this.container.offsetWidth && this.enemyDirection > 0) || (leftmostEnemy < 0 && this.enemyDirection < 0)) {
                        this.enemyDirection *= -1;
                        this.enemyMoveDown = true;
                    }
                    enemies.forEach(e => {
                        e.x += this.enemySpeed * this.enemyDirection;
                        if (this.enemyMoveDown) e.y += 20;
                    });
                }
            }
            
            enemyShoot() {
                const enemiesInFormation = this.gameObjects.filter(g => g instanceof Enemy && !(g instanceof Boss) && g.isInFormation);
                if (enemiesInFormation.length > 0) {
                    const shootingEnemy = enemiesInFormation[Math.floor(Math.random() * enemiesInFormation.length)];
                    shootingEnemy.shoot();
                }
            }

            endGame() {
                cancelAnimationFrame(this.gameLoopId);
                clearInterval(this.enemyShootInterval);
                clearInterval(this.bossShootInterval);
                soundManager.stopMusic();
                this.finalScoreDisplay.textContent = `ƒêi·ªÉm c·ªßa b·∫°n: ${this.score}`;
                this.gameOverScreen.style.display = 'flex';
            }

            updateUI() {
                if (this.gameMode === 'wave') {
                    this.levelDisplay.textContent = `M√†n: ${this.level}`;
                }
                this.scoreDisplay.textContent = `ƒêi·ªÉm: ${this.score}`;
                this.livesDisplay.innerHTML = '';
                for (let i = 0; i < this.lives; i++) this.livesDisplay.innerHTML += '‚ù§Ô∏è';
            }

            spawnPowerUp(x, y) {
                const type = CONFIG.POWERUP_TYPES[Math.floor(Math.random() * CONFIG.POWERUP_TYPES.length)];
                const powerUp = new PowerUp(this, x, y, type);
                this.gameObjects.push(powerUp);
            }

            isAABBColliding(a, b) {
                if (!a || !b || a.isDestroyed || b.isDestroyed) return false;
                return !(
                    ((a.y + a.height) < (b.y)) ||
                    (a.y > (b.y + b.height)) ||
                    ((a.x + a.width) < b.x) ||
                    (a.x > (b.x + b.width))
                );
            }

            isPathColliding(bullet, target) {
                if (!bullet || !target || bullet.isDestroyed || target.isDestroyed) return false;
                
                const pathMinX = Math.min(bullet.oldX, bullet.x);
                const pathMaxX = Math.max(bullet.oldX, bullet.x) + bullet.width;
                const pathMinY = Math.min(bullet.oldY, bullet.y);
                const pathMaxY = Math.max(bullet.oldY, bullet.y) + bullet.height;

                const targetMinX = target.x;
                const targetMaxX = target.x + target.width;
                const targetMinY = target.y;
                const targetMaxY = target.y + target.height;

                return !(
                    pathMaxX < targetMinX ||
                    pathMinX > targetMaxX ||
                    pathMaxY < targetMinY ||
                    pathMinY > targetMaxY
                );
            }

            handleResize() {
                if (this.player) {
                    this.player.x = this.container.offsetWidth / 2 - this.player.width / 2;
                    this.player.y = this.container.offsetHeight - this.player.height - 20;
                }
            }
            
            createExplosion(x, y, isPlayerHit = false) {
                if (isPlayerHit) {
                    soundManager.play('playerHit');
                } else {
                    soundManager.play('explosion');
                }
                const explosionDiv = document.createElement('div');
                explosionDiv.className = 'game-object explosion';
                if (isPlayerHit) explosionDiv.classList.add('player-explosion');
                explosionDiv.style.left = `${x}px`;
                explosionDiv.style.top = `${y}px`;
                this.container.appendChild(explosionDiv);
                setTimeout(() => explosionDiv.remove(), 300);
            }
        }

        // --- L·ªõp c∆° s·ªü cho c√°c ƒë·ªëi t∆∞·ª£ng trong game ---
        class GameObject {
            constructor(game, x, y) {
                this.game = game;
                this.x = x;
                this.y = y;
                this.width = 0;
                this.height = 0;
                this.element = null;
                this.isDestroyed = false;
            }

            update() { /* Ghi ƒë√® ·ªü l·ªõp con */ }
            
            draw() {
                if(this.element && !this.isDestroyed) {
                    this.element.style.left = `${this.x}px`;
                    this.element.style.top = `${this.y}px`;
                }
            }

            destroy() {
                if (this.isDestroyed) return;
                this.isDestroyed = true;
                if (this.element && this.element.parentElement) {
                    this.element.parentElement.removeChild(this.element);
                }
            }
        }

        // --- L·ªõp Player ---
        class Player extends GameObject {
            constructor(game) {
                const initialX = game.container.offsetWidth / 2 - 40;
                const initialY = game.container.offsetHeight - 112 * 0.5 - 20;
                super(game, initialX, initialY);
                
                const template = document.getElementById('player-template');
                this.element = template.content.firstElementChild.cloneNode(true);
                this.element.className = 'game-object player';
                this.element.style.transform = 'scale(0.5)';
                this.game.container.appendChild(this.element);

                this.width = 80 * 0.5;
                this.height = 112 * 0.5;
                this.y = this.game.container.offsetHeight - this.height - 20;
                this.x = this.game.container.offsetWidth / 2 - this.width / 2;

                this.canShoot = true;
                this.isInvulnerable = false;
                this.bulletLevel = 1;
                this.powerUpTimeout = null;
            }

            update() {
                if (this.game.keys['ArrowLeft'] && this.x > 0) this.x -= CONFIG.PLAYER_SPEED;
                if (this.game.keys['ArrowRight'] && this.x < this.game.container.offsetWidth - this.width) this.x += CONFIG.PLAYER_SPEED;
                if (this.game.keys[' '] && this.canShoot) this.shoot();
            }
            
            draw() {
                 this.element.style.left = `${this.x}px`;
            }

            shoot() {
                soundManager.play('playerShoot');
                this.canShoot = false;
                
                const createBullet = (speedX, speedY) => {
                    const bullet = new Bullet(this.game, this.x + this.width / 2 - 4, this.y, speedX, speedY, true);
                    this.game.gameObjects.push(bullet);
                };

                if (this.bulletLevel === 1) {
                    createBullet(0, -CONFIG.BULLET_SPEED);
                } else if (this.bulletLevel >= 2) {
                    createBullet(-2, -CONFIG.BULLET_SPEED * 0.9);
                    createBullet(0, -CONFIG.BULLET_SPEED);
                    createBullet(2, -CONFIG.BULLET_SPEED * 0.9);
                }
                
                setTimeout(() => { this.canShoot = true; }, CONFIG.PLAYER_SHOOT_COOLDOWN);
            }

            takeDamage() {
                if (this.isInvulnerable) return;
                this.game.createExplosion(this.x + this.width / 2 - 40, this.y + this.height / 2 - 40, true);
                this.game.lives--;
                this.game.updateUI();
                this.isInvulnerable = true;
                this.element.classList.add('hit');
                setTimeout(() => {
                    this.isInvulnerable = false;
                    this.element.classList.remove('hit');
                }, 1000);
            }
            
            activatePowerUp(type) {
                soundManager.play('powerUp');
                clearTimeout(this.powerUpTimeout);
                
                if (type.type === 'spread-shot') {
                    this.bulletLevel = 2;
                    this.powerUpTimeout = setTimeout(() => { this.bulletLevel = 1; }, type.duration);
                } else if (type.type === 'shield') {
                    this.isInvulnerable = true;
                    this.element.classList.add('shielded');
                    setTimeout(() => {
                        this.isInvulnerable = false;
                        this.element.classList.remove('shielded');
                    }, type.duration);
                } else if (type.type === 'health') {
                    if (this.game.lives < CONFIG.INITIAL_LIVES) {
                        this.game.lives++;
                        this.game.updateUI();
                    }
                }
            }
        }
        
        class Bullet extends GameObject {
            constructor(game, x, y, speedX, speedY, isPlayerBullet = false) {
                super(game, x, y);
                this.speedX = speedX;
                this.speedY = speedY;
                this.isPlayerBullet = isPlayerBullet;
                this.oldX = x; // Store initial position
                this.oldY = y;
                
                this.element = document.createElement('div');
                this.element.className = isPlayerBullet ? 'game-object bullet' : 'game-object enemy-bullet';
                this.game.container.appendChild(this.element);
                
                this.width = this.element.offsetWidth;
                this.height = this.element.offsetHeight;
            }

            update() {
                // Store the current position before moving
                this.oldX = this.x;
                this.oldY = this.y;

                // Move the bullet
                this.x += this.speedX;
                this.y += this.speedY;

                // Destroy if it goes off-screen
                if (this.y < -this.height || this.y > this.game.container.offsetHeight) {
                    this.destroy();
                }
            }
        }
        
        class Enemy extends GameObject {
             constructor(game, targetX, targetY, type) {
                const fromLeft = Math.random() < 0.5;
                super(game, fromLeft ? -100 : game.container.offsetWidth + 100, targetY);
                
                this.type = type;
                const config = CONFIG.ENEMY_TYPES[type];
                this.config = config;
                
                const template = document.getElementById(config.templateId);
                this.element = template.content.firstElementChild.cloneNode(true);
                this.element.className = 'game-object enemy';
                this.element.style.transform = `scale(${config.scale})`;
                this.element.style.width = `${config.baseWidth}px`;
                this.element.style.height = `${config.baseHeight}px`;

                this.game.container.appendChild(this.element);
                
                this.width = config.baseWidth * config.scale;
                this.height = config.baseHeight * config.scale;
                this.targetX = targetX;
                this.targetY = targetY;
                this.isInFormation = false;
            }
            
            update() {
                if (!this.isInFormation) {
                    const dx = this.targetX - this.x;
                    const dy = this.targetY - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 5) {
                        this.isInFormation = true;
                        this.x = this.targetX;
                        this.y = this.targetY;
                    } else {
                        this.x += dx * 0.05;
                        this.y += dy * 0.05;
                    }
                }
            }
            
            shoot() {
                const bullet = new Bullet(this.game, this.x + this.width / 2 - 5, this.y + this.height, 0, CONFIG.ENEMY_BULLET_SPEED, false);
                this.game.gameObjects.push(bullet);
            }
            
            takeDamage(amount) {
                this.destroy();
            }

            destroy() {
                if (this.isDestroyed) return;
                this.game.score += this.config.score;
                this.game.updateUI();
                if (Math.random() < DIFFICULTY_SETTINGS[this.game.difficulty].powerUpSpawnChance) {
                    this.game.spawnPowerUp(this.x, this.y);
                }
                this.game.createExplosion(this.x, this.y);
                super.destroy();
            }
        }
        
        class Boss extends Enemy {
            constructor(game, type, scale, health, yPos, isMainBoss = false) {
                const xPos = game.container.offsetWidth / 2;
                super(game, xPos, yPos, type);
                this.health = health;
                this.maxHealth = health;
                this.isMainBoss = isMainBoss;
                this.isInFormation = true;
                this.canTaunt = true; 
                
                this.element.classList.add('boss');
                this.element.style.transform = `scale(${scale})`;
                this.width = this.config.baseWidth * scale;
                this.height = this.config.baseHeight * scale;
                this.x = xPos - this.width / 2;
                
                this.initialY = yPos;
                this.bobbingAngle = Math.random() * Math.PI * 2;
                this.taunts = this.config.taunts || [];

                this.infoContainer = document.createElement('div');
                this.infoContainer.className = 'boss-info-container';
                
                const nameElement = document.createElement('div');
                nameElement.className = 'boss-name';
                nameElement.innerHTML = `${this.config.displayName}`;
                this.infoContainer.appendChild(nameElement);

                this.healthBarContainer = document.createElement('div');
                this.healthBarContainer.className = 'health-bar-container';
                this.healthBar = document.createElement('div');
                this.healthBar.className = 'health-bar';
                this.healthBarContainer.appendChild(this.healthBar);
                this.infoContainer.appendChild(this.healthBarContainer);
                
                this.game.container.appendChild(this.infoContainer);
                this.updateHealthBar();
            }
            
            update() {
                this.bobbingAngle += 0.02;
                this.y = this.initialY + Math.sin(this.bobbingAngle) * 5;

                this.x += this.game.bossSpeed * this.game.bossDirection;
                if ((this.x + this.width >= this.game.container.offsetWidth && this.game.bossDirection > 0) || (this.x <= 0 && this.game.bossDirection < 0)) {
                    this.game.bossDirection *= -1;
                }
            }

            draw() {
                super.draw();
                if (this.infoContainer) {
                    this.infoContainer.style.left = `${this.x + this.width / 2}px`;
                    this.infoContainer.style.top = `${this.y + this.height + 10}px`;
                }
            }

            takeDamage(amount) {
                soundManager.play('bossHit');
                this.health -= amount;
                this.updateHealthBar();
                this.element.classList.add('hit');
                this.sayTaunt();
                setTimeout(() => this.element.classList.remove('hit'), 100);

                if (Math.random() < DIFFICULTY_SETTINGS[this.game.difficulty].bossPowerUpSpawnChance) {
                    this.game.spawnPowerUp(this.x + this.width / 2, this.y + this.height / 2);
                }

                if (this.health <= 0) {
                    this.handleDefeat();
                }
            }
            
            handleDefeat() {
                soundManager.play('bossDefeat');
                this.game.score += this.isMainBoss ? 500 : 150;
                this.game.updateUI();

                if (this.isMainBoss) {
                    this.game.boss = null;
                    if(this.game.bossShootInterval) clearInterval(this.game.bossShootInterval);
                    this.game.showVictoryScreen();
                } else {
                    this.game.miniBosses = this.game.miniBosses.filter(b => b !== this);
                }
                this.destroy();
            }
            
            sayTaunt() {
                if (!this.canTaunt || this.taunts.length === 0) return;

                this.canTaunt = false; 

                const taunt = this.taunts[Math.floor(Math.random() * this.taunts.length)];
                const bubble = document.createElement('div');
                bubble.className = 'speech-bubble';
                bubble.textContent = taunt;
                
                this.infoContainer.appendChild(bubble);

                setTimeout(() => {
                    if (bubble.parentElement) {
                        bubble.parentElement.removeChild(bubble);
                    }
                    this.canTaunt = true; 
                }, 5000);
            }

            updateHealthBar() {
                 const percentage = (this.health / this.maxHealth) * 100;
                 this.healthBar.style.width = `${Math.max(0, percentage)}%`;
            }

            destroy() {
                if(this.infoContainer && this.infoContainer.parentElement) {
                    this.infoContainer.parentElement.removeChild(this.infoContainer);
                }
                super.destroy();
            }
        }
        
        class PowerUp extends GameObject {
            constructor(game, x, y, type) {
                super(game, x, y);
                this.powerUpType = type;
                this.element = document.createElement('div');
                this.element.className = 'game-object absolute text-3xl animate-bounce';
                this.element.textContent = type.emoji;
                this.game.container.appendChild(this.element);
                this.width = 30;
                this.height = 30;
            }
            
            update() {
                this.y += 2; 
                 if (this.y > this.game.container.offsetHeight) {
                    this.destroy();
                }
            }
        }

        window.onload = () => {
            new Game('game-container');
        };
    </script>
</body>
</html>
