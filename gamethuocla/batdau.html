<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game: Cuộc Chiến Không Khói</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700;900&family=Exo+2:wght@900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            overflow: hidden;
            background-color: #000;
            color: #1E3A8A;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        #intro-container {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }

        /* --- Màn hình tiêu đề --- */
        #title-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1.5s ease-out;
            background-color: #050816; /* Nền vũ trụ sâu thẳm */
            overflow: hidden;
            position: relative;
            height: 100vh;
        }
        
        #stars-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #beacon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 500px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.3) 0%, transparent 70%);
            animation: beacon-pulse 4s infinite ease-in-out;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 1;
        }
        
        #title-content:hover ~ #beacon {
            transform: translate(-50%, -50%) scale(1.5);
        }

        @keyframes beacon-pulse {
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        #title-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }
        
        #game-title {
            font-family: 'Exo 2', sans-serif;
            font-weight: 900;
            font-size: clamp(3rem, 12vw, 7.5rem); 
            color: white;
            text-align: center;
            letter-spacing: 0.05em;
            text-transform: uppercase; 
            animation: title-glow 4s ease-in-out infinite;
            text-shadow: 
                0 0 10px #EC4899, 
                0 0 20px #EC4899, 
                0 0 40px #EC4899, 
                0 0 80px #D946EF;
        }
        
        #game-subtitle {
            font-family: 'Be Vietnam Pro', sans-serif;
            font-weight: 700;
            font-size: clamp(0.8rem, 2.5vw, 1.2rem);
            color: #FBBF24; /* Amber */
            text-shadow: 0 0 8px #F59E0B;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        @keyframes title-glow {
            0%, 100% {
                text-shadow: 0 0 10px #EC4899, 0 0 20px #EC4899, 0 0 40px #EC4899, 0 0 80px #D946EF;
            }
            50% {
                text-shadow: 0 0 5px #f472b6, 0 0 10px #f472b6, 0 0 20px #f472b6, 0 0 40px #e879f9;
            }
        }

        #start-game-btn {
            font-size: 1.8rem; /* Larger font */
            font-weight: 900; /* Bolder */
            color: white;
            background: linear-gradient(45deg, #EC4899, #D946EF);
            padding: 1.2rem 3rem; /* More padding */
            border-radius: 50px;
            border: 3px solid white; /* Thicker border */
            cursor: pointer;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 0 30px rgba(236, 72, 153, 0.7), 0 0 50px rgba(217, 70, 239, 0.5);
            animation: prominent-pulse 2s infinite;
            transition: all 0.3s ease;
        }
        #start-game-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 45px rgba(236, 72, 153, 1), 0 0 70px rgba(217, 70, 239, 0.7);
        }

        #home-link-btn {
            font-size: 1rem;
            font-weight: bold;
            color: #cbd5e1; /* slate-300 */
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        #home-link-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            text-shadow: 0 0 5px white;
        }

        @keyframes prominent-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #flash-overlay {
            position: absolute;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transform: scale(0);
            border-radius: 50%;
            transition: transform 0.5s ease-out, opacity 0.6s ease-out;
        }
        #flash-overlay.active {
            transform: scale(2);
            opacity: 1;
        }
        
        /* --- Cảnh game --- */
        #cutscene-screen {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);
            opacity: 0;
            visibility: hidden;
            transition: opacity 1.5s ease-in, background 2s ease;
        }
        #cutscene-screen.visible {
            opacity: 1;
            visibility: visible;
        }
        #cutscene-screen.darkened {
            background: linear-gradient(180deg, #4A5568 0%, #1A202C 100%);
        }

        .character-container {
            position: absolute;
            bottom: 40%;
            width: 320px;
            transition: all 1.5s cubic-bezier(0.19, 1, 0.22, 1);
            opacity: 0;
            transform: translateY(100px);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #hero-container { 
            bottom: 55%;
            left: 25%;
            transform: translateX(-50%) translateY(100px);
            width: 200px;
        }
        #monster-container { 
            right: 25%;
            transform: translateX(50%) translateY(100px);
        }

        .character-container.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #monster-container.visible {
            opacity: 1;
            transform: translateX(50%) translateY(0);
        }

        /* --- Hộp thoại --- */
        #dialogue-box {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #90E0EF;
            border-radius: 15px;
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.5s ease-out, background 2s ease, border-color 2s ease;
            z-index: 20;
        }
        #dialogue-box.visible {
            opacity: 1;
        }
        #dialogue-box.darkened {
            background: rgba(10, 10, 10, 0.85);
            border-color: #7F1D1D;
        }

        #speaker-name {
            font-family: 'Be Vietnam Pro', sans-serif;
            font-weight: 900;
            font-size: 1.8rem;
            color: #0077B6;
            transition: color 2s ease;
        }
        #dialogue-box.darkened #speaker-name {
            color: #FCA5A5;
        }
        #dialogue-text {
            color: #004D40;
            font-weight: 600;
            font-size: 1.25rem;
            min-height: 3em;
            transition: color 2s ease;
        }
        #dialogue-box.darkened #dialogue-text {
            color: #E5E7EB;
        }
        
        /* --- HIỆU ỨNG KỊCH TÍNH (MỚI) --- */
        .dramatic-text {
            display: inline-block; /* Cần cho transform */
            color: #DC2626; /* red-600 */
            font-weight: 900;
            text-shadow: 0 0 8px #F87171; /* red-400 */
            animation: dramatic-pulse 1s ease-in-out;
        }

        @keyframes dramatic-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        @keyframes screen-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .screen-shake {
            animation: screen-shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }


        /* --- Character Styles --- */
        @keyframes monsterFloat {0%, 100% {transform: translateY(0px) rotate(-1deg);} 33% {transform: translateY(-10px) rotate(1deg);} 66% {transform: translateY(-5px) rotate(-0.5deg);}}
        @keyframes monsterPulse {0%, 100% {transform: scale(1);} 50% {transform: scale(1.02);}}
        @keyframes eyeGlow {0%, 100% {fill: #ff0000; filter: brightness(1);} 100% {fill: #ff4000; filter: brightness(1.5) drop-shadow(0 0 3px #ff0000);}}
        @keyframes smokeRise {0% {opacity: 0.9; transform: translateY(0px) scale(1) rotate(0deg);} 50% {opacity: 0.6; transform: translateY(-8px) scale(1.1) rotate(5deg);} 100% {opacity: 0.2; transform: translateY(-15px) scale(1.3) rotate(10deg);}}
        @keyframes cigaretteBurn {0%, 100% {fill: #ff4000; filter: brightness(1);} 50% {fill: #ff8000; filter: brightness(1.5) drop-shadow(0 0 2px #ff4000);}}
        @keyframes auraFlicker {0%, 100% {opacity: 0.3; transform: scale(1);} 50% {opacity: 0.6; transform: scale(1.05);}}
        @keyframes briefcaseGlow {0%, 100% {filter: brightness(1);} 50% {filter: brightness(1.2) drop-shadow(0 0 2px #ff0000);}}
        @keyframes toxicFloat {0% {opacity: 0; transform: translateY(0px) scale(0);} 25% {opacity: 0.7; transform: translateY(-10px) scale(1);} 50% {opacity: 0.5; transform: translateY(-20px) scale(0.8);} 75% {opacity: 0.3; transform: translateY(-30px) scale(0.6);} 100% {opacity: 0; transform: translateY(-40px) scale(0);}}
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-15px) rotate(2deg); } }
        @keyframes glow { 0%, 100% { filter: brightness(1) drop-shadow(0 0 10px currentColor); } 50% { filter: brightness(1.2) drop-shadow(0 0 20px currentColor); } }
        @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } }
        .float { animation: float 4s ease-in-out infinite; }
        .glow { animation: glow 3s ease-in-out infinite; }
        .sparkle { animation: sparkle 2s ease-in-out infinite; }
        .nicotine-monster-inner { width: 100%; height: 100%; animation: monsterFloat 3s ease-in-out infinite; filter: drop-shadow(0 0 20px #ff0000) drop-shadow(0 0 40px #800000); }
   
        /* --- POPUP KẾT THÚC HỘI THOẠI --- */
        #end-dialogue-popup {
            position: absolute;
            inset: 0;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        .popup-button {
            transition: all 0.2s ease-in-out;
        }
        .popup-button:hover {
            transform: scale(1.05);
        }
        #continue-btn {
            animation: prominent-pulse 2s infinite;
            box-shadow: 0 0 25px #10B981, 0 0 40px #10B981;
        }
        
        /* --- Fullscreen Container --- */
        #fullscreen-container {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
    </style>
</head>
<body>
    
    <!-- NÚT TOÀN MÀN HÌNH VÀ THÔNG BÁO -->
    <div id="fullscreen-container">
        <p class="text-yellow-400 font-semibold text-sm uppercase tracking-wider animate-pulse hidden md:block" style="text-shadow: 0 0 5px #fbbd24;">
            Bấm vào đây để có trải nghiệm tốt nhất
        </p>
        <button id="fullscreen-btn" title="Toàn màn hình" class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-full w-12 h-12 flex items-center justify-center text-white hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <svg id="icon-fullscreen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4m-4-4l5-5m11 5v-4m0 0h-4m4 4l-5-5" />
            </svg>
            <svg id="icon-exit-fullscreen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

<div id="intro-container">
    <!-- SVG Definitions for Characters -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <radialGradient id="auraGradient" cx="50%" cy="50%" r="80%"><stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.1" /><stop offset="50%" style="stop-color:#800000;stop-opacity:0.3" /><stop offset="100%" style="stop-color:#000000;stop-opacity:0.5" /></radialGradient>
            <linearGradient id="suitGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#1a1a1a;stop-opacity:1" /><stop offset="50%" style="stop-color:#000000;stop-opacity:1" /><stop offset="100%" style="stop-color:#330000;stop-opacity:1" /></linearGradient>
            <linearGradient id="redGlowGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.8" /><stop offset="50%" style="stop-color:#cc0000;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#800000;stop-opacity:0.4" /></linearGradient>
            <linearGradient id="smokeGradient" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" style="stop-color:#666666;stop-opacity:0.9" /><stop offset="50%" style="stop-color:#999999;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#cccccc;stop-opacity:0.3" /></linearGradient>
        </defs>
    </svg>

    <!-- MÀN HÌNH TIÊU ĐỀ -->
    <div id="title-screen" class="absolute inset-0 z-20">
        <canvas id="stars-canvas"></canvas>
        <div id="beacon"></div>
        <div id="title-content">
            <h1 id="game-title" class="mb-2">Cuộc Chiến Không Khói</h1>
            <h2 id="game-subtitle">Ý Chí Là Vũ Khí Của Bạn</h2>
            <div id="start-screen-buttons" class="mt-12 flex flex-col items-center space-y-4">
                 <button id="start-game-btn">Bắt Đầu</button>
                 <a href="index.html" id="home-link-btn">Về màn hình chính</a>
            </div>
        </div>
        <div id="flash-overlay"></div>
    </div>

    <!-- CẢNH TRONG GAME -->
    <div id="cutscene-screen" class="z-10">
        <div id="hero-container" class="character-container">
            <div class="float"><div class="relative"><div class="absolute -inset-8 bg-gradient-to-r from-yellow-400/40 via-yellow-300/50 to-yellow-400/40 rounded-full glow"></div><div class="absolute -inset-6 bg-gradient-to-r from-yellow-200/30 via-yellow-100/40 to-yellow-200/30 rounded-full sparkle"></div><div class="absolute -inset-4 bg-gradient-to-r from-yellow-300/20 via-yellow-200/30 to-yellow-300/20 rounded-full glow"></div><div class="absolute -right-8 top-2 w-16 h-24 bg-gradient-to-b from-red-500 via-red-600 to-red-800 rounded-b-3xl transform rotate-20 glow shadow-2xl border-2 border-red-400 float"><div class="absolute -right-2 top-4 w-4 h-16 bg-red-600 rounded-r-2xl transform rotate-12 opacity-80"></div><div class="absolute -right-1 top-8 w-2 h-12 bg-red-700 rounded-r-xl transform rotate-6 opacity-60"></div></div><div class="w-20 h-28 bg-gradient-to-b from-blue-400 via-blue-600 to-blue-800 rounded-2xl relative shadow-2xl border-2 border-blue-300"><div class="absolute -top-8 left-2 w-16 h-16 bg-gradient-to-b from-orange-100 to-orange-200 rounded-full border-4 border-yellow-500 shadow-2xl"><div class="absolute top-3 left-1 w-14 h-6 bg-black rounded-full border-2 border-gray-700"><div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 left-1"></div><div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 right-1"></div><div class="w-2 h-1 bg-gray-600 absolute top-2 left-1/2 transform -translate-x-1/2"></div></div><div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-8 h-3 border-b-2 border-black rounded-full"></div><div class="absolute -top-3 left-1 w-14 h-6 bg-gradient-to-r from-amber-700 to-amber-900 rounded-t-full shadow-lg"></div></div><div class="absolute top-6 left-1/2 transform -translate-x-1/2 w-10 h-10 bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 rounded-full border-2 border-yellow-600 glow shadow-xl"><div class="absolute top-1 left-1 w-8 h-8 bg-gradient-to-r from-yellow-200 to-yellow-300 rounded-full"><span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-lg font-black text-blue-900" style="font-family: 'Nunito', sans-serif;">M</span></div></div><div class="absolute -left-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div><div class="absolute -right-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div><div class="absolute bottom-0 left-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div><div class="absolute bottom-0 right-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div><div class="absolute -bottom-2 left-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div><div class="absolute -bottom-2 right-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div></div></div></div>
        </div>
        <div id="monster-container" class="character-container">
            <div class="nicotine-monster-inner"><svg class="w-full h-full" viewBox="0 0 80 80"><ellipse fill="url(#auraGradient)" cx="40" cy="40" rx="38" ry="35" style="animation: auraFlicker 2s ease-in-out infinite;"/><g transform="translate(15, 45)" style="animation: briefcaseGlow 2s ease-in-out infinite;"><rect fill="#1a1a1a" stroke="#ff0000" stroke-width="0.5" x="0" y="0" width="8" height="6" rx="1"/><rect fill="#ff0000" x="1" y="1" width="6" height="1" opacity="0.6"/><circle fill="#ff0000" cx="7" cy="3" r="0.5"/></g><ellipse fill="url(#suitGradient)" stroke="url(#redGlowGradient)" stroke-width="1" cx="40" cy="45" rx="12" ry="18" style="animation: monsterPulse 2s ease-in-out infinite;"/><path fill="#000000" stroke="#ff0000" stroke-width="0.3" d="M32,35 L35,40 L40,38 L45,40 L48,35 L45,32 L35,32 Z"/><path fill="#cc0000" stroke="#ff0000" stroke-width="0.5" d="M38,38 L42,38 L41,50 L39,50 Z"/><circle fill="#ff0000" cx="40" cy="42" r="0.8"/><circle fill="#ff0000" cx="40" cy="46" r="0.8"/><circle fill="#ff0000" cx="40" cy="50" r="0.8"/><polygon fill="#ff0000" points="28,35 30,30 32,35"/><polygon fill="#ff0000" points="48,35 50,30 52,35"/><polygon fill="#ff0000" points="26,38 28,33 30,38"/><polygon fill="#ff0000" points="50,38 52,33 54,38"/><ellipse fill="#d0d0d0" stroke="#999999" stroke-width="0.5" cx="40" cy="25" rx="10" ry="12" style="animation: monsterPulse 2.5s ease-in-out infinite;"/><path fill="#1a1a1a" stroke="#000000" stroke-width="0.3" d="M30,18 Q40,15 50,18 Q48,22 45,20 Q40,19 35,20 Q32,22 30,18"/><polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="33,18 35,10 37,18"/><polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="43,18 45,10 47,18"/><ellipse fill="#ff0000" cx="36" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"/><ellipse fill="#ff0000" cx="44" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"/><ellipse fill="#000000" cx="36" cy="23" rx="0.8" ry="1"/><ellipse fill="#000000" cx="44" cy="23" rx="0.8" ry="1"/><circle fill="#ffff00" cx="35" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite;"/><circle fill="#ffff00" cx="45" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite; animation-delay: 0.5s;"/><path fill="#000000" d="M34,28 Q40,32 46,28 Q40,30 34,28" opacity="0.9"/><polygon fill="#ffffff" points="36,28 37,30 38,28"/><polygon fill="#ffffff" points="39,28 40,31 41,28"/><polygon fill="#ffffff" points="42,28 43,30 44,28"/><rect fill="#f5f5dc" x="46" y="26" width="6" height="1" rx="0.5"/><rect fill="#d2691e" x="46" y="26.2" width="5" height="0.6" rx="0.3"/><circle fill="#ff4000" cx="52" cy="26.5" r="0.8" style="animation: cigaretteBurn 1s ease-in-out infinite;"/><circle fill="#ff8000" cx="52" cy="26.5" r="0.4" style="animation: cigaretteBurn 1s ease-in-out infinite; animation-delay: 0.3s;"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="1.5" stroke-linecap="round" d="M52,26 Q55,22 53,18 Q56,15 54,12" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0s;"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="1.2" stroke-linecap="round" d="M52,26 Q57,23 55,19 Q58,16 56,13" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0.5s;"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="1" stroke-linecap="round" d="M52,26 Q54,24 52,20 Q55,17 53,14" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 1s;"/><ellipse fill="#333333" cx="38" cy="25" rx="0.5" ry="0.3"/><ellipse fill="#333333" cx="42" cy="25" rx="0.5" ry="0.3"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M38,25 Q36,22 38,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.3s;"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M42,25 Q44,22 42,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.8s;"/><circle fill="#00ff00" cx="25" cy="15" r="0.8" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0s;"/><circle fill="#00ff00" cx="55" cy="20" r="0.6" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 1s;"/><circle fill="#00ff00" cx="20" cy="35" r="0.7" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 2s;"/><circle fill="#00ff00" cx="60" cy="30" r="0.5" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0.5s;"/><path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M20,20 Q25,15 30,20" style="animation: auraFlicker 1.8s ease-in-out infinite;"/><path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M50,20 Q55,15 60,20" style="animation: auraFlicker 1.8s ease-in-out infinite; animation-delay: 0.6s;"/><path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M15,40 Q20,35 25,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.3s;"/><path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M55,40 Q60,35 65,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.9s;"/></svg>
            </div>
        </div>
        
        <!-- Hộp thoại -->
        <div id="dialogue-box">
            <h3 id="speaker-name"></h3>
            <p id="dialogue-text"></p>
        </div>
    </div>
</div>

<!-- POPUP LỰA CHỌN -->
<div id="end-dialogue-popup" class="flex-col items-center justify-center text-white text-center p-8" style="display: none; opacity: 0; transition: opacity 0.5s ease-in;">
    <div class="bg-gray-800/90 border-2 border-blue-400 rounded-2xl p-8 max-w-md w-full shadow-2xl">
        <h1 class="text-3xl font-bold mb-6 text-yellow-300" style="font-family: 'Exo 2', sans-serif;">Hành trình bắt đầu!</h1>
        <div class="space-y-4">
            <button id="continue-btn" class="popup-button w-full text-xl font-bold bg-gradient-to-r from-green-400 to-emerald-600 text-white py-4 px-6 rounded-lg border-2 border-green-200">
                Tiếp tục
            </button>
             <button id="replay-btn" class="popup-button w-full font-bold bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg border border-blue-300">
                Xem lại hội thoại
            </button>
            <button id="home-btn" class="popup-button w-full font-bold bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-lg border border-gray-400">
                Quay về trang chủ
            </button>
        </div>
    </div>
</div>


<script>
    // --- Fullscreen Logic ---
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const iconFullscreen = document.getElementById('icon-fullscreen');
    const iconExitFullscreen = document.getElementById('icon-exit-fullscreen');
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        document.addEventListener('fullscreenchange', updateFullscreenIcons);
        document.addEventListener('webkitfullscreenchange', updateFullscreenIcons);
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
            document.documentElement.requestFullscreen?.().catch(err => console.warn(`Error enabling full-screen: ${err.message}`));
        } else {
            document.exitFullscreen?.().catch(err => console.warn(`Error exiting full-screen: ${err.message}`));
        }
    }
    
    function updateFullscreenIcons() {
        const isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement;
        if(iconFullscreen) iconFullscreen.classList.toggle('hidden', isFullscreen);
        if(iconExitFullscreen) iconExitFullscreen.classList.toggle('hidden', !isFullscreen);
    }

    // --- DOM Element References ---
    const introContainer = document.getElementById('intro-container');
    const titleScreen = document.getElementById('title-screen');
    const startGameBtn = document.getElementById('start-game-btn');
    const cutsceneScreen = document.getElementById('cutscene-screen');
    const dialogueBox = document.getElementById('dialogue-box');
    const speakerName = document.getElementById('speaker-name');
    const dialogueText = document.getElementById('dialogue-text');
    const hero = document.getElementById('hero-container');
    const monster = document.getElementById('monster-container');
    const flashOverlay = document.getElementById('flash-overlay');
    const endDialoguePopup = document.getElementById('end-dialogue-popup');
    const replayBtn = document.getElementById('replay-btn');
    const homeBtn = document.getElementById('home-btn');
    const continueBtn = document.getElementById('continue-btn');


    // --- Starfield Animation ---
    const starsCanvas = document.getElementById('stars-canvas');
    if (starsCanvas) {
        const ctx = starsCanvas.getContext('2d');
        let stars = [];
        let mouse = { x: undefined, y: undefined };
        const numStars = window.innerWidth > 768 ? 250 : 100;
        const colors = ['#FFFFFF', '#FBBF24', '#F472B6'];

        function resizeCanvas() {
            starsCanvas.width = window.innerWidth;
            starsCanvas.height = window.innerHeight;
        }

        window.addEventListener('resize', () => {
            resizeCanvas();
            initStars();
        });
        window.addEventListener('mousemove', (e) => {
            mouse.x = e.x;
            mouse.y = e.y;
        });
        window.addEventListener('mouseout', () => {
            mouse.x = undefined;
            mouse.y = undefined;
        });

        class Star {
            constructor(x, y, radius, color) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.color = color;
                this.baseX = this.x;
                this.baseY = this.y;
                this.density = (Math.random() * 20) + 5;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                ctx.fillStyle = this.color;
                ctx.fill();
            }

            update() {
                if (mouse.x !== undefined && mouse.y !== undefined) {
                    let dx = mouse.x - this.x;
                    let dy = mouse.y - this.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    let forceDirectionX = dx / distance;
                    let forceDirectionY = dy / distance;
                    let maxDistance = 150;
                    let force = (maxDistance - distance) / maxDistance;

                    if (distance < maxDistance) {
                        this.x -= forceDirectionX * this.density * 0.5;
                        this.y -= forceDirectionY * this.density * 0.5;
                    } else {
                        if (this.x !== this.baseX) { this.x -= (this.x - this.baseX) / 10; }
                        if (this.y !== this.baseY) { this.y -= (this.y - this.baseY) / 10; }
                    }
                } else {
                    if (this.x !== this.baseX) { this.x -= (this.x - this.baseX) / 10; }
                    if (this.y !== this.baseY) { this.y -= (this.y - this.baseY) / 10; }
                }
                this.draw();
            }
        }

        function initStars() {
            stars = [];
            for (let i = 0; i < numStars; i++) {
                let radius = Math.random() * 1.5 + 0.5;
                let x = Math.random() * starsCanvas.width;
                let y = Math.random() * starsCanvas.height;
                let color = colors[Math.floor(Math.random() * colors.length)];
                stars.push(new Star(x, y, radius, color));
            }
        }

        function animateStars() {
            requestAnimationFrame(animateStars);
            ctx.clearRect(0, 0, starsCanvas.width, starsCanvas.height);
            for (let i = 0; i < stars.length; i++) {
                stars[i].update();
            }
        }

        resizeCanvas();
        initStars();
        animateStars();
    }


    // --- Audio Manager ---
    const AudioManager = {
        isInitialized: false, sounds: {}, music: {},
        async init() {
            if (this.isInitialized) return;
            await Tone.start();
            this.sounds.click = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.2 }, volume: -10 }).toDestination();
            this.sounds.roar = new Tone.MonoSynth({ oscillator: { type: "sawtooth" }, filter: { Q: 2, type: "lowpass", rolloff: -24 }, envelope: { attack: 0.1, decay: 0.4, sustain: 0.1, release: 1 }, filterEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 1, baseFrequency: 80, octaves: 4 }, volume: -6 }).toDestination();
            this.sounds.heroChime = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.2, release: 0.5 }, volume: -8 }).toDestination();
            this.sounds.type = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.0006, decay: 0.2, sustain: 0 } }).toDestination();
            this.sounds.type.volume.value = -12;

            this.music.peaceful = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "fatsine" }, envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 1 } }).toDestination();
            this.music.peaceful.volume.value = -24;
            this.music.tense = new Tone.AMSynth({ harmonicity: 1.5, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 1, sustain: 0.1, release: 2 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.5, decay: 0.01, sustain: 1, release: 0.5 } }).toDestination();
            this.music.tense.volume.value = -18;
            this.isInitialized = true;
        },
        playSound(name) {
            if (!this.isInitialized) return;
            const now = Tone.now();
            if (name === 'click') this.sounds.click.triggerAttackRelease('G4', '8n', now);
            if (name === 'roar') this.sounds.roar.triggerAttackRelease('C2', '1s', now);
            if (name === 'heroChime') this.sounds.heroChime.triggerAttackRelease('G5', '2n', now);
            if (name === 'type') this.sounds.type.triggerAttackRelease('C2', '32n', now);
        },
        playMusic(mood) {
            if (!this.isInitialized) return;
            Tone.Transport.cancel();
            if (mood === 'peaceful') {
                new Tone.Sequence((time, note) => { this.music.peaceful.triggerAttackRelease(note, '1n', time); }, ['C4', 'G4', 'E4', 'A4'], '1m').start(0);
            }
            if (mood === 'tense') {
                new Tone.Loop(time => { this.music.tense.triggerAttackRelease("C1", "1n", time); }, "2n").start(0);
            }
            Tone.Transport.start();
        },
        stopMusic() {
            if (!this.isInitialized) return;
            Tone.Transport.stop();
        }
    };

    // --- Game Logic ---
    const introScript = [
        { speaker: "Người dẫn chuyện", line: "Bên trong bạn là một Thành Phố Cơ Thể kỳ diệu, nơi sự sống không ngừng vận hành..." },
        { speaker: "Người dẫn chuyện", line: "Nhưng một *bóng ma* thuốc lá... đang âm thầm xâm chiếm, đe dọa sự bình yên này.", action: 'showThreat' },
        { speaker: "Quái Vật Thuốc Lá", line: "Ha ha ha! Sức mạnh của Nicotine là *bất khả chiến bại*! Các ngươi sẽ sớm là của ta!" },
        { speaker: "Lá Phổi", line: "*Ho... ho... Cứu*... chúng tôi đang *nghẹt thở*... trong làn khói độc này!", action: 'cryForHelp' },
        { speaker: "Minh", line: "Ta nghe thấy lời kêu cứu của các bạn!", action: 'heroAppear' },
        { speaker: "Minh", line: "Đừng sợ! *Ý CHÍ* của bạn sẽ không bao giờ lùi bước!" },
        { speaker: "Người dẫn chuyện", line: "Giờ đây, bạn chính là *Minh* - anh hùng đại diện cho ý chí. Hãy bắt đầu hành trình khám phá Thành Phố Cơ Thể, và đẩy lùi vĩnh viễn *khói thuốc độc hại*!", action: 'startExploration' }
    ];

    let currentLine = 0;

    function triggerScreenShake() {
        introContainer.classList.add('screen-shake');
        setTimeout(() => {
            introContainer.classList.remove('screen-shake');
        }, 500);
    }

    function typeWriter(text, i, onCompleteCallback) {
        if (i < text.length) {
            const char = text[i];
            if (char === '<') {
                const closingTagIndex = text.indexOf('>', i);
                if (closingTagIndex !== -1) {
                    const tag = text.substring(i, closingTagIndex + 1);
                    const currentContent = dialogueText.innerHTML.replace('<span class="animate-ping">_</span>', '');
                    dialogueText.innerHTML = currentContent + tag + '<span class="animate-ping">_</span>';
                    setTimeout(() => typeWriter(text, closingTagIndex + 1, onCompleteCallback), 50);
                    return;
                }
            }
            
            if (char !== ' ') {
                 AudioManager.playSound('type');
            }
           
            const currentContent = dialogueText.innerHTML.replace('<span class="animate-ping">_</span>', '');
            dialogueText.innerHTML = currentContent + char + '<span class="animate-ping">_</span>';
            setTimeout(() => typeWriter(text, i + 1, onCompleteCallback), 60);
        } else {
            dialogueText.innerHTML = text;
            if (onCompleteCallback) {
                onCompleteCallback();
            }
        }
    }

    function showNextLine() {
        if (currentLine >= introScript.length) return;
        const scene = introScript[currentLine];
        
        if (scene.action) {
            switch (scene.action) {
                case 'showThreat':
                    cutsceneScreen.classList.add('darkened');
                    dialogueBox.classList.add('darkened');
                    AudioManager.playMusic('tense');
                    monster.classList.add('visible');
                    AudioManager.playSound('roar');
                    triggerScreenShake();
                    break;
                case 'heroAppear':
                    if (!hero.classList.contains('visible')) {
                        hero.classList.add('visible');
                        AudioManager.playSound('heroChime');
                    }
                    break;
            }
        }

        const processedLine = scene.line.replace(/\*(.*?)\*/g, '<span class="dramatic-text">$1</span>');
        speakerName.textContent = scene.speaker;
        dialogueText.innerHTML = '';

        let onTypingComplete;

        if (scene.action === 'startExploration') {
            onTypingComplete = () => {
                setTimeout(() => {
                    endDialoguePopup.style.display = 'flex';
                    setTimeout(() => {
                       endDialoguePopup.style.opacity = '1';
                    }, 50);
                }, 1500); 
            };
        } else {
            onTypingComplete = () => {
                setTimeout(showNextLine, 3500);
            };
        }

        typeWriter(processedLine, 0, onTypingComplete);
        currentLine++;
    }

    function resetCutscene() {
        currentLine = 0;
        hero.classList.remove('visible');
        monster.classList.remove('visible');
        cutsceneScreen.classList.remove('darkened');
        dialogueBox.classList.remove('darkened');
        AudioManager.playMusic('peaceful');
        
        endDialoguePopup.style.opacity = '0';
        setTimeout(() => {
            endDialoguePopup.style.display = 'none';
            showNextLine();
        }, 500);
    }

    // --- Event Listeners ---
    startGameBtn.addEventListener('click', async () => {
        await AudioManager.init();
        AudioManager.playSound('click');
        flashOverlay.classList.add('active');
        setTimeout(() => {
            titleScreen.style.opacity = '0';
            setTimeout(() => { 
                titleScreen.style.display = 'none'; 
                flashOverlay.style.opacity = '0';
            }, 600);
        }, 500);
        setTimeout(() => {
            cutsceneScreen.classList.add('visible');
            AudioManager.playMusic('peaceful');
            dialogueBox.classList.add('visible');
            showNextLine();
        }, 1200);
    });

    replayBtn.addEventListener('click', () => {
        AudioManager.playSound('click');
        resetCutscene();
    });

    homeBtn.addEventListener('click', () => {
        AudioManager.playSound('click');
        window.location.href = 'index.html';
    });

    continueBtn.addEventListener('click', () => {
        AudioManager.playSound('click');
        window.location.href = 'khampha.html';
    });

</script>
</body>
</html>
