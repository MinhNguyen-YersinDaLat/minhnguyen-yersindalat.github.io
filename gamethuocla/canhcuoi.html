<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game: Cảnh Kết</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700;900&family=Metal+Mania&display=swap" rel="stylesheet">

    <style>
        :root {
            --glow-color: #FBBF24; 
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #022a4b 0%, #005792 50%, #008ac5 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }
        
        #fireworks-canvas {
            position: fixed;
            inset: 0;
            z-index: 199;
            pointer-events: none;
        }

        /* --- Bố cục chính --- */
        .main-wrapper {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 40px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 20px 350px 20px; 
            transition: opacity 0.5s ease-out;
        }

        .character-side-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            transition: opacity 0.5s ease-in-out;
            min-height: 450px;
        }
        
        /* --- Màn hình chính của cảnh chuyển tiếp --- */
        #cutscene-screen {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            z-index: 200;
            transition: opacity 1s ease-in-out;
            opacity: 0; /* Bắt đầu với trạng thái mờ */
        }
        
        .cutscene-character {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 1s ease-in-out;
            opacity: 0;
            transform: scale(0.9);
            visibility: hidden;
        }

        .cutscene-character.visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }
        
        .cutscene-character.vanishing {
            opacity: 0;
            transform: scale(1.2) rotate(20deg);
            filter: brightness(3) blur(10px);
        }

        /* --- Hộp thoại --- */
        #dialogue-box {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            width: 90%;
            max-width: 600px;
            z-index: 210;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 2px solid var(--glow-color);
            border-radius: 15px;
            padding: 1.5rem 2rem;
            text-align: center;
            opacity: 0;
            transform: translate(-50%, 20px);
            box-shadow: 0 0 25px var(--glow-color);
            transition: all 0.5s ease-out;
        }

        #dialogue-box.visible {
            opacity: 1;
            transform: translateX(-50%);
        }
        
        #dialogue-box.final-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s;
        }
        
        #dialogue-box.final-popup.visible {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        #dialogue-text {
            color: #F1F5F9; /* Off-white */
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            font-size: 1.25rem;
            line-height: 1.6;
            min-height: 100px;
        }
        
        /* --- HIỆU ỨNG CHỮ CHIẾN THẮNG --- */
        #dialogue-text.victory-title {
            color: #FFFFFF;
            text-shadow: 0px 0px 15px rgba(0, 0, 0, 1), 0px 0px 5px rgba(0, 0, 0, 1);
            background: none;
            font-size: 2.2rem;
            font-weight: 900;
            line-height: 1.4;
            min-height: auto; /* Điều chỉnh chiều cao cho popup cuối */
            margin-bottom: 1.5rem; /* Thêm khoảng cách với các nút */
        }

        .victory-letter {
            display: inline-block;
            position: relative;
            animation: jump 2s infinite;
            animation-timing-function: cubic-bezier(0.45, 0, 0.55, 1);
        }

        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        #speaker-name {
            font-family: 'Metal Mania', cursive;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #FDE047; /* Bright yellow */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        
        #next-btn {
            margin-top: 1rem;
            padding: 0.5rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            color: #FFFFFF;
            background: linear-gradient(45deg, #0077B6, #00B4D8);
            border: 1px solid #90E0EF;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 180, 216, 0.4);
        }
        #next-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 180, 216, 0.5);
        }

        /* --- Các nút lựa chọn cuối cùng --- */
        #final-options-container.hidden {
            display: none;
        }
        .final-option-btn {
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            font-weight: bold;
            color: #FFFFFF;
            background: linear-gradient(45deg, #0077B6, #00B4D8);
            border: 1px solid #90E0EF;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 180, 216, 0.4);
            text-decoration: none;
            display: inline-block;
        }
        .final-option-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 180, 216, 0.5);
        }
        .final-option-btn.highlighted {
            background: linear-gradient(45deg, #34D399, #A7F3D0);
            color: #0F172A;
            box-shadow: 0 0 20px #34D399;
            border-color: #6EE7B7;
            transform: scale(1.05); /* Làm nổi bật hơn một chút */
        }
         .final-option-btn.highlighted:hover {
             transform: scale(1.1);
         }


        /* --- Y NGUYÊN HIỆU ỨNG NHÂN VẬT --- */
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-15px) rotate(2deg); } }
        @keyframes glow { 0%, 100% { filter: brightness(1) drop-shadow(0 0 10px currentColor); } 50% { filter: brightness(1.2) drop-shadow(0 0 20px currentColor); } }
        @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } }
        .float { animation: float 4s ease-in-out infinite; }
        .glow { animation: glow 3s ease-in-out infinite; }
        .sparkle { animation: sparkle 2s ease-in-out infinite; }

        #nicotine-visual { width: 320px; position: relative; }
        .nicotine-monster-inner { width: 100%; height: 100%; animation: monsterFloat 3s ease-in-out infinite; filter: drop-shadow(0 0 20px #ff0000) drop-shadow(0 0 40px #800000); }
        @keyframes monsterFloat {0%, 100% {transform: translateY(0px) rotate(-1deg);} 33% {transform: translateY(-10px) rotate(1deg);} 66% {transform: translateY(-5px) rotate(-0.5deg);}}
        @keyframes monsterPulse {0%, 100% {transform: scale(1);} 50% {transform: scale(1.02);}}
        @keyframes eyeGlow {0% {fill: #ff0000; filter: brightness(1);} 100% {fill: #ff4000; filter: brightness(1.5) drop-shadow(0 0 3px #ff0000);}}
        @keyframes smokeRise {0% {opacity: 0.9; transform: translateY(0px) scale(1) rotate(0deg);} 50% {opacity: 0.6; transform: translateY(-8px) scale(1.1) rotate(5deg);} 100% {opacity: 0.2; transform: translateY(-15px) scale(1.3) rotate(10deg);}}
        @keyframes cigaretteBurn {0%, 100% {fill: #ff4000; filter: brightness(1);} 50% {fill: #ff8000; filter: brightness(1.5) drop-shadow(0 0 2px #ff4000);}}
        @keyframes auraFlicker {0%, 100% {opacity: 0.3; transform: scale(1);} 50% {opacity: 0.6; transform: scale(1.05);}}
        @keyframes briefcaseGlow {0%, 100% {filter: brightness(1);} 50% {filter: brightness(1.2) drop-shadow(0 0 2px #ff0000);}}
        @keyframes toxicFloat {0% {opacity: 0; transform: translateY(0px) scale(0);} 25% {opacity: 0.7; transform: translateY(-10px) scale(1);} 50% {opacity: 0.5; transform: translateY(-20px) scale(0.8);} 75% {opacity: 0.3; transform: translateY(-30px) scale(0.6);} 100% {opacity: 0; transform: translateY(-40px) scale(0);}}
        
        /* --- Fullscreen Container --- */
        #fullscreen-container {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
    </style>
</head>
<body>
    
    <!-- NÚT TOÀN MÀN HÌNH VÀ THÔNG BÁO -->
    <div id="fullscreen-container">
        <p class="text-yellow-400 font-semibold text-sm uppercase tracking-wider animate-pulse hidden md:block" style="text-shadow: 0 0 5px #fbbd24;">
            Bấm vào đây để có trải nghiệm tốt nhất
        </p>
        <button id="fullscreen-btn" title="Toàn màn hình" class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-full w-12 h-12 flex items-center justify-center text-white hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <svg id="icon-fullscreen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4m-4-4l5-5m11 5v-4m0 0h-4m4 4l-5-5" />
            </svg>
            <svg id="icon-exit-fullscreen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

<!-- SVG Definitions -->
<svg width="0" height="0" style="position:absolute">
    <defs>
        <radialGradient id="auraGradient" cx="50%" cy="50%" r="80%"><stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.1" /><stop offset="50%" style="stop-color:#800000;stop-opacity:0.3" /><stop offset="100%" style="stop-color:#000000;stop-opacity:0.5" /></radialGradient>
        <linearGradient id="suitGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#1a1a1a;stop-opacity:1" /><stop offset="50%" style="stop-color:#000000;stop-opacity:1" /><stop offset="100%" style="stop-color:#330000;stop-opacity:1" /></linearGradient>
        <linearGradient id="redGlowGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.8" /><stop offset="50%" style="stop-color:#cc0000;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#800000;stop-opacity:0.4" /></linearGradient>
        <linearGradient id="smokeGradient" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" style="stop-color:#666666;stop-opacity:0.9" /><stop offset="50%" style="stop-color:#999999;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#cccccc;stop-opacity:0.3" /></linearGradient>
    </defs>
</svg>

<canvas id="fireworks-canvas"></canvas>

<!-- Màn hình diễn ra cảnh chuyển tiếp -->
<div id="cutscene-screen">
    <div class="main-wrapper">
        <!-- Anh hùng Minh -->
        <div class="character-side-container">
            <div id="hero-container" class="cutscene-character">
                <div class="float">
                    <div class="relative">
                        <div class="absolute -inset-8 bg-gradient-to-r from-yellow-400/40 via-yellow-300/50 to-yellow-400/40 rounded-full glow"></div>
                        <div class="absolute -inset-6 bg-gradient-to-r from-yellow-200/30 via-yellow-100/40 to-yellow-200/30 rounded-full sparkle"></div>
                        <div class="absolute -inset-4 bg-gradient-to-r from-yellow-300/20 via-yellow-200/30 to-yellow-300/20 rounded-full glow"></div>
                        <div class="absolute -right-8 top-2 w-16 h-24 bg-gradient-to-b from-red-500 via-red-600 to-red-800 rounded-b-3xl transform rotate-20 glow shadow-2xl border-2 border-red-400 float">
                            <div class="absolute -right-2 top-4 w-4 h-16 bg-red-600 rounded-r-2xl transform rotate-12 opacity-80"></div>
                            <div class="absolute -right-1 top-8 w-2 h-12 bg-red-700 rounded-r-xl transform rotate-6 opacity-60"></div>
                        </div>
                        <div class="w-20 h-28 bg-gradient-to-b from-blue-400 via-blue-600 to-blue-800 rounded-2xl relative shadow-2xl border-2 border-blue-300">
                            <div class="absolute -top-8 left-2 w-16 h-16 bg-gradient-to-b from-orange-100 to-orange-200 rounded-full border-4 border-yellow-500 shadow-2xl">
                                <div class="absolute top-3 left-1 w-14 h-6 bg-black rounded-full border-2 border-gray-700"><div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 left-1"></div><div class="w-5 h-4 bg-blue-900 rounded-full absolute top-1 right-1"></div><div class="w-2 h-1 bg-gray-600 absolute top-2 left-1/2 transform -translate-x-1/2"></div></div>
                                <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-8 h-3 border-b-2 border-black rounded-full"></div>
                                <div class="absolute -top-3 left-1 w-14 h-6 bg-gradient-to-r from-amber-700 to-amber-900 rounded-t-full shadow-lg"></div>
                            </div>
                            <div class="absolute top-6 left-1/2 transform -translate-x-1/2 w-10 h-10 bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 rounded-full border-2 border-yellow-600 glow shadow-xl"><div class="absolute top-1 left-1 w-8 h-8 bg-gradient-to-r from-yellow-200 to-yellow-300 rounded-full"><span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-lg font-black text-blue-900" style="font-family: 'Nunito', sans-serif;">M</span></div></div>
                            <div class="absolute -left-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div>
                            <div class="absolute -right-4 top-8 w-6 h-12 bg-gradient-to-b from-blue-400 to-blue-700 rounded-full shadow-xl border border-blue-300"></div>
                            <div class="absolute bottom-0 left-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div>
                            <div class="absolute bottom-0 right-2 w-6 h-16 bg-gradient-to-b from-blue-500 to-blue-800 rounded-b-full shadow-xl border border-blue-400"></div>
                            <div class="absolute -bottom-2 left-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div>
                            <div class="absolute -bottom-2 right-1 w-8 h-5 bg-gradient-to-r from-yellow-500 to-yellow-700 rounded-full shadow-xl border-2 border-yellow-400"></div>
                        </div>
                    </div>
                </div>
                <p class="text-lg font-bold text-cyan-300 mt-4" style="text-shadow: 0 0 8px #00ffff;">Anh hùng Minh</p>
            </div>
        </div>
        
        <!-- Placeholder để giữ bố cục -->
        <div style="flex:2; max-width: 600px;"></div>

        <!-- Quái vật -->
        <div class="character-side-container">
            <div id="nicotine-container" class="cutscene-character">
                <div id="nicotine-visual">
                    <div class="nicotine-monster-inner">
                        <svg class="w-full h-full" viewBox="0 0 80 80">
                            <ellipse fill="url(#auraGradient)" cx="40" cy="40" rx="38" ry="35" style="animation: auraFlicker 2s ease-in-out infinite;"/><g transform="translate(15, 45)" style="animation: briefcaseGlow 2s ease-in-out infinite;"><rect fill="#1a1a1a" stroke="#ff0000" stroke-width="0.5" x="0" y="0" width="8" height="6" rx="1"/><rect fill="#ff0000" x="1" y="1" width="6" height="1" opacity="0.6"/><circle fill="#ff0000" cx="7" cy="3" r="0.5"/></g><ellipse fill="url(#suitGradient)" stroke="url(#redGlowGradient)" stroke-width="1" cx="40" cy="45" rx="12" ry="18" style="animation: monsterPulse 2s ease-in-out infinite;"/><path fill="#000000" stroke="#ff0000" stroke-width="0.3" d="M32,35 L35,40 L40,38 L45,40 L48,35 L45,32 L35,32 Z"/><path fill="#cc0000" stroke="#ff0000" stroke-width="0.5" d="M38,38 L42,38 L41,50 L39,50 Z"/><circle fill="#ff0000" cx="40" cy="42" r="0.8"/><circle fill="#ff0000" cx="40" cy="46" r="0.8"/><circle fill="#ff0000" cx="40" cy="50" r="0.8"/><polygon fill="#ff0000" points="28,35 30,30 32,35"/><polygon fill="#ff0000" points="48,35 50,30 52,35"/><polygon fill="#ff0000" points="26,38 28,33 30,38"/><polygon fill="#ff0000" points="50,38 52,33 54,38"/><ellipse fill="#d0d0d0" stroke="#999999" stroke-width="0.5" cx="40" cy="25" rx="10" ry="12" style="animation: monsterPulse 2.5s ease-in-out infinite;"/><path fill="#1a1a1a" stroke="#000000" stroke-width="0.3" d="M30,18 Q40,15 50,18 Q48,22 45,20 Q40,19 35,20 Q32,22 30,18"/><polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="33,18 35,10 37,18"/><polygon fill="#800000" stroke="#ff0000" stroke-width="0.5" points="43,18 45,10 47,18"/><ellipse fill="#ff0000" cx="36" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"/><ellipse fill="#ff0000" cx="44" cy="22" rx="2" ry="2.5" style="animation: eyeGlow 1.5s ease-in-out infinite alternate;"/><ellipse fill="#000000" cx="36" cy="23" rx="0.8" ry="1"/><ellipse fill="#000000" cx="44" cy="23" rx="0.8" ry="1"/><circle fill="#ffff00" cx="35" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite;"/><circle fill="#ffff00" cx="45" cy="21" r="0.3" opacity="0.8" style="animation: sparkle 1s ease-in-out infinite; animation-delay: 0.5s;"/><path fill="#000000" d="M34,28 Q40,32 46,28 Q40,30 34,28" opacity="0.9"/><polygon fill="#ffffff" points="36,28 37,30 38,28"/><polygon fill="#ffffff" points="39,28 40,31 41,28"/><polygon fill="#ffffff" points="42,28 43,30 44,28"/><rect fill="#f5f5dc" x="46" y="26" width="6" height="1" rx="0.5"/><rect fill="#d2691e" x="46" y="26.2" width="5" height="0.6" rx="0.3"/><circle fill="#ff4000" cx="52" cy="26.5" r="0.8" style="animation: cigaretteBurn 1s ease-in-out infinite;"/><circle fill="#ff8000" cx="52" cy="26.5" r="0.4" style="animation: cigaretteBurn 1s ease-in-out infinite; animation-delay: 0.3s;"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="1.5" stroke-linecap="round" d="M52,26 Q55,22 53,18 Q56,15 54,12" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0s;"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="1.2" stroke-linecap="round" d="M52,26 Q57,23 55,19 Q58,16 56,13" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 0.5s;"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="1" stroke-linecap="round" d="M52,26 Q54,24 52,20 Q55,17 53,14" style="animation: smokeRise 3s ease-in-out infinite; animation-delay: 1s;"/><ellipse fill="#333333" cx="38" cy="25" rx="0.5" ry="0.3"/><ellipse fill="#333333" cx="42" cy="25" rx="0.5" ry="0.3"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M38,25 Q36,22 38,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.3s;"/><path fill="none" stroke="url(#smokeGradient)" stroke-width="0.8" stroke-linecap="round" d="M42,25 Q44,22 42,19" style="animation: smokeRise 2.5s ease-in-out infinite; animation-delay: 0.8s;"/><circle fill="#00ff00" cx="25" cy="15" r="0.8" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0s;"/><circle fill="#00ff00" cx="55" cy="20" r="0.6" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 1s;"/><circle fill="#00ff00" cx="20" cy="35" r="0.7" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 2s;"/><circle fill="#00ff00" cx="60" cy="30" r="0.5" opacity="0.7" style="animation: toxicFloat 4s ease-in-out infinite; animation-delay: 0.5s;"/><path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M20,20 Q25,15 30,20" style="animation: auraFlicker 1.8s ease-in-out infinite;"/><path fill="none" stroke="#ff0000" stroke-width="0.5" opacity="0.4" d="M50,20 Q55,15 60,20" style="animation: auraFlicker 1.8s ease-in-out infinite; animation-delay: 0.6s;"/><path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M15,40 Q20,35 25,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.3s;"/><path fill="none" stroke="#800000" stroke-width="0.3" opacity="0.5" d="M55,40 Q60,35 65,40" style="animation: auraFlicker 2.2s ease-in-out infinite; animation-delay: 0.9s;"/></svg>
                    </div>
                </div>
                <p class="text-xl font-bold text-red-500 mt-4" style="text-shadow: 0 0 8px #ff0000;">Quái vật Nicotine</p>
            </div>
        </div>
    </div>
    <div id="dialogue-box">
        <h3 id="speaker-name"></h3>
        <p id="dialogue-text"></p>
        <button id="next-btn">Tiếp theo →</button>
        <div id="final-options-container" class="hidden mt-4 flex flex-col sm:flex-row gap-4 justify-center items-center">
            <a href="#" id="replay-btn" class="final-option-btn">Xem lại hội thoại</a>
            <a href="index.html" class="final-option-btn">Về màn hình chính</a>
            <a href="credit.html" class="final-option-btn highlighted">Tiếp tục</a>
        </div>
    </div>
</div>

<script>
    // --- Fullscreen Logic ---
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const iconFullscreen = document.getElementById('icon-fullscreen');
    const iconExitFullscreen = document.getElementById('icon-exit-fullscreen');
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        document.addEventListener('fullscreenchange', updateFullscreenIcons);
        document.addEventListener('webkitfullscreenchange', updateFullscreenIcons);
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
            document.documentElement.requestFullscreen?.().catch(err => console.warn(`Error enabling full-screen: ${err.message}`));
        } else {
            document.exitFullscreen?.().catch(err => console.warn(`Error exiting full-screen: ${err.message}`));
        }
    }
    
    function updateFullscreenIcons() {
        const isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement;
        if(iconFullscreen) iconFullscreen.classList.toggle('hidden', isFullscreen);
        if(iconExitFullscreen) iconExitFullscreen.classList.toggle('hidden', !isFullscreen);
    }

    const cutsceneScreen = document.getElementById('cutscene-screen');
    const mainWrapper = document.querySelector('.main-wrapper');
    const dialogueBox = document.getElementById('dialogue-box');
    const speakerName = document.getElementById('speaker-name');
    const dialogueText = document.getElementById('dialogue-text');
    const nextButton = document.getElementById('next-btn');
    const finalOptionsContainer = document.getElementById('final-options-container');
    const replayBtn = document.getElementById('replay-btn');
    
    const heroCharacter = document.getElementById('hero-container');
    const nicotineMonster = document.getElementById('nicotine-container');

    // --- BỘ QUẢN LÝ ÂM THANH ---
    const AudioManager = {
        isInitialized: false, sounds: {}, music: null,
        async init() {
            if (this.isInitialized) return;
            await Tone.start();
            
            this.sounds.click = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.2 }, volume: -10 }).toDestination();
            this.sounds.vanish = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.7, sustain: 0, release: 0.2 } }).toDestination();
            this.sounds.vanish.volume.value = -12;
            this.sounds.victory = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.3 } }).toDestination();
            this.sounds.victory.volume.value = -12;
            const musicSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "fatsine" }, envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 1 } }).toDestination();
            musicSynth.volume.value = -24;
            this.music = new Tone.Sequence((time, note) => { 
                musicSynth.triggerAttackRelease(note, '8n', time); 
            }, ['C4', 'E4', 'G4', 'A4', 'G4', 'E4', 'D4', 'C4']).start(0);
            
            this.music.loop = true;
            Tone.Transport.start();
            this.isInitialized = true;
        },
        playMusic() { if (this.isInitialized && Tone.Transport.state !== 'started') Tone.Transport.start(); },
        stopMusic() { if (this.isInitialized) Tone.Transport.stop(); },
        playSound(name) {
            if (!this.isInitialized) return;
            const now = Tone.now();
            if (name === 'click') this.sounds.click.triggerAttackRelease('G4', '8n', now);
            if (name === 'vanish') {
                this.sounds.vanish.triggerAttack('G5', now);
                this.sounds.vanish.frequency.rampTo('C3', 0.7, now);
                this.sounds.vanish.triggerRelease(now + 0.7);
            }
            if (name === 'victory') {
                this.sounds.victory.triggerAttackRelease(['C5', 'E5', 'G5'], '16n', now);
            }
        }
    };

    // --- Kịch bản CẢNH KẾT ---
    const script = [
        { speaker: "Nicotine", character: nicotineMonster, line: "Không... không thể nào! Kiến thức... và ý chí của ngươi... quá mạnh... Aaargh!" },
        { speaker: "Người dẫn chuyện", character: null, line: "Bị đánh bại bởi kiến thức và ý chí kiên định, Nicotine tan biến. Thành Phố Cơ Thể lại bừng sáng." },
        { speaker: "Minh", character: heroCharacter, line: "Chúng ta đã làm được! Chúng ta đã bảo vệ được Thành Phố Cơ Thể!" },
        { speaker: "Minh", character: heroCharacter, line: "Chiến thắng này là của tất cả mọi người! Hãy nhớ lấy thông điệp này:" },
        { speaker: "Thông Điệp Chiến Thắng", character: heroCharacter, line: "Hãy bảo vệ từng nhịp thở. Nói không với thuốc lá!" }
    ];

    let currentLine = 0;
    let nicotineDefeated = false;

    // --- Hàm điều khiển cảnh ---
    function showLine() {
        if (currentLine >= script.length) {
            return;
        }
        const scene = script[currentLine];
        
        if (currentLine === 1 && !nicotineDefeated) {
            AudioManager.playSound('vanish');
            nicotineMonster.classList.add('vanishing');
            nicotineDefeated = true;
            setTimeout(() => {
                nicotineMonster.classList.remove('visible');
            }, 1000);
        }
        
        speakerName.textContent = scene.speaker;

        if (currentLine === script.length - 1) {
            mainWrapper.style.opacity = '0';
            dialogueBox.classList.add('final-popup');
            requestAnimationFrame(() => {
                dialogueBox.classList.add('visible');
            });

            dialogueText.innerHTML = '';
            dialogueText.classList.add('victory-title');
            const victoryMessage = scene.line;
            victoryMessage.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char;
                if (char.trim() !== '') { 
                    span.classList.add('victory-letter');
                    span.style.animationDelay = `${index * 0.07}s`;
                }
                dialogueText.appendChild(span);
            });

            AudioManager.playSound('victory');
            nextButton.style.display = 'none'; // Ẩn nút "Tiếp theo"
            finalOptionsContainer.classList.remove('hidden'); // Hiện các nút lựa chọn cuối
        } else {
            mainWrapper.style.opacity = '1';
            dialogueBox.classList.remove('final-popup');
            dialogueBox.classList.add('visible');
            
            dialogueText.classList.remove('victory-title');
            dialogueText.innerHTML = scene.line; 

            nextButton.textContent = "Tiếp theo →";
            nextButton.style.display = 'inline-block';
            finalOptionsContainer.classList.add('hidden');
        }
    }

    // --- HIỆU ỨNG PHÁO HOA ---
    const fireworksCanvas = document.getElementById('fireworks-canvas');
    const ctx = fireworksCanvas.getContext('2d');
    let fireworks = [], particles = [];
    function resizeCanvas() { fireworksCanvas.width = window.innerWidth; fireworksCanvas.height = window.innerHeight; }
    function Firework(sx, sy, tx, ty) { this.x = sx; this.y = sy; this.sx = sx; this.sy = sy; this.tx = tx; this.ty = ty; this.distanceToTarget = Math.sqrt(Math.pow(tx - sx, 2) + Math.pow(ty - sy, 2)); this.distanceTraveled = 0; this.coordinates = []; this.coordinateCount = 3; while(this.coordinateCount--) { this.coordinates.push([this.x, this.y]); } this.angle = Math.atan2(ty - sy, tx - sx); this.speed = 2; this.acceleration = 1.05; this.brightness = Math.random() * 50 + 50; }
    Firework.prototype.update = function(index) { this.coordinates.pop(); this.coordinates.unshift([this.x, this.y]); this.speed *= this.acceleration; let vx = Math.cos(this.angle) * this.speed; let vy = Math.sin(this.angle) * this.speed; this.distanceTraveled = Math.sqrt(Math.pow(this.x - this.sx, 2) + Math.pow(this.y - this.sy, 2)); if(this.distanceTraveled >= this.distanceToTarget) { createParticles(this.tx, this.ty); fireworks.splice(index, 1); } else { this.x += vx; this.y += vy; } }
    Firework.prototype.draw = function() { ctx.beginPath(); ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]); ctx.lineTo(this.x, this.y); ctx.strokeStyle = 'hsl(' + Math.random() * 360 + ', 100%, ' + this.brightness + '%)'; ctx.stroke(); }
    function Particle(x, y) { this.x = x; this.y = y; this.coordinates = []; this.coordinateCount = 5; while(this.coordinateCount--) { this.coordinates.push([this.x, this.y]); } this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 10 + 1; this.friction = 0.95; this.gravity = 1; this.hue = Math.random() * 360; this.brightness = Math.random() * 50 + 50; this.alpha = 1; this.decay = Math.random() * 0.03 + 0.015; }
    Particle.prototype.update = function(index) { this.coordinates.pop(); this.coordinates.unshift([this.x, this.y]); this.speed *= this.friction; this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed + this.gravity; this.alpha -= this.decay; if(this.alpha <= this.decay) { particles.splice(index, 1); } }
    Particle.prototype.draw = function() { ctx.beginPath(); ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]); ctx.lineTo(this.x, this.y); ctx.strokeStyle = 'hsla(' + this.hue + ', 100%, ' + this.brightness + '%, ' + this.alpha + ')'; ctx.stroke(); }
    function createParticles(x, y) { let particleCount = 30; while(particleCount--) { particles.push(new Particle(x, y)); } }
    let fireworksInterval;
    function startFireworks() { if(!fireworksInterval) { fireworksInterval = setInterval(() => { fireworks.push(new Firework(fireworksCanvas.width / 2, fireworksCanvas.height, Math.random() * fireworksCanvas.width, Math.random() * fireworksCanvas.height / 2)); }, 800); } }
    function stopFireworks() { clearInterval(fireworksInterval); fireworksInterval = null; fireworks = []; particles = []; }
    function loop() { requestAnimationFrame(loop); ctx.globalCompositeOperation = 'destination-out'; ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height); ctx.globalCompositeOperation = 'lighter'; for(let i = fireworks.length - 1; i >= 0; i--) { fireworks[i].draw(); fireworks[i].update(i); } for(let i = particles.length - 1; i >= 0; i--) { particles[i].draw(); particles[i].update(i); } }

    function setupScene() {
        requestAnimationFrame(() => {
            cutsceneScreen.style.opacity = '1';
        });
        
        mainWrapper.style.opacity = '1';
        dialogueBox.classList.remove('final-popup', 'visible');
        heroCharacter.classList.add('visible');
        nicotineMonster.classList.remove('vanishing');
        nicotineMonster.classList.add('visible');
        nicotineDefeated = false;
        
        currentLine = 0;
        showLine();
    }

    // --- Gắn sự kiện ---
    nextButton.addEventListener('click', async () => {
        if (!AudioManager.isInitialized) {
            await AudioManager.init();
            AudioManager.playMusic();
            startFireworks();
        }
        AudioManager.playSound('click');
        currentLine++;
        showLine();
    });

    replayBtn.addEventListener('click', (e) => {
        e.preventDefault();
        AudioManager.playSound('click');
        window.location.reload();
    });
    
    window.addEventListener('load', () => {
        resizeCanvas(); 
        loop();
        setupScene();
    });

    window.addEventListener('resize', resizeCanvas);

</script>
</body>
</html>
