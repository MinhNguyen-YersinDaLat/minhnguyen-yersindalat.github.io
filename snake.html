<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Rắn Săn Mồi Cấp Số Nhân</title>
  <style>
    body {
      font-family: "Comic Sans MS", cursive;
      background-color: #ffeef2;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
    }
    canvas {
      background-color: #fff8f0;
      border: 4px solid #ff8ab6;
      margin-top: 20px;
    }
    #info {
      margin-top: 10px;
      text-align: center;
      color: #444;
    }
    #restartBtn {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #ff91a4;
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>🐍 Rắn Săn Mồi Cấp Số Nhân 🧮</h1>
  <canvas id="game" width="400" height="400"></canvas>
  <div id="info">
    <p>🍬 <strong>Điểm:</strong> <span id="score">0</span> | 🏆 <strong>Kỷ lục:</strong> <span id="highscore">0</span></p>
    <p>📌 <strong>Số đầu tiên:</strong> <span id="firstTerm"></span> | ✖️ <strong>Công bội:</strong> <span id="ratio"></span></p>
    <p>👉 <strong>Số cần ăn tiếp theo:</strong> <span id="nextTarget"></span></p>
    <p>📜 <strong>Các số đã ăn:</strong> <span id="eatenList">[]</span></p>
  </div>
  <button id="restartBtn">🔄 Chơi lại</button>

  <audio id="bgMusic" src="https://cdn.pixabay.com/download/audio/2022/03/11/audio_b7f2563b14.mp3?filename=pixel-adventure-8946.mp3" loop></audio>
  <audio id="correctSound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_1fa3126c02.mp3?filename=correct-2-46134.mp3"></audio>
  <audio id="wrongSound" src="https://cdn.pixabay.com/download/audio/2022/03/11/audio_776c7bdb33.mp3?filename=wrong-47985.mp3"></audio>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const box = 20;
    const canvasSize = 400;
    const totalBoxes = canvasSize / box;

    let snake = [{ x: 9 * box, y: 9 * box }];
    let direction = "RIGHT";
    let score = 0;
    let eatenNumbers = [];

    let firstTerm = Math.floor(Math.random() * 5 + 1);
    let ratio = Math.floor(Math.random() * 3 + 2);
    let nextExpected = firstTerm;
    document.getElementById("firstTerm").textContent = firstTerm;
    document.getElementById("ratio").textContent = ratio;
    document.getElementById("nextTarget").textContent = nextExpected;

    let food = generateFood();
    let highscore = localStorage.getItem("highscore") || 0;
    document.getElementById("highscore").textContent = highscore;

    let bgMusic = document.getElementById("bgMusic");
    let correctSound = document.getElementById("correctSound");
    let wrongSound = document.getElementById("wrongSound");

    document.getElementById("restartBtn").onclick = () => location.reload();
    document.addEventListener("keydown", changeDirection);
    window.onload = () => {
      bgMusic.play();
      bgMusic.volume = 0.4;
    };

    function changeDirection(e) {
      const key = e.keyCode;
      if (key === 37 && direction !== "RIGHT") direction = "LEFT";
      else if (key === 38 && direction !== "DOWN") direction = "UP";
      else if (key === 39 && direction !== "LEFT") direction = "RIGHT";
      else if (key === 40 && direction !== "UP") direction = "DOWN";
    }

    function drawSnakeGame() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Rắn
      for (let i = 0; i < snake.length; i++) {
        ctx.fillStyle = i === 0 ? "#34c759" : "#a3e635";
        ctx.fillRect(snake[i].x, snake[i].y, box, box);
        ctx.strokeStyle = "#444";
        ctx.strokeRect(snake[i].x, snake[i].y, box, box);
      }

      // Vẽ các số (mồi)
      food.forEach(f => {
        ctx.fillStyle = "#fdba74";
        ctx.beginPath();
        ctx.arc(f.x + box / 2, f.y + box / 2, box / 2 - 2, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = "#000";
        ctx.font = "14px Comic Sans MS";
        ctx.textAlign = "center";
        ctx.fillText(f.value, f.x + box / 2, f.y + box / 2 + 5);
      });

      // Di chuyển
      let headX = snake[0].x;
      let headY = snake[0].y;
      if (direction === "LEFT") headX -= box;
      if (direction === "UP") headY -= box;
      if (direction === "RIGHT") headX += box;
      if (direction === "DOWN") headY += box;

      // Game over nếu đụng tường hoặc chính mình
      if (
        headX < 0 || headX >= canvasSize ||
        headY < 0 || headY >= canvasSize ||
        snake.some(segment => segment.x === headX && segment.y === headY)
      ) {
        bgMusic.pause();
        clearInterval(game);
        alert("🛑 Game Over!");
        return;
      }

      let ateFood = false;
      for (let i = 0; i < food.length; i++) {
        if (headX === food[i].x && headY === food[i].y) {
          if (food[i].value === nextExpected) {
            score += nextExpected;
            eatenNumbers.push(nextExpected);
            document.getElementById("score").textContent = score;
            document.getElementById("eatenList").textContent = "[" + eatenNumbers.join(", ") + "]";
            nextExpected *= ratio;
            document.getElementById("nextTarget").textContent = nextExpected;
            correctSound.play();
            food = generateFood();
            ateFood = true;
          } else {
            wrongSound.play();
            bgMusic.pause();
            clearInterval(game);
            alert("Sai số! 🧨 Bạn đã ăn nhầm!");
            return;
          }
        }
      }

      const newHead = { x: headX, y: headY };
      snake.unshift(newHead);
      if (!ateFood) snake.pop();

      if (score > highscore) {
        highscore = score;
        document.getElementById("highscore").textContent = highscore;
        localStorage.setItem("highscore", highscore);
      }
    }

    function generateFood() {
      const foods = [];
      const validValues = [];
      for (let i = 0; i < 4; i++) {
        // Một số đúng, ba số nhiễu nhưng > số cần ăn
        const isCorrect = i === 0;
        const value = isCorrect ? nextExpected : Math.floor(Math.random() * (nextExpected * 2 - nextExpected + 1) + nextExpected + 1);
        validValues.push(value);
        let position;
        do {
          position = {
            x: Math.floor(Math.random() * totalBoxes) * box,
            y: Math.floor(Math.random() * totalBoxes) * box
          };
        } while (
          snake.some(s => s.x === position.x && s.y === position.y) ||
          foods.some(f => f.x === position.x && f.y === position.y)
        );
        foods.push({ ...position, value });
      }
      return foods;
    }

    const game = setInterval(drawSnakeGame, 180);
  </script>
</body>
</html>
