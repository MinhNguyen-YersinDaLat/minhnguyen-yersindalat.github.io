<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R·∫Øn To√°n C·∫•p S·ªë Nh√¢n</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Comic Sans MS', sans-serif;
      background-color: #fff8f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 1rem;
    }
    h1 {
      color: #e6739f;
      margin-bottom: 10px;
    }
    #game {
      display: grid;
      grid-template-columns: repeat(20, 24px);
      grid-template-rows: repeat(20, 24px);
      gap: 2px;
      margin-top: 10px;
    }
    .cell {
      width: 24px;
      height: 24px;
      border-radius: 5px;
      background-color: #fff3;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .snake {
      background-color: #63d471;
    }
    .food {
      background-color: #ffc3a0;
      border: 1px dashed #ff77aa;
      font-weight: bold;
    }
    .info {
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
      color: #444;
    }
    button {
      margin-top: 10px;
      padding: 6px 16px;
      font-size: 14px;
      background-color: #ff92b2;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #ff6f9c;
    }
    audio { display: none; }
  </style>
</head>
<body>

<h1>üêç R·∫Øn To√°n H·ªçc - C·∫•p s·ªë nh√¢n üç¨</h1>
<div class="info">
  <div id="rule"></div>
  <div>üéØ ƒêi·ªÉm: <span id="score">0</span> | üèÜ K·ª∑ l·ª•c: <span id="highscore">0</span></div>
</div>
<div id="game"></div>
<div class="info" id="gameOver" style="display: none; color: red;">üíÄ Game Over! Nh·∫•n n√∫t ƒë·ªÉ ch∆°i l·∫°i.</div>
<button onclick="restart()">üîÅ Ch∆°i l·∫°i</button>
<audio autoplay loop>
  <source src="https://files.codingninjas.in/background-music-10859.mp3" type="audio/mpeg">
</audio>

<script>
  const game = document.getElementById("game");
  const scoreEl = document.getElementById("score");
  const highEl = document.getElementById("highscore");
  const ruleEl = document.getElementById("rule");
  const gameOverEl = document.getElementById("gameOver");

  const gridSize = 20;
  let snake = [{ x: 5, y: 5 }];
  let dir = { x: 0, y: 0 };
  let interval;
  let expected = 2;
  let ratio = 2;
  let food = { x: 10, y: 10, value: 2 };
  let score = 0;
  let highscore = localStorage.getItem("highscore") || 0;
  highEl.textContent = highscore;

  function getRandomInt(n) {
    return Math.floor(Math.random() * n);
  }

  function placeFood() {
    const good = { x: getRandomInt(gridSize), y: getRandomInt(gridSize), value: expected };
    const bads = [];
    while (bads.length < 3) {
      const val = expected + getRandomInt(5) + 1;
      bads.push({
        x: getRandomInt(gridSize),
        y: getRandomInt(gridSize),
        value: val
      });
    }
    return [good, ...bads];
  }

  let foods = placeFood();

  function drawGrid() {
    game.innerHTML = "";
    for (let y = 0; y < gridSize; y++) {
      for (let x = 0; x < gridSize; x++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        if (snake.some(s => s.x === x && s.y === y)) {
          cell.classList.add("snake");
        }
        const found = foods.find(f => f.x === x && f.y === y);
        if (found) {
          cell.classList.add("food");
          cell.textContent = found.value;
        }
        game.appendChild(cell);
      }
    }
  }

  function gameLoop() {
    const head = { ...snake[0] };
    head.x += dir.x;
    head.y += dir.y;

    if (
      head.x < 0 || head.x >= gridSize || head.y < 0 || head.y >= gridSize ||
      snake.some(s => s.x === head.x && s.y === head.y)
    ) {
      clearInterval(interval);
      gameOverEl.style.display = "block";
      return;
    }

    snake.unshift(head);
    const index = foods.findIndex(f => f.x === head.x && f.y === head.y);

    if (index > -1) {
      const item = foods[index];
      if (item.value !== expected) {
        clearInterval(interval);
        gameOverEl.style.display = "block";
        return;
      }
      score += expected;
      expected *= ratio;
      foods = placeFood();
      scoreEl.textContent = score;
      if (score > highscore) {
        highscore = score;
        localStorage.setItem("highscore", score);
        highEl.textContent = highscore;
      }
    } else {
      snake.pop();
    }

    drawGrid();
    ruleEl.textContent = `üß† B·∫Øt ƒë·∫ßu t·ª´ ${expected / ratio}, c√¥ng b·ªôi ${ratio}`;
  }

  function restart() {
    snake = [{ x: 5, y: 5 }];
    dir = { x: 0, y: 0 };
    const start = getRandomInt(4) + 2;
    const r = getRandomInt(3) + 2;
    expected = start;
    ratio = r;
    foods = placeFood();
    score = 0;
    scoreEl.textContent = "0";
    gameOverEl.style.display = "none";
    clearInterval(interval);
    interval = setInterval(gameLoop, 180);
  }

  document.addEventListener("keydown", (e) => {
    switch (e.key) {
      case "ArrowUp": if (dir.y === 0) dir = { x: 0, y: -1 }; break;
      case "ArrowDown": if (dir.y === 0) dir = { x: 0, y: 1 }; break;
      case "ArrowLeft": if (dir.x === 0) dir = { x: -1, y: 0 }; break;
      case "ArrowRight": if (dir.x === 0) dir = { x: 1, y: 0 }; break;
    }
  });

  restart(); // kh·ªüi ƒë·ªông game l·∫ßn ƒë·∫ßu
</script>
</body>
</html>
