<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Rắn săn mồi cấp số nhân 🐍</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f8ff;
      margin: 0;
      text-align: center;
    }
    h1 {
      color: #333;
      margin-top: 10px;
    }
    canvas {
      background-color: #fff;
      border: 4px solid #ddd;
      display: block;
      margin: 0 auto;
    }
    #info {
      margin-top: 10px;
      font-size: 18px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background-color: #90ee90;
      cursor: pointer;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>🐍 Rắn săn mồi - Cấp số nhân!</h1>
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <div id="info">
    <div>🎯 Điểm: <span id="score">0</span> | 🏆 Kỷ lục: <span id="highScore">0</span></div>
    <div>📌 Bắt đầu: <span id="firstTerm"></span> | Công bội: <span id="ratio"></span></div>
    <button onclick="startGame()">🔁 Chơi lại</button>
  </div>

  <!-- Nhạc nền -->
  <audio id="bgMusic" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/03/21/audio_8c85fdf42d.mp3?filename=arcade-funk-12348.mp3" type="audio/mpeg">
  </audio>

  <!-- Âm thanh đúng -->
  <audio id="correctSound">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4c66dbf19e.mp3?filename=success-1-6297.mp3" type="audio/mpeg">
  </audio>

  <!-- Âm thanh sai -->
  <audio id="wrongSound">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_35c6fa4323.mp3?filename=error-126627.mp3" type="audio/mpeg">
  </audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const box = 20;
    let snake, direction, food, score, highScore = 0, first, ratio, expected, interval;

    function startGame() {
      snake = [{ x: 5, y: 5 }];
      direction = "RIGHT";
      score = 0;
      first = Math.floor(Math.random() * 5 + 1);
      ratio = Math.floor(Math.random() * 4 + 2);
      expected = first;

      document.getElementById("firstTerm").innerText = first;
      document.getElementById("ratio").innerText = ratio;
      document.getElementById("score").innerText = score;

      food = generateNumber();
      clearInterval(interval);
      interval = setInterval(draw, 150);
    }

    function generateNumber() {
      const nums = [];
      for (let i = 0; i < 5; i++) {
        let value;
        if (i === 0) {
          value = expected;
        } else {
          do {
            value = Math.floor(Math.random() * 100 + 1);
          } while (value === expected);
        }
        nums.push({
          x: Math.floor(Math.random() * (canvas.width / box)),
          y: Math.floor(Math.random() * (canvas.height / box)),
          value: value
        });
      }
      return nums;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Vẽ rắn
      for (let i = 0; i < snake.length; i++) {
        ctx.fillStyle = i === 0 ? "#6a5acd" : "#8a2be2";
        ctx.fillRect(snake[i].x * box, snake[i].y * box, box, box);
      }

      // Vẽ số
      ctx.fillStyle = "#ff69b4";
      ctx.font = "bold 16px Arial";
      food.forEach(item => {
        ctx.fillText(item.value, item.x * box + 5, item.y * box + 15);
      });

      // Tự di chuyển
      let headX = snake[0].x;
      let headY = snake[0].y;

      if (direction === "LEFT") headX--;
      if (direction === "RIGHT") headX++;
      if (direction === "UP") headY--;
      if (direction === "DOWN") headY++;

      // Game over nếu chạm viền
      if (
        headX < 0 || headY < 0 ||
        headX >= canvas.width / box || headY >= canvas.height / box
      ) {
        clearInterval(interval);
        document.getElementById("wrongSound").play();
        setTimeout(() => alert("💥 Đụng tường! Game over."), 300);
        return;
      }

      // Game over nếu ăn trúng thân
      for (let i = 1; i < snake.length; i++) {
        if (headX === snake[i].x && headY === snake[i].y) {
          clearInterval(interval);
          document.getElementById("wrongSound").play();
          setTimeout(() => alert("💥 Tự cắn mình! Game over."), 300);
          return;
        }
      }

      snake.unshift({ x: headX, y: headY });

      // Ăn số đúng
      let ate = false;
      for (let i = 0; i < food.length; i++) {
        if (food[i].x === headX && food[i].y === headY) {
          if (food[i].value === expected) {
            document.getElementById("correctSound").play();
            score += expected;
            expected *= ratio;
            food = generateNumber();
            ate = true;
          } else {
            document.getElementById("wrongSound").play();
            clearInterval(interval);
            setTimeout(() => alert("❌ Ăn sai số! Game over."), 300);
            return;
          }
        }
      }

      if (!ate) snake.pop();

      document.getElementById("score").innerText = score;
      if (score > highScore) {
        highScore = score;
        document.getElementById("highScore").innerText = highScore;
      }
    }

    // Điều khiển
    document.addEventListener("keydown", e => {
      if (e.key === "ArrowLeft" && direction !== "RIGHT") direction = "LEFT";
      else if (e.key === "ArrowUp" && direction !== "DOWN") direction = "UP";
      else if (e.key === "ArrowRight" && direction !== "LEFT") direction = "RIGHT";
      else if (e.key === "ArrowDown" && direction !== "UP") direction = "DOWN";
    });

    // Tự chạy nhạc nền khi click đầu tiên
    window.addEventListener("click", () => {
      const music = document.getElementById("bgMusic");
      if (music.paused) {
        music.play().catch(e => console.log("Trình duyệt chặn autoplay:", e));
      }
    }, { once: true });

    // Tự chạy rắn khi load
    window.onload = () => {
      startGame();
    };
  </script>
</body>
</html>
