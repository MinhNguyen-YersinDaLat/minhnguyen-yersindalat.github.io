<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R·∫Øn sƒÉn m·ªìi s·ªë h·ªçc</title>
  <style>
    body {
      background-color: #fefbd8;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    canvas {
      background-color: #fff;
      border: 5px solid #ffb347;
      margin-top: 20px;
    }
    h1 {
      color: #ff6347;
    }
    .info {
      font-size: 18px;
      margin: 10px;
      color: #444;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #ffb347;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #ffa07a;
    }
  </style>
</head>
<body>
  <h1>üêç R·∫Øn sƒÉn m·ªìi s·ªë h·ªçc üßÆ</h1>
  <div class="info" id="rule"></div>
  <div class="info">ƒêi·ªÉm: <span id="score">0</span> | K·ª∑ l·ª•c: <span id="highScore">0</span></div>
  <div class="info">S·ªë ƒë√£ ƒÉn: <span id="eatenNumbers">[]</span></div>
  <canvas id="game" width="400" height="400"></canvas>
  <br />
  <button onclick="restartGame()">üîÅ Ch∆°i l·∫°i</button>
  <audio id="bgMusic" loop autoplay>
    <source src="https://cdn.pixabay.com/download/audio/2022/03/17/audio_d7540f90e0.mp3" type="audio/mpeg">
  </audio>
  <audio id="eatCorrect">
    <source src="https://cdn.pixabay.com/download/audio/2021/09/15/audio_b3789ed981.mp3" type="audio/mpeg">
  </audio>
  <audio id="eatWrong">
    <source src="https://cdn.pixabay.com/download/audio/2021/09/15/audio_a6b8fda587.mp3" type="audio/mpeg">
  </audio>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const box = 20;
    const canvasSize = 400;
    const row = canvasSize / box;

    let snake = [{ x: 5 * box, y: 5 * box }];
    let direction = "RIGHT";
    let score = 0;
    let highScore = localStorage.getItem("highScore") || 0;
    let eatenNumbers = [];
    let foodItems = [];

    // Quy t·∫Øc c·∫•p s·ªë nh√¢n
    let start = Math.floor(Math.random() * 3 + 1); // 1-3
    let ratio = Math.floor(Math.random() * 2 + 2); // 2-3
    let currentExpected = start;

    document.getElementById("rule").innerHTML = `üëâ Quy t·∫Øc: C·∫•p s·ªë nh√¢n b·∫Øt ƒë·∫ßu t·ª´ <b>${start}</b>, c√¥ng b·ªôi <b>${ratio}</b>`;

    document.addEventListener("keydown", changeDirection);

    function changeDirection(e) {
      if (e.key === "ArrowLeft" && direction !== "RIGHT") direction = "LEFT";
      else if (e.key === "ArrowUp" && direction !== "DOWN") direction = "UP";
      else if (e.key === "ArrowRight" && direction !== "LEFT") direction = "RIGHT";
      else if (e.key === "ArrowDown" && direction !== "UP") direction = "DOWN";
    }

    function drawSnake() {
      for (let i = 0; i < snake.length; i++) {
        ctx.fillStyle = "#32CD32";
        ctx.fillRect(snake[i].x, snake[i].y, box, box);
        ctx.strokeStyle = "#006400";
        ctx.strokeRect(snake[i].x, snake[i].y, box, box);
      }
    }

    function randomPosition() {
      return {
        x: Math.floor(Math.random() * row) * box,
        y: Math.floor(Math.random() * row) * box,
      };
    }

    function placeFoodItems() {
      foodItems = [];
      let correctFood = { ...randomPosition(), value: currentExpected };
      foodItems.push(correctFood);

      // Th√™m s·ªë nhi·ªÖu
      while (foodItems.length < 5) {
        let pos = randomPosition();
        let randVal = Math.floor(Math.random() * 10 + 1);
        if (!foodItems.some(f => f.x === pos.x && f.y === pos.y))
          foodItems.push({ ...pos, value: randVal });
      }
    }

    function drawFood() {
      ctx.font = "16px Comic Sans MS";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      foodItems.forEach(f => {
        ctx.fillStyle = "#FFD700";
        ctx.beginPath();
        ctx.arc(f.x + box / 2, f.y + box / 2, box / 2 - 2, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = "#000";
        ctx.fillText(f.value, f.x + box / 2, f.y + box / 2);
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvasSize, canvasSize);

      drawSnake();
      drawFood();

      let head = { ...snake[0] };

      if (direction === "LEFT") head.x -= box;
      if (direction === "UP") head.y -= box;
      if (direction === "RIGHT") head.x += box;
      if (direction === "DOWN") head.y += box;

      // Va ch·∫°m t∆∞·ªùng
      if (head.x < 0 || head.x >= canvasSize || head.y < 0 || head.y >= canvasSize || collision(head, snake)) {
        clearInterval(game);
        alert("üíÄ Game Over!");
        return;
      }

      // Ki·ªÉm tra ƒÉn
      let ate = false;
      for (let i = 0; i < foodItems.length; i++) {
        let f = foodItems[i];
        if (head.x === f.x && head.y === f.y) {
          if (f.value === currentExpected) {
            eatenNumbers.push(f.value);
            document.getElementById("eatCorrect").play();
            score += f.value;
            currentExpected *= ratio;
            placeFoodItems();
            ate = true;
          } else {
            document.getElementById("eatWrong").play();
            clearInterval(game);
            alert("üí• Sai r·ªìi! B·∫°n ƒë√£ ƒÉn nh·∫ßm s·ªë.");
            return;
          }
        }
      }

      if (!ate) snake.pop();
      snake.unshift(head);

      document.getElementById("score").textContent = score;
      if (score > highScore) {
        highScore = score;
        localStorage.setItem("highScore", highScore);
      }
      document.getElementById("highScore").textContent = highScore;
      document.getElementById("eatenNumbers").textContent = JSON.stringify(eatenNumbers);
    }

    function collision(head, array) {
      for (let i = 0; i < array.length; i++) {
        if (head.x === array[i].x && head.y === array[i].y) return true;
      }
      return false;
    }

    function restartGame() {
      location.reload();
    }

    placeFoodItems();
    let game = setInterval(draw, 150);
  </script>
</body>
</html>
